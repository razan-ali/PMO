<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PETROLUBE - Enterprise Initiative Management</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
</head>
<body>
<div id="app-root"></div>

<script>
// ============================================================================
// PETROLUBE ENTERPRISE INITIATIVE MANAGEMENT SYSTEM
// Expert-Level UI/UX with Full Sample Data
// ============================================================================

const STYLES = `
* { margin: 0; padding: 0; box-sizing: border-box; }

:root {
    --petro-green-900: #0F3B29;
    --petro-green-800: #1B5E3F;
    --petro-green-700: #2E7D52;
    --petro-green-600: #45A569;
    --petro-green-100: #E8F5E9;
    --petro-green-50: #F1F8F4;
    
    --petro-orange-700: #E67000;
    --petro-orange-600: #F57C00;
    --petro-orange-500: #FF9800;
    --petro-orange-100: #FFE0B2;
    
    --petro-gold-600: #C9A961;
    --petro-gold-500: #D4B97A;
    
    --neutral-900: #1A1A1A;
    --neutral-800: #2C2C2C;
    --neutral-700: #404040;
    --neutral-600: #525252;
    --neutral-500: #737373;
    --neutral-400: #A3A3A3;
    --neutral-300: #D4D4D4;
    --neutral-200: #E5E5E5;
    --neutral-100: #F5F5F5;
    --neutral-50: #FAFAFA;
    
    --blue-600: #2563EB;
    --blue-100: #DBEAFE;
    
    --red-600: #DC2626;
    --red-100: #FEE2E2;
    
    --yellow-600: #CA8A04;
    --yellow-100: #FEF3C7;
    
    --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
    --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
}

body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    background: var(--neutral-50);
    color: var(--neutral-900);
    line-height: 1.6;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
}

h1, h2, h3, h4, h5, h6 {
    font-weight: 700;
    line-height: 1.2;
    letter-spacing: -0.02em;
}

.container { 
    max-width: 1400px; 
    margin: 0 auto; 
    padding: 0 32px; 
}

/* Header */
header {
    background: white;
    border-bottom: 1px solid var(--neutral-200);
    box-shadow: var(--shadow-sm);
    position: sticky;
    top: 0;
    z-index: 100;
    backdrop-filter: blur(8px);
    background: rgba(255, 255, 255, 0.95);
}

.header-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
    height: 72px;
    padding: 0 32px;
}

.logo-section {
    display: flex;
    align-items: center;
    gap: 16px;
    cursor: pointer;
}

.logo {
    width: 44px;
    height: 44px;
    background: linear-gradient(135deg, var(--petro-green-800), var(--petro-green-900));
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 800;
    font-size: 20px;
    box-shadow: var(--shadow-md);
}

.logo-text h1 { 
    font-size: 18px; 
    color: var(--petro-green-800); 
    font-weight: 800;
    letter-spacing: -0.03em;
}
.logo-text p { 
    font-size: 12px; 
    color: var(--neutral-500); 
    font-weight: 500;
    margin-top: 2px;
}

nav { display: flex; gap: 4px; }

.nav-link {
    padding: 8px 16px;
    border-radius: 8px;
    font-weight: 600;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.2s ease;
    color: var(--neutral-600);
}

.nav-link:hover { 
    background: var(--neutral-100); 
    color: var(--neutral-900);
}
.nav-link.active { 
    background: var(--petro-green-800); 
    color: white; 
}

.user-info { 
    display: flex; 
    align-items: center; 
    gap: 16px; 
}

.user-badge { 
    padding: 10px 16px; 
    background: var(--neutral-100); 
    border-radius: 10px; 
    font-size: 13px; 
    font-weight: 600;
    border: 1px solid var(--neutral-200);
}

/* Buttons */
.btn {
    padding: 10px 20px;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.2s ease;
    font-family: 'Inter', sans-serif;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    justify-content: center;
}

.btn-primary { 
    background: var(--petro-green-800); 
    color: white; 
    box-shadow: var(--shadow-sm);
}
.btn-primary:hover { 
    background: var(--petro-green-900); 
    box-shadow: var(--shadow-md);
    transform: translateY(-1px);
}

.btn-secondary { 
    background: white; 
    color: var(--neutral-700); 
    border: 1px solid var(--neutral-300);
    box-shadow: var(--shadow-sm);
}
.btn-secondary:hover { 
    background: var(--neutral-50); 
    border-color: var(--neutral-400);
}

.btn-gold {
    background: linear-gradient(135deg, var(--petro-gold-600), var(--petro-gold-500));
    color: white;
    box-shadow: 0 4px 12px rgba(201, 169, 97, 0.25);
}
.btn-gold:hover { 
    transform: translateY(-1px); 
    box-shadow: 0 6px 16px rgba(201, 169, 97, 0.35);
}

.btn-orange { 
    background: var(--petro-orange-600); 
    color: white;
    box-shadow: var(--shadow-sm);
}
.btn-orange:hover { 
    background: var(--petro-orange-700);
    transform: translateY(-1px);
}

.btn-sm { padding: 6px 14px; font-size: 13px; }
.btn-lg { padding: 14px 28px; font-size: 16px; }
.btn-block { width: 100%; }
.btn:disabled { 
    opacity: 0.5; 
    cursor: not-allowed; 
}

/* Cards */
.card {
    background: white;
    border-radius: 12px;
    padding: 24px;
    box-shadow: var(--shadow-sm);
    border: 1px solid var(--neutral-200);
    margin-bottom: 24px;
    transition: all 0.2s ease;
}

.card:hover {
    box-shadow: var(--shadow-md);
}

.stat-card {
    background: white;
    border-radius: 12px;
    padding: 24px;
    box-shadow: var(--shadow-sm);
    border: 1px solid var(--neutral-200);
    transition: all 0.2s ease;
}

.stat-card:hover {
    box-shadow: var(--shadow-lg);
    transform: translateY(-2px);
}

.stat-card-header {
    font-size: 12px;
    font-weight: 700;
    color: var(--neutral-600);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: 12px;
}

.stat-card-value {
    font-size: 40px;
    font-weight: 800;
    line-height: 1;
    margin-bottom: 8px;
    letter-spacing: -0.02em;
}

.stat-card-footer {
    font-size: 13px;
    color: var(--neutral-500);
    font-weight: 500;
}

/* Status Badges */
.badge {
    padding: 4px 10px;
    border-radius: 6px;
    font-size: 11px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.03em;
    display: inline-flex;
    align-items: center;
    gap: 6px;
}

.badge-green { background: var(--petro-green-100); color: var(--petro-green-800); }
.badge-orange { background: var(--petro-orange-100); color: var(--petro-orange-700); }
.badge-yellow { background: var(--yellow-100); color: var(--yellow-600); }
.badge-red { background: var(--red-100); color: var(--red-600); }
.badge-blue { background: var(--blue-100); color: var(--blue-600); }
.badge-gray { background: var(--neutral-100); color: var(--neutral-600); }

/* Rank Badge */
.rank-badge {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 36px;
    height: 36px;
    border-radius: 8px;
    font-weight: 800;
    font-size: 16px;
}

.rank-1 { 
    background: linear-gradient(135deg, #FFD700, #FFA500); 
    color: white; 
    box-shadow: 0 4px 12px rgba(255, 215, 0, 0.3); 
}
.rank-2 { 
    background: linear-gradient(135deg, #C0C0C0, #A8A8A8); 
    color: white; 
    box-shadow: 0 4px 12px rgba(192, 192, 192, 0.3); 
}
.rank-3 { 
    background: linear-gradient(135deg, #CD7F32, #B87333); 
    color: white; 
    box-shadow: 0 4px 12px rgba(205, 127, 50, 0.3); 
}
.rank-default { 
    background: var(--petro-green-800); 
    color: white; 
}

/* Progress Bar */
.progress-bar {
    width: 100%;
    height: 8px;
    background: var(--neutral-200);
    border-radius: 4px;
    overflow: hidden;
}

.progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--petro-green-700), var(--petro-green-600));
    transition: width 0.5s ease;
    border-radius: 4px;
}

/* Alert */
.alert {
    padding: 16px 20px;
    border-radius: 10px;
    margin-bottom: 24px;
    display: flex;
    align-items: start;
    gap: 12px;
    font-size: 14px;
    border: 1px solid;
}

.alert-success { 
    background: var(--petro-green-50); 
    border-color: var(--petro-green-600); 
    color: var(--petro-green-900); 
}
.alert-danger { 
    background: var(--red-100); 
    border-color: var(--red-600); 
    color: var(--neutral-900); 
}
.alert-info { 
    background: var(--blue-100); 
    border-color: var(--blue-600); 
    color: var(--neutral-900); 
}

/* Modal */
.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.6);
    z-index: 1000;
    align-items: center;
    justify-content: center;
    padding: 20px;
    overflow-y: auto;
    backdrop-filter: blur(4px);
}

.modal.active { display: flex; }

.modal-content {
    background: white;
    border-radius: 16px;
    max-width: 1100px;
    width: 100%;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: var(--shadow-xl);
}

.modal-header {
    padding: 24px 28px;
    border-bottom: 1px solid var(--neutral-200);
    display: flex;
    justify-content: space-between;
    align-items: center;
    position: sticky;
    top: 0;
    background: white;
    z-index: 10;
}

.modal-header h2 { 
    color: var(--petro-green-800); 
    font-size: 22px; 
    font-weight: 800;
}

.modal-close {
    width: 36px;
    height: 36px;
    border: none;
    background: var(--neutral-100);
    border-radius: 8px;
    cursor: pointer;
    font-size: 20px;
    font-weight: 600;
    color: var(--neutral-600);
    transition: all 0.2s;
}

.modal-close:hover {
    background: var(--neutral-200);
    color: var(--neutral-900);
}

.modal-body { padding: 28px; }
.modal-footer { 
    padding: 20px 28px; 
    border-top: 1px solid var(--neutral-200); 
    display: flex; 
    gap: 12px; 
    justify-content: flex-end;
    position: sticky;
    bottom: 0;
    background: white;
}

/* Form */
.form-group { margin-bottom: 20px; }
.form-label { 
    display: block; 
    font-weight: 600; 
    margin-bottom: 8px; 
    font-size: 14px;
    color: var(--neutral-800);
}
.form-label.required::after { 
    content: '*'; 
    color: var(--red-600); 
    margin-left: 4px; 
}

.form-control {
    width: 100%;
    padding: 11px 14px;
    border: 1px solid var(--neutral-300);
    border-radius: 8px;
    font-family: 'Inter', sans-serif;
    font-size: 14px;
    transition: all 0.2s;
    background: white;
}

.form-control:focus { 
    outline: none; 
    border-color: var(--petro-green-600);
    box-shadow: 0 0 0 3px var(--petro-green-100);
}

/* Tables */
.data-table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    background: white;
    border-radius: 12px;
    overflow: hidden;
    border: 1px solid var(--neutral-200);
}

.data-table thead { 
    background: var(--neutral-50); 
}
.data-table th { 
    padding: 14px 16px; 
    text-align: left; 
    font-weight: 700; 
    font-size: 12px; 
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--neutral-700);
    border-bottom: 1px solid var(--neutral-200);
}
.data-table td { 
    padding: 16px; 
    border-bottom: 1px solid var(--neutral-100);
    font-size: 14px;
}
.data-table tbody tr { 
    cursor: pointer; 
    transition: background 0.15s; 
}
.data-table tbody tr:hover { 
    background: var(--neutral-50); 
}
.data-table tbody tr:last-child td {
    border-bottom: none;
}

/* Agent Panel */
.agent-panel {
    background: linear-gradient(135deg, #EFF6FF, #DBEAFE);
    border-left: 3px solid var(--blue-600);
    padding: 20px;
    border-radius: 10px;
    margin: 16px 0;
    border: 1px solid #BFDBFE;
}

/* Wizard */
.wizard-steps {
    display: flex;
    justify-content: space-between;
    margin-bottom: 32px;
    position: relative;
    padding: 0 40px;
}

.wizard-step {
    display: flex;
    flex-direction: column;
    align-items: center;
    flex: 1;
    position: relative;
    z-index: 1;
}

.wizard-step-circle {
    width: 44px;
    height: 44px;
    border-radius: 10px;
    background: white;
    border: 2px solid var(--neutral-300);
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 800;
    margin-bottom: 10px;
    transition: all 0.2s;
}

.wizard-step.active .wizard-step-circle { 
    background: var(--petro-green-800); 
    border-color: var(--petro-green-800); 
    color: white;
    box-shadow: 0 0 0 4px var(--petro-green-100);
}
.wizard-step.completed .wizard-step-circle { 
    background: var(--petro-gold-600); 
    border-color: var(--petro-gold-600); 
    color: white; 
}

.wizard-step-label {
    font-size: 13px;
    font-weight: 600;
    text-align: center;
    color: var(--neutral-600);
}

.wizard-step.active .wizard-step-label {
    color: var(--petro-green-800);
}

/* Section Header */
.section-header {
    background: linear-gradient(135deg, var(--petro-green-800), var(--petro-green-700));
    color: white;
    padding: 14px 20px;
    margin: 28px 0 20px 0;
    font-weight: 700;
    font-size: 15px;
    border-left: 4px solid var(--petro-orange-600);
    border-radius: 8px;
    box-shadow: var(--shadow-sm);
}

/* Portfolio Matrix */
.matrix-container {
    position: relative;
    background: linear-gradient(to bottom right, var(--neutral-50), white);
    padding: 60px;
    border-radius: 12px;
    border: 1px solid var(--neutral-200);
    min-height: 450px;
}

.matrix-dot {
    position: absolute;
    width: 16px;
    height: 16px;
    background: var(--petro-green-700);
    border-radius: 50%;
    border: 3px solid white;
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    cursor: pointer;
    transition: all 0.2s;
}

.matrix-dot:hover {
    transform: scale(1.3);
    box-shadow: 0 4px 12px rgba(0,0,0,0.25);
}

/* Grid */
.grid { display: grid; gap: 24px; }
.grid-2 { grid-template-columns: repeat(2, 1fr); }
.grid-3 { grid-template-columns: repeat(3, 1fr); }
.grid-4 { grid-template-columns: repeat(4, 1fr); }

@media (max-width: 1024px) {
    .grid-4 { grid-template-columns: repeat(2, 1fr); }
    .grid-3 { grid-template-columns: repeat(2, 1fr); }
}

@media (max-width: 640px) {
    .grid-4, .grid-3, .grid-2 { grid-template-columns: 1fr; }
}

/* Utilities */
.hidden { display: none !important; }
.mb-2 { margin-bottom: 8px; }
.mb-4 { margin-bottom: 16px; }
.mb-6 { margin-bottom: 24px; }
.mt-4 { margin-top: 16px; }
.text-center { text-align: center; }

footer {
    background: var(--neutral-900);
    color: white;
    padding: 32px;
    margin-top: 80px;
}

footer a {
    color: var(--petro-green-600);
    text-decoration: none;
}

/* Gantt Chart Styles */
.gantt-wrapper {
    background: white;
    border-radius: 8px;
    padding: 24px;
    box-shadow: var(--shadow-md);
}

.gantt-controls {
    display: flex;
    gap: 16px;
    margin-bottom: 24px;
    flex-wrap: wrap;
    align-items: center;
}

.gantt-control-group {
    display: flex;
    align-items: center;
    gap: 8px;
}

.gantt-control-group label {
    font-size: 14px;
    font-weight: 600;
    color: var(--neutral-700);
}

.gantt-checkbox {
    display: flex;
    align-items: center;
    gap: 6px;
    cursor: pointer;
}

.gantt-checkbox input[type="checkbox"] {
    width: 18px;
    height: 18px;
    cursor: pointer;
}

.gantt-search {
    flex: 1;
    min-width: 250px;
}

.gantt-container {
    overflow-x: auto;
    border: 1px solid var(--neutral-200);
    border-radius: 8px;
}

.gantt-table {
    min-width: 1800px;
    border-collapse: separate;
    border-spacing: 0;
}

.gantt-table thead {
    position: sticky;
    top: 0;
    z-index: 10;
    background: var(--neutral-50);
}

.gantt-table th {
    padding: 12px;
    text-align: left;
    font-size: 13px;
    font-weight: 700;
    color: var(--neutral-700);
    border-bottom: 2px solid var(--neutral-300);
    background: var(--neutral-50);
    white-space: nowrap;
}

.gantt-table tbody tr {
    transition: background-color 0.2s;
}

.gantt-table tbody tr:hover {
    background: var(--petro-green-50);
}

.gantt-table td {
    padding: 12px;
    font-size: 13px;
    border-bottom: 1px solid var(--neutral-200);
    vertical-align: middle;
}

.initiative-id {
    font-family: 'JetBrains Mono', monospace;
    font-weight: 600;
    color: var(--petro-green-800);
    min-width: 100px;
}

.initiative-name {
    min-width: 300px;
    font-weight: 500;
}

.initiative-tier {
    display: inline-block;
    padding: 4px 12px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: 700;
    text-align: center;
    min-width: 60px;
}

.tier-1a {
    background: var(--petro-green-700);
    color: white;
}

.tier-1b {
    background: var(--petro-green-600);
    color: white;
}

.tier-1c {
    background: var(--blue-600);
    color: white;
}

.tier-1d {
    background: var(--petro-orange-600);
    color: white;
}

.tier-contingent {
    background: var(--neutral-400);
    color: white;
}

.initiative-dates {
    min-width: 120px;
    font-size: 12px;
    color: var(--neutral-600);
}

.timeline-cell {
    position: relative;
    min-width: 800px;
    height: 40px;
    padding: 4px;
}

.timeline-grid {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    display: flex;
}

.timeline-month {
    flex: 1;
    border-left: 1px solid var(--neutral-200);
    position: relative;
}

.timeline-month:first-child {
    border-left: none;
}

.timeline-quarter-marker {
    position: absolute;
    top: 0;
    bottom: 0;
    left: 0;
    border-left: 2px solid var(--petro-gold-500);
}

.gantt-bar {
    position: absolute;
    height: 32px;
    border-radius: 4px;
    background: var(--petro-green-600);
    top: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 11px;
    font-weight: 600;
    color: white;
    cursor: pointer;
    transition: all 0.2s;
    box-shadow: var(--shadow-sm);
}

.gantt-bar:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
    z-index: 5;
}

.gantt-bar.tier-1a { background: var(--petro-green-700); }
.gantt-bar.tier-1b { background: var(--petro-green-600); }
.gantt-bar.tier-1c { background: var(--blue-600); }
.gantt-bar.tier-1d { background: var(--petro-orange-600); }
.gantt-bar.tier-contingent { background: var(--neutral-400); }

.gantt-bar.critical-path {
    border: 2px solid var(--red-600);
    box-shadow: 0 0 0 2px rgba(220, 38, 38, 0.2);
}

.gantt-bar.has-dependencies::after {
    content: '⚡';
    position: absolute;
    right: -8px;
    top: -8px;
    background: var(--yellow-600);
    width: 20px;
    height: 20px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 10px;
    border: 2px solid white;
}

.gantt-tooltip {
    position: absolute;
    background: var(--neutral-900);
    color: white;
    padding: 12px;
    border-radius: 6px;
    font-size: 12px;
    pointer-events: none;
    z-index: 1000;
    box-shadow: var(--shadow-xl);
    max-width: 300px;
    display: none;
}

.gantt-tooltip.visible {
    display: block;
}

.gantt-tooltip-title {
    font-weight: 700;
    margin-bottom: 8px;
    color: var(--petro-gold-500);
}

.gantt-tooltip-detail {
    margin: 4px 0;
    font-size: 11px;
}

.timeline-header {
    background: white;
    border-bottom: 2px solid var(--neutral-300);
    padding: 16px 0;
    margin-bottom: 16px;
}

.timeline-months {
    display: flex;
    gap: 0;
}

.timeline-month-header {
    flex: 1;
    text-align: center;
    font-size: 12px;
    font-weight: 600;
    color: var(--neutral-700);
    padding: 8px 4px;
    border-left: 1px solid var(--neutral-200);
}

.timeline-month-header:first-child {
    border-left: none;
}

.timeline-quarter {
    background: var(--petro-gold-100);
    color: var(--neutral-900);
    font-weight: 700;
}

.gantt-stats {
    display: flex;
    gap: 16px;
    margin-bottom: 24px;
}

.gantt-stat {
    background: var(--neutral-50);
    padding: 16px;
    border-radius: 8px;
    flex: 1;
    border-left: 4px solid var(--petro-green-600);
}

.gantt-stat-label {
    font-size: 12px;
    color: var(--neutral-600);
    margin-bottom: 4px;
}

.gantt-stat-value {
    font-size: 24px;
    font-weight: 700;
    color: var(--neutral-900);
}

.filter-badge {
    display: inline-block;
    padding: 4px 8px;
    background: var(--petro-green-100);
    color: var(--petro-green-800);
    border-radius: 4px;
    font-size: 12px;
    font-weight: 600;
    margin-left: 8px;
}

/* Status Indicators */
.status-badge {
    display: inline-block;
    padding: 3px 10px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.03em;
}

.status-not-started {
    background: var(--neutral-200);
    color: var(--neutral-700);
}

.status-in-progress {
    background: var(--blue-100);
    color: var(--blue-600);
}

.status-at-risk {
    background: var(--red-100);
    color: var(--red-600);
}

.status-completed {
    background: var(--petro-green-100);
    color: var(--petro-green-700);
}

/* Progress Bar */
.progress-container {
    width: 80px;
    height: 8px;
    background: var(--neutral-200);
    border-radius: 4px;
    overflow: hidden;
}

.progress-bar {
    height: 100%;
    background: var(--petro-green-600);
    transition: width 0.3s ease;
    border-radius: 4px;
}

.progress-bar.at-risk {
    background: var(--red-600);
}

.progress-bar.completed {
    background: var(--petro-green-700);
}

/* Tier Grouping */
.tier-group-header {
    background: var(--neutral-100);
    font-weight: 700;
    cursor: pointer;
    transition: background 0.2s;
    position: sticky;
    top: 0;
    z-index: 5;
}

.tier-group-header:hover {
    background: var(--neutral-200);
}

.tier-group-header td {
    padding: 16px 12px !important;
    border-bottom: 2px solid var(--neutral-300) !important;
}

.tier-group-collapsed {
    display: none;
}

.tier-chevron {
    display: inline-block;
    margin-right: 8px;
    transition: transform 0.2s;
    font-weight: 700;
}

.tier-chevron.collapsed {
    transform: rotate(-90deg);
}

/* Today Marker */
.today-marker {
    position: absolute;
    top: 0;
    bottom: 0;
    width: 2px;
    background: var(--red-600);
    z-index: 4;
    pointer-events: none;
}

.today-marker::before {
    content: 'TODAY';
    position: absolute;
    top: -20px;
    left: -18px;
    background: var(--red-600);
    color: white;
    padding: 2px 6px;
    font-size: 9px;
    font-weight: 700;
    border-radius: 3px;
    white-space: nowrap;
}

/* View Mode Toggle */
.view-toggle {
    display: flex;
    gap: 0;
    border: 1px solid var(--neutral-300);
    border-radius: 6px;
    overflow: hidden;
}

.view-toggle-btn {
    padding: 6px 16px;
    background: white;
    border: none;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    color: var(--neutral-700);
}

.view-toggle-btn:hover {
    background: var(--neutral-100);
}

.view-toggle-btn.active {
    background: var(--petro-green-600);
    color: white;
}

/* Improved Spacing */
.gantt-table tbody tr {
    border-left: 3px solid transparent;
}

.gantt-table tbody tr:hover {
    background: var(--petro-green-50);
    border-left-color: var(--petro-green-600);
}

.gantt-table tbody tr.at-risk-row {
    background: rgba(220, 38, 38, 0.03);
}

.gantt-table tbody tr.at-risk-row:hover {
    background: rgba(220, 38, 38, 0.08);
    border-left-color: var(--red-600);
}
`;

// ============================================================================
// PETROLUBE 35-CRITERIA TEMPLATE
// ============================================================================

// PETROLUBE 35-CRITERIA FRAMEWORK V14
// Complete input-to-prioritization flow

const PETROLUBE_35_TEMPLATE = {
    id: 'template-petrolube-35-v14',
    name: 'Petrolube Initiative Dossier - 35 Criteria Framework V14',
    version: '1.0',
    is_published: true,
    created_at: '2025-01-11T00:00:00Z',
    description: 'Complete flow: 35 criteria → 6 dimensions → composite score → tier → rank',

    // Scoring configuration
    scoringConfig: {
        dimensions: ['D1', 'D2', 'D3', 'D4', 'D5', 'D6'],
        scenarios: {
            A: { d1: 0.25, d2: 0.25, d3: 0.15, d4: 0.15, d5: 0.10, d6: 0.10 },
            B: { d1: 0.30, d2: 0.20, d3: 0.15, d4: 0.15, d5: 0.10, d6: 0.10 },
            C: { d1: 0.20, d2: 0.30, d3: 0.15, d4: 0.15, d5: 0.10, d6: 0.10 }
        },
        quadrantModifiers: {
            quick_win: 0.95,
            push_harder: 0.90,
            transformational: 1.00,
            moonshot: 0.85
        }
    },

    fields: [
        // =====================================================================
        // SECTION 1: METADATA (CRITERIA 1-5)
        // =====================================================================
        {
            id: '1',
            key: 'initiative_id',
            label: '1. Initiative ID',
            description: 'Unique identifier: PET (core), NEW (new), REB (rebranding), ECO (ecosystem), HCM (HR)',
            type: 'text',
            required: true,
            is_scoring: false,
            weight: 0,
            category: 'metadata',
            config: {
                maxLength: 10,
                placeholder: 'PET-006',
                pattern: '^[A-Z]{3}-[A-Z0-9]{1,6}$'
            }
        },
        {
            id: '2',
            key: 'initiative_name',
            label: '2. Initiative Name',
            description: 'Descriptive title (max 200 chars)',
            type: 'text',
            required: true,
            is_scoring: false,
            weight: 0,
            category: 'metadata',
            config: {
                maxLength: 200,
                placeholder: 'AI Demand Forecasting System'
            }
        },
        {
            id: '3',
            key: 'owner_name',
            label: '3. Owner',
            description: 'Initiative owner responsible for delivery',
            type: 'dropdown',
            required: true,
            is_scoring: false,
            weight: 0,
            category: 'metadata',
            config: {
                options: [
                    { value: 'ceo', label: 'CEO: Salman Saadat' },
                    { value: 'cfo', label: 'CFO: John Sliedregt' },
                    { value: 'cito', label: 'CITO: Ghadah Al-Dabbagh' },
                    { value: 'cmo', label: 'Marketing Director: Mian M. Usman' },
                    { value: 'chro', label: 'CHRO' },
                    { value: 'pmo', label: 'PMO Director' }
                ]
            }
        },
        {
            id: '4',
            key: 'strategic_domain',
            label: '4. Strategic Domain',
            description: 'Primary strategic area aligned with Vision 2030',
            type: 'dropdown',
            required: true,
            is_scoring: false,
            weight: 0,
            category: 'metadata',
            config: {
                options: [
                    { value: 'core_operations', label: 'Core Operations' },
                    { value: 'business_model', label: 'Business Model Innovation' },
                    { value: 'customer_experience', label: 'Customer Experience' },
                    { value: 'technology_data', label: 'Technology & Data' },
                    { value: 'ecosystem', label: 'Ecosystem & Partnerships' },
                    { value: 'organizational', label: 'Organizational Transformation' }
                ]
            }
        },
        {
            id: '5',
            key: 'portfolio_category',
            label: '5. Portfolio Category',
            description: '60-15-15-10 allocation framework',
            type: 'dropdown',
            required: true,
            is_scoring: false,
            weight: 0,
            category: 'metadata',
            config: {
                options: [
                    { value: 'core_incremental', label: 'Core Incremental (60%)' },
                    { value: 'core_disruptive', label: 'Core Disruptive (15%)' },
                    { value: 'non_core_incremental', label: 'Non-Core Incremental (15%)' },
                    { value: 'non_core_disruptive', label: 'Non-Core Disruptive (10%)' }
                ]
            }
        },

        // =====================================================================
        // SECTION 2: STRATEGIC POSITIONING (CRITERIA 6-10)
        // =====================================================================
        {
            id: '6',
            key: 'quadrant',
            label: '6. Quadrant (Auto-calculated from D1/D2)',
            description: 'Impact vs Feasibility Matrix position',
            type: 'dropdown',
            required: false,
            is_scoring: false,
            weight: 0,
            category: 'strategic',
            auto_calculated: true,
            config: {
                options: [
                    { value: 'quick_win', label: 'Quick-Win (D1≥75, D2≥80)' },
                    { value: 'push_harder', label: 'Push-Harder (D1<75, D2≥80)' },
                    { value: 'transformational', label: 'Transformational (D1≥75, D2<80)' },
                    { value: 'moonshot', label: 'Moonshot (D1<75, D2<80)' }
                ]
            }
        },
        {
            id: '7',
            key: 'priority',
            label: '7. Priority',
            description: 'Executive priority classification',
            type: 'dropdown',
            required: true,
            is_scoring: false,
            weight: 0,
            category: 'strategic',
            config: {
                options: [
                    { value: 'critical', label: 'Critical (CEO mandate)' },
                    { value: 'high', label: 'High' },
                    { value: 'medium', label: 'Medium' },
                    { value: 'low', label: 'Low' }
                ]
            }
        },
        {
            id: '8',
            key: 'tier',
            label: '8. Year 1 Tier',
            description: 'Tier assignment (system suggests based on scores)',
            type: 'dropdown',
            required: true,
            is_scoring: false,
            weight: 0,
            category: 'strategic',
            config: {
                options: [
                    { value: '1a', label: 'Tier 1A: Catastrophic Dependency' },
                    { value: '1b', label: 'Tier 1B: Quick-Win' },
                    { value: '1c', label: 'Tier 1C: Foundation' },
                    { value: '1d', label: 'Tier 1D: Strategic' },
                    { value: '2', label: 'Tier 2: Positioning' },
                    { value: 'contingent', label: 'Contingent' }
                ]
            }
        },
        {
            id: '9',
            key: 'aramco_response',
            label: '9. Aramco Competitive Response',
            description: 'How does this respond to Aramco-Valvoline threat? (feeds D4 scoring)',
            type: 'textarea',
            required: true,
            is_scoring: false,
            weight: 0,
            category: 'strategic',
            config: {
                maxLength: 500,
                placeholder: 'Describe defensive and offensive competitive value...'
            }
        },
        {
            id: '10',
            key: 'bcg_i2i_dimensions',
            label: '10. BCG i2i Impact',
            description: 'Select dimensions and expected gain (+points)',
            type: 'multiselect',
            required: true,
            is_scoring: false,
            weight: 0,
            category: 'strategic',
            config: {
                options: [
                    { value: 'd1', label: 'D1: Innovation Strategy' },
                    { value: 'd2', label: 'D2: Organization & Decision Making' },
                    { value: 'd3', label: 'D3: Governance & Metrics' },
                    { value: 'd4', label: 'D4: Customer & Market Intelligence' },
                    { value: 'd5', label: 'D5: Portfolio & Performance Mgmt' },
                    { value: 'd6', label: 'D6: Talent & Culture' },
                    { value: 'd7', label: 'D7: Analytics & Insights' },
                    { value: 'd8', label: 'D8: Digital Technology' },
                    { value: 'd9', label: 'D9: Ecosystems & Partnerships' },
                    { value: 'd10', label: 'D10: Results Measurement' }
                ],
                gains: [1, 2, 3, 4, 5, 6]
            }
        },

        // =====================================================================
        // SECTION 3: DIMENSION SCORES (CRITERIA 11-16) - AUTO-CALCULATED
        // =====================================================================
        {
            id: '11',
            key: 'd1_score',
            label: '11. D1: Strategic Impact (Auto-calc)',
            description: 'Calculated from NPV (60%) + Qualitative assessment (40%)',
            type: 'number',
            required: false,
            is_scoring: true,
            weight: 25,
            category: 'scoring',
            auto_calculated: true,
            config: { min: 0, max: 100, step: 1, unit: 'points', readonly: true }
        },
        {
            id: '12',
            key: 'd2_score',
            label: '12. D2: Execution Feasibility (Auto-calc)',
            description: 'Calculated from TRL (30%) + Resources (25%) + Timeline (25%) + Dependencies (20%)',
            type: 'number',
            required: false,
            is_scoring: true,
            weight: 25,
            category: 'scoring',
            auto_calculated: true,
            config: { min: 0, max: 100, step: 1, unit: 'points', readonly: true }
        },
        {
            id: '13',
            key: 'd3_score',
            label: '13. D3: BCG i2i Advancement (Auto-calc)',
            description: 'Calculated from selected dimensions × expected gains',
            type: 'number',
            required: false,
            is_scoring: true,
            weight: 20,
            category: 'scoring',
            auto_calculated: true,
            config: { min: 0, max: 100, step: 1, unit: 'points', readonly: true }
        },
        {
            id: '14',
            key: 'd4_score',
            label: '14. D4: Aramco Response (AI-suggested)',
            description: 'AI analyzes competitive response text, human validates',
            type: 'number',
            required: false,
            is_scoring: true,
            weight: 15,
            category: 'scoring',
            ai_suggested: true,
            config: { min: 0, max: 100, step: 1, unit: 'points' }
        },
        {
            id: '15',
            key: 'd5_score',
            label: '15. D5: MiRA Integration (Auto-calc)',
            description: 'Calculated from MiRA layer + integration depth',
            type: 'number',
            required: false,
            is_scoring: true,
            weight: 10,
            category: 'scoring',
            auto_calculated: true,
            config: { min: 0, max: 100, step: 1, unit: 'points', readonly: true }
        },
        {
            id: '16',
            key: 'd6_score',
            label: '16. D6: Three Engines Alignment (Auto-calc)',
            description: 'Calculated from engine contribution + portfolio balance + coherence',
            type: 'number',
            required: false,
            is_scoring: true,
            weight: 10,
            category: 'scoring',
            auto_calculated: true,
            config: { min: 0, max: 100, step: 1, unit: 'points', readonly: true }
        },

        // =====================================================================
        // SECTION 4: BUSINESS CASE (CRITERIA 17-23)
        // =====================================================================
        {
            id: '17',
            key: 'problem_statement',
            label: '17. Problem Statement',
            description: 'Clear description of current state pain (feeds D1)',
            type: 'textarea',
            required: true,
            is_scoring: false,
            weight: 0,
            category: 'business_case',
            config: {
                maxLength: 1000,
                placeholder: 'Describe the problem, quantify the pain...'
            }
        },
        {
            id: '18',
            key: 'solution_description',
            label: '18. Solution Description',
            description: 'How the solution works (feeds D2)',
            type: 'textarea',
            required: true,
            is_scoring: false,
            weight: 0,
            category: 'business_case',
            config: {
                maxLength: 1500,
                placeholder: 'Explain the solution approach and methodology...'
            }
        },
        {
            id: '19',
            key: 'financial_projections',
            label: '19. Financial Projections',
            description: 'Year-by-year cash flows (feeds D1 quantitative)',
            type: 'financial_table',
            required: true,
            is_scoring: false,
            weight: 0,
            category: 'business_case',
            config: {
                years: [0, 1, 2, 3, 4, 5],
                calculate_npv: true,
                wacc: 0.12
            }
        },
        {
            id: '20',
            key: 'roi_analysis',
            label: '20. ROI Analysis',
            description: 'Benefit breakdown by category',
            type: 'benefit_table',
            required: true,
            is_scoring: false,
            weight: 0,
            category: 'business_case',
            config: {
                maxCategories: 5
            }
        },
        {
            id: '21',
            key: 'stakeholder_impact',
            label: '21. Stakeholder Impact',
            description: 'Impact by stakeholder group (feeds D1 qualitative)',
            type: 'text',
            required: true,
            is_scoring: false,
            weight: 0,
            category: 'business_case',
            config: {
                maxLength: 600,
                placeholder: 'CEO impact, CFO impact, Customer impact, Employee impact...'
            }
        },
        {
            id: '22',
            key: 'competitive_analysis',
            label: '22. Competitive Analysis',
            description: 'Competitive positioning (feeds D4)',
            type: 'textarea',
            required: true,
            is_scoring: false,
            weight: 0,
            category: 'business_case',
            config: {
                maxLength: 800,
                placeholder: 'What competitors lack, our advantage, time to replicate...'
            }
        },
        {
            id: '23',
            key: 'strategic_rationale',
            label: '23. Strategic Rationale',
            description: 'Why now, why important (feeds D6)',
            type: 'textarea',
            required: true,
            is_scoring: false,
            weight: 0,
            category: 'business_case',
            config: {
                maxLength: 600,
                placeholder: 'Why strategically important, why now, what if we don\'t...'
            }
        },

        // =====================================================================
        // SECTION 5: IMPLEMENTATION (CRITERIA 24-27)
        // =====================================================================
        {
            id: '24',
            key: 'trl_level',
            label: '24. Technology Readiness Level (TRL)',
            description: 'TRL 1-9 (feeds D2 - 30% weight)',
            type: 'dropdown',
            required: true,
            is_scoring: false,
            weight: 0,
            category: 'implementation',
            config: {
                options: [
                    { value: 9, label: 'TRL 9: Proven in operational environment', score: 95 },
                    { value: 8, label: 'TRL 8: System complete and qualified', score: 90 },
                    { value: 7, label: 'TRL 7: System prototype in operation', score: 85 },
                    { value: 6, label: 'TRL 6: System model in relevant environment', score: 80 },
                    { value: 5, label: 'TRL 5: Component validation', score: 75 },
                    { value: 4, label: 'TRL 4: Component validation in lab', score: 65 },
                    { value: 3, label: 'TRL 3: Proof of concept', score: 60 },
                    { value: 2, label: 'TRL 2: Technology concept formulated', score: 55 },
                    { value: 1, label: 'TRL 1: Basic principles observed', score: 50 }
                ]
            }
        },
        {
            id: '25',
            key: 'resource_availability',
            label: '25. Resource Availability',
            description: 'Team, budget, sponsor, skills (feeds D2 - 25% weight)',
            type: 'checklist',
            required: true,
            is_scoring: false,
            weight: 0,
            category: 'implementation',
            config: {
                options: [
                    { value: 'team', label: 'Team assigned' },
                    { value: 'budget', label: 'Budget confirmed' },
                    { value: 'sponsor', label: 'Executive sponsor identified' },
                    { value: 'skills', label: 'Required skills available' }
                ]
            }
        },
        {
            id: '26',
            key: 'timeline',
            label: '26. Timeline',
            description: 'Start date, end date, confidence (feeds D2 - 25% weight)',
            type: 'timeline',
            required: true,
            is_scoring: false,
            weight: 0,
            category: 'implementation',
            config: {
                fields: ['start_date', 'end_date', 'confidence']
            }
        },
        {
            id: '27',
            key: 'mira_integration',
            label: '27. MiRA Integration',
            description: 'MiRA layer and integration depth (feeds D5)',
            type: 'mira_config',
            required: true,
            is_scoring: false,
            weight: 0,
            category: 'implementation',
            config: {
                layers: [
                    { value: 0, label: 'No MiRA use', score: 0 },
                    { value: 1, label: 'Layer 1: Basic reporting', score: 30 },
                    { value: 2, label: 'Layer 2: Data lake/analytics', score: 50 },
                    { value: 3, label: 'Layer 3: ML/AI models', score: 70 },
                    { value: 4, label: 'Layer 4: API/ecosystem monetization', score: 90 }
                ],
                depth: ['low', 'medium', 'high']
            }
        },

        // =====================================================================
        // SECTION 6: DEPENDENCIES (CRITERIA 28-30)
        // =====================================================================
        {
            id: '28',
            key: 'prerequisites',
            label: '28. Prerequisites',
            description: 'Critical dependencies that must complete first (feeds D2 - 20% weight)',
            type: 'dependency_list',
            required: true,
            is_scoring: false,
            weight: 0,
            category: 'dependencies',
            config: {
                fields: ['type', 'name', 'criticality', 'due_date', 'status']
            }
        },
        {
            id: '29',
            key: 'enablers',
            label: '29. Enablers',
            description: 'Capabilities that enable this initiative',
            type: 'enabler_list',
            required: true,
            is_scoring: false,
            weight: 0,
            category: 'dependencies',
            config: {
                types: ['Technology', 'Data', 'Process', 'Capability']
            }
        },
        {
            id: '30',
            key: 'integration_points',
            label: '30. Integration Points',
            description: 'Systems/platforms requiring integration',
            type: 'integration_list',
            required: true,
            is_scoring: false,
            weight: 0,
            category: 'dependencies',
            config: {
                systems: ['Oracle', 'MiRA', 'SAP', 'Custom']
            }
        },

        // =====================================================================
        // SECTION 7: RAID (CRITERIA 31-34)
        // =====================================================================
        {
            id: '31',
            key: 'risks',
            label: '31. Risks',
            description: 'Risk register with 5×5 matrix (impacts D2)',
            type: 'risk_matrix',
            required: true,
            is_scoring: false,
            weight: 0,
            category: 'raid',
            config: {
                minRisks: 3,
                probability: ['Very Low', 'Low', 'Medium', 'High', 'Very High'],
                impact: ['Negligible', 'Low', 'Medium', 'High', 'Catastrophic']
            }
        },
        {
            id: '32',
            key: 'assumptions',
            label: '32. Assumptions',
            description: 'Key assumptions requiring validation (impacts D2)',
            type: 'assumption_list',
            required: true,
            is_scoring: false,
            weight: 0,
            category: 'raid',
            config: {
                minAssumptions: 3,
                categories: ['Market', 'Technology', 'Resource', 'Financial', 'Regulatory']
            }
        },
        {
            id: '33',
            key: 'issues',
            label: '33. Issues',
            description: 'Current blockers requiring resolution',
            type: 'issue_list',
            required: false,
            is_scoring: false,
            weight: 0,
            category: 'raid',
            config: {
                severity: ['Critical', 'High', 'Medium', 'Low']
            }
        },
        {
            id: '34',
            key: 'dependency_count',
            label: '34. Total Critical Dependencies',
            description: 'Count of critical dependencies (auto-calc from #28)',
            type: 'number',
            required: false,
            is_scoring: false,
            weight: 0,
            category: 'raid',
            auto_calculated: true,
            config: { readonly: true }
        },

        // =====================================================================
        // SECTION 8: METRICS (CRITERIA 35-37)
        // =====================================================================
        {
            id: '35',
            key: 'success_criteria',
            label: '35. Success Criteria',
            description: 'SMART measurable success definitions (min 3)',
            type: 'criteria_list',
            required: true,
            is_scoring: false,
            weight: 0,
            category: 'metrics',
            config: {
                minCriteria: 3,
                fields: ['metric', 'baseline', 'target', 'timeframe', 'method']
            }
        },
        {
            id: '36',
            key: 'kpis',
            label: '36. KPIs',
            description: 'Key Performance Indicators with thresholds (min 3)',
            type: 'kpi_list',
            required: true,
            is_scoring: false,
            weight: 0,
            category: 'metrics',
            config: {
                minKPIs: 3,
                categories: ['Financial', 'Operational', 'Customer', 'Employee', 'Strategic'],
                frequency: ['Daily', 'Weekly', 'Monthly', 'Quarterly']
            }
        },
        {
            id: '37',
            key: 'governance',
            label: '37. Governance',
            description: 'Reporting structure and review cadence',
            type: 'governance_config',
            required: true,
            is_scoring: false,
            weight: 0,
            category: 'metrics',
            config: {
                sponsors: ['CEO', 'CFO', 'CITO', 'Other'],
                reporting: ['Daily', 'Weekly', 'Bi-weekly', 'Monthly', 'Quarterly'],
                gates: ['Gate 0', 'Gate 1', 'Gate 2', 'Gate 3', 'Gate 4', 'Gate 5']
            }
        }
    ]
};

// ============================================================================
// SAMPLE DATA - 7 REALISTIC PROJECTS
// ============================================================================

// ============================================================================
// 6-DIMENSION SCORING CALCULATION FUNCTIONS
// ============================================================================

/**
 * Calculate D1: Strategic Impact Score (0-100)
 * Components: NPV-based Quantitative (60%) + Qualitative Assessment (40%)
 */
function calculateD1Score(criteriaValues, allInitiatives) {
    // Quantitative Component (60% weight) - from Financial Projections
    const npv = calculateNPV(criteriaValues.financial_projections);
    let quantScore = 0;

    if (npv > 100000000) quantScore = 95;
    else if (npv > 50000000) quantScore = 85;
    else if (npv > 20000000) quantScore = 75;
    else if (npv > 5000000) quantScore = 65;
    else quantScore = 55;

    // Qualitative Component (40% weight) - from Problem, Stakeholder, Strategic Rationale
    let qualScore = 0;

    // Analyze problem severity
    const problemText = (criteriaValues.problem_statement || '').toLowerCase();
    if (problemText.includes('sar') || problemText.includes('million')) qualScore += 3;
    if (problemText.includes('critical') || problemText.includes('urgent')) qualScore += 2;

    // Analyze stakeholder impact
    const stakeholderText = (criteriaValues.stakeholder_impact || '').toLowerCase();
    if (stakeholderText.includes('ceo') || stakeholderText.includes('executive')) qualScore += 2;
    if (stakeholderText.includes('customer')) qualScore += 2;

    // Strategic alignment
    const strategicText = (criteriaValues.strategic_rationale || '').toLowerCase();
    if (strategicText.includes('vision') || strategicText.includes('strategy')) qualScore += 1;

    // Combine: 60% quantitative + 40% qualitative
    const d1 = Math.round((quantScore * 0.6) + (qualScore * 4));
    return Math.min(100, Math.max(0, d1));
}

/**
 * Calculate D2: Execution Feasibility Score (0-100)
 * Components: TRL (30%) + Resources (25%) + Timeline (25%) + Dependencies (20%)
 */
function calculateD2Score(criteriaValues) {
    // TRL Component (30% weight)
    const trlOptions = {
        9: 95, 8: 90, 7: 85, 6: 80, 5: 75,
        4: 65, 3: 60, 2: 55, 1: 50
    };
    const trlScore = (trlOptions[criteriaValues.trl_level] || 70) * 0.30;

    // Resource Availability Component (25% weight)
    const resources = criteriaValues.resource_availability || [];
    const resourceScore = (resources.length / 4) * 100 * 0.25;

    // Timeline Confidence Component (25% weight)
    const timeline = criteriaValues.timeline || {};
    const duration = calculateMonthsDuration(timeline.start_date, timeline.end_date);
    let timelineScore = 70;

    if (duration <= 4 && timeline.confidence === 'high') timelineScore = 90;
    else if (duration <= 6 && timeline.confidence !== 'low') timelineScore = 80;
    else if (duration <= 12 && timeline.confidence !== 'low') timelineScore = 70;
    else timelineScore = 60;

    timelineScore *= 0.25;

    // Dependency Complexity Component (20% weight)
    const criticalDeps = (criteriaValues.prerequisites || []).filter(p => p.criticality === 'Critical').length;
    const totalDeps = (criteriaValues.prerequisites || []).length;
    let depScore = 90;

    if (criticalDeps === 0 && totalDeps <= 3) depScore = 90;
    else if (criticalDeps === 0 && totalDeps <= 5) depScore = 80;
    else if (criticalDeps === 1) depScore = 70;
    else if (criticalDeps === 2) depScore = 60;
    else depScore = 50;

    depScore *= 0.20;

    const d2 = Math.round(trlScore + resourceScore + timelineScore + depScore);
    return Math.min(100, Math.max(0, d2));
}

/**
 * Calculate D3: BCG i2i Advancement Score (0-100)
 * Based on number of dimensions × expected gain
 */
function calculateD3Score(criteriaValues) {
    const dimensions = criteriaValues.bcg_i2i_dimensions || [];
    if (dimensions.length === 0) return 0;

    // Base score: number of dimensions × 10
    const baseScore = dimensions.length * 10;

    // Calculate average expected gain
    const avgGain = dimensions.reduce((sum, dim) => sum + (dim.gain || 3), 0) / dimensions.length;
    const gainPoints = avgGain * 5;

    // Breadth bonus
    let breadthBonus = 0;
    if (dimensions.length >= 7) breadthBonus = 20;
    else if (dimensions.length >= 5) breadthBonus = 10;

    const d3 = Math.round(baseScore + gainPoints + breadthBonus);
    return Math.min(100, Math.max(0, d3));
}

/**
 * Calculate D4: Aramco Competitive Response Score (0-100)
 * AI-suggested from competitive analysis text, human validates
 */
function calculateD4Score(criteriaValues) {
    // This would use AI analysis in production
    // For now, use keyword-based scoring

    const aramcoText = (criteriaValues.aramco_response || '').toLowerCase();
    const compText = (criteriaValues.competitive_analysis || '').toLowerCase();
    const combinedText = aramcoText + ' ' + compText;

    let defensiveScore = 50;
    let offensiveScore = 50;

    // Defensive keywords
    if (combinedText.includes('protect') || combinedText.includes('retain')) defensiveScore += 10;
    if (combinedText.includes('defend') || combinedText.includes('prevent')) defensiveScore += 10;
    if (combinedText.includes('customer retention') || combinedText.includes('loyalty')) defensiveScore += 10;
    if (combinedText.includes('switching cost')) defensiveScore += 10;

    // Offensive keywords
    if (combinedText.includes('lead') || combinedText.includes('first-mover')) offensiveScore += 10;
    if (combinedText.includes('cannot replicate') || combinedText.includes('unique')) offensiveScore += 10;
    if (combinedText.includes('capability gap') || combinedText.includes('advantage')) offensiveScore += 10;
    if (combinedText.includes('mira') || combinedText.includes('data')) offensiveScore += 10;

    // Time to replicate modifier
    if (combinedText.includes('36 month') || combinedText.includes('3 year')) offensiveScore += 10;
    else if (combinedText.includes('24 month') || combinedText.includes('2 year')) offensiveScore += 5;

    const d4 = Math.round((Math.min(100, defensiveScore) + Math.min(100, offensiveScore)) / 2);
    return Math.min(100, Math.max(0, d4));
}

/**
 * Calculate D5: MiRA Integration Potential Score (0-100)
 * Based on MiRA layer + integration depth
 */
function calculateD5Score(criteriaValues) {
    const miraConfig = criteriaValues.mira_integration || {};

    if (!miraConfig.layer || miraConfig.layer === 0) return 0;

    // Base score from layer
    const layerScores = { 0: 0, 1: 30, 2: 50, 3: 70, 4: 90 };
    let baseScore = layerScores[miraConfig.layer] || 0;

    // Depth modifier
    const depthModifiers = { 'low': -10, 'medium': 0, 'high': 10 };
    const depthMod = depthModifiers[miraConfig.depth] || 0;

    // Multi-layer bonus
    const multiLayerBonus = miraConfig.multiple_layers ? 5 : 0;

    // Monetization clarity (for Layer 4)
    let monetizationMod = 0;
    if (miraConfig.layer === 4) {
        if (miraConfig.monetization_clarity === 'yes') monetizationMod = 0;
        else if (miraConfig.monetization_clarity === 'partial') monetizationMod = -10;
        else monetizationMod = -20;
    }

    const d5 = Math.round(baseScore + depthMod + multiLayerBonus + monetizationMod);
    return Math.min(100, Math.max(0, d5));
}

/**
 * Calculate D6: Three Engines Alignment Score (0-100)
 * Components: Engine Contribution (40%) + Portfolio Balance (35%) + Strategic Coherence (25%)
 */
function calculateD6Score(criteriaValues, allInitiatives) {
    // Engine Contribution (40% weight)
    const engineStrengthScores = {
        'critical': 95,
        'strong': 85,
        'solid': 75,
        'moderate': 65,
        'weak': 55
    };
    const contributionScore = (engineStrengthScores[criteriaValues.engine_contribution_strength] || 70) * 0.40;

    // Portfolio Balance (35% weight)
    const targetDistribution = { e1_sustain_grow: 0.60, e2_expand_inorganically: 0.25, e3_base_oil_integration: 0.15 };
    const currentEngine = criteriaValues.three_engines_alignment || 'e1_sustain_grow';

    // Calculate current distribution
    const engineCounts = { e1_sustain_grow: 0, e2_expand_inorganically: 0, e3_base_oil_integration: 0 };
    allInitiatives.forEach(init => {
        const engine = init.criteriaValues?.three_engines_alignment || 'e1_sustain_grow';
        if (engineCounts[engine] !== undefined) engineCounts[engine]++;
    });

    const total = allInitiatives.length;
    const currentPct = engineCounts[currentEngine] / total;
    const targetPct = targetDistribution[currentEngine];
    const gap = targetPct - currentPct;

    let balanceScore = 70;
    if (gap > 0) balanceScore = 85 + Math.min(gap * 100, 15); // Under-allocated, adding helps
    else balanceScore = 70 - Math.min(Math.abs(gap) * 100, 20); // Over-allocated

    balanceScore *= 0.35;

    // Strategic Coherence (25% weight)
    const coherence = criteriaValues.strategic_coherence || {};
    let coherenceChecks = 0;
    if (coherence.ceo_priority) coherenceChecks++;
    if (coherence.aramco_address) coherenceChecks++;
    if (coherence.bcg_i2i) coherenceChecks++;
    if (coherence.vision_fit) coherenceChecks++;

    const coherenceScore = (coherenceChecks / 4) * 100 * 0.25;

    const d6 = Math.round(contributionScore + balanceScore + coherenceScore);
    return Math.min(100, Math.max(0, d6));
}

/**
 * Calculate NPV from financial projections
 */
function calculateNPV(financialData) {
    if (!financialData || !financialData.years) return 0;

    const wacc = financialData.wacc || 0.12;
    const years = financialData.years || {};

    let npv = 0;
    Object.keys(years).forEach(year => {
        const yearNum = parseInt(year);
        const cashFlow = years[year] || 0;
        npv += cashFlow / Math.pow(1 + wacc, yearNum);
    });

    return npv;
}

/**
 * Calculate months between two dates
 */
function calculateMonthsDuration(startDate, endDate) {
    if (!startDate || !endDate) return 12;

    const start = new Date(startDate);
    const end = new Date(endDate);
    const months = (end.getFullYear() - start.getFullYear()) * 12 + (end.getMonth() - start.getMonth());
    return Math.max(1, months);
}

/**
 * Calculate composite score from 6 dimensions
 */
function calculateCompositeScore(scores, scenario = 'A') {
    const weights = PETROLUBE_35_TEMPLATE.scoringConfig.scenarios[scenario];

    const composite =
        (scores.d1 || 0) * weights.d1 +
        (scores.d2 || 0) * weights.d2 +
        (scores.d3 || 0) * weights.d3 +
        (scores.d4 || 0) * weights.d4 +
        (scores.d5 || 0) * weights.d5 +
        (scores.d6 || 0) * weights.d6;

    return Math.round(composite * 10) / 10; // Round to 1 decimal
}

/**
 * Assign quadrant based on D1 and D2 scores
 */
function assignQuadrant(d1, d2) {
    if (d1 >= 75 && d2 >= 80) return 'quick_win';
    if (d1 < 75 && d2 >= 80) return 'push_harder';
    if (d1 >= 75 && d2 < 80) return 'transformational';
    return 'moonshot';
}

/**
 * Calculate final score with quadrant modifier
 */
function calculateFinalScore(compositeScore, quadrant) {
    const modifier = PETROLUBE_35_TEMPLATE.scoringConfig.quadrantModifiers[quadrant] || 1.0;
    return Math.round(compositeScore * modifier * 10) / 10;
}

/**
 * Assign tier based on scores and characteristics
 */
function assignTier(criteriaValues, finalScore, allInitiatives) {
    // Check for catastrophic dependencies
    const criticalDeps = (criteriaValues.prerequisites || []).filter(p => p.criticality === 'Critical').length;
    if (criticalDeps >= 3) return '1a';

    // Priority-based tier assignment
    if (criteriaValues.priority === 'critical') {
        if (finalScore >= 80) return '1a';
        return '1b';
    }

    // Score-based tier assignment
    if (finalScore >= 80) return '1b';
    if (finalScore >= 70) return '1c';
    if (finalScore >= 60) return '1d';
    if (finalScore >= 50) return '2';
    return 'contingent';
}

/**
 * Validate portfolio balance
 */
function validatePortfolioBalance(allInitiatives) {
    const categoryCounts = {
        core_incremental: 0,
        core_disruptive: 0,
        non_core_incremental: 0,
        non_core_disruptive: 0
    };

    const engineCounts = {
        e1_sustain_grow: 0,
        e2_expand_inorganically: 0,
        e3_base_oil_integration: 0
    };

    allInitiatives.forEach(init => {
        const cat = init.criteriaValues?.portfolio_category;
        const eng = init.criteriaValues?.three_engines_alignment;

        if (categoryCounts[cat] !== undefined) categoryCounts[cat]++;
        if (engineCounts[eng] !== undefined) engineCounts[eng]++;
    });

    const total = allInitiatives.length;

    // Calculate percentages
    const categoryPct = {
        core_incremental: (categoryCounts.core_incremental / total) * 100,
        core_disruptive: (categoryCounts.core_disruptive / total) * 100,
        non_core_incremental: (categoryCounts.non_core_incremental / total) * 100,
        non_core_disruptive: (categoryCounts.non_core_disruptive / total) * 100
    };

    const enginePct = {
        e1_sustain_grow: (engineCounts.e1_sustain_grow / total) * 100,
        e2_expand_inorganically: (engineCounts.e2_expand_inorganically / total) * 100,
        e3_base_oil_integration: (engineCounts.e3_base_oil_integration / total) * 100
    };

    // Validate against targets
    const validation = {
        category: {
            core_incremental: { actual: categoryPct.core_incremental, target: 60, inRange: categoryPct.core_incremental >= 58 && categoryPct.core_incremental <= 62 },
            core_disruptive: { actual: categoryPct.core_disruptive, target: 15, inRange: categoryPct.core_disruptive >= 13 && categoryPct.core_disruptive <= 17 },
            non_core_incremental: { actual: categoryPct.non_core_incremental, target: 15, inRange: categoryPct.non_core_incremental >= 13 && categoryPct.non_core_incremental <= 17 },
            non_core_disruptive: { actual: categoryPct.non_core_disruptive, target: 10, inRange: categoryPct.non_core_disruptive >= 8 && categoryPct.non_core_disruptive <= 12 }
        },
        engine: {
            e1_sustain_grow: { actual: enginePct.e1_sustain_grow, target: 60, inRange: enginePct.e1_sustain_grow >= 58 && enginePct.e1_sustain_grow <= 62 },
            e2_expand_inorganically: { actual: enginePct.e2_expand_inorganically, target: 25, inRange: enginePct.e2_expand_inorganically >= 23 && enginePct.e2_expand_inorganically <= 27 },
            e3_base_oil_integration: { actual: enginePct.e3_base_oil_integration, target: 15, inRange: enginePct.e3_base_oil_integration >= 13 && enginePct.e3_base_oil_integration <= 17 }
        }
    };

    return validation;
}

const SAMPLE_PROJECTS = [
    {
        id: 'proj-001',
        name: 'Oracle Redwood UX Migration',
        criteriaValues: {
            initiative_id: 'PET-2025-001',
            initiative_name: 'Oracle Redwood UX Migration',
            strategic_domain: 'digital_transformation',
            portfolio_category: 'core_incremental',
            three_engines_alignment: 'e1_sustain_grow',
            quadrant: 'quick_win',
            strategic_priority: 'p1_critical',
            year1_tier: 'tier_1a',
            aramco_response: 'defensive',
            bcg_i2i_target: 8,
            strategic_impact_score: 24,
            financial_impact_score: 23,
            execution_feasibility_score: 18,
            risk_management_score: 12,
            innovation_index_score: 13,
            investment_required: 12500000,
            year1_investment: 8500000,
            timeline_months: 14,
            resource_fte: 18,
            expected_roi_year3: 17550000,
            irr_percentage: 42,
            payback_period: 2.1,
            npv_5year: 24300000,
            phase1_duration: 6,
            phase2_duration: 5,
            phase3_duration: 3,
            gate0_approved: 'yes',
            critical_prerequisites_count: 3,
            technical_dependencies_count: 5,
            organizational_dependencies_count: 4,
            risk1_severity: 'high',
            upside_potential_sar: 5000000,
            contingency_budget: 1250000,
            roi_target_year1: 35,
            board_recommendation: 'accelerate'
        },
        status: 'Prioritized',
        scores: {},
        createdAt: '2024-12-01T00:00:00Z'
    },
    {
        id: 'proj-002',
        name: 'AI-Powered Predictive Maintenance Platform',
        criteriaValues: {
            initiative_id: 'PET-2025-002',
            initiative_name: 'AI-Powered Predictive Maintenance Platform',
            strategic_domain: 'digital_transformation',
            portfolio_category: 'core_disruptive',
            three_engines_alignment: 'e1_sustain_grow',
            quadrant: 'push_harder',
            strategic_priority: 'p1_critical',
            year1_tier: 'tier_1b',
            aramco_response: 'offensive',
            bcg_i2i_target: 12,
            strategic_impact_score: 25,
            financial_impact_score: 24,
            execution_feasibility_score: 15,
            risk_management_score: 10,
            innovation_index_score: 14,
            investment_required: 18000000,
            year1_investment: 9000000,
            timeline_months: 18,
            resource_fte: 22,
            expected_roi_year3: 32400000,
            irr_percentage: 48,
            payback_period: 1.8,
            npv_5year: 41200000,
            phase1_duration: 7,
            phase2_duration: 7,
            phase3_duration: 4,
            gate0_approved: 'yes',
            critical_prerequisites_count: 4,
            technical_dependencies_count: 8,
            organizational_dependencies_count: 5,
            risk1_severity: 'medium',
            upside_potential_sar: 12000000,
            contingency_budget: 1800000,
            roi_target_year1: 28,
            board_recommendation: 'accelerate'
        },
        status: 'Prioritized',
        scores: {},
        createdAt: '2024-11-28T00:00:00Z'
    },
    {
        id: 'proj-003',
        name: 'Morocco Manufacturing Facility Expansion',
        criteriaValues: {
            initiative_id: 'PET-2025-003',
            initiative_name: 'Morocco Manufacturing Facility Expansion',
            strategic_domain: 'international_expansion',
            portfolio_category: 'core_disruptive',
            three_engines_alignment: 'e2_expand_inorganically',
            quadrant: 'transformational',
            strategic_priority: 'p2_high',
            year1_tier: 'tier_2',
            aramco_response: 'offensive',
            bcg_i2i_target: 15,
            strategic_impact_score: 23,
            financial_impact_score: 22,
            execution_feasibility_score: 14,
            risk_management_score: 9,
            innovation_index_score: 11,
            investment_required: 45000000,
            year1_investment: 18000000,
            timeline_months: 30,
            resource_fte: 35,
            expected_roi_year3: 67500000,
            irr_percentage: 35,
            payback_period: 3.2,
            npv_5year: 78000000,
            phase1_duration: 10,
            phase2_duration: 12,
            phase3_duration: 8,
            gate0_approved: 'yes',
            critical_prerequisites_count: 7,
            technical_dependencies_count: 6,
            organizational_dependencies_count: 9,
            risk1_severity: 'high',
            upside_potential_sar: 20000000,
            contingency_budget: 4500000,
            roi_target_year1: 18,
            board_recommendation: 'keep'
        },
        status: 'Prioritized',
        scores: {},
        createdAt: '2024-11-20T00:00:00Z'
    },
    {
        id: 'proj-004',
        name: 'Customer Portal & Self-Service Platform',
        criteriaValues: {
            initiative_id: 'PET-2025-004',
            initiative_name: 'Customer Portal & Self-Service Platform',
            strategic_domain: 'digital_transformation',
            portfolio_category: 'core_incremental',
            three_engines_alignment: 'e1_sustain_grow',
            quadrant: 'quick_win',
            strategic_priority: 'p2_high',
            year1_tier: 'tier_1c',
            aramco_response: 'neutral',
            bcg_i2i_target: 6,
            strategic_impact_score: 20,
            financial_impact_score: 21,
            execution_feasibility_score: 17,
            risk_management_score: 13,
            innovation_index_score: 12,
            investment_required: 7500000,
            year1_investment: 5000000,
            timeline_months: 10,
            resource_fte: 14,
            expected_roi_year3: 11250000,
            irr_percentage: 38,
            payback_period: 2.3,
            npv_5year: 14800000,
            phase1_duration: 4,
            phase2_duration: 4,
            phase3_duration: 2,
            gate0_approved: 'yes',
            critical_prerequisites_count: 2,
            technical_dependencies_count: 4,
            organizational_dependencies_count: 3,
            risk1_severity: 'low',
            upside_potential_sar: 3500000,
            contingency_budget: 750000,
            roi_target_year1: 32,
            board_recommendation: 'keep'
        },
        status: 'Prioritized',
        scores: {},
        createdAt: '2024-12-05T00:00:00Z'
    },
    {
        id: 'proj-005',
        name: 'Bio-Lubricants R&D Initiative',
        criteriaValues: {
            initiative_id: 'PET-2025-005',
            initiative_name: 'Bio-Lubricants R&D Initiative',
            strategic_domain: 'ev_bio_lubricants',
            portfolio_category: 'non_core_disruptive',
            three_engines_alignment: 'e1_sustain_grow',
            quadrant: 'transformational',
            strategic_priority: 'p2_high',
            year1_tier: 'tier_1d',
            aramco_response: 'offensive',
            bcg_i2i_target: 10,
            strategic_impact_score: 22,
            financial_impact_score: 19,
            execution_feasibility_score: 13,
            risk_management_score: 11,
            innovation_index_score: 15,
            investment_required: 24000000,
            year1_investment: 12000000,
            timeline_months: 24,
            resource_fte: 28,
            expected_roi_year3: 31200000,
            irr_percentage: 29,
            payback_period: 3.5,
            npv_5year: 38500000,
            phase1_duration: 9,
            phase2_duration: 9,
            phase3_duration: 6,
            gate0_approved: 'yes',
            critical_prerequisites_count: 5,
            technical_dependencies_count: 7,
            organizational_dependencies_count: 6,
            risk1_severity: 'medium',
            upside_potential_sar: 18000000,
            contingency_budget: 2400000,
            roi_target_year1: 22,
            board_recommendation: 'keep'
        },
        status: 'Prioritized',
        scores: {},
        createdAt: '2024-11-25T00:00:00Z'
    },
    {
        id: 'proj-006',
        name: 'Supply Chain Blockchain Traceability',
        criteriaValues: {
            initiative_id: 'PET-2025-006',
            initiative_name: 'Supply Chain Blockchain Traceability',
            strategic_domain: 'innovation_new_products',
            portfolio_category: 'non_core_disruptive',
            three_engines_alignment: 'e1_sustain_grow',
            quadrant: 'moonshot',
            strategic_priority: 'p3_medium',
            year1_tier: 'deferred',
            aramco_response: 'neutral',
            bcg_i2i_target: 4,
            strategic_impact_score: 18,
            financial_impact_score: 16,
            execution_feasibility_score: 10,
            risk_management_score: 8,
            innovation_index_score: 14,
            investment_required: 32000000,
            year1_investment: 8000000,
            timeline_months: 36,
            resource_fte: 24,
            expected_roi_year3: 19200000,
            irr_percentage: 12,
            payback_period: 5.2,
            npv_5year: 18500000,
            phase1_duration: 12,
            phase2_duration: 14,
            phase3_duration: 10,
            gate0_approved: 'yes',
            critical_prerequisites_count: 8,
            technical_dependencies_count: 12,
            organizational_dependencies_count: 7,
            risk1_severity: 'critical',
            upside_potential_sar: 25000000,
            contingency_budget: 3200000,
            roi_target_year1: 8,
            board_recommendation: 'keep_conditions'
        },
        status: 'Blocked',
        scores: {},
        killSwitch: {
            triggered: true,
            fieldId: '31a',
            message: 'Critical risk requires Risk Committee approval'
        },
        createdAt: '2024-12-10T00:00:00Z'
    },
    {
        id: 'proj-007',
        name: 'ESG Reporting & Sustainability Dashboard',
        criteriaValues: {
            initiative_id: 'PET-2025-007',
            initiative_name: 'ESG Reporting & Sustainability Dashboard',
            strategic_domain: 'sustainability_esg',
            portfolio_category: 'core_incremental',
            three_engines_alignment: 'e1_sustain_grow',
            quadrant: 'quick_win',
            strategic_priority: 'p2_high',
            year1_tier: 'tier_1d',
            aramco_response: 'neutral',
            bcg_i2i_target: 7,
            strategic_impact_score: 21,
            financial_impact_score: 18,
            execution_feasibility_score: 16,
            risk_management_score: 12,
            innovation_index_score: 11,
            investment_required: 5500000,
            year1_investment: 4000000,
            timeline_months: 9,
            resource_fte: 12,
            expected_roi_year3: 7700000,
            irr_percentage: 32,
            payback_period: 2.6,
            npv_5year: 9800000,
            phase1_duration: 3,
            phase2_duration: 4,
            phase3_duration: 2,
            gate0_approved: 'yes',
            critical_prerequisites_count: 2,
            technical_dependencies_count: 3,
            organizational_dependencies_count: 4,
            risk1_severity: 'low',
            upside_potential_sar: 2000000,
            contingency_budget: 550000,
            roi_target_year1: 28,
            board_recommendation: 'keep'
        },
        status: 'Prioritized',
        scores: {},
        createdAt: '2024-12-03T00:00:00Z'
    }
];

// ============================================================================
// DATA STORE WITH SAMPLE DATA
// ============================================================================

const INITIAL_DATA = {
    templates: [PETROLUBE_35_TEMPLATE],
    projects: SAMPLE_PROJECTS,
    scenarios: [
        {
            id: 'scenario-quick-wins',
            name: 'Quick Wins (2025)',
            description: 'Fast ROI and low-risk projects'
        },
        {
            id: 'scenario-balanced',
            name: 'Balanced Portfolio',
            description: 'Balance short-term and long-term'
        },
        {
            id: 'scenario-transformation',
            name: 'Strategic Transformation (2025-2030)',
            description: 'Long-term strategic bets'
        }
    ],
    adminSettings: {
        companyProfile: {
            companyName: 'Petrolube',
            companyFullName: 'Petrolube Company',
            industry: 'Lubricants & Petroleum Products',
            headquarters: 'Riyadh, Saudi Arabia',
            founded: '1985',
            employees: '500+',
            description: 'Leading lubricants manufacturer in the Middle East',
            vision: 'To be the most trusted lubricants brand in the region',
            mission: 'Delivering premium quality lubricants that exceed customer expectations'
        },
        coCompanies: [
            {
                id: 'co-1',
                name: 'Petrolube Distribution',
                relationship: 'Subsidiary',
                country: 'Saudi Arabia',
                description: 'Distribution and logistics arm'
            },
            {
                id: 'co-2',
                name: 'Petrolube International',
                relationship: 'Subsidiary',
                country: 'UAE',
                description: 'International operations division'
            }
        ],
        businessInfo: {
            taxId: 'SAT-300123456789',
            registrationNumber: 'CR-1234567890',
            fiscalYearStart: 'January',
            currency: 'SAR',
            timezone: 'Asia/Riyadh',
            website: 'www.petrolube.com',
            contactEmail: 'info@petrolube.com',
            contactPhone: '+966 11 234 5678'
        },
        documents: [
            {
                id: 'doc-1',
                name: '2025-2030 Strategic Plan.pdf',
                type: 'Strategy',
                uploadedBy: 'Ghadah (CITO)',
                uploadedAt: '2024-11-15T10:30:00Z',
                size: '2.4 MB',
                description: 'Five-year strategic roadmap'
            },
            {
                id: 'doc-2',
                name: 'BCG Innovation Framework.pdf',
                type: 'Framework',
                uploadedBy: 'Ghadah (CITO)',
                uploadedAt: '2024-11-10T14:20:00Z',
                size: '1.8 MB',
                description: 'BCG i2i methodology guidelines'
            }
        ]
    },
    auditEvents: []
};

class DataStore {
    constructor() {
        this.loadData();
    }

    loadData() {
        const stored = localStorage.getItem('petrolubeEnterpriseData');
        if (stored) {
            this.data = JSON.parse(stored);

            // Migration: Add adminSettings if it doesn't exist
            if (!this.data.adminSettings) {
                this.data.adminSettings = JSON.parse(JSON.stringify(INITIAL_DATA.adminSettings));
                this.saveData();
            }
        } else {
            this.data = JSON.parse(JSON.stringify(INITIAL_DATA));
            // Score all sample projects
            const template = this.data.templates[0];
            this.data.projects.forEach(project => {
                if (project.status !== 'Blocked') {
                    ScoringEngine.scoreProject(project, template, this.data.projects);
                }
            });
            // Prioritize
            ScoringEngine.prioritizeProjects(this.data.projects, template);
            this.saveData();
        }
    }

    saveData() {
        localStorage.setItem('petrolubeEnterpriseData', JSON.stringify(this.data));
    }

    getData() {
        return this.data;
    }

    addAuditEvent(event) {
        this.data.auditEvents.unshift({
            id: 'evt-' + Date.now(),
            timestamp: new Date().toISOString(),
            ...event
        });
        if (this.data.auditEvents.length > 50) {
            this.data.auditEvents = this.data.auditEvents.slice(0, 50);
        }
        this.saveData();
    }

    saveTemplate(template) {
        const existingIndex = this.data.templates.findIndex(t => t.id === template.id);

        if (existingIndex >= 0) {
            // Update existing template
            this.data.templates[existingIndex] = template;
            this.addAuditEvent({
                type: 'template_updated',
                user: state.currentUserName,
                description: `Updated template: ${template.name}`
            });
        } else {
            // Add new template
            this.data.templates.push(template);
            this.addAuditEvent({
                type: 'template_created',
                user: state.currentUserName,
                description: `Created template: ${template.name}`
            });
        }

        this.saveData();
    }

    deleteTemplate(templateId) {
        this.data.templates = this.data.templates.filter(t => t.id !== templateId);
        this.addAuditEvent({
            type: 'template_deleted',
            user: state.currentUserName,
            description: `Deleted template ID: ${templateId}`
        });
        this.saveData();
    }
}

// ============================================================================
// SCORING ENGINE
// ============================================================================

class ScoringEngine {
    static calculateCriterionScore(value, field) {
        if (field.type === 'dropdown') {
            const option = field.config.options.find(opt => opt.value === value);
            return option ? option.points : 0;
        } else if (field.type === 'currency' || field.type === 'number') {
            if (field.threshold !== null && field.threshold !== undefined && field.threshold !== '') {
                return value >= field.threshold ? 100 : 0;
            } else {
                const min = field.config.min || 0;
                const max = field.config.max || 100;
                const points = ((value - min) / (max - min)) * 100;
                return Math.max(0, Math.min(100, points));
            }
        } else if (field.type === 'yesno') {
            return value === 'yes' ? 100 : 0;
        }
        return 0;
    }

    static checkKillSwitch(project, template) {
        for (const field of template.fields) {
            if (!field.killSwitch) continue;
            const value = project.criteriaValues[field.key];
            if (value === undefined) continue;

            const { operator, threshold, message } = field.killSwitch;
            let triggered = false;

            if (operator === '<' && parseFloat(value) < threshold) triggered = true;
            if (operator === '==' && value === threshold) triggered = true;

            if (triggered) {
                return {
                    triggered: true,
                    fieldId: field.id,
                    message: message
                };
            }
        }
        return null;
    }

    static scoreProject(project, template, allProjects = []) {
        // Check kill switches first
        const killSwitch = this.checkKillSwitch(project, template);
        if (killSwitch) {
            project.killSwitch = killSwitch;
            project.status = 'Blocked';
            return null;
        }

        // ============================================================================
        // NEW: 6-DIMENSION AUTOMATIC SCORING
        // ============================================================================

        const criteriaValues = project.criteriaValues || {};

        // Calculate all 6 dimensions
        const d1 = calculateD1Score(criteriaValues, allProjects);
        const d2 = calculateD2Score(criteriaValues);
        const d3 = calculateD3Score(criteriaValues);
        const d4 = calculateD4Score(criteriaValues);
        const d5 = calculateD5Score(criteriaValues);
        const d6 = calculateD6Score(criteriaValues, allProjects);

        // Store dimension scores in criteriaValues for display
        project.criteriaValues.d1_score = d1;
        project.criteriaValues.d2_score = d2;
        project.criteriaValues.d3_score = d3;
        project.criteriaValues.d4_score = d4;
        project.criteriaValues.d5_score = d5;
        project.criteriaValues.d6_score = d6;

        // Determine scenario (use from criteriaValues or default to 'A')
        const scenario = criteriaValues.scenario_assignment || 'A';

        // Calculate composite score using scenario weights
        const dimensionScores = { d1, d2, d3, d4, d5, d6 };
        const compositeScore = calculateCompositeScore(dimensionScores, scenario);

        // Assign quadrant based on D1 and D2
        const quadrant = assignQuadrant(d1, d2);
        project.criteriaValues.quadrant = quadrant;

        // Calculate final score with quadrant modifier
        const finalScore = calculateFinalScore(compositeScore, quadrant);

        // Assign tier
        const tier = assignTier(criteriaValues, finalScore, allProjects);
        project.criteriaValues.tier = tier;

        // Create breakdown for display
        const breakdown = [
            { dimension: 'D1', label: 'Strategic Impact', score: d1, weight: template.scoringConfig.scenarios[scenario].d1 },
            { dimension: 'D2', label: 'Execution Feasibility', score: d2, weight: template.scoringConfig.scenarios[scenario].d2 },
            { dimension: 'D3', label: 'BCG i2i Advancement', score: d3, weight: template.scoringConfig.scenarios[scenario].d3 },
            { dimension: 'D4', label: 'Aramco Response', score: d4, weight: template.scoringConfig.scenarios[scenario].d4 },
            { dimension: 'D5', label: 'MiRA Integration', score: d5, weight: template.scoringConfig.scenarios[scenario].d5 },
            { dimension: 'D6', label: 'Three Engines', score: d6, weight: template.scoringConfig.scenarios[scenario].d6 }
        ];

        // Store comprehensive scores
        project.scores = {
            // Dimension scores
            d1, d2, d3, d4, d5, d6,

            // Composite and final
            compositeScore,
            finalScore,

            // Classification
            scenario,
            quadrant,
            tier,

            // Breakdown for UI
            breakdown,

            // Metadata
            scoredAt: new Date().toISOString()
        };

        project.status = 'Scored';
        return project.scores;
    }

    static prioritizeProjects(projects, template) {
        // Score all eligible projects (pass all projects for D1 and D6 calculations)
        for (const project of projects) {
            if (project.status !== 'Blocked' && project.status !== 'Draft') {
                this.scoreProject(project, template, projects);
            }
        }

        // Get eligible projects
        const eligible = projects.filter(p =>
            p.scores && p.status !== 'Blocked'
        );

        // Sort by final score (includes quadrant modifiers)
        eligible.sort((a, b) =>
            (b.scores.finalScore || b.scores.compositeScore) - (a.scores.finalScore || a.scores.compositeScore)
        );

        // Assign ranks
        eligible.forEach((project, index) => {
            project.scores.rank = index + 1;
            project.status = 'Prioritized';
        });

        return {
            rankedProjects: eligible,
            blockedCount: projects.filter(p => p.status === 'Blocked').length
        };
    }
}

// ============================================================================
// AI AUTO-FILL AGENT
// ============================================================================

class AIAgent {
    static analyzeDescription(description) {
        const lowerDesc = description.toLowerCase();
        
        const signals = {
            isDigital: /digital|cloud|ai|automation|software|platform|oracle|sap|erp/i.test(description),
            isInternational: /international|expansion|morocco|africa|export|global/i.test(description),
            isSustainability: /sustainability|esg|environment|green|carbon|bio/i.test(description),
            isCritical: /critical|urgent|catastrophic|blocking|dependency/i.test(description),
            isHighValue: /million|strategic|transform|competitive|market share/i.test(description),
            isQuickWin: /quick|fast|rapid|immediate|short-term/i.test(description),
            isTransformational: /transform|revolutionize|game-changer|fundamental/i.test(description),
        };
        
        const generated = {};
        
        const idMatch = description.match(/PET-\d+/i);
        generated.initiative_id = idMatch ? idMatch[0].toUpperCase() : `PET-2025-${String(Math.floor(Math.random() * 900) + 100).padStart(3, '0')}`;
        
        const sentences = description.split(/[.!?]/);
        generated.initiative_name = sentences[0].trim().slice(0, 80);
        
        if (signals.isDigital) generated.strategic_domain = 'digital_transformation';
        else if (signals.isInternational) generated.strategic_domain = 'international_expansion';
        else if (signals.isSustainability) generated.strategic_domain = 'sustainability_esg';
        else generated.strategic_domain = 'core_business_excellence';
        
        generated.portfolio_category = signals.isTransformational ? 'core_disruptive' : 'core_incremental';
        generated.three_engines_alignment = signals.isInternational ? 'e2_expand_inorganically' : 'e1_sustain_grow';
        generated.quadrant = signals.isQuickWin ? 'quick_win' : signals.isTransformational ? 'transformational' : 'push_harder';
        generated.strategic_priority = signals.isCritical ? 'p1_critical' : signals.isHighValue ? 'p2_high' : 'p3_medium';
        
        if (signals.isCritical && signals.isDigital) generated.year1_tier = 'tier_1a';
        else if (signals.isQuickWin && signals.isDigital) generated.year1_tier = 'tier_1b';
        else if (signals.isQuickWin) generated.year1_tier = 'tier_1c';
        else generated.year1_tier = 'tier_2';
        
        generated.aramco_response = /aramco|compet/i.test(description) ? 'defensive' : 'neutral';
        generated.bcg_i2i_target = signals.isTransformational ? 12 : signals.isHighValue ? 8 : 5;
        generated.strategic_impact_score = signals.isCritical ? 23 : signals.isHighValue ? 20 : 18;
        generated.financial_impact_score = signals.isHighValue ? 22 : 19;
        generated.execution_feasibility_score = signals.isQuickWin ? 18 : signals.isTransformational ? 12 : 15;
        generated.risk_management_score = 11;
        generated.innovation_index_score = signals.isDigital ? 13 : 10;
        
        const investmentMatch = description.match(/(\d+(?:\.\d+)?)\s*(?:million|m)/i);
        if (investmentMatch) {
            generated.investment_required = parseFloat(investmentMatch[1]) * 1000000;
            generated.year1_investment = generated.investment_required * 0.6;
        } else {
            generated.investment_required = signals.isTransformational ? 15000000 : signals.isHighValue ? 10000000 : 5000000;
            generated.year1_investment = generated.investment_required * 0.6;
        }
        
        const timelineMatch = description.match(/(\d+)\s*month/i);
        generated.timeline_months = timelineMatch ? parseInt(timelineMatch[1]) : signals.isQuickWin ? 8 : signals.isTransformational ? 24 : 12;
        generated.resource_fte = Math.ceil(generated.timeline_months * 1.5);
        generated.expected_roi_year3 = generated.investment_required * (signals.isHighValue ? 1.8 : 1.4);
        generated.irr_percentage = signals.isHighValue ? 38 : 25;
        generated.payback_period = signals.isQuickWin ? 1.5 : signals.isHighValue ? 2.2 : 3.0;
        generated.npv_5year = generated.investment_required * (signals.isHighValue ? 2.2 : 1.6);
        generated.phase1_duration = Math.ceil(generated.timeline_months * 0.4);
        generated.phase2_duration = Math.ceil(generated.timeline_months * 0.35);
        generated.phase3_duration = Math.ceil(generated.timeline_months * 0.25);
        generated.gate0_approved = 'yes';
        generated.critical_prerequisites_count = signals.isCritical ? 5 : 3;
        generated.technical_dependencies_count = signals.isDigital ? 6 : 4;
        generated.organizational_dependencies_count = signals.isTransformational ? 7 : 4;
        generated.risk1_severity = signals.isCritical ? 'high' : 'medium';
        generated.upside_potential_sar = generated.investment_required * 0.3;
        generated.contingency_budget = generated.investment_required * 0.1;
        generated.roi_target_year1 = signals.isQuickWin ? 40 : 25;
        generated.board_recommendation = signals.isCritical ? 'accelerate' : signals.isHighValue ? 'keep' : 'keep_conditions';
        
        return generated;
    }
}

// ============================================================================
// INITIATIVES DATA FOR GANTT CHART
// ============================================================================

const INITIATIVES_DATA = [
    // TIER 1A - Strategic Initiatives (15 initiatives)
    { id: 'PET-2025-001', name: 'Digital Transformation Program', tier: '1a', start: '2025-01', end: '2025-12', duration: 12, criticalPath: true, dependencies: ['PET-2025-002'], owner: 'CIO', budget: 15000000, status: 'in-progress', progress: 85 },
    { id: 'PET-2025-002', name: 'Cloud Migration & Infrastructure Modernization', tier: '1a', start: '2025-01', end: '2025-09', duration: 9, criticalPath: true, dependencies: [], owner: 'IT Director', budget: 8000000, status: 'completed', progress: 100 },
    { id: 'PET-2025-003', name: 'Advanced Analytics & AI Platform', tier: '1a', start: '2025-03', end: '2025-12', duration: 10, criticalPath: true, dependencies: ['PET-2025-002'], owner: 'CDO', budget: 12000000, status: 'in-progress', progress: 70 },
    { id: 'PET-2025-004', name: 'Supply Chain Optimization Initiative', tier: '1a', start: '2025-02', end: '2025-11', duration: 10, criticalPath: false, dependencies: ['PET-2025-003'], owner: 'COO', budget: 6000000 },
    { id: 'PET-2025-005', name: 'Customer Experience Transformation', tier: '1a', start: '2025-01', end: '2025-10', duration: 10, criticalPath: false, dependencies: [], owner: 'CMO', budget: 5000000 },
    { id: 'PET-2025-006', name: 'Sustainability & ESG Integration', tier: '1a', start: '2025-02', end: '2025-12', duration: 11, criticalPath: false, dependencies: [], owner: 'CSO', budget: 10000000 },
    { id: 'PET-2025-007', name: 'Manufacturing Excellence 4.0', tier: '1a', start: '2025-03', end: '2025-12', duration: 10, criticalPath: true, dependencies: ['PET-2025-002'], owner: 'VP Manufacturing', budget: 18000000 },
    { id: 'PET-2025-008', name: 'Innovation Lab & R&D Center', tier: '1a', start: '2025-01', end: '2025-08', duration: 8, criticalPath: false, dependencies: [], owner: 'CTO', budget: 7000000 },
    { id: 'PET-2025-009', name: 'Strategic Partnerships & M&A', tier: '1a', start: '2025-02', end: '2025-09', duration: 8, criticalPath: false, dependencies: [], owner: 'CFO', budget: 25000000 },
    { id: 'PET-2025-010', name: 'Workforce Transformation Program', tier: '1a', start: '2025-01', end: '2025-12', duration: 12, criticalPath: false, dependencies: [], owner: 'CHRO', budget: 4000000 },
    { id: 'PET-2025-011', name: 'Regional Expansion - GCC Markets', tier: '1a', start: '2025-04', end: '2025-12', duration: 9, criticalPath: false, dependencies: ['PET-2025-009'], owner: 'VP Sales', budget: 20000000 },
    { id: 'PET-2025-012', name: 'Product Portfolio Optimization', tier: '1a', start: '2025-02', end: '2025-10', duration: 9, criticalPath: false, dependencies: [], owner: 'VP Product', budget: 8000000 },
    { id: 'PET-2025-013', name: 'Cybersecurity Enhancement Program', tier: '1a', start: '2025-01', end: '2025-12', duration: 12, criticalPath: true, dependencies: ['PET-2025-002'], owner: 'CISO', budget: 6000000 },
    { id: 'PET-2025-014', name: 'Enterprise Data Governance', tier: '1a', start: '2025-03', end: '2025-11', duration: 9, criticalPath: false, dependencies: ['PET-2025-003'], owner: 'CDO', budget: 3000000 },
    { id: 'PET-2025-015', name: 'Quality Management System Upgrade', tier: '1a', start: '2025-02', end: '2025-09', duration: 8, criticalPath: false, dependencies: [], owner: 'VP Quality', budget: 2500000 },

    // TIER 1B - High Priority (18 initiatives)
    { id: 'PET-2025-016', name: 'E-Commerce Platform Launch', tier: '1b', start: '2025-03', end: '2025-10', duration: 8, criticalPath: false, dependencies: ['PET-2025-005'], owner: 'Digital Director', budget: 4000000 },
    { id: 'PET-2025-017', name: 'Warehouse Automation Project', tier: '1b', start: '2025-04', end: '2025-12', duration: 9, criticalPath: false, dependencies: ['PET-2025-004'], owner: 'Logistics Manager', budget: 9000000 },
    { id: 'PET-2025-018', name: 'CRM System Implementation', tier: '1b', start: '2025-02', end: '2025-08', duration: 7, criticalPath: false, dependencies: [], owner: 'Sales Director', budget: 2000000 },
    { id: 'PET-2025-019', name: 'Mobile Workforce Solutions', tier: '1b', start: '2025-03', end: '2025-09', duration: 7, criticalPath: false, dependencies: ['PET-2025-002'], owner: 'IT Manager', budget: 1500000 },
    { id: 'PET-2025-020', name: 'Predictive Maintenance System', tier: '1b', start: '2025-05', end: '2025-12', duration: 8, criticalPath: false, dependencies: ['PET-2025-007'], owner: 'Maintenance Manager', budget: 3500000 },
    { id: 'PET-2025-021', name: 'Energy Efficiency Program', tier: '1b', start: '2025-02', end: '2025-10', duration: 9, criticalPath: false, dependencies: ['PET-2025-006'], owner: 'Sustainability Manager', budget: 5000000 },
    { id: 'PET-2025-022', name: 'Compliance & Regulatory Update', tier: '1b', start: '2025-01', end: '2025-07', duration: 7, criticalPath: false, dependencies: [], owner: 'Legal Director', budget: 1000000 },
    { id: 'PET-2025-023', name: 'Fleet Management Optimization', tier: '1b', start: '2025-04', end: '2025-11', duration: 8, criticalPath: false, dependencies: [], owner: 'Fleet Manager', budget: 2500000 },
    { id: 'PET-2025-024', name: 'Customer Portal & Self-Service', tier: '1b', start: '2025-05', end: '2025-11', duration: 7, criticalPath: false, dependencies: ['PET-2025-016'], owner: 'CX Manager', budget: 1800000 },
    { id: 'PET-2025-025', name: 'Business Intelligence Dashboard', tier: '1b', start: '2025-04', end: '2025-10', duration: 7, criticalPath: false, dependencies: ['PET-2025-003'], owner: 'Analytics Manager', budget: 1200000 },
    { id: 'PET-2025-026', name: 'HR Management System Upgrade', tier: '1b', start: '2025-03', end: '2025-09', duration: 7, criticalPath: false, dependencies: [], owner: 'HR Director', budget: 1500000 },
    { id: 'PET-2025-027', name: 'Vendor Management Portal', tier: '1b', start: '2025-05', end: '2025-11', duration: 7, criticalPath: false, dependencies: ['PET-2025-004'], owner: 'Procurement Manager', budget: 900000 },
    { id: 'PET-2025-028', name: 'Product Lifecycle Management', tier: '1b', start: '2025-06', end: '2025-12', duration: 7, criticalPath: false, dependencies: ['PET-2025-012'], owner: 'Product Manager', budget: 2000000 },
    { id: 'PET-2025-029', name: 'Contract Management System', tier: '1b', start: '2025-04', end: '2025-10', duration: 7, criticalPath: false, dependencies: [], owner: 'Legal Manager', budget: 800000 },
    { id: 'PET-2025-030', name: 'Incident Management Enhancement', tier: '1b', start: '2025-03', end: '2025-08', duration: 6, criticalPath: false, dependencies: ['PET-2025-013'], owner: 'Security Manager', budget: 700000 },
    { id: 'PET-2025-031', name: 'Training & Development Platform', tier: '1b', start: '2025-02', end: '2025-08', duration: 7, criticalPath: false, dependencies: ['PET-2025-010'], owner: 'Learning Manager', budget: 1000000 },
    { id: 'PET-2025-032', name: 'Marketing Automation Platform', tier: '1b', start: '2025-05', end: '2025-11', duration: 7, criticalPath: false, dependencies: ['PET-2025-018'], owner: 'Marketing Manager', budget: 1200000 },
    { id: 'PET-2025-033', name: 'Document Management System', tier: '1b', start: '2025-04', end: '2025-09', duration: 6, criticalPath: false, dependencies: [], owner: 'Admin Manager', budget: 600000 },

    // TIER 1C - Medium Priority (16 initiatives)
    { id: 'PET-2025-034', name: 'API Gateway Implementation', tier: '1c', start: '2025-06', end: '2025-11', duration: 6, criticalPath: false, dependencies: ['PET-2025-002'], owner: 'Integration Architect', budget: 1500000 },
    { id: 'PET-2025-035', name: 'Network Infrastructure Upgrade', tier: '1c', start: '2025-05', end: '2025-10', duration: 6, criticalPath: false, dependencies: [], owner: 'Network Manager', budget: 2000000 },
    { id: 'PET-2025-036', name: 'Backup & Disaster Recovery', tier: '1c', start: '2025-03', end: '2025-08', duration: 6, criticalPath: false, dependencies: ['PET-2025-002'], owner: 'Infrastructure Manager', budget: 1800000 },
    { id: 'PET-2025-037', name: 'Asset Management System', tier: '1c', start: '2025-07', end: '2025-12', duration: 6, criticalPath: false, dependencies: [], owner: 'Asset Manager', budget: 900000 },
    { id: 'PET-2025-038', name: 'Laboratory Information System', tier: '1c', start: '2025-04', end: '2025-09', duration: 6, criticalPath: false, dependencies: ['PET-2025-015'], owner: 'Lab Manager', budget: 1200000 },
    { id: 'PET-2025-039', name: 'Environmental Monitoring System', tier: '1c', start: '2025-06', end: '2025-11', duration: 6, criticalPath: false, dependencies: ['PET-2025-006'], owner: 'EHS Manager', budget: 1100000 },
    { id: 'PET-2025-040', name: 'Project Management Office Setup', tier: '1c', start: '2025-01', end: '2025-06', duration: 6, criticalPath: false, dependencies: [], owner: 'PMO Director', budget: 800000 },
    { id: 'PET-2025-041', name: 'Change Management Framework', tier: '1c', start: '2025-02', end: '2025-07', duration: 6, criticalPath: false, dependencies: ['PET-2025-040'], owner: 'Change Manager', budget: 500000 },
    { id: 'PET-2025-042', name: 'Performance Management System', tier: '1c', start: '2025-05', end: '2025-10', duration: 6, criticalPath: false, dependencies: ['PET-2025-026'], owner: 'HR Manager', budget: 700000 },
    { id: 'PET-2025-043', name: 'Expense Management System', tier: '1c', start: '2025-06', end: '2025-11', duration: 6, criticalPath: false, dependencies: [], owner: 'Finance Manager', budget: 600000 },
    { id: 'PET-2025-044', name: 'Time Tracking & Attendance', tier: '1c', start: '2025-04', end: '2025-08', duration: 5, criticalPath: false, dependencies: [], owner: 'HR Manager', budget: 400000 },
    { id: 'PET-2025-045', name: 'Visitor Management System', tier: '1c', start: '2025-07', end: '2025-11', duration: 5, criticalPath: false, dependencies: [], owner: 'Security Manager', budget: 300000 },
    { id: 'PET-2025-046', name: 'Facilities Management Platform', tier: '1c', start: '2025-05', end: '2025-10', duration: 6, criticalPath: false, dependencies: [], owner: 'Facilities Manager', budget: 800000 },
    { id: 'PET-2025-047', name: 'Knowledge Management System', tier: '1c', start: '2025-08', end: '2025-12', duration: 5, criticalPath: false, dependencies: ['PET-2025-033'], owner: 'KM Manager', budget: 500000 },
    { id: 'PET-2025-048', name: 'Collaboration Tools Enhancement', tier: '1c', start: '2025-03', end: '2025-07', duration: 5, criticalPath: false, dependencies: ['PET-2025-002'], owner: 'IT Manager', budget: 600000 },
    { id: 'PET-2025-049', name: 'Video Conferencing Upgrade', tier: '1c', start: '2025-04', end: '2025-07', duration: 4, criticalPath: false, dependencies: [], owner: 'IT Manager', budget: 400000 },

    // TIER 1D - Lower Priority (12 initiatives)
    { id: 'PET-2025-050', name: 'Corporate Website Redesign', tier: '1d', start: '2025-06', end: '2025-10', duration: 5, criticalPath: false, dependencies: [], owner: 'Marketing Manager', budget: 500000 },
    { id: 'PET-2025-051', name: 'Internal Communications Portal', tier: '1d', start: '2025-07', end: '2025-11', duration: 5, criticalPath: false, dependencies: [], owner: 'Comms Manager', budget: 300000 },
    { id: 'PET-2025-052', name: 'Employee Wellness Program', tier: '1d', start: '2025-05', end: '2025-12', duration: 8, criticalPath: false, dependencies: [], owner: 'HR Manager', budget: 400000 },
    { id: 'PET-2025-053', name: 'Corporate Social Responsibility', tier: '1d', start: '2025-06', end: '2025-12', duration: 7, criticalPath: false, dependencies: [], owner: 'CSR Manager', budget: 600000 },
    { id: 'PET-2025-054', name: 'Brand Refresh Initiative', tier: '1d', start: '2025-08', end: '2025-12', duration: 5, criticalPath: false, dependencies: ['PET-2025-050'], owner: 'Brand Manager', budget: 800000 },
    { id: 'PET-2025-055', name: 'Customer Loyalty Program', tier: '1d', start: '2025-09', end: '2025-12', duration: 4, criticalPath: false, dependencies: ['PET-2025-016'], owner: 'CX Manager', budget: 700000 },
    { id: 'PET-2025-056', name: 'Social Media Strategy Refresh', tier: '1d', start: '2025-07', end: '2025-10', duration: 4, criticalPath: false, dependencies: [], owner: 'Social Media Manager', budget: 200000 },
    { id: 'PET-2025-057', name: 'Office Space Optimization', tier: '1d', start: '2025-08', end: '2025-12', duration: 5, criticalPath: false, dependencies: [], owner: 'Facilities Manager', budget: 1000000 },
    { id: 'PET-2025-058', name: 'Parking Management System', tier: '1d', start: '2025-09', end: '2025-12', duration: 4, criticalPath: false, dependencies: [], owner: 'Admin Manager', budget: 250000 },
    { id: 'PET-2025-059', name: 'Cafeteria Service Enhancement', tier: '1d', start: '2025-07', end: '2025-11', duration: 5, criticalPath: false, dependencies: [], owner: 'Admin Manager', budget: 300000 },
    { id: 'PET-2025-060', name: 'Corporate Events Management', tier: '1d', start: '2025-06', end: '2025-12', duration: 7, criticalPath: false, dependencies: [], owner: 'Events Manager', budget: 400000 },
    { id: 'PET-2025-061', name: 'Archive Digitization Project', tier: '1d', start: '2025-10', end: '2025-12', duration: 3, criticalPath: false, dependencies: ['PET-2025-033'], owner: 'Records Manager', budget: 350000 },

    // CONTINGENT - Conditional Initiatives (10 initiatives)
    { id: 'PET-2025-062', name: 'Blockchain Supply Chain POC', tier: 'contingent', start: '2025-09', end: '2025-12', duration: 4, criticalPath: false, dependencies: ['PET-2025-004'], owner: 'Innovation Manager', budget: 500000 },
    { id: 'PET-2025-063', name: 'IoT Sensors Pilot Program', tier: 'contingent', start: '2025-10', end: '2025-12', duration: 3, criticalPath: false, dependencies: ['PET-2025-007'], owner: 'IoT Specialist', budget: 600000 },
    { id: 'PET-2025-064', name: 'Augmented Reality Training', tier: 'contingent', start: '2025-08', end: '2025-12', duration: 5, criticalPath: false, dependencies: ['PET-2025-031'], owner: 'Training Manager', budget: 400000 },
    { id: 'PET-2025-065', name: 'Drone Inspection System', tier: 'contingent', start: '2025-09', end: '2025-12', duration: 4, criticalPath: false, dependencies: [], owner: 'Operations Manager', budget: 350000 },
    { id: 'PET-2025-066', name: 'Robotic Process Automation', tier: 'contingent', start: '2025-07', end: '2025-12', duration: 6, criticalPath: false, dependencies: ['PET-2025-003'], owner: 'Automation Lead', budget: 800000 },
    { id: 'PET-2025-067', name: 'Voice Assistant Integration', tier: 'contingent', start: '2025-11', end: '2025-12', duration: 2, criticalPath: false, dependencies: ['PET-2025-024'], owner: 'UX Designer', budget: 200000 },
    { id: 'PET-2025-068', name: 'Quantum Computing Research', tier: 'contingent', start: '2025-10', end: '2025-12', duration: 3, criticalPath: false, dependencies: ['PET-2025-008'], owner: 'Research Lead', budget: 1000000 },
    { id: 'PET-2025-069', name: 'Digital Twin Manufacturing', tier: 'contingent', start: '2025-09', end: '2025-12', duration: 4, criticalPath: false, dependencies: ['PET-2025-007'], owner: 'Digital Lead', budget: 1200000 },
    { id: 'PET-2025-070', name: 'Predictive Analytics Engine', tier: 'contingent', start: '2025-11', end: '2025-12', duration: 2, criticalPath: false, dependencies: ['PET-2025-003'], owner: 'Data Scientist', budget: 500000 },
    { id: 'PET-2025-071', name: 'Edge Computing Infrastructure', tier: 'contingent', start: '2025-10', end: '2025-12', duration: 3, criticalPath: false, dependencies: ['PET-2025-002'], owner: 'Infrastructure Lead', budget: 900000 }
];

// ============================================================================
// APP STATE
// ============================================================================

const state = {
    currentPage: 'landing',
    currentTenant: 'petrolube',
    currentRole: 'pmo',
    currentUserName: 'Ghadah (CITO)',
    wizardStep: 1,
    wizardData: { criteriaValues: {} },
    showDescriptionBox: true,
    store: new DataStore(),
    // Template Builder State
    templateBuilderMode: null, // null, 'create', 'edit'
    editingTemplate: null,
    showFieldEditor: false,
    editingField: null,
    editingFieldIndex: null,
    // Admin State
    adminEditMode: null, // null, 'profile', 'business', 'company'
    editingCompany: null,
    // Tracking/Gantt State
    ganttFilters: {
        tier: 'all', // 'all', '1a', '1b', '1c', '1d', 'contingent'
        showCriticalPath: false,
        showDependencies: false,
        searchQuery: ''
    },
    ganttCollapsed: {
        '1a': false,
        '1b': false,
        '1c': false,
        '1d': false,
        'contingent': false
    },
    ganttViewMode: 'detailed', // 'detailed' or 'summary'
    // Dashboard State
    dashboardPage: 'executive' // 'executive', 'portfolio', 'maturity', 'engines', 'financial', 'budget', 'risk', 'dependencies'
};

// ============================================================================
// RENDER ENGINE
// ============================================================================

function render() {
    const root = document.getElementById('app-root');
    root.innerHTML = `
        <style>${STYLES}</style>
        ${state.currentPage === 'landing' ? renderLanding() : ''}
        ${state.currentPage !== 'landing' ? renderHeader() : ''}
        ${state.currentPage !== 'landing' ? renderPage() : ''}
        ${state.currentPage !== 'landing' ? renderFooter() : ''}
        ${renderModals()}
    `;
}

function renderLanding() {
    return `
        <div style="background: linear-gradient(135deg, var(--petro-green-900), var(--petro-green-800), var(--neutral-900)); min-height: 100vh; padding: 80px 24px; color: white;">
            <div class="container">
                <div class="text-center" style="margin-bottom: 64px;">
                    <div style="display: inline-flex; align-items: center; justify-content: center; width: 80px; height: 80px; background: rgba(255,255,255,0.15); border-radius: 20px; margin-bottom: 24px; backdrop-filter: blur(10px);">
                        <div style="font-size: 40px; font-weight: 800;">P</div>
                    </div>
                    <h1 style="font-size: 56px; margin-bottom: 16px; font-weight: 900; letter-spacing: -0.03em;">PETROLUBE</h1>
                    <p style="font-size: 24px; color: var(--petro-gold-500); font-weight: 700; margin-bottom: 12px;">Enterprise Initiative Management</p>
                    <p style="color: rgba(255,255,255,0.8); font-size: 16px; max-width: 600px; margin: 0 auto;">35-Criteria Framework • AI-Powered Analysis • Strategic Portfolio Optimization</p>
                </div>

                <div class="grid grid-4 mb-6">
                    ${[
                        { icon: '🤖', title: 'AI Auto-Fill', desc: 'Intelligent data population' },
                        { icon: '📊', title: '35 Criteria', desc: 'Comprehensive evaluation' },
                        { icon: '⚡', title: 'Smart Scoring', desc: 'Weighted prioritization' },
                        { icon: '📈', title: 'Live Data', desc: '7 sample projects ready' }
                    ].map(item => `
                        <div style="background: rgba(255,255,255,0.1); padding: 28px; border-radius: 16px; text-align: center; backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2);">
                            <div style="font-size: 48px; margin-bottom: 16px;">${item.icon}</div>
                            <h3 style="font-size: 18px; font-weight: 700; margin-bottom: 8px;">${item.title}</h3>
                            <p style="font-size: 14px; color: rgba(255,255,255,0.7);">${item.desc}</p>
                        </div>
                    `).join('')}
                </div>

                <div style="background: white; border-radius: 20px; padding: 48px; max-width: 900px; margin: 0 auto; box-shadow: 0 20px 60px rgba(0,0,0,0.4);">
                    <h2 style="color: var(--petro-green-800); margin-bottom: 32px; font-size: 26px; font-weight: 800;">Access System</h2>
                    
                    <div style="margin-bottom: 36px;">
                        <p style="font-weight: 700; margin-bottom: 16px; text-transform: uppercase; font-size: 13px; color: var(--neutral-600); letter-spacing: 0.05em;">Organization</p>
                        <div class="grid grid-2" style="gap: 16px;">
                            ${[
                                { id: 'petrolube', name: 'PETROLUBE', desc: 'Primary Instance' },
                                { id: 'acme', name: 'ACME Industries', desc: 'Multi-Tenant Demo' }
                            ].map(tenant => `
                                <div onclick="selectTenant('${tenant.id}')" style="padding: 24px; border: 2px solid ${state.currentTenant === tenant.id ? 'var(--petro-green-700)' : 'var(--neutral-200)'}; border-radius: 12px; cursor: pointer; text-align: center; background: ${state.currentTenant === tenant.id ? 'var(--petro-green-50)' : 'white'}; transition: all 0.2s;">
                                    <div style="font-size: 40px; font-weight: 800; margin-bottom: 12px; color: var(--petro-green-800);">${tenant.name[0]}</div>
                                    <h3 style="font-weight: 700; margin-bottom: 4px; color: var(--neutral-900);">${tenant.name}</h3>
                                    <p style="font-size: 13px; color: var(--neutral-600);">${tenant.desc}</p>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <div>
                        <p style="font-weight: 700; margin-bottom: 16px; text-transform: uppercase; font-size: 13px; color: var(--neutral-600); letter-spacing: 0.05em;">Select Role</p>
                        ${[
                            { id: 'pmo', name: 'PMO / Innovation Office', user: 'Ghadah (CITO)', desc: 'Full system access' },
                            { id: 'executive', name: 'Executive Leadership', user: 'Ahmed Al-Rashid (CEO)', desc: 'Strategic overview' },
                            { id: 'analyst', name: 'Portfolio Analyst', user: 'Sara Al-Otaibi', desc: 'Analysis & modeling' },
                            { id: 'dept', name: 'Department Lead', user: 'Khalid Al-Fahad', desc: 'Department initiatives' }
                        ].map(role => `
                            <div onclick="selectRole('${role.id}', '${role.user}')" style="padding: 18px 20px; border: 2px solid ${state.currentRole === role.id ? 'var(--petro-green-700)' : 'var(--neutral-200)'}; border-radius: 10px; margin-bottom: 12px; cursor: pointer; background: ${state.currentRole === role.id ? 'var(--petro-green-50)' : 'white'}; transition: all 0.2s;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <strong style="font-weight: 700; color: var(--neutral-900);">${role.name}</strong>
                                        <p style="font-size: 13px; color: var(--neutral-600); margin-top: 4px;">${role.desc}</p>
                                    </div>
                                    ${state.currentRole === role.id ? '<div style="width: 20px; height: 20px; background: var(--petro-green-700); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 12px;">✓</div>' : ''}
                                </div>
                            </div>
                        `).join('')}
                    </div>

                    <button class="btn btn-gold btn-block btn-lg" style="margin-top: 32px; font-size: 16px;" onclick="continueToDashboard()">
                        Continue to Dashboard →
                    </button>
                </div>
            </div>
        </div>
    `;
}

function renderHeader() {
    return `
        <header>
            <div class="header-content container">
                <div class="logo-section" onclick="navigateTo('dashboard')">
                    <div class="logo">P</div>
                    <div class="logo-text">
                        <h1>PETROLUBE</h1>
                        <p>Enterprise Initiative Management</p>
                    </div>
                </div>
                <nav>
                    <a href="#" class="nav-link ${state.currentPage === 'dashboard' ? 'active' : ''}" onclick="event.preventDefault(); navigateTo('dashboard');">Dashboard</a>
                    <a href="#" class="nav-link ${state.currentPage === 'projects' ? 'active' : ''}" onclick="event.preventDefault(); navigateTo('projects');">Projects</a>
                    <a href="#" class="nav-link ${state.currentPage === 'templates' ? 'active' : ''}" onclick="event.preventDefault(); navigateTo('templates');">Templates</a>
                    <a href="#" class="nav-link ${state.currentPage === 'scenarios' ? 'active' : ''}" onclick="event.preventDefault(); navigateTo('scenarios');">Scenarios</a>
                    <a href="#" class="nav-link ${state.currentPage === 'insights' ? 'active' : ''}" onclick="event.preventDefault(); navigateTo('insights');">Insights</a>
                    <a href="#" class="nav-link ${state.currentPage === 'tracking' ? 'active' : ''}" onclick="event.preventDefault(); navigateTo('tracking');">Tracking</a>
                    <a href="#" class="nav-link ${state.currentPage === 'admin' ? 'active' : ''}" onclick="event.preventDefault(); navigateTo('admin');">Admin</a>
                </nav>
                <div class="user-info">
                    <div class="user-badge">
                        <span style="font-weight: 700;">${state.currentUserName}</span>
                        <span style="color: var(--petro-green-800); margin-left: 8px; font-weight: 700;">${state.currentRole.toUpperCase()}</span>
                    </div>
                    <button class="btn btn-secondary btn-sm" onclick="logout()">Logout</button>
                </div>
            </div>
        </header>
    `;
}

function renderFooter() {
    return `
        <footer>
            <div class="container" style="display: flex; justify-content: space-between; align-items: center;">
                <div style="font-size: 14px;">
                    <span style="color: var(--petro-gold-500); font-weight: 700;">CONFIDENTIAL</span> 
                    <span style="opacity: 0.7; margin: 0 8px;">•</span>
                    Petrolube Internal Use Only
                </div>
                <div style="font-size: 13px; opacity: 0.7;">© 2024 PETROLUBE. Enterprise System v2.5</div>
            </div>
        </footer>
    `;
}

function renderPage() {
    const pages = {
        'dashboard': renderDashboard,
        'projects': renderProjects,
        'templates': renderTemplates,
        'scenarios': renderScenarios,
        'insights': renderInsights,
        'tracking': renderTracking,
        'admin': renderAdmin
    };

    const renderFn = pages[state.currentPage];
    return renderFn ? renderFn() : '<div class="container">Page not found</div>';
}

function renderDashboard() {
    const dashboardPages = [
        { id: 'executive', label: 'Executive Summary', icon: '📊' },
        { id: 'portfolio', label: 'Portfolio & Delivery', icon: '📈' },
        { id: 'maturity', label: 'BCG i2i Maturity', icon: '🎯' },
        { id: 'engines', label: 'Three Engines', icon: '⚙️' },
        { id: 'financial', label: 'Financial & ROI', icon: '💰' },
        { id: 'budget', label: 'Budget & Resources', icon: '💼' },
        { id: 'risk', label: 'Risk Management', icon: '⚠️' },
        { id: 'dependencies', label: 'Dependencies', icon: '🔗' }
    ];

    return `
        <div class="container" style="padding: 40px 32px;">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 32px;">
                <div>
                    <h1 style="font-size: 32px; margin-bottom: 8px; font-weight: 800;">Strategic Portfolio Dashboard</h1>
                    <p style="color: var(--neutral-600); font-size: 15px;">Comprehensive initiative analytics and enterprise performance monitoring</p>
                </div>
            </div>

            <!-- Dashboard Sub-Navigation -->
            <div style="background: white; border-radius: 12px; padding: 16px; margin-bottom: 32px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); display: flex; flex-wrap: wrap; gap: 8px;">
                ${dashboardPages.map(page => `
                    <button
                        class="btn ${state.dashboardPage === page.id ? 'btn-primary' : 'btn-secondary'}"
                        style="white-space: nowrap; font-size: 12px; padding: 8px 12px;"
                        onclick="navigateToDashboardPage('${page.id}')">
                        ${page.icon} ${page.label}
                    </button>
                `).join('')}
            </div>

            <!-- Dashboard Page Content -->
            ${renderDashboardPage()}
        </div>
    `;
}

function navigateToDashboardPage(pageId) {
    state.dashboardPage = pageId;
    render();
    // Initialize charts after render
    setTimeout(() => {
        if (typeof initializeDashboardCharts === 'function') {
            initializeDashboardCharts();
        }
    }, 100);
}

function renderDashboardPage() {
    switch (state.dashboardPage) {
        case 'executive':
            return renderExecutiveSummary();
        case 'portfolio':
            return renderPortfolioDelivery();
        case 'maturity':
            return renderBCGMaturity();
        case 'engines':
            return renderThreeEngines();
        case 'financial':
            return renderFinancial();
        case 'budget':
            return renderBudget();
        case 'risk':
            return renderRisk();
        case 'dependencies':
            return renderDependencies();
        default:
            return renderExecutiveSummary();
    }
}

// ============================================================================
// DASHBOARD SUB-PAGES
// ============================================================================

function getInitiatives() {
    // Merge portfolio_category from SAMPLE_PROJECTS into INITIATIVES_DATA
    return INITIATIVES_DATA.map(init => {
        // Try to find matching project in SAMPLE_PROJECTS by ID
        const matchingProject = typeof SAMPLE_PROJECTS !== 'undefined' ?
            SAMPLE_PROJECTS.find(p => p.criteriaValues?.initiative_id === init.id) : null;

        return {
            ...init,
            ...calculateInitiativeStatus(init),
            // Add portfolio_category if found in SAMPLE_PROJECTS
            portfolio_category: matchingProject?.criteriaValues?.portfolio_category || null
        };
    });
}

function renderExecutiveSummary() {
    const initiatives = getInitiatives();
    const totalBudget = initiatives.reduce((sum, i) => sum + i.budget, 0);
    const completedCount = initiatives.filter(i => i.status === 'completed').length;
    const atRiskCount = initiatives.filter(i => i.status === 'at-risk').length;
    const avgProgress = initiatives.reduce((sum, i) => sum + i.progress, 0) / initiatives.length;

    return `
        <div>
            <!-- KPI Cards -->
            <div class="grid grid-4 mb-6">
                <div class="stat-card">
                    <div class="stat-card-header">Total Initiatives</div>
                    <div class="stat-card-value" style="color: var(--petro-green-800);">${initiatives.length}</div>
                    <div class="stat-card-footer">Active portfolio</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-header">Portfolio Budget</div>
                    <div class="stat-card-value" style="color: var(--blue-600);">${(totalBudget / 1000000).toFixed(0)}M</div>
                    <div class="stat-card-footer">SAR total investment</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-header">Completion Rate</div>
                    <div class="stat-card-value" style="color: var(--petro-green-700);">${completedCount}</div>
                    <div class="stat-card-footer">${((completedCount / initiatives.length) * 100).toFixed(0)}% completed</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-header">At Risk</div>
                    <div class="stat-card-value" style="color: var(--red-600);">${atRiskCount}</div>
                    <div class="stat-card-footer">Require attention</div>
                </div>
            </div>

            <!-- Charts Row -->
            <div class="grid grid-2 mb-6" style="gap: 24px;">
                <div class="card">
                    <h2 style="font-size: 18px; font-weight: 800; margin-bottom: 20px; color: var(--neutral-900);">Status Distribution</h2>
                    <canvas id="statusChart" style="max-height: 300px;"></canvas>
                </div>
                <div class="card">
                    <h2 style="font-size: 18px; font-weight: 800; margin-bottom: 20px; color: var(--neutral-900);">Budget by Tier</h2>
                    <canvas id="budgetChart" style="max-height: 300px;"></canvas>
                </div>
            </div>

            <!-- Progress Timeline -->
            <div class="card">
                <h2 style="font-size: 18px; font-weight: 800; margin-bottom: 20px; color: var(--neutral-900);">Overall Portfolio Progress</h2>
                <div style="display: flex; align-items: center; gap: 16px; padding: 20px; background: var(--neutral-50); border-radius: 8px;">
                    <div style="flex: 1;">
                        <div style="height: 32px; background: var(--neutral-200); border-radius: 16px; overflow: hidden;">
                            <div style="height: 100%; width: ${avgProgress.toFixed(0)}%; background: linear-gradient(90deg, var(--petro-green-600), var(--petro-green-500)); display: flex; align-items: center; justify-content: flex-end; padding-right: 16px; color: white; font-weight: 700; font-size: 14px;">
                                ${avgProgress.toFixed(0)}%
                            </div>
                        </div>
                    </div>
                    <div style="text-align: center; min-width: 100px;">
                        <div style="font-size: 24px; font-weight: 800; color: var(--petro-green-700);">${avgProgress.toFixed(0)}%</div>
                        <div style="font-size: 12px; color: var(--neutral-600);">Complete</div>
                    </div>
                </div>
            </div>
        </div>
    `;
}

function renderPortfolioDelivery() {
    const initiatives = getInitiatives();

    return `
        <div>
            <!-- Portfolio Impact vs Feasibility Matrix -->
            <div class="card mb-6">
                <h2 style="font-size: 18px; font-weight: 800; margin-bottom: 12px; color: var(--neutral-900);">Portfolio Impact vs Feasibility Matrix - Interactive D3.js</h2>
                <p style="font-size: 13px; color: var(--neutral-600); margin-bottom: 20px;">71 Initiatives | Strategic Positioning Analysis</p>
                <div id="portfolioImpactMatrix" style="position: relative; height: 550px; width: 100%; background: var(--neutral-50); border-radius: 8px;"></div>
            </div>

            <!-- Portfolio Distribution Matrix -->
            <div class="card mb-6">
                <h2 style="font-size: 18px; font-weight: 800; margin-bottom: 12px; color: var(--neutral-900);">Portfolio Distribution Matrix - Strategic Positioning</h2>
                <p style="font-size: 13px; color: var(--neutral-600); margin-bottom: 20px;">71 INITIATIVES | CORE vs NON-CORE × INCREMENTAL vs DISRUPTIVE</p>
                <div id="portfolioDistributionMatrix" style="position: relative; height: 550px; width: 100%;"></div>
            </div>

            <!-- Additional Charts -->
            <div class="grid grid-2 mb-6" style="gap: 24px;">
                <div class="card">
                    <h2 style="font-size: 18px; font-weight: 800; margin-bottom: 20px; color: var(--neutral-900);">Delivery Timeline</h2>
                    <canvas id="deliveryChart" style="max-height: 300px;"></canvas>
                </div>
                <div class="card">
                    <h2 style="font-size: 18px; font-weight: 800; margin-bottom: 20px; color: var(--neutral-900);">Tier Distribution</h2>
                    <canvas id="tierChart" style="max-height: 300px;"></canvas>
                </div>
            </div>
        </div>
    `;
}

function renderBCGMaturity() {
    return `
        <div>
            <div class="card mb-6">
                <h2 style="font-size: 18px; font-weight: 800; margin-bottom: 20px; color: var(--neutral-900);">BCG i2i Digital Maturity Assessment</h2>
                <canvas id="maturityRadar" style="max-height: 450px;"></canvas>
            </div>

            <div class="grid grid-3 mb-6" style="gap: 24px;">
                <div class="card">
                    <h3 style="font-size: 16px; font-weight: 700; margin-bottom: 12px; color: var(--petro-green-800);">Strategy</h3>
                    <div style="font-size: 32px; font-weight: 800; color: var(--petro-green-700); margin-bottom: 8px;">3.8</div>
                    <div style="font-size: 13px; color: var(--neutral-600);">Digital strategy & vision alignment</div>
                </div>
                <div class="card">
                    <h3 style="font-size: 16px; font-weight: 700; margin-bottom: 12px; color: var(--blue-700);">Technology</h3>
                    <div style="font-size: 32px; font-weight: 800; color: var(--blue-600); margin-bottom: 8px;">3.5</div>
                    <div style="font-size: 13px; color: var(--neutral-600);">Technology infrastructure & tools</div>
                </div>
                <div class="card">
                    <h3 style="font-size: 16px; font-weight: 700; margin-bottom: 12px; color: var(--petro-gold-700);">People</h3>
                    <div style="font-size: 32px; font-weight: 800; color: var(--petro-gold-600); margin-bottom: 8px;">3.2</div>
                    <div style="font-size: 13px; color: var(--neutral-600);">Talent & capability development</div>
                </div>
            </div>
        </div>
    `;
}

function renderThreeEngines() {
    return `
        <div>
            <div class="grid grid-3 mb-6" style="gap: 24px;">
                <div class="card" style="border-top: 4px solid var(--petro-green-600);">
                    <h3 style="font-size: 18px; font-weight: 800; margin-bottom: 16px; color: var(--petro-green-800);">Engine 1: Run</h3>
                    <div style="font-size: 28px; font-weight: 800; color: var(--petro-green-700); margin-bottom: 8px;">32 Initiatives</div>
                    <div style="font-size: 14px; color: var(--neutral-600); margin-bottom: 20px;">Operational excellence & efficiency</div>
                    <div class="progress-container" style="height: 12px; margin-bottom: 12px;">
                        <div class="progress-bar" style="width: 68%; background: var(--petro-green-600);"></div>
                    </div>
                    <div style="font-size: 13px; font-weight: 600; color: var(--neutral-700);">68% Complete</div>
                </div>
                <div class="card" style="border-top: 4px solid var(--blue-600);">
                    <h3 style="font-size: 18px; font-weight: 800; margin-bottom: 16px; color: var(--blue-800);">Engine 2: Grow</h3>
                    <div style="font-size: 28px; font-weight: 800; color: var(--blue-700); margin-bottom: 8px;">24 Initiatives</div>
                    <div style="font-size: 14px; color: var(--neutral-600); margin-bottom: 20px;">Business growth & market expansion</div>
                    <div class="progress-container" style="height: 12px; margin-bottom: 12px;">
                        <div class="progress-bar" style="width: 52%; background: var(--blue-600);"></div>
                    </div>
                    <div style="font-size: 13px; font-weight: 600; color: var(--neutral-700);">52% Complete</div>
                </div>
                <div class="card" style="border-top: 4px solid var(--petro-gold-600);">
                    <h3 style="font-size: 18px; font-weight: 800; margin-bottom: 16px; color: var(--petro-gold-800);">Engine 3: Transform</h3>
                    <div style="font-size: 28px; font-weight: 800; color: var(--petro-gold-700); margin-bottom: 8px;">15 Initiatives</div>
                    <div style="font-size: 14px; color: var(--neutral-600); margin-bottom: 20px;">Innovation & digital transformation</div>
                    <div class="progress-container" style="height: 12px; margin-bottom: 12px;">
                        <div class="progress-bar" style="width: 38%; background: var(--petro-gold-600);"></div>
                    </div>
                    <div style="font-size: 13px; font-weight: 600; color: var(--neutral-700);">38% Complete</div>
                </div>
            </div>

            <div class="card">
                <h2 style="font-size: 18px; font-weight: 800; margin-bottom: 20px; color: var(--neutral-900);">Investment Allocation by Engine</h2>
                <canvas id="enginesChart" style="max-height: 350px;"></canvas>
            </div>
        </div>
    `;
}

function renderFinancial() {
    const initiatives = getInitiatives();
    const totalBudget = initiatives.reduce((sum, i) => sum + i.budget, 0);
    const totalSpent = totalBudget * 0.42; // Simulated 42% spent
    const roi = 2.8; // Simulated ROI

    return `
        <div>
            <div class="grid grid-4 mb-6">
                <div class="stat-card">
                    <div class="stat-card-header">Total Budget</div>
                    <div class="stat-card-value" style="color: var(--blue-600);">${(totalBudget / 1000000).toFixed(0)}M</div>
                    <div class="stat-card-footer">SAR allocated</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-header">Spent to Date</div>
                    <div class="stat-card-value" style="color: var(--petro-gold-600);">${(totalSpent / 1000000).toFixed(0)}M</div>
                    <div class="stat-card-footer">42% of budget</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-header">Expected ROI</div>
                    <div class="stat-card-value" style="color: var(--petro-green-700);">${roi}x</div>
                    <div class="stat-card-footer">Return on investment</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-header">Projected Value</div>
                    <div class="stat-card-value" style="color: var(--petro-green-700);">${((totalBudget * roi) / 1000000).toFixed(0)}M</div>
                    <div class="stat-card-footer">SAR expected return</div>
                </div>
            </div>

            <div class="grid grid-2 mb-6" style="gap: 24px;">
                <div class="card">
                    <h2 style="font-size: 18px; font-weight: 800; margin-bottom: 20px; color: var(--neutral-900);">Budget Utilization</h2>
                    <canvas id="budgetUtilizationChart" style="max-height: 300px;"></canvas>
                </div>
                <div class="card">
                    <h2 style="font-size: 18px; font-weight: 800; margin-bottom: 20px; color: var(--neutral-900);">ROI by Initiative Tier</h2>
                    <canvas id="roiChart" style="max-height: 300px;"></canvas>
                </div>
            </div>
        </div>
    `;
}

function renderBudget() {
    return `
        <div>
            <div class="card mb-6">
                <h2 style="font-size: 18px; font-weight: 800; margin-bottom: 20px; color: var(--neutral-900);">Budget Variance Analysis</h2>
                <canvas id="varianceChart" style="max-height: 350px;"></canvas>
            </div>

            <div class="grid grid-2 mb-6" style="gap: 24px;">
                <div class="card">
                    <h2 style="font-size: 18px; font-weight: 800; margin-bottom: 20px; color: var(--neutral-900);">Resource Allocation</h2>
                    <canvas id="resourceChart" style="max-height: 300px;"></canvas>
                </div>
                <div class="card">
                    <h2 style="font-size: 18px; font-weight: 800; margin-bottom: 20px; color: var(--neutral-900);">Monthly Burn Rate</h2>
                    <canvas id="burnRateChart" style="max-height: 300px;"></canvas>
                </div>
            </div>
        </div>
    `;
}

function renderRisk() {
    const initiatives = getInitiatives();
    const atRiskCount = initiatives.filter(i => i.status === 'at-risk').length;
    const criticalPathCount = initiatives.filter(i => i.criticalPath).length;

    return `
        <div>
            <div class="grid grid-4 mb-6">
                <div class="stat-card">
                    <div class="stat-card-header">High Risk</div>
                    <div class="stat-card-value" style="color: var(--red-600);">${atRiskCount}</div>
                    <div class="stat-card-footer">Initiatives at risk</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-header">Critical Path</div>
                    <div class="stat-card-value" style="color: var(--petro-gold-600);">${criticalPathCount}</div>
                    <div class="stat-card-footer">Critical initiatives</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-header">Budget Risk</div>
                    <div class="stat-card-value" style="color: var(--red-600);">3</div>
                    <div class="stat-card-footer">Over budget</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-header">Schedule Risk</div>
                    <div class="stat-card-value" style="color: var(--petro-gold-600);">5</div>
                    <div class="stat-card-footer">Behind schedule</div>
                </div>
            </div>

            <div class="card mb-6">
                <h2 style="font-size: 18px; font-weight: 800; margin-bottom: 20px; color: var(--neutral-900);">Risk Heat Map</h2>
                <div id="riskHeatMap" style="position: relative; height: 400px; width: 100%;"></div>
            </div>

            <div class="card">
                <h2 style="font-size: 18px; font-weight: 800; margin-bottom: 20px; color: var(--neutral-900);">Top Risks</h2>
                <div style="display: flex; flex-direction: column; gap: 12px;">
                    ${[
                        { title: 'Resource Constraints', impact: 'High', probability: 'Medium', tier: '1a' },
                        { title: 'Technical Complexity', impact: 'High', probability: 'High', tier: '1b' },
                        { title: 'Vendor Dependencies', impact: 'Medium', probability: 'High', tier: '1c' },
                        { title: 'Change Management', impact: 'High', probability: 'Medium', tier: '1d' },
                        { title: 'Budget Overruns', impact: 'Medium', probability: 'Medium', tier: '1a' }
                    ].map(risk => `
                        <div style="padding: 16px; border: 1px solid var(--neutral-200); border-radius: 8px; background: white;">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                                <strong style="font-weight: 700; color: var(--neutral-900);">${risk.title}</strong>
                                <span class="badge" style="background: var(--neutral-100); color: var(--neutral-700); padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 700;">Tier ${risk.tier}</span>
                            </div>
                            <div style="display: flex; gap: 16px; font-size: 13px; color: var(--neutral-600);">
                                <span><strong>Impact:</strong> <span style="color: ${risk.impact === 'High' ? 'var(--red-600)' : 'var(--petro-gold-600)'};">${risk.impact}</span></span>
                                <span><strong>Probability:</strong> <span style="color: ${risk.probability === 'High' ? 'var(--red-600)' : 'var(--petro-gold-600)'};">${risk.probability}</span></span>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
        </div>
    `;
}

function renderDependencies() {
    const initiatives = getInitiatives();
    const withDeps = initiatives.filter(i => i.dependencies && i.dependencies.length > 0);

    return `
        <div>
            <div class="grid grid-3 mb-6" style="gap: 24px;">
                <div class="stat-card">
                    <div class="stat-card-header">Total Dependencies</div>
                    <div class="stat-card-value" style="color: var(--blue-600);">${withDeps.reduce((sum, i) => sum + i.dependencies.length, 0)}</div>
                    <div class="stat-card-footer">Cross-initiative links</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-header">Critical Dependencies</div>
                    <div class="stat-card-value" style="color: var(--red-600);">12</div>
                    <div class="stat-card-footer">High priority links</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-header">Blocked Items</div>
                    <div class="stat-card-value" style="color: var(--petro-gold-600);">3</div>
                    <div class="stat-card-footer">Awaiting dependencies</div>
                </div>
            </div>

            <div class="card mb-6">
                <h2 style="font-size: 18px; font-weight: 800; margin-bottom: 20px; color: var(--neutral-900);">Dependency Network</h2>
                <div id="dependencyGraph" style="position: relative; height: 450px; width: 100%; background: var(--neutral-50); border-radius: 8px; display: flex; align-items: center; justify-content: center; color: var(--neutral-500);">
                    <div style="text-align: center;">
                        <div style="font-size: 48px; margin-bottom: 16px;">🔗</div>
                        <div style="font-size: 16px; font-weight: 600;">Dependency Network Visualization</div>
                        <div style="font-size: 13px; margin-top: 8px;">Interactive graph showing initiative relationships</div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2 style="font-size: 18px; font-weight: 800; margin-bottom: 20px; color: var(--neutral-900);">Critical Dependencies</h2>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Initiative</th>
                            <th>Depends On</th>
                            <th>Type</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${withDeps.slice(0, 10).map(init =>
                            init.dependencies.map(dep => `
                                <tr>
                                    <td style="font-weight: 600;">${init.id}</td>
                                    <td>${dep}</td>
                                    <td><span class="badge" style="background: var(--blue-100); color: var(--blue-700); padding: 4px 8px; border-radius: 4px; font-size: 11px;">Technical</span></td>
                                    <td><span class="badge" style="background: var(--petro-green-100); color: var(--petro-green-700); padding: 4px 8px; border-radius: 4px; font-size: 11px;">On Track</span></td>
                                </tr>
                            `).join('')
                        ).join('')}
                    </tbody>
                </table>
            </div>
        </div>
    `;
}

function renderPortfolioMatrix() {
    const data = state.store.getData();
    const scored = data.projects.filter(p => p.scores && p.scores.compositeScore);
    
    let html = `
        <div class="matrix-container">
            <div style="position: absolute; top: 16px; left: 50%; transform: translateX(-50%); font-size: 12px; font-weight: 700; color: var(--neutral-600); text-transform: uppercase; letter-spacing: 0.05em;">High Impact</div>
            <div style="position: absolute; bottom: 16px; left: 50%; transform: translateX(-50%); font-size: 12px; font-weight: 700; color: var(--neutral-600); text-transform: uppercase; letter-spacing: 0.05em;">Low Impact</div>
            <div style="position: absolute; left: 16px; top: 50%; transform: translateY(-50%) rotate(-90deg); font-size: 12px; font-weight: 700; color: var(--neutral-600); text-transform: uppercase; letter-spacing: 0.05em;">Low Feasibility</div>
            <div style="position: absolute; right: 16px; top: 50%; transform: translateY(-50%) rotate(-90deg); font-size: 12px; font-weight: 700; color: var(--neutral-600); text-transform: uppercase; letter-spacing: 0.05em;">High Feasibility</div>
    `;
    
    scored.forEach(p => {
        const alignment = p.criteriaValues?.strategic_impact_score || 50;
        const feasibility = p.criteriaValues?.execution_feasibility_score || 50;
        const x = (feasibility / 20) * 85 + 5;
        const y = 95 - ((alignment / 25) * 85 + 5);
        
        html += `<div class="matrix-dot" style="left: ${x}%; top: ${y}%;" onclick="viewProject('${p.id}')" title="${p.criteriaValues?.initiative_name || p.name} (Score: ${p.scores.compositeScore})"></div>`;
    });
    
    return html + '</div>';
}

function renderProjectsTable(topOnly = false) {
    const data = state.store.getData();
    let projects = data.projects
        .filter(p => p.scores && p.scores.compositeScore)
        .sort((a, b) => (a.scores.rank || 999) - (b.scores.rank || 999));
    
    if (topOnly) projects = projects.slice(0, 5);
    
    if (projects.length === 0) {
        return `
            <div style="text-align: center; padding: 60px 20px; color: var(--neutral-500);">
                <div style="font-size: 48px; margin-bottom: 16px;">📊</div>
                <p style="font-size: 16px; font-weight: 600; margin-bottom: 8px;">No Scored Initiatives</p>
                <p style="font-size: 14px;">Create and score initiatives to see them here.</p>
            </div>
        `;
    }
    
    return `
        <table class="data-table">
            <thead>
                <tr>
                    <th style="width: 80px;">Rank</th>
                    <th>Initiative Name</th>
                    <th>Domain</th>
                    <th style="width: 100px;">Score</th>
                    <th style="width: 120px;">Priority</th>
                    <th style="width: 140px;">Investment</th>
                </tr>
            </thead>
            <tbody>
                ${projects.map(p => {
                    const rank = p.scores.rank;
                    const rankClass = rank === 1 ? 'rank-1' : rank === 2 ? 'rank-2' : rank === 3 ? 'rank-3' : 'rank-default';
                    
                    return `
                        <tr onclick="viewProject('${p.id}')">
                            <td><div class="rank-badge ${rankClass}">${rank}</div></td>
                            <td>
                                <div style="font-weight: 700; color: var(--neutral-900); margin-bottom: 4px;">${p.criteriaValues?.initiative_name || p.name}</div>
                                <div style="font-size: 12px; color: var(--neutral-500); font-family: 'JetBrains Mono', monospace;">${p.criteriaValues?.initiative_id}</div>
                            </td>
                            <td>
                                <span class="badge badge-gray">${(p.criteriaValues?.strategic_domain || '').replace(/_/g, ' ')}</span>
                            </td>
                            <td>
                                <div style="font-size: 20px; font-weight: 800; color: var(--petro-orange-600);">${p.scores.compositeScore.toFixed(1)}</div>
                            </td>
                            <td>
                                <span class="badge ${
                                    p.criteriaValues?.strategic_priority === 'p1_critical' ? 'badge-red' :
                                    p.criteriaValues?.strategic_priority === 'p2_high' ? 'badge-orange' :
                                    p.criteriaValues?.strategic_priority === 'p3_medium' ? 'badge-yellow' : 'badge-gray'
                                }">${(p.criteriaValues?.strategic_priority || '').replace(/_/g, ' ').toUpperCase()}</span>
                            </td>
                            <td>
                                <div style="font-weight: 700; color: var(--neutral-900);">${p.criteriaValues?.investment_required ? (p.criteriaValues.investment_required / 1000000).toFixed(1) + 'M SAR' : '—'}</div>
                            </td>
                        </tr>
                    `;
                }).join('')}
            </tbody>
        </table>
    `;
}

function renderProjects() {
    const data = state.store.getData();
    const scored = data.projects.filter(p => p.scores && Object.keys(p.scores).length > 0).length;
    const blocked = data.projects.filter(p => p.status === 'Blocked').length;
    const drafts = data.projects.filter(p => p.status === 'Draft').length;

    return `
        <div class="container" style="padding: 40px 32px;">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 32px;">
                <div>
                    <h1 style="font-size: 32px; margin-bottom: 8px; font-weight: 800;">Initiative Portfolio</h1>
                    <p style="color: var(--neutral-600); font-size: 15px;">${data.projects.length} total initiatives across all stages</p>
                </div>
                <button class="btn btn-gold" onclick="openProjectWizard()">
                    <span>🤖</span> New Initiative
                </button>
            </div>

            <div class="grid grid-4 mb-6">
                <div class="stat-card">
                    <div class="stat-card-header">Total</div>
                    <div class="stat-card-value" style="color: var(--petro-green-800);">${data.projects.length}</div>
                    <div class="stat-card-footer">All initiatives</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-header">Scored</div>
                    <div class="stat-card-value" style="color: var(--blue-600);">${scored}</div>
                    <div class="stat-card-footer">Ready for review</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-header">Blocked</div>
                    <div class="stat-card-value" style="color: var(--red-600);">${blocked}</div>
                    <div class="stat-card-footer">Requires action</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-header">Drafts</div>
                    <div class="stat-card-value" style="color: var(--neutral-500);">${drafts}</div>
                    <div class="stat-card-footer">In progress</div>
                </div>
            </div>

            ${blocked > 0 ? `
                <div class="alert alert-danger mb-6">
                    <div style="font-size: 20px;">⚠️</div>
                    <div>
                        <strong style="font-weight: 700;">Kill-Switch Triggered</strong><br>
                        <span style="font-size: 14px;">${blocked} initiative(s) blocked. Critical risk assessment required before proceeding.</span>
                    </div>
                </div>
            ` : ''}

            <div class="card">
                ${renderProjectsTable(false)}
            </div>
        </div>
    `;
}

// ============================================================================
// ADMIN FUNCTIONS
// ============================================================================

function updateCompanyProfile(field, value) {
    const data = state.store.getData();
    data.adminSettings.companyProfile[field] = value;
    state.store.saveData();
    state.store.addAuditEvent({
        type: 'admin_profile_updated',
        user: state.currentUserName,
        description: `Updated company ${field}`
    });
}

function updateBusinessInfo(field, value) {
    const data = state.store.getData();
    data.adminSettings.businessInfo[field] = value;
    state.store.saveData();
    state.store.addAuditEvent({
        type: 'admin_business_updated',
        user: state.currentUserName,
        description: `Updated business ${field}`
    });
}

function startAddCoCompany() {
    state.editingCompany = {
        id: 'co-' + Date.now(),
        name: '',
        relationship: 'Subsidiary',
        country: '',
        description: ''
    };
    state.adminEditMode = 'company';
    render();
}

function startEditCoCompany(companyId) {
    const data = state.store.getData();
    const company = data.adminSettings.coCompanies.find(c => c.id === companyId);
    if (company) {
        state.editingCompany = JSON.parse(JSON.stringify(company));
        state.adminEditMode = 'company';
        render();
    }
}

function saveCoCompany() {
    const company = state.editingCompany;
    if (!company.name.trim()) {
        alert('Company name is required');
        return;
    }

    const data = state.store.getData();
    const existingIndex = data.adminSettings.coCompanies.findIndex(c => c.id === company.id);

    if (existingIndex >= 0) {
        data.adminSettings.coCompanies[existingIndex] = company;
    } else {
        data.adminSettings.coCompanies.push(company);
    }

    state.store.saveData();
    state.store.addAuditEvent({
        type: 'admin_cocompany_updated',
        user: state.currentUserName,
        description: `${existingIndex >= 0 ? 'Updated' : 'Added'} co-company: ${company.name}`
    });

    cancelEditCoCompany();
}

function deleteCoCompany(companyId) {
    if (!confirm('Are you sure you want to remove this co-company?')) return;

    const data = state.store.getData();
    const company = data.adminSettings.coCompanies.find(c => c.id === companyId);
    data.adminSettings.coCompanies = data.adminSettings.coCompanies.filter(c => c.id !== companyId);

    state.store.saveData();
    state.store.addAuditEvent({
        type: 'admin_cocompany_deleted',
        user: state.currentUserName,
        description: `Removed co-company: ${company?.name}`
    });

    render();
}

function cancelEditCoCompany() {
    state.editingCompany = null;
    state.adminEditMode = null;
    render();
}

function simulateDocumentUpload() {
    const docName = prompt('Enter document name (e.g., "Q4 2024 Strategic Review.pdf"):');
    if (!docName) return;

    const docType = prompt('Enter document type (Strategy/Framework/Report/Policy):') || 'Document';

    const data = state.store.getData();
    const newDoc = {
        id: 'doc-' + Date.now(),
        name: docName,
        type: docType,
        uploadedBy: state.currentUserName,
        uploadedAt: new Date().toISOString(),
        size: (Math.random() * 5 + 0.5).toFixed(1) + ' MB',
        description: ''
    };

    data.adminSettings.documents.unshift(newDoc);
    state.store.saveData();
    state.store.addAuditEvent({
        type: 'admin_document_uploaded',
        user: state.currentUserName,
        description: `Uploaded document: ${docName}`
    });

    render();
}

function deleteDocument(docId) {
    if (!confirm('Are you sure you want to delete this document?')) return;

    const data = state.store.getData();
    const doc = data.adminSettings.documents.find(d => d.id === docId);
    data.adminSettings.documents = data.adminSettings.documents.filter(d => d.id !== docId);

    state.store.saveData();
    state.store.addAuditEvent({
        type: 'admin_document_deleted',
        user: state.currentUserName,
        description: `Deleted document: ${doc?.name}`
    });

    render();
}

function renderAdmin() {
    const data = state.store.getData();

    // Ensure adminSettings exists with full structure
    if (!data.adminSettings) {
        data.adminSettings = {
            companyProfile: {
                companyName: 'Petrolube',
                companyFullName: 'Petrolube Company',
                industry: 'Lubricants & Petroleum Products',
                headquarters: 'Riyadh, Saudi Arabia',
                founded: '1985',
                employees: '500+',
                description: 'Leading lubricants manufacturer in the Middle East',
                vision: 'To be the most trusted lubricants brand in the region',
                mission: 'Delivering premium quality lubricants that exceed customer expectations'
            },
            coCompanies: [],
            businessInfo: {
                taxId: 'SAT-300123456789',
                registrationNumber: 'CR-1234567890',
                fiscalYearStart: 'January',
                currency: 'SAR',
                timezone: 'Asia/Riyadh',
                website: 'www.petrolube.com',
                contactEmail: 'info@petrolube.com',
                contactPhone: '+966 11 234 5678'
            },
            documents: []
        };
        state.store.saveData();
    }

    const admin = data.adminSettings;

    if (state.adminEditMode === 'company') {
        return renderCoCompanyEditor();
    }

    return `
        <div class="container" style="padding: 40px 32px;">
            <div style="margin-bottom: 40px;">
                <h1 style="font-size: 32px; margin-bottom: 8px; font-weight: 800;">Admin Settings</h1>
                <p style="color: var(--neutral-600); font-size: 15px;">Manage company information, co-companies, and strategic documents</p>
            </div>

            <!-- Company Profile Section -->
            <div class="card" style="margin-bottom: 32px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; padding-bottom: 20px; border-bottom: 1px solid var(--neutral-200);">
                    <div>
                        <h2 style="font-size: 22px; font-weight: 800; color: var(--neutral-900); margin-bottom: 4px;">🏢 Company Profile</h2>
                        <p style="font-size: 14px; color: var(--neutral-600);">Core business identity and information</p>
                    </div>
                </div>

                <div class="grid grid-2" style="gap: 24px;">
                    <div class="form-group">
                        <label class="form-label">Company Name</label>
                        <input type="text" class="form-control" value="${admin.companyProfile.companyName}"
                               oninput="updateCompanyProfile('companyName', this.value)">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Full Legal Name</label>
                        <input type="text" class="form-control" value="${admin.companyProfile.companyFullName}"
                               oninput="updateCompanyProfile('companyFullName', this.value)">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Industry</label>
                        <input type="text" class="form-control" value="${admin.companyProfile.industry}"
                               oninput="updateCompanyProfile('industry', this.value)">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Headquarters</label>
                        <input type="text" class="form-control" value="${admin.companyProfile.headquarters}"
                               oninput="updateCompanyProfile('headquarters', this.value)">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Founded</label>
                        <input type="text" class="form-control" value="${admin.companyProfile.founded}"
                               oninput="updateCompanyProfile('founded', this.value)">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Employees</label>
                        <input type="text" class="form-control" value="${admin.companyProfile.employees}"
                               oninput="updateCompanyProfile('employees', this.value)">
                    </div>
                    <div class="form-group" style="grid-column: span 2;">
                        <label class="form-label">Company Description</label>
                        <textarea class="form-control" rows="2"
                                  oninput="updateCompanyProfile('description', this.value)">${admin.companyProfile.description}</textarea>
                    </div>
                    <div class="form-group" style="grid-column: span 2;">
                        <label class="form-label">Vision Statement</label>
                        <textarea class="form-control" rows="2"
                                  oninput="updateCompanyProfile('vision', this.value)">${admin.companyProfile.vision}</textarea>
                    </div>
                    <div class="form-group" style="grid-column: span 2;">
                        <label class="form-label">Mission Statement</label>
                        <textarea class="form-control" rows="2"
                                  oninput="updateCompanyProfile('mission', this.value)">${admin.companyProfile.mission}</textarea>
                    </div>
                </div>
            </div>

            <!-- Co-Companies Section -->
            <div class="card" style="margin-bottom: 32px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; padding-bottom: 20px; border-bottom: 1px solid var(--neutral-200);">
                    <div>
                        <h2 style="font-size: 22px; font-weight: 800; color: var(--neutral-900); margin-bottom: 4px;">🤝 Co-Companies & Subsidiaries</h2>
                        <p style="font-size: 14px; color: var(--neutral-600);">${admin.coCompanies.length} related entities</p>
                    </div>
                    <button class="btn btn-primary" onclick="startAddCoCompany()">+ Add Co-Company</button>
                </div>

                <div class="grid grid-2" style="gap: 16px;">
                    ${admin.coCompanies.map(company => `
                        <div class="card" style="border: 1px solid var(--neutral-200); margin: 0;">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                                <div style="flex: 1;">
                                    <h3 style="font-size: 16px; font-weight: 700; color: var(--neutral-900); margin-bottom: 4px;">${company.name}</h3>
                                    <span class="badge badge-blue" style="margin-bottom: 8px;">${company.relationship}</span>
                                </div>
                            </div>
                            <div style="font-size: 13px; color: var(--neutral-600); margin-bottom: 8px;">
                                <strong>Country:</strong> ${company.country}
                            </div>
                            <div style="font-size: 13px; color: var(--neutral-600); margin-bottom: 12px;">
                                ${company.description}
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button class="btn btn-secondary btn-sm" onclick="startEditCoCompany('${company.id}')" style="flex: 1;">Edit</button>
                                <button class="btn btn-secondary btn-sm" onclick="deleteCoCompany('${company.id}')" style="color: var(--red-600);">Remove</button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>

            <!-- Business Information Section -->
            <div class="card" style="margin-bottom: 32px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; padding-bottom: 20px; border-bottom: 1px solid var(--neutral-200);">
                    <div>
                        <h2 style="font-size: 22px; font-weight: 800; color: var(--neutral-900); margin-bottom: 4px;">📋 Business Information</h2>
                        <p style="font-size: 14px; color: var(--neutral-600);">Legal and operational details</p>
                    </div>
                </div>

                <div class="grid grid-2" style="gap: 24px;">
                    <div class="form-group">
                        <label class="form-label">Tax ID</label>
                        <input type="text" class="form-control" value="${admin.businessInfo.taxId}"
                               oninput="updateBusinessInfo('taxId', this.value)">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Registration Number</label>
                        <input type="text" class="form-control" value="${admin.businessInfo.registrationNumber}"
                               oninput="updateBusinessInfo('registrationNumber', this.value)">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Fiscal Year Start</label>
                        <select class="form-control" onchange="updateBusinessInfo('fiscalYearStart', this.value)">
                            ${['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'].map(month => `
                                <option value="${month}" ${admin.businessInfo.fiscalYearStart === month ? 'selected' : ''}>${month}</option>
                            `).join('')}
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Currency</label>
                        <select class="form-control" onchange="updateBusinessInfo('currency', this.value)">
                            ${['SAR', 'USD', 'EUR', 'AED', 'GBP'].map(curr => `
                                <option value="${curr}" ${admin.businessInfo.currency === curr ? 'selected' : ''}>${curr}</option>
                            `).join('')}
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Timezone</label>
                        <input type="text" class="form-control" value="${admin.businessInfo.timezone}"
                               oninput="updateBusinessInfo('timezone', this.value)">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Website</label>
                        <input type="text" class="form-control" value="${admin.businessInfo.website}"
                               oninput="updateBusinessInfo('website', this.value)">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Contact Email</label>
                        <input type="email" class="form-control" value="${admin.businessInfo.contactEmail}"
                               oninput="updateBusinessInfo('contactEmail', this.value)">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Contact Phone</label>
                        <input type="tel" class="form-control" value="${admin.businessInfo.contactPhone}"
                               oninput="updateBusinessInfo('contactPhone', this.value)">
                    </div>
                </div>
            </div>

            <!-- Documents Section -->
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; padding-bottom: 20px; border-bottom: 1px solid var(--neutral-200);">
                    <div>
                        <h2 style="font-size: 22px; font-weight: 800; color: var(--neutral-900); margin-bottom: 4px;">📄 Strategic Documents</h2>
                        <p style="font-size: 14px; color: var(--neutral-600);">${admin.documents.length} documents uploaded</p>
                    </div>
                    <button class="btn btn-primary" onclick="simulateDocumentUpload()">📤 Upload Document</button>
                </div>

                ${admin.documents.length === 0 ? `
                    <div style="text-align: center; padding: 60px 40px; background: var(--neutral-50); border-radius: 10px; border: 2px dashed var(--neutral-300);">
                        <div style="font-size: 48px; margin-bottom: 16px; opacity: 0.3;">📄</div>
                        <p style="color: var(--neutral-500); font-size: 15px; margin-bottom: 20px;">No documents uploaded yet</p>
                        <button class="btn btn-primary" onclick="simulateDocumentUpload()">Upload First Document</button>
                    </div>
                ` : `
                    <div style="display: flex; flex-direction: column; gap: 12px;">
                        ${admin.documents.map(doc => `
                            <div class="card" style="margin: 0; padding: 16px; border: 1px solid var(--neutral-200); display: flex; justify-content: space-between; align-items: center;">
                                <div style="display: flex; align-items: center; gap: 16px; flex: 1;">
                                    <div style="width: 48px; height: 48px; background: var(--petro-green-50); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 24px;">
                                        📄
                                    </div>
                                    <div style="flex: 1;">
                                        <div style="font-size: 15px; font-weight: 700; color: var(--neutral-900); margin-bottom: 4px;">${doc.name}</div>
                                        <div style="font-size: 13px; color: var(--neutral-600);">
                                            <span class="badge badge-orange" style="margin-right: 8px;">${doc.type}</span>
                                            <span>${doc.size}</span>
                                            <span style="margin: 0 8px;">•</span>
                                            <span>Uploaded by ${doc.uploadedBy}</span>
                                            <span style="margin: 0 8px;">•</span>
                                            <span>${new Date(doc.uploadedAt).toLocaleDateString()}</span>
                                        </div>
                                    </div>
                                </div>
                                <div style="display: flex; gap: 8px;">
                                    <button class="btn btn-secondary btn-sm">Download</button>
                                    <button class="btn btn-secondary btn-sm" onclick="deleteDocument('${doc.id}')" style="color: var(--red-600);">Delete</button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `}
            </div>
        </div>
    `;
}

// ============================================================================
// TRACKING PAGE - GANTT CHART
// ============================================================================

// Helper function to calculate initiative status and progress
function calculateInitiativeStatus(initiative) {
    const now = new Date('2025-12-15'); // Current date
    const startDate = new Date(initiative.start + '-01');
    const endDate = new Date(initiative.end + '-01');
    endDate.setMonth(endDate.getMonth() + 1); // End of month

    const totalDuration = endDate - startDate;
    const elapsed = now - startDate;
    const progress = Math.max(0, Math.min(100, Math.round((elapsed / totalDuration) * 100)));

    let status;
    if (now < startDate) {
        status = 'not-started';
    } else if (now > endDate) {
        status = 'completed';
    } else if (initiative.criticalPath && progress < 50) {
        status = 'at-risk';
    } else if (progress < 30) {
        status = 'at-risk';
    } else {
        status = 'in-progress';
    }

    return { status, progress };
}

function renderTracking() {
    const filters = state.ganttFilters;

    // Add status and progress to all initiatives
    const enrichedInitiatives = INITIATIVES_DATA.map(init => ({
        ...init,
        ...calculateInitiativeStatus(init)
    }));

    // Filter initiatives
    let filteredInitiatives = enrichedInitiatives.slice();

    if (filters.tier !== 'all') {
        filteredInitiatives = filteredInitiatives.filter(init => init.tier === filters.tier);
    }

    if (filters.showCriticalPath) {
        filteredInitiatives = filteredInitiatives.filter(init => init.criticalPath);
    }

    if (filters.showDependencies) {
        filteredInitiatives = filteredInitiatives.filter(init => init.dependencies && init.dependencies.length > 0);
    }

    if (filters.searchQuery) {
        const query = filters.searchQuery.toLowerCase();
        filteredInitiatives = filteredInitiatives.filter(init =>
            init.id.toLowerCase().includes(query) ||
            init.name.toLowerCase().includes(query) ||
            init.owner.toLowerCase().includes(query)
        );
    }

    // Group by tier
    const tierGroups = {
        '1a': { name: 'Tier 1A - Strategic Initiatives', initiatives: [], color: 'var(--petro-green-700)' },
        '1b': { name: 'Tier 1B - High Priority', initiatives: [], color: 'var(--petro-green-600)' },
        '1c': { name: 'Tier 1C - Medium Priority', initiatives: [], color: 'var(--blue-600)' },
        '1d': { name: 'Tier 1D - Lower Priority', initiatives: [], color: 'var(--petro-orange-600)' },
        'contingent': { name: 'Contingent - Conditional Initiatives', initiatives: [], color: 'var(--neutral-500)' }
    };

    filteredInitiatives.forEach(init => {
        if (tierGroups[init.tier]) {
            tierGroups[init.tier].initiatives.push(init);
        }
    });

    // Calculate statistics
    const stats = {
        total: filteredInitiatives.length,
        inProgress: filteredInitiatives.filter(i => i.status === 'in-progress').length,
        atRisk: filteredInitiatives.filter(i => i.status === 'at-risk').length,
        completed: filteredInitiatives.filter(i => i.status === 'completed').length,
        notStarted: filteredInitiatives.filter(i => i.status === 'not-started').length,
        criticalPath: filteredInitiatives.filter(i => i.criticalPath).length,
        totalBudget: filteredInitiatives.reduce((sum, i) => sum + i.budget, 0)
    };

    // Calculate today marker position (Dec 15 = month 11, mid-month = 11.5)
    const todayPosition = ((11 + 0.5) / 12) * 100;

    const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

    return `
        <div class="container" style="padding: 40px 32px;">
            <div style="margin-bottom: 32px; display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h1 style="margin-bottom: 8px;">Initiative Tracking & Timeline</h1>
                    <p style="color: var(--neutral-600); font-size: 15px;">2025 Portfolio Gantt Chart - ${stats.total} Initiatives</p>
                </div>
                <div class="view-toggle">
                    <button class="view-toggle-btn active">Detailed View</button>
                    <button class="view-toggle-btn" onclick="alert('Summary view coming soon!')">Summary View</button>
                </div>
            </div>

            <!-- Status Statistics -->
            <div class="gantt-stats">
                <div class="gantt-stat">
                    <div class="gantt-stat-label">Total Initiatives</div>
                    <div class="gantt-stat-value">${stats.total}</div>
                </div>
                <div class="gantt-stat" style="border-left-color: var(--blue-600);">
                    <div class="gantt-stat-label">In Progress</div>
                    <div class="gantt-stat-value">${stats.inProgress}</div>
                </div>
                <div class="gantt-stat" style="border-left-color: var(--red-600);">
                    <div class="gantt-stat-label">At Risk</div>
                    <div class="gantt-stat-value">${stats.atRisk}</div>
                </div>
                <div class="gantt-stat" style="border-left-color: var(--petro-green-700);">
                    <div class="gantt-stat-label">Completed</div>
                    <div class="gantt-stat-value">${stats.completed}</div>
                </div>
                <div class="gantt-stat" style="border-left-color: var(--neutral-400);">
                    <div class="gantt-stat-label">Not Started</div>
                    <div class="gantt-stat-value">${stats.notStarted}</div>
                </div>
                <div class="gantt-stat" style="border-left-color: var(--petro-gold-600);">
                    <div class="gantt-stat-label">Total Budget</div>
                    <div class="gantt-stat-value">$${(stats.totalBudget / 1000000).toFixed(0)}M</div>
                </div>
            </div>

            <!-- Filters and Controls -->
            <div class="gantt-wrapper">
                <div class="gantt-controls">
                    <div class="gantt-control-group">
                        <label>Tier Filter:</label>
                        <select class="form-control" style="width: 150px;" value="${filters.tier}" onchange="updateGanttFilter('tier', this.value)">
                            <option value="all">All Tiers</option>
                            <option value="1a">Tier 1A</option>
                            <option value="1b">Tier 1B</option>
                            <option value="1c">Tier 1C</option>
                            <option value="1d">Tier 1D</option>
                            <option value="contingent">Contingent</option>
                        </select>
                    </div>

                    <label class="gantt-checkbox">
                        <input type="checkbox" ${filters.showCriticalPath ? 'checked' : ''} onchange="updateGanttFilter('showCriticalPath', this.checked)">
                        <span>Critical Path Only</span>
                    </label>

                    <label class="gantt-checkbox">
                        <input type="checkbox" ${filters.showDependencies ? 'checked' : ''} onchange="updateGanttFilter('showDependencies', this.checked)">
                        <span>Has Dependencies</span>
                    </label>

                    <div class="gantt-search">
                        <input type="text" class="form-control" placeholder="Search initiatives..." value="${filters.searchQuery}" oninput="updateGanttFilter('searchQuery', this.value)">
                    </div>

                    ${filters.tier !== 'all' || filters.showCriticalPath || filters.showDependencies || filters.searchQuery ?
                        `<button class="btn btn-secondary btn-sm" onclick="clearGanttFilters()">Clear Filters</button>` : ''}
                </div>

                <!-- Gantt Chart with Grouping -->
                <div class="gantt-container">
                    <table class="gantt-table">
                        <thead>
                            <tr>
                                <th style="width: 120px;">ID</th>
                                <th style="width: 280px;">Initiative Name</th>
                                <th style="width: 110px;">Status</th>
                                <th style="width: 100px;">Progress</th>
                                <th style="width: 140px;">Owner</th>
                                <th style="width: 100px;">Budget</th>
                                <th style="width: 900px; position: relative;">
                                    <div style="text-align: center; margin-bottom: 8px; font-weight: 700;">2025 Timeline (Today: Dec 15)</div>
                                    <div style="display: flex;">
                                        ${months.map((month, idx) => `
                                            <div style="flex: 1; text-align: center; font-size: 11px; font-weight: 600; padding: 4px; ${[0, 3, 6, 9].includes(idx) ? 'background: var(--petro-gold-100); border-left: 2px solid var(--petro-gold-500);' : ''}">${month}</div>
                                        `).join('')}
                                    </div>
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            ${Object.entries(tierGroups).map(([tier, group]) => {
                                if (group.initiatives.length === 0) return '';
                                const isCollapsed = state.ganttCollapsed[tier];
                                return `
                                    <tr class="tier-group-header" onclick="toggleTierGroup('${tier}')">
                                        <td colspan="7" style="color: ${group.color};">
                                            <span class="tier-chevron ${isCollapsed ? 'collapsed' : ''}">▼</span>
                                            ${group.name} (${group.initiatives.length})
                                        </td>
                                    </tr>
                                    ${group.initiatives.map(init => renderGanttRow(init, isCollapsed, todayPosition)).join('')}
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    `;
}

function renderGanttRow(initiative, isCollapsed, todayPosition) {
    const tierClass = `tier-${initiative.tier}`;
    const statusClass = `status-${initiative.status}`;
    const rowClass = initiative.status === 'at-risk' ? 'at-risk-row' : '';

    // Calculate timeline position (months 0-11 for Jan-Dec 2025)
    const startMonth = parseInt(initiative.start.split('-')[1]) - 1; // 0-indexed
    const endMonth = parseInt(initiative.end.split('-')[1]) - 1;
    const duration = endMonth - startMonth + 1;

    // Position calculations (each month is 1/12 of the width)
    const leftPercent = (startMonth / 12) * 100;
    const widthPercent = (duration / 12) * 100;

    // Status labels
    const statusLabels = {
        'not-started': 'Not Started',
        'in-progress': 'In Progress',
        'at-risk': 'At Risk',
        'completed': 'Completed'
    };

    // Progress bar class
    const progressBarClass = initiative.status === 'at-risk' ? 'at-risk' : (initiative.status === 'completed' ? 'completed' : '');

    return `
        <tr class="${rowClass} ${isCollapsed ? 'tier-group-collapsed' : ''}">
            <td class="initiative-id">${initiative.id}</td>
            <td class="initiative-name">${initiative.name}</td>
            <td>
                <span class="status-badge ${statusClass}">${statusLabels[initiative.status]}</span>
            </td>
            <td>
                <div style="display: flex; align-items: center; gap: 8px;">
                    <div class="progress-container">
                        <div class="progress-bar ${progressBarClass}" style="width: ${initiative.progress}%;"></div>
                    </div>
                    <span style="font-size: 12px; font-weight: 600; color: var(--neutral-700); min-width: 35px;">${initiative.progress}%</span>
                </div>
            </td>
            <td style="font-size: 12px; color: var(--neutral-600);">${initiative.owner}</td>
            <td style="font-size: 12px; font-weight: 600;">$${(initiative.budget / 1000000).toFixed(1)}M</td>
            <td class="timeline-cell">
                <div class="timeline-grid">
                    ${[0, 3, 6, 9].map(quarterStart => `
                        <div class="timeline-quarter-marker" style="left: ${(quarterStart / 12) * 100}%;"></div>
                    `).join('')}
                    ${Array(12).fill(0).map((_, i) => '<div class="timeline-month"></div>').join('')}
                    <div class="today-marker" style="left: ${todayPosition}%;"></div>
                </div>
                <div class="gantt-bar ${tierClass} ${initiative.criticalPath ? 'critical-path' : ''} ${initiative.dependencies && initiative.dependencies.length > 0 ? 'has-dependencies' : ''}"
                     style="left: ${leftPercent}%; width: ${widthPercent}%;"
                     onmouseenter="showGanttTooltip(event, ${JSON.stringify(initiative).replace(/"/g, '&quot;')})"
                     onmouseleave="hideGanttTooltip()">
                    ${duration >= 2 ? initiative.progress + '%' : ''}
                </div>
            </td>
        </tr>
    `;
}

// Gantt Filter Functions
function updateGanttFilter(key, value) {
    state.ganttFilters[key] = value;
    render();
}

function clearGanttFilters() {
    state.ganttFilters = {
        tier: 'all',
        showCriticalPath: false,
        showDependencies: false,
        searchQuery: ''
    };
    render();
}

function toggleTierGroup(tier) {
    state.ganttCollapsed[tier] = !state.ganttCollapsed[tier];
    render();
}

// Tooltip Functions
let tooltipTimeout;
function showGanttTooltip(event, initiative) {
    clearTimeout(tooltipTimeout);

    const tooltip = document.getElementById('gantt-tooltip');
    if (!tooltip) {
        const newTooltip = document.createElement('div');
        newTooltip.id = 'gantt-tooltip';
        newTooltip.className = 'gantt-tooltip';
        document.body.appendChild(newTooltip);
    }

    tooltipTimeout = setTimeout(() => {
        const tooltipEl = document.getElementById('gantt-tooltip');

        // Status labels and colors
        const statusInfo = {
            'not-started': { label: 'Not Started', color: 'var(--neutral-600)' },
            'in-progress': { label: 'In Progress', color: 'var(--blue-600)' },
            'at-risk': { label: 'At Risk ⚠️', color: 'var(--red-600)' },
            'completed': { label: 'Completed ✓', color: 'var(--petro-green-700)' }
        };

        const status = statusInfo[initiative.status] || statusInfo['in-progress'];

        tooltipEl.innerHTML = `
            <div class="gantt-tooltip-title">${initiative.name}</div>
            <div class="gantt-tooltip-detail"><strong>ID:</strong> ${initiative.id}</div>
            <div class="gantt-tooltip-detail"><strong>Tier:</strong> ${initiative.tier.toUpperCase()}</div>
            <div class="gantt-tooltip-detail" style="color: ${status.color}; font-weight: 700;"><strong>Status:</strong> ${status.label}</div>
            <div class="gantt-tooltip-detail"><strong>Progress:</strong> ${initiative.progress}% complete</div>
            <div class="gantt-tooltip-detail"><strong>Owner:</strong> ${initiative.owner}</div>
            <div class="gantt-tooltip-detail"><strong>Duration:</strong> ${initiative.duration} months (${initiative.start} to ${initiative.end})</div>
            <div class="gantt-tooltip-detail"><strong>Budget:</strong> $${(initiative.budget / 1000000).toFixed(2)}M</div>
            ${initiative.criticalPath ? '<div class="gantt-tooltip-detail" style="color: var(--red-600); font-weight: 700;">⚠️ Critical Path Initiative</div>' : ''}
            ${initiative.dependencies && initiative.dependencies.length > 0 ? `<div class="gantt-tooltip-detail"><strong>Dependencies:</strong> ${initiative.dependencies.join(', ')}</div>` : ''}
        `;

        tooltipEl.style.display = 'block';
        tooltipEl.style.left = (event.pageX + 15) + 'px';
        tooltipEl.style.top = (event.pageY + 15) + 'px';
        tooltipEl.classList.add('visible');
    }, 300);
}

function hideGanttTooltip() {
    clearTimeout(tooltipTimeout);
    const tooltip = document.getElementById('gantt-tooltip');
    if (tooltip) {
        tooltip.classList.remove('visible');
        setTimeout(() => {
            tooltip.style.display = 'none';
        }, 200);
    }
}

function renderCoCompanyEditor() {
    const company = state.editingCompany;

    return `
        <div class="container" style="padding: 40px 32px; max-width: 800px;">
            <div style="margin-bottom: 32px;">
                <h1 style="font-size: 32px; margin-bottom: 8px; font-weight: 800;">
                    ${company.name ? 'Edit Co-Company' : 'Add Co-Company'}
                </h1>
                <p style="color: var(--neutral-600); font-size: 15px;">Configure related entity information</p>
            </div>

            <div class="card">
                <div class="form-group">
                    <label class="form-label required">Company Name</label>
                    <input type="text" class="form-control" value="${company.name}"
                           oninput="state.editingCompany.name = this.value; render();"
                           placeholder="e.g., Petrolube Distribution">
                </div>

                <div class="form-group">
                    <label class="form-label">Relationship</label>
                    <select class="form-control" onchange="state.editingCompany.relationship = this.value; render();">
                        ${['Subsidiary', 'Joint Venture', 'Partner', 'Affiliate', 'Division'].map(rel => `
                            <option value="${rel}" ${company.relationship === rel ? 'selected' : ''}>${rel}</option>
                        `).join('')}
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Country</label>
                    <input type="text" class="form-control" value="${company.country}"
                           oninput="state.editingCompany.country = this.value; render();"
                           placeholder="e.g., Saudi Arabia">
                </div>

                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea class="form-control" rows="3"
                              oninput="state.editingCompany.description = this.value; render();"
                              placeholder="Brief description of the company and its role">${company.description}</textarea>
                </div>
            </div>

            <div style="display: flex; gap: 12px; margin-top: 24px;">
                <button class="btn btn-secondary btn-lg" onclick="cancelEditCoCompany()">Cancel</button>
                <button class="btn btn-primary btn-lg btn-block" onclick="saveCoCompany()">
                    ${company.name ? 'Update' : 'Add'} Co-Company
                </button>
            </div>
        </div>
    `;
}

// ============================================================================
// TEMPLATE BUILDER FUNCTIONS
// ============================================================================

function startCreateTemplate() {
    state.templateBuilderMode = 'create';
    state.editingTemplate = {
        id: 'template-' + Date.now(),
        name: '',
        fields: [],
        is_published: true,
        created_at: new Date().toISOString()
    };
    render();
}

function startEditTemplate(templateId) {
    const data = state.store.getData();
    const template = data.templates.find(t => t.id === templateId);
    if (template) {
        state.templateBuilderMode = 'edit';
        state.editingTemplate = JSON.parse(JSON.stringify(template)); // Deep copy
        render();
    }
}

function duplicateTemplate(templateId) {
    const data = state.store.getData();
    const template = data.templates.find(t => t.id === templateId);
    if (template) {
        state.templateBuilderMode = 'create';
        state.editingTemplate = {
            ...JSON.parse(JSON.stringify(template)),
            id: 'template-' + Date.now(),
            name: template.name + ' (Copy)',
            created_at: new Date().toISOString()
        };
        render();
    }
}

function cancelTemplateBuilder() {
    state.templateBuilderMode = null;
    state.editingTemplate = null;
    state.showFieldEditor = false;
    state.editingField = null;
    state.editingFieldIndex = null;
    render();
}

function saveTemplateFromBuilder() {
    const template = state.editingTemplate;

    if (!template.name.trim()) {
        alert('Template name is required');
        return;
    }

    if (template.fields.length === 0) {
        alert('Add at least one field');
        return;
    }

    const scoringFields = template.fields.filter(f => f.is_scoring);
    const totalWeight = scoringFields.reduce((sum, f) => sum + f.weight, 0);

    if (totalWeight !== 100) {
        alert(`Scoring weight total must equal 100% (currently ${totalWeight}%)`);
        return;
    }

    state.store.saveTemplate(template);
    cancelTemplateBuilder();
}

function openFieldEditor(fieldIndex = null) {
    if (fieldIndex !== null) {
        state.editingField = JSON.parse(JSON.stringify(state.editingTemplate.fields[fieldIndex]));
        state.editingFieldIndex = fieldIndex;
    } else {
        state.editingField = {
            id: 'field-' + Date.now(),
            type: 'text',
            label: '',
            key: '',
            required: false,
            is_scoring: false,
            weight: 0,
            threshold: null,
            category: '',
            config: {}
        };
        state.editingFieldIndex = null;
    }
    state.showFieldEditor = true;
    render();
}

function closeFieldEditor() {
    state.showFieldEditor = false;
    state.editingField = null;
    state.editingFieldIndex = null;
    render();
}

function saveField() {
    const field = state.editingField;

    if (!field.label.trim() || !field.key.trim()) {
        alert('Label and Key are required');
        return;
    }

    // Validate dropdown options
    if (field.type === 'dropdown') {
        const validOptions = field.config.options.filter(o => o.value && o.label);
        if (validOptions.length === 0) {
            alert('Add at least one dropdown option');
            return;
        }
        field.config.options = validOptions;
    }

    // Set config for number/currency fields
    if (field.type === 'number' || field.type === 'currency') {
        field.config = {
            min: Number(field.config.min) || 0,
            max: Number(field.config.max) || 100
        };
    }

    // Ensure weight is 0 if not scoring
    if (!field.is_scoring) {
        field.weight = 0;
    }

    if (state.editingFieldIndex !== null) {
        // Update existing field
        state.editingTemplate.fields[state.editingFieldIndex] = field;
    } else {
        // Add new field
        state.editingTemplate.fields.push(field);
    }

    closeFieldEditor();
}

function removeField(fieldIndex) {
    if (confirm('Remove this field?')) {
        state.editingTemplate.fields.splice(fieldIndex, 1);
        render();
    }
}

function moveField(fieldIndex, direction) {
    const fields = state.editingTemplate.fields;
    const newIndex = direction === 'up' ? fieldIndex - 1 : fieldIndex + 1;

    if (newIndex >= 0 && newIndex < fields.length) {
        [fields[fieldIndex], fields[newIndex]] = [fields[newIndex], fields[fieldIndex]];
        render();
    }
}

function updateFieldEditorProperty(property, value) {
    if (property.includes('.')) {
        const [parent, child] = property.split('.');
        if (!state.editingField[parent]) {
            state.editingField[parent] = {};
        }
        state.editingField[parent][child] = value;
    } else {
        state.editingField[property] = value;
    }

    // Auto-generate key from label
    if (property === 'label') {
        state.editingField.key = value.toLowerCase()
            .replace(/^\d+\.\s*/, '') // Remove numbering
            .replace(/\s+/g, '_')
            .replace(/[^a-z0-9_]/g, '');
    }

    render();
}

function addDropdownOption() {
    if (!state.editingField.config.options) {
        state.editingField.config.options = [];
    }
    state.editingField.config.options.push({ value: '', label: '', points: 0 });
    render();
}

function removeDropdownOption(index) {
    state.editingField.config.options.splice(index, 1);
    render();
}

function updateDropdownOption(index, property, value) {
    state.editingField.config.options[index][property] = value;
    render();
}

function renderFieldEditorModal() {
    const field = state.editingField;
    if (!field) return '';

    const isEditing = state.editingFieldIndex !== null;

    return `
        <div class="modal" style="display: flex;">
            <div class="modal-content" style="max-width: 800px;">
                <div class="modal-header">
                    <h2>${isEditing ? 'Edit Field' : 'Add Field'}</h2>
                    <button class="modal-close" onclick="closeFieldEditor()">×</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label class="form-label">Field Type</label>
                        <select class="form-control" onchange="updateFieldEditorProperty('type', this.value)">
                            <option value="text" ${field.type === 'text' ? 'selected' : ''}>Text</option>
                            <option value="number" ${field.type === 'number' ? 'selected' : ''}>Number</option>
                            <option value="currency" ${field.type === 'currency' ? 'selected' : ''}>Currency (SAR)</option>
                            <option value="dropdown" ${field.type === 'dropdown' ? 'selected' : ''}>Dropdown</option>
                            <option value="date" ${field.type === 'date' ? 'selected' : ''}>Date</option>
                            <option value="yesno" ${field.type === 'yesno' ? 'selected' : ''}>Yes/No</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Label (Display Name)</label>
                        <input type="text" class="form-control" value="${field.label}"
                               oninput="updateFieldEditorProperty('label', this.value)"
                               placeholder="e.g., 7. Strategic Priority">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Key (Internal Identifier - no spaces)</label>
                        <input type="text" class="form-control" value="${field.key}"
                               oninput="updateFieldEditorProperty('key', this.value.toLowerCase().replace(/\\s+/g, '_'))"
                               placeholder="e.g., strategic_priority">
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px;">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 12px; background: var(--neutral-50); border-radius: 8px; border: 1px solid var(--neutral-200);">
                            <input type="checkbox" ${field.required ? 'checked' : ''}
                                   onchange="updateFieldEditorProperty('required', this.checked)">
                            <span style="font-weight: 600; color: var(--neutral-800); font-size: 14px;">Required field</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 12px; background: var(--neutral-50); border-radius: 8px; border: 1px solid var(--neutral-200);">
                            <input type="checkbox" ${field.is_scoring ? 'checked' : ''}
                                   onchange="updateFieldEditorProperty('is_scoring', this.checked)">
                            <span style="font-weight: 600; color: var(--neutral-800); font-size: 14px;">Use for scoring</span>
                        </label>
                    </div>

                    ${field.is_scoring ? `
                        <div style="background: var(--petro-green-50); border: 2px solid var(--petro-green-200); border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                            <h3 style="font-weight: 700; color: var(--petro-green-800); margin-bottom: 16px; font-size: 16px;">Scoring Configuration</h3>
                            <div class="form-group">
                                <label class="form-label">Weight (%)</label>
                                <input type="number" class="form-control" value="${field.weight}"
                                       oninput="updateFieldEditorProperty('weight', Number(this.value))"
                                       placeholder="e.g., 25" min="0" max="100">
                            </div>

                            ${(field.type === 'number' || field.type === 'currency') ? `
                                <div class="form-group">
                                    <label class="form-label">Threshold (Optional - for pass/fail scoring)</label>
                                    <input type="number" class="form-control" value="${field.threshold || ''}"
                                           oninput="updateFieldEditorProperty('threshold', this.value ? Number(this.value) : null)"
                                           placeholder="e.g., 15 (for IRR >= 15%)">
                                </div>
                                <div class="alert alert-info" style="margin-bottom: 0;">
                                    ${field.threshold !== null && field.threshold !== undefined && field.threshold !== '' ? `
                                        <strong>Threshold Mode:</strong> Value ≥ ${field.threshold} = 100 points, below = 0 points
                                    ` : `
                                        <strong>Normalization Mode:</strong> Value normalized to 0-100 scale based on min/max
                                    `}
                                </div>
                            ` : ''}
                        </div>
                    ` : ''}

                    ${(field.type === 'number' || field.type === 'currency') ? `
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px;">
                            <div class="form-group">
                                <label class="form-label">Min Value</label>
                                <input type="number" class="form-control" value="${field.config.min || 0}"
                                       oninput="updateFieldEditorProperty('config.min', Number(this.value))">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Max Value</label>
                                <input type="number" class="form-control" value="${field.config.max || 100}"
                                       oninput="updateFieldEditorProperty('config.max', Number(this.value))">
                            </div>
                        </div>
                    ` : ''}

                    ${field.type === 'dropdown' ? `
                        <div class="form-group">
                            <label class="form-label">
                                Dropdown Options ${field.is_scoring ? '(with point values)' : ''}
                            </label>
                            <div style="max-height: 300px; overflow-y: auto; margin-bottom: 12px; padding: 12px; background: var(--neutral-50); border-radius: 8px; border: 1px solid var(--neutral-200);">
                                ${(field.config.options || []).map((opt, idx) => `
                                    <div style="display: grid; grid-template-columns: ${field.is_scoring ? '2fr 3fr 1fr 40px' : '2fr 3fr 40px'}; gap: 8px; margin-bottom: 8px;">
                                        <input type="text" class="form-control" placeholder="value" value="${opt.value}"
                                               oninput="updateDropdownOption(${idx}, 'value', this.value)" style="font-size: 13px; padding: 8px 10px;">
                                        <input type="text" class="form-control" placeholder="Label" value="${opt.label}"
                                               oninput="updateDropdownOption(${idx}, 'label', this.value)" style="font-size: 13px; padding: 8px 10px;">
                                        ${field.is_scoring ? `
                                            <input type="number" class="form-control" placeholder="Points" value="${opt.points}"
                                                   oninput="updateDropdownOption(${idx}, 'points', Number(this.value))" style="font-size: 13px; padding: 8px 10px;">
                                        ` : ''}
                                        <button class="btn btn-secondary btn-sm" onclick="removeDropdownOption(${idx})" style="padding: 8px;">×</button>
                                    </div>
                                `).join('')}
                            </div>
                            <button class="btn btn-secondary btn-sm" onclick="addDropdownOption()">+ Add Option</button>
                        </div>
                    ` : ''}
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="closeFieldEditor()">Cancel</button>
                    <button class="btn btn-primary" onclick="saveField()">
                        ${isEditing ? 'Update Field' : 'Add Field'}
                    </button>
                </div>
            </div>
        </div>
    `;
}

function renderTemplateBuilder() {
    const template = state.editingTemplate;
    const scoringFields = template.fields.filter(f => f.is_scoring);
    const totalWeight = scoringFields.reduce((sum, f) => sum + f.weight, 0);

    return `
        <div class="container" style="padding: 40px 32px;">
            <div style="margin-bottom: 32px;">
                <h1 style="font-size: 32px; margin-bottom: 8px; font-weight: 800;">
                    ${state.templateBuilderMode === 'edit' ? 'Edit Template' : 'Create Template'}
                </h1>
                <p style="color: var(--neutral-600); font-size: 15px;">Configure initiative criteria and scoring weights</p>
            </div>

            <div class="card">
                <div class="form-group">
                    <label class="form-label">Template Name</label>
                    <input type="text" class="form-control" value="${template.name}"
                           oninput="state.editingTemplate.name = this.value; render();"
                           placeholder="e.g., Petrolube Initiative Dossier - 35 Criteria V15">
                </div>
            </div>

            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 24px; padding-bottom: 20px; border-bottom: 1px solid var(--neutral-200);">
                    <div>
                        <h2 style="font-size: 20px; font-weight: 800; margin-bottom: 4px; color: var(--neutral-900);">Fields Configuration</h2>
                        <p style="font-size: 14px; color: var(--neutral-600);">
                            ${template.fields.length} total fields • ${scoringFields.length} scoring fields
                        </p>
                    </div>
                    <div class="stat-card" style="min-width: 140px; text-align: center; margin: 0;">
                        <div class="stat-card-header" style="margin-bottom: 8px;">Weight Total</div>
                        <div style="font-size: 36px; font-weight: 800; line-height: 1; color: ${totalWeight === 100 ? 'var(--petro-green-700)' : 'var(--red-600)'};">
                            ${totalWeight}%
                        </div>
                        ${totalWeight !== 100 ? '<div style="font-size: 11px; color: var(--red-600); margin-top: 8px; font-weight: 600;">Must equal 100%</div>' : '<div style="font-size: 11px; color: var(--petro-green-700); margin-top: 8px; font-weight: 600;">✓ Valid</div>'}
                    </div>
                </div>

                ${template.fields.length === 0 ? `
                    <div style="text-align: center; padding: 80px 40px; background: var(--neutral-50); border-radius: 10px; border: 2px dashed var(--neutral-300);">
                        <div style="font-size: 48px; margin-bottom: 16px; opacity: 0.3;">📝</div>
                        <p style="color: var(--neutral-500); font-size: 15px; margin-bottom: 20px;">No fields added yet. Click "Add Field" to get started.</p>
                        <button class="btn btn-primary" onclick="openFieldEditor()">+ Add First Field</button>
                    </div>
                ` : `
                    <div style="max-height: 500px; overflow-y: auto; margin-bottom: 20px; padding-right: 4px;">
                        ${template.fields.map((field, index) => `
                            <div class="card" style="margin-bottom: 12px; padding: 16px; border: 1px solid var(--neutral-200); box-shadow: var(--shadow-sm);">
                                <div style="display: flex; gap: 16px; align-items: start;">
                                    <div style="display: flex; flex-direction: column; gap: 6px;">
                                        <button class="btn btn-secondary btn-sm" onclick="moveField(${index}, 'up')"
                                                ${index === 0 ? 'disabled' : ''}
                                                style="padding: 6px 10px; font-size: 11px; min-width: 32px;">▲</button>
                                        <button class="btn btn-secondary btn-sm" onclick="moveField(${index}, 'down')"
                                                ${index === template.fields.length - 1 ? 'disabled' : ''}
                                                style="padding: 6px 10px; font-size: 11px; min-width: 32px;">▼</button>
                                    </div>

                                    <div style="flex: 1;">
                                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px; flex-wrap: wrap;">
                                            <span style="font-size: 11px; font-family: monospace; color: var(--neutral-400); background: var(--neutral-100); padding: 2px 6px; border-radius: 4px;">#${index + 1}</span>
                                            <span style="font-size: 15px; font-weight: 700; color: var(--neutral-900);">${field.label}</span>
                                            ${field.required ? '<span class="badge badge-red">Required</span>' : ''}
                                            ${field.is_scoring ? `<span class="badge badge-orange">Scoring: ${field.weight}%</span>` : ''}
                                        </div>
                                        <div style="font-size: 13px; color: var(--neutral-600); line-height: 1.6;">
                                            <span style="font-weight: 600;">Type:</span> <code style="background: var(--neutral-100); padding: 2px 6px; border-radius: 4px; font-size: 12px;">${field.type}</code>
                                            <span style="margin-left: 12px; font-weight: 600;">Key:</span> <code style="background: var(--neutral-100); padding: 2px 6px; border-radius: 4px; font-size: 12px;">${field.key}</code>
                                            ${field.threshold !== null && field.threshold !== undefined && field.threshold !== '' ?
                                                `<span style="margin-left: 12px; font-weight: 600;">Threshold: <strong>${field.threshold}</strong></span>` : ''}
                                        </div>
                                        ${field.type === 'dropdown' && field.config.options ? `
                                            <div style="margin-top: 10px; padding: 8px 12px; background: var(--neutral-50); border-radius: 6px; border: 1px solid var(--neutral-200);">
                                                <div style="font-size: 11px; color: var(--neutral-600); font-weight: 600; margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.03em;">Options</div>
                                                <div style="font-size: 12px; color: var(--neutral-700);">${field.config.options.map(o => o.label).slice(0, 5).join(', ')}${field.config.options.length > 5 ? ` +${field.config.options.length - 5} more` : ''}</div>
                                            </div>
                                        ` : ''}
                                    </div>

                                    <div style="display: flex; gap: 8px;">
                                        <button class="btn btn-primary btn-sm" onclick="openFieldEditor(${index})">Edit</button>
                                        <button class="btn btn-secondary btn-sm" onclick="removeField(${index})" style="color: var(--red-600);">Remove</button>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    <button class="btn btn-secondary btn-block" onclick="openFieldEditor()">+ Add Field</button>
                `}
            </div>

            <div style="display: flex; gap: 12px; position: sticky; bottom: 20px; background: var(--neutral-50); padding: 16px 0; margin-top: 24px;">
                <button class="btn btn-secondary btn-lg" onclick="cancelTemplateBuilder()">Cancel</button>
                <button class="btn btn-primary btn-lg btn-block" onclick="saveTemplateFromBuilder()"
                        ${totalWeight !== 100 ? 'disabled' : ''}>
                    ${totalWeight === 100 ? '✓ Publish Template' : `⚠ Fix Weight Total (${totalWeight}% ≠ 100%)`}
                </button>
            </div>
        </div>
    `;
}

function renderTemplates() {
    // If in builder mode, show builder
    if (state.templateBuilderMode) {
        return renderTemplateBuilder();
    }

    const data = state.store.getData();
    
    return `
        <div class="container" style="padding: 40px 32px;">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 32px;">
                <div>
                    <h1 style="font-size: 32px; margin-bottom: 8px; font-weight: 800;">Assessment Templates</h1>
                    <p style="color: var(--neutral-600); font-size: 15px;">Manage evaluation frameworks and scoring criteria</p>
                </div>
                <button class="btn btn-primary" onclick="startCreateTemplate()">+ Create New Template</button>
            </div>

            ${data.templates.length === 0 ? `
                <div class="card" style="padding: 80px 40px; text-align: center;">
                    <div style="font-size: 64px; margin-bottom: 20px; opacity: 0.3;">📝</div>
                    <p style="color: var(--neutral-600); margin-bottom: 24px; font-size: 16px;">No templates yet</p>
                    <button class="btn btn-primary" onclick="startCreateTemplate()">Create Your First Template</button>
                </div>
            ` : `
                <div class="grid grid-2">
                    ${data.templates.map(template => {
                        const scoringFields = template.fields.filter(f => f.is_scoring);
                        const totalWeight = scoringFields.reduce((sum, f) => sum + f.weight, 0);

                        return `
                            <div class="card">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 20px;">
                                    <div style="flex: 1;">
                                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                                            <h3 style="font-size: 18px; font-weight: 800; color: var(--neutral-900);">${template.name}</h3>
                                            ${template.is_published ? '<span class="badge badge-green">Published</span>' : ''}
                                        </div>
                                        <div style="font-size: 13px; color: var(--neutral-600);">
                                            ${template.fields.length} total fields • ${scoringFields.length} scoring fields • Weight total:
                                            <span style="font-weight: 700; color: ${totalWeight === 100 ? 'var(--petro-green-700)' : 'var(--red-600)'};">
                                                ${totalWeight}%
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 20px;">
                                    <div>
                                        <div style="font-size: 11px; color: var(--neutral-600); margin-bottom: 4px; text-transform: uppercase; font-weight: 700; letter-spacing: 0.05em;">Total Fields</div>
                                        <div style="font-size: 28px; font-weight: 800; color: var(--neutral-900);">${template.fields.length}</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 11px; color: var(--neutral-600); margin-bottom: 4px; text-transform: uppercase; font-weight: 700; letter-spacing: 0.05em;">Scoring</div>
                                        <div style="font-size: 28px; font-weight: 800; color: var(--petro-green-700);">${scoringFields.length}</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 11px; color: var(--neutral-600); margin-bottom: 4px; text-transform: uppercase; font-weight: 700; letter-spacing: 0.05em;">Weight Total</div>
                                        <div style="font-size: 28px; font-weight: 800; color: ${totalWeight === 100 ? 'var(--petro-green-700)' : 'var(--red-600)'};">${totalWeight}%</div>
                                    </div>
                                </div>
                                <div style="padding: 16px; background: var(--neutral-50); border-radius: 10px; margin-bottom: 20px;">
                                    <div style="font-size: 12px; font-weight: 700; color: var(--neutral-700); margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.05em;">Scoring Criteria Preview</div>
                                    <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                                        ${scoringFields.slice(0, 5).map(f => `
                                            <span class="badge badge-orange">${f.label.split('.')[1]?.trim() || f.label}: ${f.weight}%</span>
                                        `).join('')}
                                        ${scoringFields.length > 5 ? `<span style="font-size: 12px; color: var(--neutral-500);">+${scoringFields.length - 5} more</span>` : ''}
                                    </div>
                                </div>
                                <div style="display: flex; gap: 8px;">
                                    <button class="btn btn-primary btn-sm" onclick="startEditTemplate('${template.id}')" style="flex: 1;">Edit</button>
                                    <button class="btn btn-secondary btn-sm" onclick="duplicateTemplate('${template.id}')">Duplicate</button>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `}
        </div>
    `;
}

function renderScenarios() {
    const data = state.store.getData();
    
    return `
        <div class="container" style="padding: 40px 32px;">
            <div style="margin-bottom: 32px;">
                <h1 style="font-size: 32px; margin-bottom: 8px; font-weight: 800;">Scenario Management</h1>
                <p style="color: var(--neutral-600); font-size: 15px;">Compare strategic approaches and portfolio optimization strategies</p>
            </div>
            
            <div class="grid grid-3 mb-6">
                ${data.scenarios.map(s => `
                    <div class="card" style="cursor: pointer; ${s.id === state.selectedScenario ? 'border: 2px solid var(--petro-green-700); background: var(--petro-green-50);' : ''}" onclick="selectScenario('${s.id}')">
                        <h3 style="font-size: 18px; font-weight: 800; margin-bottom: 12px; color: var(--neutral-900);">${s.name}</h3>
                        <p style="font-size: 14px; color: var(--neutral-600); margin-bottom: 16px;">${s.description}</p>
                        ${s.id === state.selectedScenario ? '<span class="badge badge-green">Active Scenario</span>' : '<span class="badge badge-gray">Available</span>'}
                    </div>
                `).join('')}
            </div>

            <div class="card">
                <h2 style="font-size: 20px; font-weight: 800; margin-bottom: 24px; color: var(--neutral-900);">Cross-Scenario Comparison</h2>
                <p style="color: var(--neutral-600); margin-bottom: 20px; font-size: 14px;">Compare how initiatives rank across different strategic scenarios</p>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Initiative</th>
                            ${data.scenarios.map(s => `<th>${s.name.split(' ')[0]}</th>`).join('')}
                        </tr>
                    </thead>
                    <tbody>
                        ${data.projects.filter(p => p.scores).slice(0, 10).map(p => `
                            <tr>
                                <td>
                                    <div style="font-weight: 700; color: var(--neutral-900);">${p.criteriaValues?.initiative_name || p.name}</div>
                                    <div style="font-size: 12px; color: var(--neutral-500); margin-top: 2px;">${p.criteriaValues?.initiative_id}</div>
                                </td>
                                ${data.scenarios.map(s => {
                                    const rank = p.scores?.rank;
                                    return `<td><div class="rank-badge rank-default" style="width: 32px; height: 32px; font-size: 14px;">${rank || '—'}</div></td>`;
                                }).join('')}
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        </div>
    `;
}

function renderInsights() {
    const data = state.store.getData();
    const scored = data.projects.filter(p => p.scores && p.scores.compositeScore);
    const avgScore = scored.length > 0 ? scored.reduce((sum, p) => sum + p.scores.compositeScore, 0) / scored.length : 0;
    const maxScore = Math.max(...scored.map(p => p.scores.compositeScore), 0);
    const minScore = scored.length > 0 ? Math.min(...scored.map(p => p.scores.compositeScore)) : 0;
    const template = data.templates[0];
    const scoringFields = template.fields.filter(f => f.is_scoring);

    return `
        <div class="container" style="padding: 40px 32px;">
            <div style="margin-bottom: 32px;">
                <h1 style="font-size: 32px; margin-bottom: 8px; font-weight: 800;">Portfolio Insights</h1>
                <p style="color: var(--neutral-600); font-size: 15px;">Deep analytics and scoring methodology transparency</p>
            </div>
            
            <div class="grid grid-3 mb-6">
                <div class="stat-card" style="background: linear-gradient(135deg, var(--blue-100), white); border-left: 3px solid var(--blue-600);">
                    <div class="stat-card-header" style="color: var(--blue-600);">Top Driver</div>
                    <div style="font-size: 24px; font-weight: 800; color: var(--blue-600); margin-bottom: 4px;">Financial Impact</div>
                    <div class="stat-card-footer">25% weight contribution</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, var(--petro-green-100), white); border-left: 3px solid var(--petro-green-700);">
                    <div class="stat-card-header" style="color: var(--petro-green-700);">Score Range</div>
                    <div style="font-size: 24px; font-weight: 800; color: var(--petro-green-700); margin-bottom: 4px;">${minScore.toFixed(0)} - ${maxScore.toFixed(0)}</div>
                    <div class="stat-card-footer">Portfolio distribution</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, var(--petro-orange-100), white); border-left: 3px solid var(--petro-orange-600);">
                    <div class="stat-card-header" style="color: var(--petro-orange-600);">Average Score</div>
                    <div style="font-size: 24px; font-weight: 800; color: var(--petro-orange-600); margin-bottom: 4px;">${avgScore.toFixed(1)}</div>
                    <div class="stat-card-footer">Across ${scored.length} projects</div>
                </div>
            </div>

            <div class="card mb-6">
                <h2 style="font-size: 20px; font-weight: 800; margin-bottom: 24px; color: var(--neutral-900);">Scoring Methodology</h2>
                
                <div style="padding: 20px; background: var(--petro-green-50); border-radius: 10px; border-left: 3px solid var(--petro-green-700); margin-bottom: 24px;">
                    <h3 style="font-size: 16px; font-weight: 800; margin-bottom: 12px; color: var(--petro-green-900);">35-Criteria Framework V14</h3>
                    <div class="grid grid-2" style="gap: 16px;">
                        <div>
                            <p style="font-size: 14px; color: var(--neutral-700); margin-bottom: 8px;"><strong>Total Criteria:</strong> 35 evaluation points</p>
                            <p style="font-size: 14px; color: var(--neutral-700); margin-bottom: 8px;"><strong>Scoring Criteria:</strong> ${scoringFields.length} weighted fields</p>
                            <p style="font-size: 14px; color: var(--neutral-700);"><strong>Total Weight:</strong> 100% distributed across criteria</p>
                        </div>
                        <div>
                            <p style="font-size: 14px; color: var(--neutral-700); margin-bottom: 8px;"><strong>Methodology:</strong> Weighted composite scoring</p>
                            <p style="font-size: 14px; color: var(--neutral-700); margin-bottom: 8px;"><strong>Kill-Switch:</strong> Automated risk gates</p>
                            <p style="font-size: 14px; color: var(--neutral-700);"><strong>Normalization:</strong> 0-100 scale</p>
                        </div>
                    </div>
                </div>

                <div style="margin-bottom: 20px;">
                    <h4 style="font-size: 14px; font-weight: 800; margin-bottom: 16px; color: var(--neutral-800); text-transform: uppercase; letter-spacing: 0.05em;">Weight Distribution</h4>
                    ${scoringFields.map(field => {
                        const percentage = field.weight;
                        return `
                            <div style="margin-bottom: 16px;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                                    <span style="font-size: 14px; font-weight: 600; color: var(--neutral-900);">${field.label}</span>
                                    <span style="font-size: 14px; font-weight: 800; color: var(--petro-green-700);">${percentage}%</span>
                                </div>
                                <div class="progress-bar" style="height: 10px;">
                                    <div class="progress-fill" style="width: ${percentage}%;"></div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            </div>

            <div class="card">
                <h2 style="font-size: 20px; font-weight: 800; margin-bottom: 24px; color: var(--neutral-900);">Top Performers Analysis</h2>
                ${scored.slice(0, 3).map((p, idx) => `
                    <div style="padding: 20px; background: ${idx === 0 ? 'var(--petro-green-50)' : 'var(--neutral-50)'}; border-radius: 10px; margin-bottom: 16px; border-left: 3px solid ${idx === 0 ? 'var(--petro-gold-600)' : 'var(--petro-green-700)'};">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                            <div style="flex: 1;">
                                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                                    <div class="rank-badge ${p.scores.rank === 1 ? 'rank-1' : p.scores.rank === 2 ? 'rank-2' : 'rank-3'}" style="width: 32px; height: 32px; font-size: 14px;">${p.scores.rank}</div>
                                    <h3 style="font-size: 18px; font-weight: 800; color: var(--neutral-900);">${p.criteriaValues?.initiative_name || p.name}</h3>
                                </div>
                                <p style="font-size: 12px; color: var(--neutral-600); font-family: 'JetBrains Mono', monospace;">${p.criteriaValues?.initiative_id}</p>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 36px; font-weight: 800; color: var(--petro-orange-600);">${p.scores.compositeScore.toFixed(1)}</div>
                                <div style="font-size: 12px; color: var(--neutral-600);">Composite Score</div>
                            </div>
                        </div>
                        <div style="padding-top: 16px; border-top: 1px solid var(--neutral-200);">
                            <h4 style="font-size: 12px; font-weight: 800; margin-bottom: 12px; color: var(--neutral-700); text-transform: uppercase; letter-spacing: 0.05em;">Top Contributors</h4>
                            ${p.scores.breakdown.sort((a, b) => b.contribution - a.contribution).slice(0, 3).map((item, i) => `
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; ${i < 2 ? 'border-bottom: 1px solid var(--neutral-200);' : ''}">
                                    <span style="font-size: 13px; color: var(--neutral-700);">${item.field_label.split('.')[1]?.trim() || item.field_label}</span>
                                    <div style="display: flex; align-items: center; gap: 12px;">
                                        <span style="font-size: 12px; color: var(--neutral-600); font-family: 'JetBrains Mono', monospace;">${item.raw_value}</span>
                                        <span style="font-size: 14px; font-weight: 800; color: var(--petro-green-700); min-width: 50px; text-align: right;">${item.contribution.toFixed(1)} pts</span>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `).join('')}
            </div>
        </div>
    `;
}

function renderModals() {
    return `
        <div id="projectWizardModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Create New Initiative</h2>
                    <button class="modal-close" onclick="closeProjectWizard()">×</button>
                </div>
                <div class="modal-body" id="wizardContent"></div>
            </div>
        </div>

        ${state.showFieldEditor ? renderFieldEditorModal() : ''}
    `;
}

// ============================================================================
// WIZARD RENDERS
// ============================================================================

function renderWizard() {
    const data = state.store.getData();
    const template = data.templates[0];
    const mandatoryFields = template.fields.filter(f => f.required);
    
    let completed = 0;
    if (state.wizardData.description) completed++;
    mandatoryFields.forEach(f => {
        if (state.wizardData.criteriaValues?.[f.key]) completed++;
    });
    const completeness = Math.round((completed / (mandatoryFields.length + 1)) * 100);

    let html = `
        <div class="wizard-steps">
            ${[1, 2, 3, 4, 5].map(s => `
                <div class="wizard-step ${state.wizardStep === s ? 'active' : state.wizardStep > s ? 'completed' : ''}">
                    <div class="wizard-step-circle">${s}</div>
                    <div class="wizard-step-label">
                        ${['AI Describe', 'Header', 'Strategic', 'Scoring', 'Review'][s - 1]}
                    </div>
                </div>
            `).join('')}
        </div>

        <div class="card mb-6">
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
                <h3 style="font-size: 15px; color: var(--petro-green-800); font-weight: 700;">Completion Progress</h3>
                <div style="font-size: 24px; font-weight: 800; color: var(--petro-green-700);">${completeness}%</div>
            </div>
            <div class="progress-bar" style="height: 12px;">
                <div class="progress-fill" style="width: ${completeness}%"></div>
            </div>
            <div style="margin-top: 8px; font-size: 13px; color: var(--neutral-600);">
                ${completed} of ${mandatoryFields.length + 1} required fields completed
            </div>
        </div>
    `;

    if (state.wizardStep === 1) html += renderWizardStep1();
    else if (state.wizardStep === 2) html += renderWizardStep2(template);
    else if (state.wizardStep === 3) html += renderWizardStep3(template);
    else if (state.wizardStep === 4) html += renderWizardStep4(template);
    else if (state.wizardStep === 5) html += renderWizardStep5(template);

    document.getElementById('wizardContent').innerHTML = html;
}

function renderWizardStep1() {
    return `
        <h3 style="font-size: 18px; font-weight: 800; margin-bottom: 20px;">Step 1: AI-Powered Description</h3>
        
        ${state.showDescriptionBox ? `
            <div class="agent-panel">
                <div style="display: flex; align-items: start; gap: 16px; margin-bottom: 16px;">
                    <div style="font-size: 40px;">🤖</div>
                    <div>
                        <h4 style="font-size: 16px; font-weight: 800; color: var(--blue-600); margin-bottom: 8px;">AI Auto-Fill Assistant</h4>
                        <p style="font-size: 14px; color: var(--neutral-700);">
                            Describe your initiative and our AI will intelligently populate all 35 criteria based on pattern recognition and historical data analysis.
                        </p>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label required">Project Description</label>
                    <textarea class="form-control" id="wizard-description" rows="6" 
                              placeholder="Example: Oracle ERP Redwood UX migration. Critical dependency blocking 91 AI agents. Budget: 12.5M SAR, Timeline: 14 months, Expected IRR: 42%. High strategic priority for Q1 2025 delivery...">${state.wizardData.description || ''}</textarea>
                </div>
                
                <button class="btn btn-gold btn-block btn-lg" onclick="runAIAutoFill()">
                    <span>✨</span> Auto-Fill All 35 Criteria
                </button>
            </div>
        ` : `
            <div class="alert alert-success mb-4">
                <div style="font-size: 24px;">✅</div>
                <div>
                    <strong style="font-weight: 700;">AI Processing Complete!</strong><br>
                    <span style="font-size: 14px;">All 35 criteria have been intelligently populated. Review and adjust in the following steps.</span>
                </div>
            </div>
            <button class="btn btn-secondary" onclick="resetAIAutoFill()">
                <span>↺</span> Re-run AI Analysis
            </button>
        `}

        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeProjectWizard()">Cancel</button>
            <button class="btn btn-primary" onclick="wizardNext(1)" ${!state.wizardData.description ? 'disabled' : ''}>
                Next: Header Info →
            </button>
        </div>
    `;
}

function renderWizardStep2(template) {
    const fields = template.fields.filter(f => f.category === 'metadata');

    return `
        <div class="section-header">Section 1: Metadata & Identification</div>
        <p style="color: var(--neutral-600); margin-bottom: 24px;">Basic initiative information and strategic classification</p>
        <div class="grid grid-2">
            ${fields.map(field => renderFieldInput(field)).join('')}
        </div>

        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="wizardPrev()">← Back</button>
            <button class="btn btn-primary" onclick="wizardNext(2)">Next: Strategic →</button>
        </div>
    `;
}

function renderWizardStep3(template) {
    const fields = template.fields.filter(f => f.category === 'strategic');

    return `
        <div class="section-header">Section 2: Strategic Positioning</div>
        <p style="color: var(--neutral-600); margin-bottom: 24px;">Priority, tier, competitive response, and BCG i2i impact</p>
        <div class="grid grid-2">
            ${fields.map(field => renderFieldInput(field)).join('')}
        </div>

        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="wizardPrev()">← Back</button>
            <button class="btn btn-primary" onclick="wizardNext(3)">Next: Business Case →</button>
        </div>
    `;
}

function renderWizardStep4(template) {
    const businessFields = template.fields.filter(f => f.category === 'business_case');
    const implFields = template.fields.filter(f => f.category === 'implementation');
    const depFields = template.fields.filter(f => f.category === 'dependencies');

    return `
        <div class="section-header">Section 4: Business Case</div>
        <p style="color: var(--neutral-600); margin-bottom: 24px;">Problem, solution, financials, and strategic rationale</p>
        <div class="grid grid-2">
            ${businessFields.slice(0, 5).map(field => renderFieldInput(field)).join('')}
        </div>

        <div class="section-header" style="margin-top: 32px;">Section 5: Implementation</div>
        <p style="color: var(--neutral-600); margin-bottom: 24px;">TRL, resources, timeline, and MiRA integration</p>
        <div class="grid grid-2">
            ${implFields.map(field => renderFieldInput(field)).join('')}
        </div>

        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="wizardPrev()">← Back</button>
            <button class="btn btn-primary" onclick="wizardNext(4)">Next: Review →</button>
        </div>
    `;
}

function renderWizardStep5(template) {
    const allComplete = template.fields.filter(f => f.required).every(f => state.wizardData.criteriaValues?.[f.key]);

    // Calculate preview scores
    const data = state.store.getData();
    const allProjects = data.projects || [];
    const criteriaValues = state.wizardData.criteriaValues || {};

    const d1 = calculateD1Score(criteriaValues, allProjects);
    const d2 = calculateD2Score(criteriaValues);
    const d3 = calculateD3Score(criteriaValues);
    const d4 = calculateD4Score(criteriaValues);
    const d5 = calculateD5Score(criteriaValues);
    const d6 = calculateD6Score(criteriaValues, allProjects);

    const scenario = criteriaValues.scenario_assignment || 'A';
    const dimensionScores = { d1, d2, d3, d4, d5, d6 };
    const compositeScore = calculateCompositeScore(dimensionScores, scenario);
    const quadrant = assignQuadrant(d1, d2);
    const finalScore = calculateFinalScore(compositeScore, quadrant);
    const tier = assignTier(criteriaValues, finalScore, allProjects);

    const quadrantLabels = {
        quick_win: 'Quick Win',
        push_harder: 'Push Harder',
        transformational: 'Transformational',
        moonshot: 'Moonshot'
    };

    const quadrantColors = {
        quick_win: '#0d5530',
        push_harder: '#2563eb',
        transformational: '#d97706',
        moonshot: '#dc2626'
    };

    return `
        <h3 style="font-size: 18px; font-weight: 800; margin-bottom: 24px;">Step 5: Review & Submit</h3>

        ${allComplete ? `
            <div class="alert alert-success mb-6">
                <div style="font-size: 24px;">✅</div>
                <div>
                    <strong style="font-weight: 700;">Ready to Create</strong><br>
                    <span style="font-size: 14px;">All required fields are complete. Review the summary below and submit.</span>
                </div>
            </div>
        ` : `
            <div class="alert alert-danger mb-6">
                <div style="font-size: 24px;">⚠️</div>
                <div>
                    <strong style="font-weight: 700;">Missing Required Fields</strong><br>
                    <span style="font-size: 14px;">Please go back and complete all mandatory criteria before submitting.</span>
                </div>
            </div>
        `}

        <div class="card mb-6">
            <h4 style="font-size: 16px; font-weight: 800; margin-bottom: 20px; color: var(--neutral-900);">Initiative Summary</h4>
            <div style="padding: 20px; background: var(--neutral-50); border-radius: 10px; margin-bottom: 16px;">
                <div style="font-size: 24px; font-weight: 800; color: var(--petro-green-800); margin-bottom: 8px;">${state.wizardData.criteriaValues?.initiative_name || 'Unnamed Initiative'}</div>
                <div style="font-size: 13px; color: var(--neutral-600); font-family: 'JetBrains Mono', monospace;">${state.wizardData.criteriaValues?.initiative_id || '—'}</div>
            </div>
            <div class="grid grid-4" style="gap: 16px;">
                <div>
                    <div style="font-size: 11px; color: var(--neutral-600); margin-bottom: 4px; text-transform: uppercase; font-weight: 700; letter-spacing: 0.05em;">Domain</div>
                    <div style="font-weight: 700; font-size: 14px; color: var(--neutral-900);">${(state.wizardData.criteriaValues?.strategic_domain || '').replace(/_/g, ' ')}</div>
                </div>
                <div>
                    <div style="font-size: 11px; color: var(--neutral-600); margin-bottom: 4px; text-transform: uppercase; font-weight: 700; letter-spacing: 0.05em;">Priority</div>
                    <div style="font-weight: 700; font-size: 14px; color: var(--neutral-900);">${(state.wizardData.criteriaValues?.strategic_priority || '').replace(/_/g, ' ').toUpperCase()}</div>
                </div>
                <div>
                    <div style="font-size: 11px; color: var(--neutral-600); margin-bottom: 4px; text-transform: uppercase; font-weight: 700; letter-spacing: 0.05em;">Investment</div>
                    <div style="font-weight: 700; font-size: 14px; color: var(--neutral-900);">${state.wizardData.criteriaValues?.investment_required ? (state.wizardData.criteriaValues.investment_required / 1000000).toFixed(1) + 'M SAR' : '—'}</div>
                </div>
                <div>
                    <div style="font-size: 11px; color: var(--neutral-600); margin-bottom: 4px; text-transform: uppercase; font-weight: 700; letter-spacing: 0.05em;">IRR</div>
                    <div style="font-weight: 700; font-size: 14px; color: var(--petro-green-700);">${state.wizardData.criteriaValues?.irr_percentage || '—'}%</div>
                </div>
            </div>
        </div>

        <div class="card mb-6" style="background: linear-gradient(135deg, #0d5530 0%, #1a7a4a 100%); color: white;">
            <h4 style="font-size: 16px; font-weight: 800; margin-bottom: 20px; color: white;">📊 Automatic Scoring Preview</h4>

            <!-- 6 Dimension Scores -->
            <div class="grid grid-6" style="gap: 12px; margin-bottom: 24px;">
                <div style="background: rgba(255,255,255,0.15); padding: 12px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 10px; font-weight: 700; letter-spacing: 0.05em; opacity: 0.8; margin-bottom: 4px;">D1: STRATEGIC</div>
                    <div style="font-size: 24px; font-weight: 800;">${d1}</div>
                </div>
                <div style="background: rgba(255,255,255,0.15); padding: 12px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 10px; font-weight: 700; letter-spacing: 0.05em; opacity: 0.8; margin-bottom: 4px;">D2: FEASIBILITY</div>
                    <div style="font-size: 24px; font-weight: 800;">${d2}</div>
                </div>
                <div style="background: rgba(255,255,255,0.15); padding: 12px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 10px; font-weight: 700; letter-spacing: 0.05em; opacity: 0.8; margin-bottom: 4px;">D3: BCG i2i</div>
                    <div style="font-size: 24px; font-weight: 800;">${d3}</div>
                </div>
                <div style="background: rgba(255,255,255,0.15); padding: 12px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 10px; font-weight: 700; letter-spacing: 0.05em; opacity: 0.8; margin-bottom: 4px;">D4: ARAMCO</div>
                    <div style="font-size: 24px; font-weight: 800;">${d4}</div>
                </div>
                <div style="background: rgba(255,255,255,0.15); padding: 12px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 10px; font-weight: 700; letter-spacing: 0.05em; opacity: 0.8; margin-bottom: 4px;">D5: MiRA</div>
                    <div style="font-size: 24px; font-weight: 800;">${d5}</div>
                </div>
                <div style="background: rgba(255,255,255,0.15); padding: 12px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 10px; font-weight: 700; letter-spacing: 0.05em; opacity: 0.8; margin-bottom: 4px;">D6: 3 ENGINES</div>
                    <div style="font-size: 24px; font-weight: 800;">${d6}</div>
                </div>
            </div>

            <!-- Final Scores -->
            <div class="grid grid-4" style="gap: 12px;">
                <div style="background: rgba(255,255,255,0.2); padding: 16px; border-radius: 8px;">
                    <div style="font-size: 11px; font-weight: 700; letter-spacing: 0.05em; opacity: 0.9; margin-bottom: 6px;">COMPOSITE SCORE</div>
                    <div style="font-size: 28px; font-weight: 800;">${compositeScore.toFixed(1)}</div>
                    <div style="font-size: 10px; opacity: 0.7; margin-top: 4px;">Scenario ${scenario}</div>
                </div>
                <div style="background: rgba(255,255,255,0.2); padding: 16px; border-radius: 8px;">
                    <div style="font-size: 11px; font-weight: 700; letter-spacing: 0.05em; opacity: 0.9; margin-bottom: 6px;">FINAL SCORE</div>
                    <div style="font-size: 28px; font-weight: 800;">${finalScore.toFixed(1)}</div>
                    <div style="font-size: 10px; opacity: 0.7; margin-top: 4px;">With modifiers</div>
                </div>
                <div style="background: rgba(255,255,255,0.2); padding: 16px; border-radius: 8px;">
                    <div style="font-size: 11px; font-weight: 700; letter-spacing: 0.05em; opacity: 0.9; margin-bottom: 6px;">QUADRANT</div>
                    <div style="font-size: 16px; font-weight: 800;">${quadrantLabels[quadrant]}</div>
                    <div style="font-size: 10px; opacity: 0.7; margin-top: 4px;">D1:${d1} / D2:${d2}</div>
                </div>
                <div style="background: rgba(255,255,255,0.2); padding: 16px; border-radius: 8px;">
                    <div style="font-size: 11px; font-weight: 700; letter-spacing: 0.05em; opacity: 0.9; margin-bottom: 6px;">TIER</div>
                    <div style="font-size: 28px; font-weight: 800;">${tier}</div>
                    <div style="font-size: 10px; opacity: 0.7; margin-top: 4px;">Auto-assigned</div>
                </div>
            </div>
        </div>

        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="wizardPrev()">← Back</button>
            <button class="btn btn-gold" ${!allComplete ? 'disabled' : ''} onclick="submitWizard()">
                <span>✨</span> Create & Score Initiative
            </button>
        </div>
    `;
}

function renderFieldInput(field) {
    const value = state.wizardData.criteriaValues?.[field.key] || '';
    const description = field.description ? `<small style="color: var(--neutral-600); font-size: 12px; display: block; margin-top: 4px;">${field.description}</small>` : '';
    const placeholder = field.config?.placeholder || '';

    if (field.type === 'text') {
        return `
            <div class="form-group">
                <label class="form-label ${field.required ? 'required' : ''}">${field.label}</label>
                ${description}
                <input type="text" class="form-control" id="field-${field.key}"
                       value="${value}" placeholder="${placeholder}"
                       maxlength="${field.config?.maxLength || 200}"
                       onchange="updateFieldValue('${field.key}', this.value)">
            </div>
        `;
    } else if (field.type === 'number') {
        const unit = field.config?.unit || '';
        return `
            <div class="form-group">
                <label class="form-label ${field.required ? 'required' : ''}">${field.label}</label>
                ${description}
                <div style="position: relative;">
                    <input type="number" class="form-control" id="field-${field.key}"
                           value="${value}" min="${field.config?.min || 0}" max="${field.config?.max || 100}"
                           step="${field.config?.step || 1}" placeholder="${placeholder}"
                           style="${unit ? 'padding-right: 50px;' : ''}"
                           onchange="updateFieldValue('${field.key}', parseFloat(this.value))">
                    ${unit ? `<span style="position: absolute; right: 14px; top: 13px; color: var(--neutral-500); font-size: 14px; font-weight: 600;">${unit}</span>` : ''}
                </div>
            </div>
        `;
    } else if (field.type === 'currency') {
        return `
            <div class="form-group">
                <label class="form-label ${field.required ? 'required' : ''}">${field.label}</label>
                ${description}
                <div style="position: relative;">
                    <span style="position: absolute; left: 14px; top: 13px; color: var(--neutral-500); font-size: 14px; font-weight: 600;">SAR</span>
                    <input type="number" class="form-control" id="field-${field.key}"
                           style="padding-left: 54px;"
                           value="${value}" min="0" step="1000" placeholder="${placeholder}"
                           onchange="updateFieldValue('${field.key}', parseFloat(this.value))">
                </div>
            </div>
        `;
    } else if (field.type === 'dropdown') {
        return `
            <div class="form-group">
                <label class="form-label ${field.required ? 'required' : ''}">${field.label}</label>
                ${description}
                <select class="form-control" id="field-${field.key}" onchange="updateFieldValue('${field.key}', this.value)">
                    <option value="">Select...</option>
                    ${field.config.options.map(opt => `
                        <option value="${opt.value}" ${value === opt.value ? 'selected' : ''}>${opt.label}</option>
                    `).join('')}
                </select>
            </div>
        `;
    } else if (field.type === 'yesno') {
        return `
            <div class="form-group">
                <label class="form-label ${field.required ? 'required' : ''}">${field.label}</label>
                ${description}
                <div style="display: flex; gap: 16px; padding-top: 8px;">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="radio" name="${field.key}" value="yes" ${value === 'yes' ? 'checked' : ''} onchange="updateFieldValue('${field.key}', 'yes')">
                        <span>Yes - Approved</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="radio" name="${field.key}" value="no" ${value === 'no' ? 'checked' : ''} onchange="updateFieldValue('${field.key}', 'no')">
                        <span>No - Pending</span>
                    </label>
                </div>
            </div>
        `;
    } else if (field.type === 'textarea') {
        return `
            <div class="form-group" style="grid-column: 1 / -1;">
                <label class="form-label ${field.required ? 'required' : ''}">${field.label}</label>
                ${description}
                <textarea class="form-control" id="field-${field.key}" rows="${field.config?.rows || 4}"
                          placeholder="${placeholder}" maxlength="${field.config?.maxLength || 2000}"
                          onchange="updateFieldValue('${field.key}', this.value)">${value}</textarea>
            </div>
        `;
    } else if (field.type === 'multiselect') {
        const selectedValues = Array.isArray(value) ? value : [];
        return `
            <div class="form-group" style="grid-column: 1 / -1;">
                <label class="form-label ${field.required ? 'required' : ''}">${field.label}</label>
                ${description}
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; padding-top: 8px;">
                    ${field.config.options.map(opt => {
                        const isChecked = selectedValues.some(v => v.dimension === opt.value);
                        const selectedItem = selectedValues.find(v => v.dimension === opt.value);
                        const gain = selectedItem?.gain || 3;
                        return `
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input type="checkbox" value="${opt.value}"
                                       ${isChecked ? 'checked' : ''}
                                       onchange="updateMultiselectValue('${field.key}', '${opt.value}', this.checked)">
                                <span>${opt.label}</span>
                                ${isChecked ? `
                                    <select class="form-control" style="width: 80px; margin-left: auto; font-size: 12px; padding: 4px 8px;"
                                            onchange="updateMultiselectGain('${field.key}', '${opt.value}', parseInt(this.value))">
                                        <option value="1" ${gain === 1 ? 'selected' : ''}>+1</option>
                                        <option value="2" ${gain === 2 ? 'selected' : ''}>+2</option>
                                        <option value="3" ${gain === 3 ? 'selected' : ''}>+3</option>
                                        <option value="4" ${gain === 4 ? 'selected' : ''}>+4</option>
                                        <option value="5" ${gain === 5 ? 'selected' : ''}>+5</option>
                                    </select>
                                ` : ''}
                            </label>
                        `;
                    }).join('')}
                </div>
            </div>
        `;
    } else if (field.type === 'checklist') {
        const selectedValues = Array.isArray(value) ? value : [];
        return `
            <div class="form-group">
                <label class="form-label ${field.required ? 'required' : ''}">${field.label}</label>
                ${description}
                <div style="display: flex; flex-direction: column; gap: 8px; padding-top: 8px;">
                    ${field.config.options.map(opt => `
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" value="${opt.value}"
                                   ${selectedValues.includes(opt.value) ? 'checked' : ''}
                                   onchange="updateChecklistValue('${field.key}', '${opt.value}', this.checked)">
                            <span>${opt.label}</span>
                        </label>
                    `).join('')}
                </div>
            </div>
        `;
    } else if (field.type === 'timeline') {
        const timelineValue = typeof value === 'object' ? value : { start_date: '', end_date: '', confidence: 'medium' };
        return `
            <div class="form-group" style="grid-column: 1 / -1;">
                <label class="form-label ${field.required ? 'required' : ''}">${field.label}</label>
                ${description}
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; padding-top: 8px;">
                    <div>
                        <label style="font-size: 12px; color: var(--neutral-600); display: block; margin-bottom: 4px;">Start Date</label>
                        <input type="date" class="form-control" value="${timelineValue.start_date || ''}"
                               onchange="updateTimelineValue('${field.key}', 'start_date', this.value)">
                    </div>
                    <div>
                        <label style="font-size: 12px; color: var(--neutral-600); display: block; margin-bottom: 4px;">End Date</label>
                        <input type="date" class="form-control" value="${timelineValue.end_date || ''}"
                               onchange="updateTimelineValue('${field.key}', 'end_date', this.value)">
                    </div>
                    <div>
                        <label style="font-size: 12px; color: var(--neutral-600); display: block; margin-bottom: 4px;">Confidence</label>
                        <select class="form-control" onchange="updateTimelineValue('${field.key}', 'confidence', this.value)">
                            <option value="high" ${timelineValue.confidence === 'high' ? 'selected' : ''}>High</option>
                            <option value="medium" ${timelineValue.confidence === 'medium' ? 'selected' : ''}>Medium</option>
                            <option value="low" ${timelineValue.confidence === 'low' ? 'selected' : ''}>Low</option>
                        </select>
                    </div>
                </div>
            </div>
        `;
    } else if (field.type === 'mira_config') {
        const miraValue = typeof value === 'object' ? value : { layer: 0, depth: 'medium', multiple_layers: false, monetization_clarity: 'partial' };
        return `
            <div class="form-group" style="grid-column: 1 / -1;">
                <label class="form-label ${field.required ? 'required' : ''}">${field.label}</label>
                ${description}
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; padding-top: 8px;">
                    <div>
                        <label style="font-size: 12px; color: var(--neutral-600); display: block; margin-bottom: 4px;">MiRA Layer</label>
                        <select class="form-control" onchange="updateMiraValue('${field.key}', 'layer', parseInt(this.value))">
                            <option value="0" ${miraValue.layer === 0 ? 'selected' : ''}>0 - No Integration</option>
                            <option value="1" ${miraValue.layer === 1 ? 'selected' : ''}>1 - Data Input</option>
                            <option value="2" ${miraValue.layer === 2 ? 'selected' : ''}>2 - AI Enhancement</option>
                            <option value="3" ${miraValue.layer === 3 ? 'selected' : ''}>3 - Predictive/Generative</option>
                            <option value="4" ${miraValue.layer === 4 ? 'selected' : ''}>4 - Direct Monetization</option>
                        </select>
                    </div>
                    <div>
                        <label style="font-size: 12px; color: var(--neutral-600); display: block; margin-bottom: 4px;">Integration Depth</label>
                        <select class="form-control" onchange="updateMiraValue('${field.key}', 'depth', this.value)">
                            <option value="low" ${miraValue.depth === 'low' ? 'selected' : ''}>Low</option>
                            <option value="medium" ${miraValue.depth === 'medium' ? 'selected' : ''}>Medium</option>
                            <option value="high" ${miraValue.depth === 'high' ? 'selected' : ''}>High</option>
                        </select>
                    </div>
                    <div>
                        <label style="font-size: 12px; color: var(--neutral-600); display: block; margin-bottom: 4px;">Options</label>
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; margin-bottom: 4px;">
                            <input type="checkbox" ${miraValue.multiple_layers ? 'checked' : ''}
                                   onchange="updateMiraValue('${field.key}', 'multiple_layers', this.checked)">
                            <span style="font-size: 12px;">Multiple Layers</span>
                        </label>
                    </div>
                </div>
            </div>
        `;
    } else if (field.type === 'financial_table' || field.type === 'benefit_table') {
        const tableValue = typeof value === 'object' ? value : { wacc: 0.12, years: {} };
        return `
            <div class="form-group" style="grid-column: 1 / -1;">
                <label class="form-label ${field.required ? 'required' : ''}">${field.label}</label>
                ${description}
                <div style="background: var(--neutral-50); border: 1px solid var(--neutral-200); border-radius: 8px; padding: 16px; margin-top: 8px;">
                    <div style="margin-bottom: 12px;">
                        <label style="font-size: 12px; color: var(--neutral-600); display: block; margin-bottom: 4px;">WACC (%)</label>
                        <input type="number" class="form-control" value="${tableValue.wacc * 100}" min="0" max="100" step="0.1"
                               style="width: 120px;"
                               onchange="updateFinancialTableValue('${field.key}', 'wacc', parseFloat(this.value) / 100)">
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px;">
                        ${[1, 2, 3, 4, 5].map(year => `
                            <div>
                                <label style="font-size: 11px; color: var(--neutral-600); display: block; margin-bottom: 4px;">Year ${year}</label>
                                <input type="number" class="form-control" placeholder="0" value="${tableValue.years?.[year] || ''}"
                                       style="font-size: 12px;"
                                       onchange="updateFinancialTableYear('${field.key}', ${year}, parseFloat(this.value) || 0)">
                            </div>
                        `).join('')}
                    </div>
                </div>
            </div>
        `;
    } else if (field.type === 'dependency_list' || field.type === 'enabler_list' || field.type === 'integration_list' ||
               field.type === 'risk_matrix' || field.type === 'assumption_list' || field.type === 'issue_list' ||
               field.type === 'criteria_list' || field.type === 'kpi_list') {
        const listValue = Array.isArray(value) ? value : [];
        const itemType = field.type.replace('_list', '').replace('_matrix', '');
        return `
            <div class="form-group" style="grid-column: 1 / -1;">
                <label class="form-label ${field.required ? 'required' : ''}">${field.label}</label>
                ${description}
                <div style="background: var(--neutral-50); border: 1px solid var(--neutral-200); border-radius: 8px; padding: 12px; margin-top: 8px;">
                    <div id="list-${field.key}" style="display: flex; flex-direction: column; gap: 8px; margin-bottom: 8px;">
                        ${listValue.length === 0 ? `<div style="color: var(--neutral-500); font-size: 12px; padding: 8px;">No items added yet</div>` :
                          listValue.map((item, idx) => `
                            <div style="display: flex; gap: 8px; align-items: center;">
                                <input type="text" class="form-control" value="${typeof item === 'string' ? item : item.name || item.description || ''}"
                                       style="flex: 1; font-size: 12px;"
                                       onchange="updateListItemValue('${field.key}', ${idx}, this.value)" readonly>
                                <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 12px;"
                                        onclick="removeListItem('${field.key}', ${idx})">Remove</button>
                            </div>
                        `).join('')}
                    </div>
                    <button class="btn btn-secondary" style="font-size: 12px; padding: 6px 12px;"
                            onclick="addListItem('${field.key}', '${itemType}')">+ Add ${itemType.charAt(0).toUpperCase() + itemType.slice(1)}</button>
                </div>
            </div>
        `;
    } else if (field.type === 'governance_config') {
        const govValue = typeof value === 'object' ? value : { review_frequency: 'monthly', owner_role: '', escalation_path: '' };
        return `
            <div class="form-group" style="grid-column: 1 / -1;">
                <label class="form-label ${field.required ? 'required' : ''}">${field.label}</label>
                ${description}
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; padding-top: 8px;">
                    <div>
                        <label style="font-size: 12px; color: var(--neutral-600); display: block; margin-bottom: 4px;">Review Frequency</label>
                        <select class="form-control" onchange="updateGovernanceValue('${field.key}', 'review_frequency', this.value)">
                            <option value="weekly" ${govValue.review_frequency === 'weekly' ? 'selected' : ''}>Weekly</option>
                            <option value="monthly" ${govValue.review_frequency === 'monthly' ? 'selected' : ''}>Monthly</option>
                            <option value="quarterly" ${govValue.review_frequency === 'quarterly' ? 'selected' : ''}>Quarterly</option>
                        </select>
                    </div>
                    <div>
                        <label style="font-size: 12px; color: var(--neutral-600); display: block; margin-bottom: 4px;">Owner Role</label>
                        <input type="text" class="form-control" value="${govValue.owner_role || ''}" placeholder="e.g., Program Manager"
                               onchange="updateGovernanceValue('${field.key}', 'owner_role', this.value)">
                    </div>
                    <div>
                        <label style="font-size: 12px; color: var(--neutral-600); display: block; margin-bottom: 4px;">Escalation Path</label>
                        <input type="text" class="form-control" value="${govValue.escalation_path || ''}" placeholder="e.g., VP → CEO"
                               onchange="updateGovernanceValue('${field.key}', 'escalation_path', this.value)">
                    </div>
                </div>
            </div>
        `;
    }
    return '';
}

// ============================================================================
// EVENT HANDLERS
// ============================================================================

function selectTenant(tenant) {
    state.currentTenant = tenant;
    render();
}

function selectRole(role, userName) {
    state.currentRole = role;
    state.currentUserName = userName;
    render();
}

function continueToDashboard() {
    navigateTo('dashboard');
}

function navigateTo(page) {
    state.currentPage = page;
    render();
    window.scrollTo(0, 0);

    // Initialize dashboard charts after navigation
    if (page === 'dashboard') {
        setTimeout(() => {
            if (typeof initializeDashboardCharts === 'function') {
                initializeDashboardCharts();
            }
        }, 100);
    }
}

function logout() {
    navigateTo('landing');
}

function selectScenario(scenarioId) {
    state.selectedScenario = scenarioId;
    render();
}

function openProjectWizard() {
    state.wizardStep = 1;
    state.wizardData = { criteriaValues: {} };
    state.showDescriptionBox = true;
    document.getElementById('projectWizardModal').classList.add('active');
    renderWizard();
}

function closeProjectWizard() {
    document.getElementById('projectWizardModal').classList.remove('active');
    state.wizardData = { criteriaValues: {} };
}

function runAIAutoFill() {
    const description = document.getElementById('wizard-description').value;
    if (!description.trim()) {
        alert('Please enter a project description first');
        return;
    }
    
    state.wizardData.description = description;
    const generated = AIAgent.analyzeDescription(description);
    state.wizardData.criteriaValues = generated;
    state.showDescriptionBox = false;
    
    renderWizard();
}

function resetAIAutoFill() {
    state.showDescriptionBox = true;
    state.wizardData.criteriaValues = {};
    renderWizard();
}

function updateFieldValue(key, value) {
    if (!state.wizardData.criteriaValues) state.wizardData.criteriaValues = {};
    state.wizardData.criteriaValues[key] = value;
}

function updateMultiselectValue(key, optionValue, isChecked) {
    if (!state.wizardData.criteriaValues) state.wizardData.criteriaValues = {};
    let currentValue = state.wizardData.criteriaValues[key] || [];

    if (isChecked) {
        currentValue.push({ dimension: optionValue, gain: 3 });
    } else {
        currentValue = currentValue.filter(v => v.dimension !== optionValue);
    }

    state.wizardData.criteriaValues[key] = currentValue;
    renderWizard(); // Re-render to show/hide gain selector
}

function updateMultiselectGain(key, optionValue, gain) {
    if (!state.wizardData.criteriaValues) state.wizardData.criteriaValues = {};
    let currentValue = state.wizardData.criteriaValues[key] || [];

    const item = currentValue.find(v => v.dimension === optionValue);
    if (item) {
        item.gain = gain;
    }

    state.wizardData.criteriaValues[key] = currentValue;
}

function updateChecklistValue(key, optionValue, isChecked) {
    if (!state.wizardData.criteriaValues) state.wizardData.criteriaValues = {};
    let currentValue = state.wizardData.criteriaValues[key] || [];

    if (isChecked) {
        currentValue.push(optionValue);
    } else {
        currentValue = currentValue.filter(v => v !== optionValue);
    }

    state.wizardData.criteriaValues[key] = currentValue;
}

function updateTimelineValue(key, field, value) {
    if (!state.wizardData.criteriaValues) state.wizardData.criteriaValues = {};
    let currentValue = state.wizardData.criteriaValues[key] || { start_date: '', end_date: '', confidence: 'medium' };
    currentValue[field] = value;
    state.wizardData.criteriaValues[key] = currentValue;
}

function updateMiraValue(key, field, value) {
    if (!state.wizardData.criteriaValues) state.wizardData.criteriaValues = {};
    let currentValue = state.wizardData.criteriaValues[key] || { layer: 0, depth: 'medium', multiple_layers: false, monetization_clarity: 'partial' };
    currentValue[field] = value;
    state.wizardData.criteriaValues[key] = currentValue;
}

function updateFinancialTableValue(key, field, value) {
    if (!state.wizardData.criteriaValues) state.wizardData.criteriaValues = {};
    let currentValue = state.wizardData.criteriaValues[key] || { wacc: 0.12, years: {} };
    currentValue[field] = value;
    state.wizardData.criteriaValues[key] = currentValue;
}

function updateFinancialTableYear(key, year, value) {
    if (!state.wizardData.criteriaValues) state.wizardData.criteriaValues = {};
    let currentValue = state.wizardData.criteriaValues[key] || { wacc: 0.12, years: {} };
    if (!currentValue.years) currentValue.years = {};
    currentValue.years[year] = value;
    state.wizardData.criteriaValues[key] = currentValue;
}

function updateGovernanceValue(key, field, value) {
    if (!state.wizardData.criteriaValues) state.wizardData.criteriaValues = {};
    let currentValue = state.wizardData.criteriaValues[key] || { review_frequency: 'monthly', owner_role: '', escalation_path: '' };
    currentValue[field] = value;
    state.wizardData.criteriaValues[key] = currentValue;
}

function updateListItemValue(key, index, value) {
    if (!state.wizardData.criteriaValues) state.wizardData.criteriaValues = {};
    let currentValue = state.wizardData.criteriaValues[key] || [];
    if (currentValue[index]) {
        if (typeof currentValue[index] === 'string') {
            currentValue[index] = value;
        } else {
            currentValue[index].name = value;
        }
    }
    state.wizardData.criteriaValues[key] = currentValue;
}

function addListItem(key, itemType) {
    if (!state.wizardData.criteriaValues) state.wizardData.criteriaValues = {};
    let currentValue = state.wizardData.criteriaValues[key] || [];

    const itemName = prompt(`Enter ${itemType} name or description:`);
    if (itemName) {
        if (itemType === 'risk') {
            currentValue.push({ name: itemName, impact: 'medium', probability: 'medium', mitigation: '' });
        } else if (itemType === 'dependency' || itemType === 'enabler') {
            currentValue.push({ name: itemName, criticality: 'Medium', status: 'Pending' });
        } else {
            currentValue.push(itemName);
        }
        state.wizardData.criteriaValues[key] = currentValue;
        renderWizard();
    }
}

function removeListItem(key, index) {
    if (!state.wizardData.criteriaValues) state.wizardData.criteriaValues = {};
    let currentValue = state.wizardData.criteriaValues[key] || [];
    currentValue.splice(index, 1);
    state.wizardData.criteriaValues[key] = currentValue;
    renderWizard();
}

function wizardNext(currentStep) {
    state.wizardStep++;
    renderWizard();
}

function wizardPrev() {
    state.wizardStep--;
    renderWizard();
}

function submitWizard() {
    const data = state.store.getData();
    const template = data.templates[0];
    
    const newProject = {
        id: 'proj-' + Date.now(),
        name: state.wizardData.criteriaValues.initiative_name || 'Unnamed Initiative',
        criteriaValues: state.wizardData.criteriaValues,
        status: 'Ready',
        scores: {},
        createdAt: new Date().toISOString()
    };

    data.projects.push(newProject);

    // Auto-score with all projects for D1/D6 calculations
    ScoringEngine.scoreProject(newProject, template, data.projects);

    // Re-prioritize all
    ScoringEngine.prioritizeProjects(data.projects, template);
    
    state.store.saveData();
    
    state.store.addAuditEvent({
        type: 'ProjectCreated',
        entityType: 'Project',
        entityId: newProject.id,
        actor: state.currentUserName
    });

    closeProjectWizard();
    
    // Show success message
    alert(`✅ Initiative "${newProject.name}" created and scored successfully!\n\nScore: ${newProject.scores.compositeScore.toFixed(1)}/100\nRank: #${newProject.scores.rank}`);
    
    navigateTo('projects');
}

function runPrioritization() {
    const data = state.store.getData();
    const template = data.templates[0];
    const result = ScoringEngine.prioritizeProjects(data.projects, template);
    
    state.store.addAuditEvent({
        type: 'PrioritizationRun',
        entityType: 'Portfolio',
        entityId: 'all',
        actor: state.currentUserName
    });
    
    state.store.saveData();
    
    alert(`✅ Prioritization complete!\n\n${result.rankedProjects.length} initiatives ranked\n${result.blockedCount} blocked by kill-switch rules`);
    render();
}

function viewProject(projectId) {
    const data = state.store.getData();
    const project = data.projects.find(p => p.id === projectId);
    if (project) {
        const details = `
Initiative: ${project.criteriaValues?.initiative_name || project.name}
ID: ${project.criteriaValues?.initiative_id || project.id}
Score: ${project.scores?.compositeScore?.toFixed(1) || 'Not scored'}/100
Rank: #${project.scores?.rank || 'N/A'}
Status: ${project.status}

Investment: ${project.criteriaValues?.investment_required ? (project.criteriaValues.investment_required / 1000000).toFixed(1) + 'M SAR' : 'N/A'}
Timeline: ${project.criteriaValues?.timeline_months || 'N/A'} months
IRR: ${project.criteriaValues?.irr_percentage || 'N/A'}%
        `.trim();
        
        alert(details);
    }
}

// ============================================================================
// D3.JS PORTFOLIO MATRICES
// ============================================================================

function classifyInitiative(init) {
    // Use existing portfolio_category field from initiative data
    // Can be in init.portfolio_category or init.criteriaValues.portfolio_category
    const portfolioCategory = init.portfolio_category || init.criteriaValues?.portfolio_category;

    if (portfolioCategory) {
        // Format: 'core_incremental', 'core_disruptive', 'non_core_incremental', 'non_core_disruptive'
        const parts = portfolioCategory.split('_');

        // Handle 'non_core' vs 'core'
        let coreValue, innovationValue;
        if (parts[0] === 'non' && parts[1] === 'core') {
            coreValue = 'non-core';
            innovationValue = parts[2]?.toLowerCase() || 'incremental';
        } else {
            coreValue = parts[0]?.toLowerCase() || 'core';
            innovationValue = parts[1]?.toLowerCase() || 'incremental';
        }

        return {
            core: coreValue,
            innovation: innovationValue
        };
    }

    // Fallback: Classify based on tier and budget
    const isCore = init.tier === '1a' || init.tier === '1b' || init.budget > 8000000;
    const disruptiveKeywords = ['transformation', 'innovation', 'digital', 'ai', 'analytics', 'platform', 'modernization'];
    const isDisruptive = disruptiveKeywords.some(keyword => init.name?.toLowerCase().includes(keyword)) || init.criticalPath;

    return {
        core: isCore ? 'core' : 'non-core',
        innovation: isDisruptive ? 'disruptive' : 'incremental'
    };
}

function renderPortfolioImpactMatrix() {
    const container = document.getElementById('portfolioImpactMatrix');
    if (!container) return;

    // Clear previous content
    container.innerHTML = '';

    const initiatives = getInitiatives().map(init => ({
        ...init,
        impact: Math.min(100, (init.budget / 250000) + (init.criticalPath ? 20 : 0)),
        feasibility: 100 - (init.dependencies?.length || 0) * 10 - (init.tier === '1a' ? 10 : 0)
    }));

    const width = container.clientWidth;
    const height = 550;
    const margin = { top: 40, right: 40, bottom: 60, left: 60 };
    const innerWidth = width - margin.left - margin.right;
    const innerHeight = height - margin.top - margin.bottom;

    const svg = d3.select(container)
        .append('svg')
        .attr('width', width)
        .attr('height', height);

    const g = svg.append('g')
        .attr('transform', `translate(${margin.left},${margin.top})`);

    // Scales
    const xScale = d3.scaleLinear()
        .domain([0, 100])
        .range([0, innerWidth]);

    const yScale = d3.scaleLinear()
        .domain([0, 100])
        .range([innerHeight, 0]);

    const sizeScale = d3.scaleSqrt()
        .domain([0, d3.max(initiatives, d => d.budget)])
        .range([4, 20]);

    const colorScale = d3.scaleOrdinal()
        .domain(['1a', '1b', '1c', '1d', 'contingent'])
        .range(['#0d5530', '#16a34a', '#2563eb', '#d97706', '#6b7280']);

    // Quadrant lines
    g.append('line')
        .attr('x1', innerWidth / 2)
        .attr('x2', innerWidth / 2)
        .attr('y1', 0)
        .attr('y2', innerHeight)
        .attr('stroke', '#d1d5db')
        .attr('stroke-width', 2)
        .attr('stroke-dasharray', '5,5');

    g.append('line')
        .attr('x1', 0)
        .attr('x2', innerWidth)
        .attr('y1', innerHeight / 2)
        .attr('y2', innerHeight / 2)
        .attr('stroke', '#d1d5db')
        .attr('stroke-width', 2)
        .attr('stroke-dasharray', '5,5');

    // Quadrant labels
    const quadrantLabels = [
        { x: innerWidth * 0.75, y: innerHeight * 0.25, text: 'Quick Wins', color: '#059669' },
        { x: innerWidth * 0.25, y: innerHeight * 0.25, text: 'Strategic Investments', color: '#2563eb' },
        { x: innerWidth * 0.25, y: innerHeight * 0.75, text: 'Low Priority', color: '#6b7280' },
        { x: innerWidth * 0.75, y: innerHeight * 0.75, text: 'Fill-ins', color: '#d97706' }
    ];

    quadrantLabels.forEach(label => {
        g.append('text')
            .attr('x', label.x)
            .attr('y', label.y)
            .attr('text-anchor', 'middle')
            .attr('fill', label.color)
            .attr('font-size', '14px')
            .attr('font-weight', '700')
            .attr('opacity', 0.5)
            .text(label.text);
    });

    // Axes
    const xAxis = d3.axisBottom(xScale).ticks(5);
    const yAxis = d3.axisLeft(yScale).ticks(5);

    g.append('g')
        .attr('transform', `translate(0,${innerHeight})`)
        .call(xAxis)
        .style('font-size', '11px');

    g.append('g')
        .call(yAxis)
        .style('font-size', '11px');

    // Axis labels
    g.append('text')
        .attr('x', innerWidth / 2)
        .attr('y', innerHeight + 45)
        .attr('text-anchor', 'middle')
        .attr('font-size', '12px')
        .attr('font-weight', '700')
        .attr('fill', '#374151')
        .text('Feasibility →');

    g.append('text')
        .attr('transform', 'rotate(-90)')
        .attr('x', -innerHeight / 2)
        .attr('y', -45)
        .attr('text-anchor', 'middle')
        .attr('font-size', '12px')
        .attr('font-weight', '700')
        .attr('fill', '#374151')
        .text('← Impact');

    // Tooltip
    const tooltip = d3.select('body')
        .append('div')
        .attr('class', 'matrix-tooltip')
        .style('position', 'absolute')
        .style('background', 'rgba(0,0,0,0.9)')
        .style('color', 'white')
        .style('padding', '12px')
        .style('border-radius', '6px')
        .style('font-size', '12px')
        .style('pointer-events', 'none')
        .style('opacity', 0)
        .style('z-index', '10000');

    // Bubbles
    const bubbles = g.selectAll('circle')
        .data(initiatives)
        .enter()
        .append('circle')
        .attr('cx', d => xScale(d.feasibility))
        .attr('cy', d => yScale(d.impact))
        .attr('r', d => sizeScale(d.budget))
        .attr('fill', d => colorScale(d.tier))
        .attr('stroke', '#fff')
        .attr('stroke-width', 2)
        .attr('opacity', 0.8)
        .style('cursor', 'pointer')
        .on('mouseover', function(event, d) {
            d3.select(this)
                .transition()
                .duration(200)
                .attr('opacity', 1)
                .attr('stroke-width', 3);

            tooltip.transition().duration(200).style('opacity', 1);
            tooltip.html(`
                <strong>${d.id}</strong><br/>
                ${d.name}<br/>
                <strong>Impact:</strong> ${d.impact.toFixed(0)}<br/>
                <strong>Feasibility:</strong> ${d.feasibility.toFixed(0)}<br/>
                <strong>Budget:</strong> ${(d.budget / 1000000).toFixed(1)}M SAR<br/>
                <strong>Tier:</strong> ${d.tier.toUpperCase()}
            `)
                .style('left', (event.pageX + 10) + 'px')
                .style('top', (event.pageY - 28) + 'px');
        })
        .on('mouseout', function(event, d) {
            d3.select(this)
                .transition()
                .duration(200)
                .attr('opacity', 0.8)
                .attr('stroke-width', 2);

            tooltip.transition().duration(500).style('opacity', 0);
        });

    // Legend
    const legend = g.append('g')
        .attr('transform', `translate(${innerWidth - 150}, 10)`);

    const tiers = ['1a', '1b', '1c', '1d', 'contingent'];
    const tierLabels = ['Tier 1A', 'Tier 1B', 'Tier 1C', 'Tier 1D', 'Contingent'];

    tiers.forEach((tier, i) => {
        const legendRow = legend.append('g')
            .attr('transform', `translate(0, ${i * 20})`);

        legendRow.append('circle')
            .attr('r', 5)
            .attr('fill', colorScale(tier));

        legendRow.append('text')
            .attr('x', 12)
            .attr('y', 4)
            .attr('font-size', '11px')
            .attr('fill', '#374151')
            .text(tierLabels[i]);
    });
}

function renderPortfolioDistributionMatrix() {
    const container = document.getElementById('portfolioDistributionMatrix');
    if (!container) return;

    container.innerHTML = '';

    const initiatives = getInitiatives().map(init => ({
        ...init,
        ...classifyInitiative(init)
    }));

    const width = container.clientWidth;
    const height = 550;
    const margin = { top: 60, right: 40, bottom: 60, left: 80 };
    const innerWidth = width - margin.left - margin.right;
    const innerHeight = height - margin.top - margin.bottom;

    const svg = d3.select(container)
        .append('svg')
        .attr('width', width)
        .attr('height', height);

    const g = svg.append('g')
        .attr('transform', `translate(${margin.left},${margin.top})`);

    // Map classification to coordinates
    const positionMap = {
        'core-disruptive': { x: 0.75, y: 0.25 },
        'non-core-disruptive': { x: 0.25, y: 0.25 },
        'core-incremental': { x: 0.75, y: 0.75 },
        'non-core-incremental': { x: 0.25, y: 0.75 }
    };

    // Add jitter to avoid overlap
    const jitter = () => (Math.random() - 0.5) * 0.15;

    const enrichedInitiatives = initiatives.map(init => {
        const key = `${init.core}-${init.innovation}`;
        const pos = positionMap[key] || { x: 0.5, y: 0.5 }; // Default to center if key not found
        return {
            ...init,
            x: (pos.x + jitter()) * innerWidth,
            y: (pos.y + jitter()) * innerHeight
        };
    });

    // Draw quadrant backgrounds
    const quadrants = [
        { x: innerWidth / 2, y: 0, width: innerWidth / 2, height: innerHeight / 2, label: 'Core-Disruptive', color: '#0d5530' },
        { x: 0, y: 0, width: innerWidth / 2, height: innerHeight / 2, label: 'NonCore-Disruptive', color: '#2563eb' },
        { x: innerWidth / 2, y: innerHeight / 2, width: innerWidth / 2, height: innerHeight / 2, label: 'Core-Incremental', color: '#d97706' },
        { x: 0, y: innerHeight / 2, width: innerWidth / 2, height: innerHeight / 2, label: 'NonCore-Incremental', color: '#6b7280' }
    ];

    quadrants.forEach(quad => {
        g.append('rect')
            .attr('x', quad.x)
            .attr('y', quad.y)
            .attr('width', quad.width)
            .attr('height', quad.height)
            .attr('fill', quad.color)
            .attr('opacity', 0.08)
            .attr('stroke', quad.color)
            .attr('stroke-width', 2)
            .attr('stroke-dasharray', '5,5');

        g.append('text')
            .attr('x', quad.x + quad.width / 2)
            .attr('y', quad.y + 25)
            .attr('text-anchor', 'middle')
            .attr('font-size', '14px')
            .attr('font-weight', '800')
            .attr('fill', quad.color)
            .attr('opacity', 0.7)
            .text(quad.label);
    });

    // Divider lines
    g.append('line')
        .attr('x1', innerWidth / 2)
        .attr('x2', innerWidth / 2)
        .attr('y1', 0)
        .attr('y2', innerHeight)
        .attr('stroke', '#d1d5db')
        .attr('stroke-width', 2);

    g.append('line')
        .attr('x1', 0)
        .attr('x2', innerWidth)
        .attr('y1', innerHeight / 2)
        .attr('y2', innerHeight / 2)
        .attr('stroke', '#d1d5db')
        .attr('stroke-width', 2);

    // Scale for bubble size
    const sizeScale = d3.scaleSqrt()
        .domain([0, d3.max(enrichedInitiatives, d => d.budget)])
        .range([5, 18]);

    const colorScale = d3.scaleOrdinal()
        .domain(['1a', '1b', '1c', '1d', 'contingent'])
        .range(['#0d5530', '#16a34a', '#2563eb', '#d97706', '#6b7280']);

    // Tooltip
    const tooltip = d3.select('body')
        .append('div')
        .attr('class', 'matrix-tooltip-dist')
        .style('position', 'absolute')
        .style('background', 'rgba(0,0,0,0.9)')
        .style('color', 'white')
        .style('padding', '12px')
        .style('border-radius', '6px')
        .style('font-size', '12px')
        .style('pointer-events', 'none')
        .style('opacity', 0)
        .style('z-index', '10000');

    // Draw bubbles
    g.selectAll('circle')
        .data(enrichedInitiatives)
        .enter()
        .append('circle')
        .attr('cx', d => d.x)
        .attr('cy', d => d.y)
        .attr('r', d => sizeScale(d.budget))
        .attr('fill', d => colorScale(d.tier))
        .attr('stroke', '#fff')
        .attr('stroke-width', 2)
        .attr('opacity', 0.8)
        .style('cursor', 'pointer')
        .on('mouseover', function(event, d) {
            d3.select(this)
                .transition()
                .duration(200)
                .attr('opacity', 1)
                .attr('stroke-width', 3);

            tooltip.transition().duration(200).style('opacity', 1);
            tooltip.html(`
                <strong>${d.id}</strong><br/>
                ${d.name}<br/>
                <strong>Classification:</strong> ${d.core.toUpperCase()} / ${d.innovation.toUpperCase()}<br/>
                <strong>Budget:</strong> ${(d.budget / 1000000).toFixed(1)}M SAR<br/>
                <strong>Tier:</strong> ${d.tier.toUpperCase()}
            `)
                .style('left', (event.pageX + 10) + 'px')
                .style('top', (event.pageY - 28) + 'px');
        })
        .on('mouseout', function(event, d) {
            d3.select(this)
                .transition()
                .duration(200)
                .attr('opacity', 0.8)
                .attr('stroke-width', 2);

            tooltip.transition().duration(500).style('opacity', 0);
        });

    // Axis labels
    g.append('text')
        .attr('x', innerWidth / 2)
        .attr('y', -30)
        .attr('text-anchor', 'middle')
        .attr('font-size', '14px')
        .attr('font-weight', '700')
        .attr('fill', '#374151')
        .text('DISRUPTIVE');

    g.append('text')
        .attr('x', innerWidth / 2)
        .attr('y', innerHeight + 40)
        .attr('text-anchor', 'middle')
        .attr('font-size', '14px')
        .attr('font-weight', '700')
        .attr('fill', '#374151')
        .text('INCREMENTAL');

    g.append('text')
        .attr('transform', `translate(-50, ${innerHeight / 2}) rotate(-90)`)
        .attr('text-anchor', 'middle')
        .attr('font-size', '14px')
        .attr('font-weight', '700')
        .attr('fill', '#374151')
        .text('NON-CORE');

    g.append('text')
        .attr('transform', `translate(${innerWidth + 30}, ${innerHeight / 2}) rotate(90)`)
        .attr('text-anchor', 'middle')
        .attr('font-size', '14px')
        .attr('font-weight', '700')
        .attr('fill', '#374151')
        .text('CORE');

    // Legend
    const legend = g.append('g')
        .attr('transform', `translate(10, 10)`);

    const tiers = ['1a', '1b', '1c', '1d', 'contingent'];
    const tierLabels = ['Tier 1A', 'Tier 1B', 'Tier 1C', 'Tier 1D', 'Contingent'];

    tiers.forEach((tier, i) => {
        const legendRow = legend.append('g')
            .attr('transform', `translate(0, ${i * 20})`);

        legendRow.append('circle')
            .attr('r', 5)
            .attr('fill', colorScale(tier));

        legendRow.append('text')
            .attr('x', 12)
            .attr('y', 4)
            .attr('font-size', '11px')
            .attr('fill', '#374151')
            .text(tierLabels[i]);
    });
}

function renderRiskHeatMap() {
    const container = document.getElementById('riskHeatMap');
    if (!container) return;

    container.innerHTML = '';

    const initiatives = getInitiatives();

    // Calculate risk metrics for each initiative
    const riskData = initiatives.map(init => {
        // Impact: based on budget and critical path
        const impactScore = Math.min(5, Math.floor((init.budget / 5000000) + (init.criticalPath ? 1 : 0)));

        // Probability: based on status, dependencies, and tier
        let probabilityScore = 0;
        if (init.status === 'at-risk') probabilityScore += 3;
        else if (init.status === 'in-progress') probabilityScore += 1;
        probabilityScore += Math.min(2, (init.dependencies?.length || 0));
        if (init.tier === '1a' || init.tier === '1b') probabilityScore += 1;
        probabilityScore = Math.min(5, probabilityScore);

        return {
            ...init,
            impact: impactScore,
            probability: probabilityScore,
            riskLevel: impactScore * probabilityScore
        };
    });

    const width = container.clientWidth;
    const height = 400;
    const margin = { top: 40, right: 40, bottom: 60, left: 80 };
    const innerWidth = width - margin.left - margin.right;
    const innerHeight = height - margin.top - margin.bottom;

    const svg = d3.select(container)
        .append('svg')
        .attr('width', width)
        .attr('height', height);

    const g = svg.append('g')
        .attr('transform', `translate(${margin.left},${margin.top})`);

    // Scales
    const xScale = d3.scaleLinear()
        .domain([0, 5])
        .range([0, innerWidth]);

    const yScale = d3.scaleLinear()
        .domain([0, 5])
        .range([innerHeight, 0]);

    const colorScale = d3.scaleSequential(d3.interpolateRdYlGn)
        .domain([25, 0]);

    const sizeScale = d3.scaleSqrt()
        .domain([0, d3.max(riskData, d => d.budget)])
        .range([4, 16]);

    // Draw risk zones
    const zones = [
        { x: 0, y: 0, width: innerWidth * 0.4, height: innerHeight * 0.4, label: 'Low Risk', color: '#22c55e', opacity: 0.1 },
        { x: innerWidth * 0.4, y: 0, width: innerWidth * 0.6, height: innerHeight * 0.4, label: 'Medium Risk', color: '#f59e0b', opacity: 0.1 },
        { x: 0, y: innerHeight * 0.4, width: innerWidth * 0.4, height: innerHeight * 0.6, label: 'Medium Risk', color: '#f59e0b', opacity: 0.1 },
        { x: innerWidth * 0.4, y: innerHeight * 0.4, width: innerWidth * 0.6, height: innerHeight * 0.6, label: 'High Risk', color: '#ef4444', opacity: 0.15 }
    ];

    zones.forEach(zone => {
        g.append('rect')
            .attr('x', zone.x)
            .attr('y', zone.y)
            .attr('width', zone.width)
            .attr('height', zone.height)
            .attr('fill', zone.color)
            .attr('opacity', zone.opacity);
    });

    // Axes
    const xAxis = d3.axisBottom(xScale).ticks(5).tickFormat(d => ['', 'Very Low', 'Low', 'Medium', 'High', 'Very High'][d] || '');
    const yAxis = d3.axisLeft(yScale).ticks(5).tickFormat(d => ['', 'Very Low', 'Low', 'Medium', 'High', 'Very High'][d] || '');

    g.append('g')
        .attr('transform', `translate(0,${innerHeight})`)
        .call(xAxis)
        .style('font-size', '10px')
        .selectAll('text')
        .attr('transform', 'rotate(-45)')
        .style('text-anchor', 'end');

    g.append('g')
        .call(yAxis)
        .style('font-size', '10px');

    // Axis labels
    g.append('text')
        .attr('x', innerWidth / 2)
        .attr('y', innerHeight + 55)
        .attr('text-anchor', 'middle')
        .attr('font-size', '13px')
        .attr('font-weight', '700')
        .attr('fill', '#374151')
        .text('Probability →');

    g.append('text')
        .attr('transform', 'rotate(-90)')
        .attr('x', -innerHeight / 2)
        .attr('y', -60)
        .attr('text-anchor', 'middle')
        .attr('font-size', '13px')
        .attr('font-weight', '700')
        .attr('fill', '#374151')
        .text('← Impact');

    // Tooltip
    const tooltip = d3.select('body')
        .append('div')
        .attr('class', 'risk-tooltip')
        .style('position', 'absolute')
        .style('background', 'rgba(0,0,0,0.9)')
        .style('color', 'white')
        .style('padding', '12px')
        .style('border-radius', '6px')
        .style('font-size', '12px')
        .style('pointer-events', 'none')
        .style('opacity', 0)
        .style('z-index', '10000');

    // Draw bubbles
    g.selectAll('circle')
        .data(riskData)
        .enter()
        .append('circle')
        .attr('cx', d => xScale(d.probability))
        .attr('cy', d => yScale(d.impact))
        .attr('r', d => sizeScale(d.budget))
        .attr('fill', d => colorScale(d.riskLevel))
        .attr('stroke', '#fff')
        .attr('stroke-width', 2)
        .attr('opacity', 0.85)
        .style('cursor', 'pointer')
        .on('mouseover', function(event, d) {
            d3.select(this)
                .transition()
                .duration(200)
                .attr('opacity', 1)
                .attr('stroke-width', 3);

            tooltip.transition().duration(200).style('opacity', 1);
            tooltip.html(`
                <strong>${d.id}</strong><br/>
                ${d.name}<br/>
                <strong>Impact:</strong> ${['', 'Very Low', 'Low', 'Medium', 'High', 'Very High'][d.impact]}<br/>
                <strong>Probability:</strong> ${['', 'Very Low', 'Low', 'Medium', 'High', 'Very High'][d.probability]}<br/>
                <strong>Risk Score:</strong> ${d.riskLevel}/25<br/>
                <strong>Status:</strong> ${d.status.toUpperCase()}
            `)
                .style('left', (event.pageX + 10) + 'px')
                .style('top', (event.pageY - 28) + 'px');
        })
        .on('mouseout', function(event, d) {
            d3.select(this)
                .transition()
                .duration(200)
                .attr('opacity', 0.85)
                .attr('stroke-width', 2);

            tooltip.transition().duration(500).style('opacity', 0);
        });
}

function renderDependencyNetwork() {
    const container = document.getElementById('dependencyGraph');
    if (!container) return;

    container.innerHTML = '';

    const initiatives = getInitiatives();

    // Filter to only initiatives with dependencies
    const nodes = initiatives.filter(i => i.dependencies && i.dependencies.length > 0 ||
                                         initiatives.some(other => other.dependencies?.includes(i.id)));

    // Create links
    const links = [];
    initiatives.forEach(init => {
        if (init.dependencies) {
            init.dependencies.forEach(depId => {
                links.push({
                    source: depId,
                    target: init.id
                });
            });
        }
    });

    const width = container.clientWidth;
    const height = 450;

    const svg = d3.select(container)
        .append('svg')
        .attr('width', width)
        .attr('height', height);

    const colorScale = d3.scaleOrdinal()
        .domain(['1a', '1b', '1c', '1d', 'contingent'])
        .range(['#0d5530', '#16a34a', '#2563eb', '#d97706', '#6b7280']);

    // Create simulation
    const simulation = d3.forceSimulation(nodes)
        .force('link', d3.forceLink(links).id(d => d.id).distance(100))
        .force('charge', d3.forceManyBody().strength(-300))
        .force('center', d3.forceCenter(width / 2, height / 2))
        .force('collision', d3.forceCollide().radius(25));

    // Draw links
    const link = svg.append('g')
        .selectAll('line')
        .data(links)
        .enter()
        .append('line')
        .attr('stroke', '#94a3b8')
        .attr('stroke-width', 2)
        .attr('stroke-opacity', 0.6)
        .attr('marker-end', 'url(#arrowhead)');

    // Add arrowhead marker
    svg.append('defs').append('marker')
        .attr('id', 'arrowhead')
        .attr('viewBox', '-0 -5 10 10')
        .attr('refX', 20)
        .attr('refY', 0)
        .attr('orient', 'auto')
        .attr('markerWidth', 8)
        .attr('markerHeight', 8)
        .attr('xoverflow', 'visible')
        .append('svg:path')
        .attr('d', 'M 0,-5 L 10 ,0 L 0,5')
        .attr('fill', '#94a3b8')
        .style('stroke', 'none');

    // Tooltip
    const tooltip = d3.select('body')
        .append('div')
        .attr('class', 'dep-tooltip')
        .style('position', 'absolute')
        .style('background', 'rgba(0,0,0,0.9)')
        .style('color', 'white')
        .style('padding', '10px')
        .style('border-radius', '6px')
        .style('font-size', '12px')
        .style('pointer-events', 'none')
        .style('opacity', 0)
        .style('z-index', '10000');

    // Draw nodes
    const node = svg.append('g')
        .selectAll('circle')
        .data(nodes)
        .enter()
        .append('circle')
        .attr('r', 12)
        .attr('fill', d => colorScale(d.tier))
        .attr('stroke', '#fff')
        .attr('stroke-width', 2)
        .style('cursor', 'pointer')
        .on('mouseover', function(event, d) {
            d3.select(this).attr('r', 15);
            tooltip.transition().duration(200).style('opacity', 1);
            tooltip.html(`
                <strong>${d.id}</strong><br/>
                ${d.name}<br/>
                <strong>Dependencies:</strong> ${d.dependencies?.length || 0}
            `)
                .style('left', (event.pageX + 10) + 'px')
                .style('top', (event.pageY - 28) + 'px');
        })
        .on('mouseout', function(event, d) {
            d3.select(this).attr('r', 12);
            tooltip.transition().duration(500).style('opacity', 0);
        })
        .call(d3.drag()
            .on('start', dragstarted)
            .on('drag', dragged)
            .on('end', dragended));

    // Add labels
    const labels = svg.append('g')
        .selectAll('text')
        .data(nodes)
        .enter()
        .append('text')
        .text(d => d.id)
        .attr('font-size', '9px')
        .attr('font-weight', '600')
        .attr('text-anchor', 'middle')
        .attr('dy', 4)
        .attr('fill', '#fff')
        .style('pointer-events', 'none');

    // Update positions on tick
    simulation.on('tick', () => {
        link
            .attr('x1', d => d.source.x)
            .attr('y1', d => d.source.y)
            .attr('x2', d => d.target.x)
            .attr('y2', d => d.target.y);

        node
            .attr('cx', d => d.x)
            .attr('cy', d => d.y);

        labels
            .attr('x', d => d.x)
            .attr('y', d => d.y);
    });

    // Drag functions
    function dragstarted(event, d) {
        if (!event.active) simulation.alphaTarget(0.3).restart();
        d.fx = d.x;
        d.fy = d.y;
    }

    function dragged(event, d) {
        d.fx = event.x;
        d.fy = event.y;
    }

    function dragended(event, d) {
        if (!event.active) simulation.alphaTarget(0);
        d.fx = null;
        d.fy = null;
    }
}

// ============================================================================
// DASHBOARD CHARTS
// ============================================================================

function initializeDashboardCharts() {
    const initiatives = getInitiatives();

    // Destroy existing charts before creating new ones
    Object.keys(window.chartInstances || {}).forEach(key => {
        if (window.chartInstances[key]) {
            window.chartInstances[key].destroy();
            delete window.chartInstances[key];
        }
    });

    if (!window.chartInstances) {
        window.chartInstances = {};
    }

    // Executive Summary Charts
    if (state.dashboardPage === 'executive') {
        // Initiative Status Chart
        const statusCtx = document.getElementById('statusChart');
        if (statusCtx) {
            const statusCounts = {
                'completed': initiatives.filter(i => i.status === 'completed').length,
                'in-progress': initiatives.filter(i => i.status === 'in-progress').length,
                'at-risk': initiatives.filter(i => i.status === 'at-risk').length,
                'not-started': initiatives.filter(i => i.status === 'not-started').length
            };

            window.chartInstances.statusChart = new Chart(statusCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Completed', 'In Progress', 'At Risk', 'Not Started'],
                    datasets: [{
                        data: Object.values(statusCounts),
                        backgroundColor: ['#10b981', '#3b82f6', '#f59e0b', '#6b7280'],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { padding: 15, font: { size: 12, weight: '600' } }
                        }
                    }
                }
            });
        }

        // Budget by Tier Chart
        const budgetCtx = document.getElementById('budgetChart');
        if (budgetCtx) {
            const tierBudgets = {};
            initiatives.forEach(i => {
                if (!tierBudgets[i.tier]) tierBudgets[i.tier] = 0;
                tierBudgets[i.tier] += i.budget || 0;
            });

            window.chartInstances.budgetChart = new Chart(budgetCtx, {
                type: 'bar',
                data: {
                    labels: Object.keys(tierBudgets),
                    datasets: [{
                        label: 'Budget (SAR)',
                        data: Object.values(tierBudgets).map(v => v / 1000000),
                        backgroundColor: '#0d5530',
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { callback: (value) => value + 'M' }
                        }
                    }
                }
            });
        }
    }

    // Portfolio & Delivery Charts
    if (state.dashboardPage === 'portfolio') {
        // Render D3.js Matrices
        renderPortfolioImpactMatrix();
        renderPortfolioDistributionMatrix();

        // Delivery Timeline Chart
        const deliveryCtx = document.getElementById('deliveryChart');
        if (deliveryCtx) {
            const monthlyData = {};
            initiatives.forEach(i => {
                const endMonth = i.end;
                if (!monthlyData[endMonth]) monthlyData[endMonth] = 0;
                monthlyData[endMonth]++;
            });

            const sortedMonths = Object.keys(monthlyData).sort();
            window.chartInstances.deliveryChart = new Chart(deliveryCtx, {
                type: 'line',
                data: {
                    labels: sortedMonths,
                    datasets: [{
                        label: 'Initiatives Delivered',
                        data: sortedMonths.map(m => monthlyData[m]),
                        borderColor: '#0d5530',
                        backgroundColor: 'rgba(13, 85, 48, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }

        // Tier Distribution Chart
        const tierCtx = document.getElementById('tierChart');
        if (tierCtx) {
            const tierCounts = {};
            initiatives.forEach(i => {
                if (!tierCounts[i.tier]) tierCounts[i.tier] = 0;
                tierCounts[i.tier]++;
            });

            window.chartInstances.tierChart = new Chart(tierCtx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(tierCounts),
                    datasets: [{
                        data: Object.values(tierCounts),
                        backgroundColor: ['#0d5530', '#2563eb', '#d97706', '#dc2626', '#6b7280'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { padding: 15, font: { size: 12, weight: '600' } }
                        }
                    }
                }
            });
        }
    }

    // BCG Maturity Chart
    if (state.dashboardPage === 'maturity') {
        const maturityCtx = document.getElementById('maturityRadar');
        if (maturityCtx) {
            window.chartInstances.maturityChart = new Chart(maturityCtx, {
                type: 'radar',
                data: {
                    labels: ['Strategy', 'Technology', 'People', 'Processes', 'Data', 'Culture'],
                    datasets: [{
                        label: 'Current Maturity',
                        data: [3.8, 3.5, 3.2, 3.6, 3.4, 3.1],
                        borderColor: '#0d5530',
                        backgroundColor: 'rgba(13, 85, 48, 0.2)',
                        pointBackgroundColor: '#0d5530',
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: '#0d5530'
                    }, {
                        label: 'Target Maturity',
                        data: [4.5, 4.5, 4.0, 4.3, 4.2, 4.0],
                        borderColor: '#d97706',
                        backgroundColor: 'rgba(217, 119, 6, 0.1)',
                        pointBackgroundColor: '#d97706',
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: '#d97706'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        r: {
                            beginAtZero: true,
                            max: 5,
                            ticks: { stepSize: 1 }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { padding: 15, font: { size: 12, weight: '600' } }
                        }
                    }
                }
            });
        }
    }

    // Three Engines Chart
    if (state.dashboardPage === 'engines') {
        const enginesCtx = document.getElementById('enginesChart');
        if (enginesCtx) {
            window.chartInstances.enginesChart = new Chart(enginesCtx, {
                type: 'bar',
                data: {
                    labels: ['Run', 'Grow', 'Transform'],
                    datasets: [{
                        label: 'Investment (SAR M)',
                        data: [850, 620, 380],
                        backgroundColor: ['#0d5530', '#2563eb', '#d97706'],
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { callback: (value) => value + 'M' }
                        }
                    }
                }
            });
        }
    }

    // Financial Charts
    if (state.dashboardPage === 'financial') {
        const totalBudget = initiatives.reduce((sum, i) => sum + i.budget, 0);
        const totalSpent = totalBudget * 0.42;

        // Budget Utilization Chart
        const utilizationCtx = document.getElementById('budgetUtilizationChart');
        if (utilizationCtx) {
            window.chartInstances.utilizationChart = new Chart(utilizationCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Spent', 'Remaining'],
                    datasets: [{
                        data: [totalSpent / 1000000, (totalBudget - totalSpent) / 1000000],
                        backgroundColor: ['#d97706', '#e5e7eb'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { padding: 15, font: { size: 12, weight: '600' } }
                        }
                    }
                }
            });
        }

        // ROI Chart
        const roiCtx = document.getElementById('roiChart');
        if (roiCtx) {
            window.chartInstances.roiChart = new Chart(roiCtx, {
                type: 'bar',
                data: {
                    labels: ['Tier 1a', 'Tier 1b', 'Tier 1c', 'Tier 1d', 'Contingent'],
                    datasets: [{
                        label: 'Expected ROI',
                        data: [3.2, 2.8, 2.5, 2.1, 1.8],
                        backgroundColor: '#059669',
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { callback: (value) => value + 'x' }
                        }
                    }
                }
            });
        }
    }

    // Budget & Resources Charts
    if (state.dashboardPage === 'budget') {
        // Budget Variance Chart
        const varianceCtx = document.getElementById('varianceChart');
        if (varianceCtx) {
            window.chartInstances.varianceChart = new Chart(varianceCtx, {
                type: 'bar',
                data: {
                    labels: ['Q1', 'Q2', 'Q3', 'Q4'],
                    datasets: [{
                        label: 'Planned',
                        data: [450, 480, 520, 400],
                        backgroundColor: '#2563eb'
                    }, {
                        label: 'Actual',
                        data: [470, 465, 495, 380],
                        backgroundColor: '#d97706'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { padding: 15, font: { size: 12, weight: '600' } }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { callback: (value) => value + 'M' }
                        }
                    }
                }
            });
        }

        // Resource Allocation Chart
        const resourceCtx = document.getElementById('resourceChart');
        if (resourceCtx) {
            window.chartInstances.resourceChart = new Chart(resourceCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Engineering', 'Operations', 'Marketing', 'Sales', 'Support'],
                    datasets: [{
                        data: [35, 25, 15, 15, 10],
                        backgroundColor: ['#0d5530', '#2563eb', '#d97706', '#dc2626', '#6b7280'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { padding: 15, font: { size: 12, weight: '600' } }
                        }
                    }
                }
            });
        }

        // Burn Rate Chart
        const burnRateCtx = document.getElementById('burnRateChart');
        if (burnRateCtx) {
            window.chartInstances.burnRateChart = new Chart(burnRateCtx, {
                type: 'line',
                data: {
                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
                    datasets: [{
                        label: 'Monthly Spend (SAR M)',
                        data: [120, 135, 142, 155, 148, 162, 158, 165, 170, 155, 145, 135],
                        borderColor: '#dc2626',
                        backgroundColor: 'rgba(220, 38, 38, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { callback: (value) => value + 'M' }
                        }
                    }
                }
            });
        }
    }

    // Risk Management
    if (state.dashboardPage === 'risk') {
        renderRiskHeatMap();
    }

    // Dependencies
    if (state.dashboardPage === 'dependencies') {
        renderDependencyNetwork();
    }
}

// ============================================================================
// INITIALIZE
// ============================================================================

render();

// Make functions global
window.selectTenant = selectTenant;
window.selectRole = selectRole;
window.continueToDashboard = continueToDashboard;
window.navigateTo = navigateTo;
window.logout = logout;
window.selectScenario = selectScenario;
window.openProjectWizard = openProjectWizard;
window.closeProjectWizard = closeProjectWizard;
window.runAIAutoFill = runAIAutoFill;
window.resetAIAutoFill = resetAIAutoFill;
window.updateFieldValue = updateFieldValue;
window.updateMultiselectValue = updateMultiselectValue;
window.updateMultiselectGain = updateMultiselectGain;
window.updateChecklistValue = updateChecklistValue;
window.updateTimelineValue = updateTimelineValue;
window.updateMiraValue = updateMiraValue;
window.updateFinancialTableValue = updateFinancialTableValue;
window.updateFinancialTableYear = updateFinancialTableYear;
window.updateGovernanceValue = updateGovernanceValue;
window.updateListItemValue = updateListItemValue;
window.addListItem = addListItem;
window.removeListItem = removeListItem;
window.wizardNext = wizardNext;
window.wizardPrev = wizardPrev;
window.submitWizard = submitWizard;
window.runPrioritization = runPrioritization;
window.viewProject = viewProject;
window.navigateToDashboardPage = navigateToDashboardPage;
window.initializeDashboardCharts = initializeDashboardCharts;

// Initialize charts if on dashboard page
if (state.currentPage === 'dashboard') {
    setTimeout(() => initializeDashboardCharts(), 100);
}

</script>
</body>
</html>

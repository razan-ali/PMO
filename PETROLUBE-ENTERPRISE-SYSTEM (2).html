<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PETROLUBE - Enterprise Initiative Management</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
</head>
<body>
<div id="app-root"></div>

<script>
// ============================================================================
// PETROLUBE ENTERPRISE SYSTEM - CLEAN VERSION
// ============================================================================

const STYLES = `
* { margin: 0; padding: 0; box-sizing: border-box; }

:root {
    --petro-green-900: #0F3B29;
    --petro-green-800: #1B5E3F;
    --petro-green-700: #2E7D52;
    --petro-green-600: #45A569;
    --petro-green-100: #E8F5E9;
    --petro-green-50: #F1F8F4;
    --petro-gold-600: #C9A961;
    --petro-gold-500: #D4B97A;
    --neutral-900: #1A1A1A;
    --neutral-800: #2C2C2C;
    --neutral-700: #404040;
    --neutral-600: #525252;
    --neutral-500: #737373;
    --neutral-400: #A3A3A3;
    --neutral-300: #D4D4D4;
    --neutral-200: #E5E5E5;
    --neutral-100: #F5F5F5;
    --neutral-50: #FAFAFA;
    --blue-600: #2563EB;
    --blue-500: #3B82F6;
    --blue-50: #EFF6FF;
    --green-600: #16A34A;
    --green-500: #22C55E;
    --green-50: #F0FDF4;
    --red-600: #DC2626;
    --red-50: #FEF2F2;
    --orange-600: #EA580C;
    --orange-500: #F97316;
    --purple-600: #9333EA;
    --purple-500: #A855F7;
}

body {
    font-family: 'Inter', sans-serif;
    background: var(--neutral-50);
    color: var(--neutral-900);
    line-height: 1.6;
}

.container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 0 32px;
}

header {
    background: linear-gradient(135deg, var(--petro-green-900), var(--petro-green-800));
    color: white;
    padding: 20px 0;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}

.header-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.logo-section {
    display: flex;
    align-items: center;
    gap: 16px;
    cursor: pointer;
}

.logo {
    width: 48px;
    height: 48px;
    background: var(--petro-gold-600);
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    font-weight: 900;
    color: white;
}

.logo-text h1 {
    font-size: 20px;
    font-weight: 900;
    margin-bottom: 2px;
}

.logo-text p {
    font-size: 11px;
    opacity: 0.8;
}

nav {
    display: flex;
    gap: 8px;
}

.nav-link {
    padding: 8px 16px;
    color: white;
    text-decoration: none;
    border-radius: 6px;
    font-weight: 600;
    font-size: 14px;
    transition: all 0.2s;
}

.nav-link:hover {
    background: rgba(255,255,255,0.1);
}

.nav-link.active {
    background: var(--petro-gold-600);
}

.user-info {
    display: flex;
    align-items: center;
    gap: 16px;
}

.user-badge {
    font-size: 13px;
}

.btn {
    padding: 10px 20px;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    font-size: 14px;
}

.btn-primary {
    background: var(--petro-green-700);
    color: white;
}

.btn-primary:hover {
    background: var(--petro-green-600);
}

.btn-secondary {
    background: var(--neutral-200);
    color: var(--neutral-900);
}

.btn-secondary:hover {
    background: var(--neutral-300);
}

.btn-gold {
    background: var(--petro-gold-600);
    color: white;
}

.btn-gold:hover {
    background: var(--petro-gold-500);
}

.btn-sm {
    padding: 6px 12px;
    font-size: 13px;
}

.btn-lg {
    padding: 14px 28px;
    font-size: 16px;
}

.btn-block {
    width: 100%;
}

.btn-danger {
    background: var(--red-600);
    color: white;
}

.card {
    background: white;
    border-radius: 12px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.grid {
    display: grid;
    gap: 24px;
}

.grid-2 {
    grid-template-columns: repeat(2, 1fr);
}

.grid-3 {
    grid-template-columns: repeat(3, 1fr);
}

.grid-4 {
    grid-template-columns: repeat(4, 1fr);
}

.grid-5 {
    grid-template-columns: repeat(5, 1fr);
}

.mb-4 {
    margin-bottom: 16px;
}

.mb-6 {
    margin-bottom: 24px;
}

.form-group {
    margin-bottom: 20px;
}

.form-label {
    display: block;
    font-weight: 600;
    margin-bottom: 8px;
    font-size: 14px;
    color: var(--neutral-900);
}

.form-label.required::after {
    content: ' *';
    color: var(--red-600);
}

.form-control {
    width: 100%;
    padding: 10px 14px;
    border: 1px solid var(--neutral-300);
    border-radius: 6px;
    font-size: 14px;
    font-family: inherit;
}

.form-control:focus {
    outline: none;
    border-color: var(--petro-green-600);
}

select.form-control {
    cursor: pointer;
}

textarea.form-control {
    resize: vertical;
    min-height: 80px;
}

.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 1000;
    align-items: center;
    justify-content: center;
}

.modal.active {
    display: flex;
}

.modal-content {
    background: white;
    border-radius: 16px;
    width: 90%;
    max-width: 900px;
    max-height: 90vh;
    overflow: hidden;
    display: flex;
    flex-direction: column;
}

.modal-header {
    padding: 24px 32px;
    border-bottom: 1px solid var(--neutral-200);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-header h2 {
    font-size: 24px;
    font-weight: 800;
}

.modal-close {
    background: none;
    border: none;
    font-size: 32px;
    cursor: pointer;
    color: var(--neutral-500);
    padding: 0;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.modal-body {
    padding: 32px;
    overflow-y: auto;
    flex: 1;
}

.modal-footer {
    padding: 16px 32px;
    border-top: 1px solid var(--neutral-200);
    display: flex;
    gap: 12px;
    justify-content: flex-end;
}

.wizard-steps {
    display: flex;
    justify-content: space-between;
    margin-bottom: 32px;
}

.wizard-step {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    position: relative;
}

.wizard-step-circle {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: var(--neutral-300);
    color: var(--neutral-600);
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    margin-bottom: 8px;
}

.wizard-step.active .wizard-step-circle {
    background: var(--petro-green-600);
    color: white;
}

.wizard-step.completed .wizard-step-circle {
    background: var(--petro-green-700);
    color: white;
}

.wizard-step-label {
    font-size: 12px;
    font-weight: 600;
    color: var(--neutral-600);
}

.wizard-step.active .wizard-step-label {
    color: var(--petro-green-700);
}

.agent-panel {
    background: linear-gradient(135deg, #EFF6FF 0%, #DBEAFE 100%);
    border: 2px solid var(--blue-500);
    border-radius: 12px;
    padding: 24px;
}

.alert {
    padding: 16px;
    border-radius: 8px;
    display: flex;
    gap: 12px;
    align-items: start;
}

.alert-success {
    background: var(--green-50);
    border: 1px solid var(--green-500);
    color: var(--green-600);
}

.badge {
    display: inline-block;
    padding: 4px 12px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 600;
}

.badge-green {
    background: var(--green-50);
    color: var(--green-600);
}

.badge-blue {
    background: var(--blue-50);
    color: var(--blue-600);
}

.badge-red {
    background: var(--red-50);
    color: var(--red-600);
}

.badge-orange {
    background: #FFF7ED;
    color: var(--orange-600);
}

.badge-purple {
    background: #FAF5FF;
    color: var(--purple-600);
}

.badge-gray {
    background: var(--neutral-100);
    color: var(--neutral-600);
}

.data-table {
    width: 100%;
    border-collapse: collapse;
}

.data-table th,
.data-table td {
    padding: 12px;
    text-align: left;
    border-bottom: 1px solid var(--neutral-200);
}

.data-table th {
    background: var(--neutral-50);
    font-weight: 700;
    font-size: 12px;
    text-transform: uppercase;
    color: var(--neutral-600);
}

.data-table tbody tr:hover {
    background: var(--neutral-50);
}

.text-center {
    text-align: center;
}

footer {
    background: var(--neutral-900);
    color: white;
    padding: 24px 0;
    margin-top: 60px;
}

@keyframes pulse {
    0%, 100% { opacity: 1; transform: scale(1); }
    50% { opacity: 0.6; transform: scale(1.1); }
}

.progress-bar {
    width: 100%;
    height: 6px;
    background: var(--neutral-200);
    border-radius: 3px;
    overflow: hidden;
}

.progress-fill {
    height: 100%;
    background: var(--petro-green-600);
    transition: width 0.3s ease;
}
`;

// ============================================================================
// USER ROLES & AUTHENTICATION
// ============================================================================

const USER_ROLES = {
    AGB_MEMBER: 'agb_member',
    PROJECT_OWNER: 'project_owner',
    FINANCE: 'finance',
    LEGAL: 'legal',
    IT: 'it',
    PMO: 'pmo',
    ADMIN: 'admin'
};

const USERS = [
    { id: 'user-1', name: 'Ghadah Al-Otaibi', role: USER_ROLES.PMO, email: 'ghadah@petrolube.sa', department: 'PMO' },
    { id: 'user-2', name: 'Ahmed Al-Fahad', role: USER_ROLES.LEGAL, email: 'ahmed.legal@petrolube.sa', department: 'Legal' },
    { id: 'user-3', name: 'Sara Al-Qahtani', role: USER_ROLES.FINANCE, email: 'sara.finance@petrolube.sa', department: 'Finance' },
    { id: 'user-4', name: 'Khalid Al-Mansour', role: USER_ROLES.IT, email: 'khalid.it@petrolube.sa', department: 'IT' },
    { id: 'user-5', name: 'Dr. Abdulaziz Al-Saud', role: USER_ROLES.AGB_MEMBER, email: 'abdulaziz@petrolube.sa', department: 'AGB' },
    { id: 'user-6', name: 'Rawan Al-Harbi', role: USER_ROLES.PROJECT_OWNER, email: 'rawan@petrolube.sa', department: 'Operations' },
    { id: 'user-7', name: 'Fahad Al-Dossary', role: USER_ROLES.ADMIN, email: 'fahad.admin@petrolube.sa', department: 'Administration' }
];

// Legal Review Criteria (1-5 scale, /30 total)
const LEGAL_CRITERIA = [
    { id: 1, title: 'Regulatory Compliance Completeness', desc: 'PDPL, NCA, Labor Law verified', weight: 5 },
    { id: 2, title: 'Contract Quality & Risk Mitigation', desc: 'Terms clear, liability balanced', weight: 5 },
    { id: 3, title: 'Intellectual Property Protection', desc: 'IP ownership assigned', weight: 5 },
    { id: 4, title: 'Data Privacy & Security Compliance', desc: 'PDPL assessment, DPA in place', weight: 5 },
    { id: 5, title: 'Liability & Indemnification Balance', desc: 'Caps appropriate', weight: 5 },
    { id: 6, title: 'Overall Legal Risk Acceptability', desc: 'Risk within tolerance', weight: 5 }
];

// Finance Review Criteria (1-5 scale, /30 total)
const FINANCE_CRITERIA = [
    { id: 1, title: 'Budget Accuracy & Completeness', desc: 'Detailed budget breakdown', weight: 5 },
    { id: 2, title: 'ROI Calculation Quality', desc: 'NPV, IRR, Payback Period calculated', weight: 5 },
    { id: 3, title: 'Financial Risk Assessment', desc: 'Currency risk, budget overrun probability', weight: 5 },
    { id: 4, title: 'Funding Source Clarity', desc: 'Approved budget line, allocation method', weight: 5 },
    { id: 5, title: 'Cash Flow Feasibility', desc: 'Payment schedule realistic', weight: 5 },
    { id: 6, title: 'Alignment with Portfolio Strategy', desc: 'Fits strategic tier', weight: 5 }
];

// IT Review Criteria (1-5 scale, /30 total)
const IT_CRITERIA = [
    { id: 1, title: 'Security Compliance', desc: 'NCA cybersecurity standards met', weight: 5 },
    { id: 2, title: 'Infrastructure Capacity', desc: 'Systems can support requirements', weight: 5 },
    { id: 3, title: 'Technical Specifications Quality', desc: 'Clear, complete, achievable', weight: 5 },
    { id: 4, title: 'Integration Complexity', desc: 'Compatible with existing systems', weight: 5 },
    { id: 5, title: 'Data Architecture', desc: 'Data governance standards followed', weight: 5 },
    { id: 6, title: 'IT Risk Assessment', desc: 'Technical risks identified and mitigated', weight: 5 }
];

// ============================================================================
// APP STATE
// ============================================================================

const state = {
    currentPage: 'landing',
    currentTenant: 'petrolube',
    currentUser: null, // Will be set on login
    currentRole: null,
    currentUserName: null,
    wizardStep: 1,
    wizardData: { criteriaValues: {} },
    showDescriptionBox: true,
    aiProcessing: false,
    aiComplete: false,
    selectedScenario: 'A',
    selectedPMOProject: null,
    selectedReviewProject: null, // For department reviewers
    projects: []
};

// ============================================================================
// SIMPLE SAMPLE DATA
// ============================================================================

const SAMPLE_PROJECTS = [
    {
        id: 'proj-1',
        name: 'Oracle ERP Redwood UX Migration',
        status: 'awaiting_legal_review',
        submittedBy: 'user-6',
        submittedAt: '2025-01-08T10:00:00Z',
        criteriaValues: {
            initiative_name: 'Oracle ERP Redwood UX Migration',
            initiative_id: 'INI-2025-001',
            strategic_priority: 'p1_critical',
            investment_required: 12500000,
            implementation_timeline: {
                start_date: '2025-01-15',
                end_date: '2025-12-31',
                confidence: 'high'
            }
        },
        approvalChain: {
            legal: {
                status: 'pending',
                score: null,
                reviewer: null,
                reviewedAt: null,
                scores: {},
                comments: '',
                mandatoryFields: {}
            },
            finance: {
                status: 'not_started',
                score: null,
                reviewer: null,
                reviewedAt: null,
                scores: {},
                comments: '',
                mandatoryFields: {}
            },
            it: {
                status: 'not_started',
                score: null,
                reviewer: null,
                reviewedAt: null,
                scores: {},
                comments: '',
                mandatoryFields: {}
            },
            agb: {
                status: 'not_started',
                approved: null,
                reviewer: null,
                reviewedAt: null,
                comments: ''
            }
        },
        auditTrail: [
            {
                timestamp: '2025-01-08T10:00:00Z',
                userId: 'user-6',
                action: 'Project submitted for approval',
                details: 'Initiated approval chain workflow'
            }
        ],
        tasks: [
            {
                name: 'Requirements Gathering',
                description: 'Collect requirements from stakeholders',
                assignedTo: 'Sara Al-Otaibi',
                priority: 'high',
                startDate: '2025-01-15',
                dueDate: '2025-02-01',
                status: 'in_progress',
                progress: 60,
                raci: {
                    responsible: ['Sara Al-Otaibi'],
                    accountable: ['Ghadah Al-Otaibi'],
                    consulted: ['Khalid Al-Fahad', 'Ahmed Al-Mansour'],
                    informed: ['Rawan Al-Harbi']
                },
                createdAt: '2025-01-10T10:00:00Z'
            },
            {
                name: 'Design UX Mockups',
                description: 'Create new Redwood interface designs',
                assignedTo: 'Khalid Al-Fahad',
                priority: 'high',
                startDate: '2025-01-20',
                dueDate: '2025-02-15',
                status: 'not_started',
                progress: 0,
                raci: {
                    responsible: ['Khalid Al-Fahad'],
                    accountable: ['Ghadah Al-Otaibi'],
                    consulted: ['Sara Al-Otaibi'],
                    informed: ['Rawan Al-Harbi']
                },
                createdAt: '2025-01-10T10:05:00Z'
            },
            {
                name: 'Backend API Development',
                description: 'Develop Redwood REST APIs',
                assignedTo: 'Ahmed Al-Mansour',
                priority: 'high',
                startDate: '2025-02-01',
                dueDate: '2025-03-15',
                status: 'not_started',
                progress: 0,
                raci: {
                    responsible: ['Ahmed Al-Mansour', 'Fahad Al-Dossary'],
                    accountable: ['Khalid Al-Mansour'],
                    consulted: ['Sara Al-Otaibi'],
                    informed: ['Ghadah Al-Otaibi']
                },
                createdAt: '2025-01-10T10:10:00Z'
            },
            {
                name: 'User Acceptance Testing',
                description: 'UAT with key stakeholders',
                assignedTo: 'Rawan Al-Harbi',
                priority: 'medium',
                startDate: '2025-03-01',
                dueDate: '2025-03-31',
                status: 'not_started',
                progress: 0,
                raci: {
                    responsible: ['Rawan Al-Harbi'],
                    accountable: ['Ghadah Al-Otaibi'],
                    consulted: ['All Stakeholders'],
                    informed: ['Executive Team']
                },
                createdAt: '2025-01-10T10:15:00Z'
            }
        ],
        milestones: [
            {
                name: 'Phase 1 Complete',
                date: '2025-03-31',
                status: 'pending'
            },
            {
                name: 'Go-Live',
                date: '2025-12-31',
                status: 'pending'
            }
        ],
        scores: {
            compositeScore: 87.5,
            rank: 1
        },
        createdAt: '2025-01-05T10:00:00Z',
        // ===== POST-APPROVAL LIFECYCLE (Activated after AGB approval) =====
        lifecycle: {
            activated: false, // Set to true when AGB approves
            currentGate: 'gate_0', // gate_0, gate_1, gate_2, gate_3, gate_4, gate_5
            currentPhase: 'approval', // approval, phase_0, phase_1, phase_2, phase_3, phase_4
            projectStatus: 'PENDING_APPROVAL', // GREEN, YELLOW, RED, BLUE, BLACK, COMPLETED, TERMINATED, PENDING_APPROVAL
            projectStartDate: null, // GO decision date + 5 business days
            projectEndDate: null, // Final phase end + 30 days
            handoverDate: null, // Date of formal handover from approval to delivery
            gateHistory: [], // Array of {gate, decision, date, reviewer, conditions}
            phases: {
                phase_0: {
                    name: 'Initiation',
                    status: 'not_started',
                    startDate: null,
                    endDate: null,
                    milestones: []
                },
                phase_1: {
                    name: 'Development/Pilot',
                    status: 'not_started',
                    startDate: null,
                    endDate: null,
                    milestones: []
                },
                phase_2: {
                    name: 'Scale/Deployment',
                    status: 'not_started',
                    startDate: null,
                    endDate: null,
                    milestones: []
                },
                phase_3: {
                    name: 'Optimization',
                    status: 'not_started',
                    startDate: null,
                    endDate: null,
                    milestones: []
                },
                phase_4: {
                    name: 'Closure',
                    status: 'not_started',
                    startDate: null,
                    endDate: null,
                    milestones: []
                }
            },
            tier: 'tier_1a', // tier_1a, tier_1b, tier_1c, tier_1d, contingent
            owner: {
                primary: null,
                backup: null,
                escalationPath: 'CITO'
            }
        },
        performance: {
            // Earned Value Management metrics
            budgetBaseline: 0,
            plannedValue: 0, // PV: Budget √ó Planned % Complete
            earnedValue: 0, // EV: Budget √ó Actual % Complete
            actualCost: 0, // AC: Actual spend to date
            schedulePerformanceIndex: 1.0, // SPI: EV / PV
            costPerformanceIndex: 1.0, // CPI: EV / AC
            scheduleVariance: 0, // SV: EV - PV
            costVariance: 0, // CV: EV - AC
            estimateAtCompletion: 0, // EAC: Planned Duration / SPI
            lastUpdated: null
        },
        changeRequests: [], // Array of change request objects
        riskRegister: {
            risks: [], // RAID: Risks
            assumptions: [], // RAID: Assumptions
            issues: [], // RAID: Issues
            dependencies: [] // RAID: Dependencies
        },
        benefitsTracking: {
            baselineSet: false,
            financialBenefits: {
                projectedRevenue: 0,
                actualRevenue: 0,
                projectedCostSavings: 0,
                actualCostSavings: 0
            },
            operationalBenefits: [],
            strategicBenefits: [],
            kpis: []
        },
        closureData: {
            status: 'active', // active, in_closure, closed
            closureType: null, // successful, terminated, delivery
            closureApprovedBy: null,
            closureDate: null,
            lessonsLearned: [],
            postImplementationReview: {
                scheduled: false,
                completed: false,
                findings: []
            }
        }
    },
    {
        id: 'proj-2',
        name: 'AI-Powered Predictive Maintenance',
        status: 'awaiting_finance_review',
        submittedBy: 'user-6',
        submittedAt: '2025-01-06T10:00:00Z',
        criteriaValues: {
            initiative_name: 'AI-Powered Predictive Maintenance',
            initiative_id: 'INI-2025-002',
            strategic_priority: 'p2_high',
            investment_required: 8000000,
            implementation_timeline: {
                start_date: '2025-02-01',
                end_date: '2025-09-30',
                confidence: 'medium'
            }
        },
        approvalChain: {
            legal: {
                status: 'approved',
                score: 26,
                reviewer: 'user-2',
                reviewedAt: '2025-01-07T14:00:00Z',
                scores: { 1: 4, 2: 5, 3: 4, 4: 5, 5: 4, 6: 4 },
                comments: 'Legal review complete. All regulatory requirements met.',
                mandatoryFields: {
                    saudi_regulatory_compliance: 'Compliant',
                    contract_review_status: 'Approved',
                    legal_risk_rating: 'Medium'
                }
            },
            finance: {
                status: 'pending',
                score: null,
                reviewer: null,
                reviewedAt: null,
                scores: {},
                comments: '',
                mandatoryFields: {}
            },
            it: {
                status: 'not_started',
                score: null,
                reviewer: null,
                reviewedAt: null,
                scores: {},
                comments: '',
                mandatoryFields: {}
            },
            agb: {
                status: 'not_started',
                approved: null,
                reviewer: null,
                reviewedAt: null,
                comments: ''
            }
        },
        auditTrail: [
            {
                timestamp: '2025-01-06T10:00:00Z',
                userId: 'user-6',
                action: 'Project submitted for approval',
                details: 'Initiated approval chain workflow'
            },
            {
                timestamp: '2025-01-07T14:00:00Z',
                userId: 'user-2',
                action: 'Legal review completed',
                details: 'Score: 26/30 - Approved'
            }
        ],
        tasks: [
            {
                name: 'Data Collection Setup',
                description: 'Set up IoT sensors for data collection',
                assignedTo: 'Sara Al-Otaibi',
                priority: 'high',
                startDate: '2025-02-01',
                dueDate: '2025-03-01',
                status: 'not_started',
                progress: 0,
                raci: {
                    responsible: ['Sara Al-Otaibi', 'Khalid Al-Mansour'],
                    accountable: ['Ghadah Al-Otaibi'],
                    consulted: ['IT Team'],
                    informed: ['Operations']
                },
                createdAt: '2025-01-10T11:00:00Z'
            },
            {
                name: 'AI Model Training',
                description: 'Train predictive maintenance ML models',
                assignedTo: 'Ahmed Al-Mansour',
                priority: 'high',
                startDate: '2025-03-01',
                dueDate: '2025-05-31',
                status: 'not_started',
                progress: 0,
                raci: {
                    responsible: ['Ahmed Al-Mansour'],
                    accountable: ['Ghadah Al-Otaibi'],
                    consulted: ['Data Science Team'],
                    informed: ['Executive Team']
                },
                createdAt: '2025-01-10T11:05:00Z'
            },
            {
                name: 'Integration with SAP',
                description: 'Integrate predictive alerts into SAP PM',
                assignedTo: 'Khalid Al-Mansour',
                priority: 'medium',
                startDate: '2025-06-01',
                dueDate: '2025-07-31',
                status: 'not_started',
                progress: 0,
                raci: {
                    responsible: ['Khalid Al-Mansour'],
                    accountable: ['Ghadah Al-Otaibi'],
                    consulted: ['SAP Team', 'IT Architecture'],
                    informed: ['Operations', 'Maintenance Team']
                },
                createdAt: '2025-01-10T11:10:00Z'
            }
        ],
        milestones: [
            {
                name: 'Pilot Launch',
                date: '2025-06-30',
                status: 'pending'
            }
        ],
        scores: {
            compositeScore: 82.3,
            rank: 2
        },
        createdAt: '2025-01-06T10:00:00Z'
    },
    {
        id: 'proj-3',
        name: 'Digital Twin Manufacturing',
        status: 'approved',
        submittedBy: 'user-6',
        submittedAt: '2025-01-02T10:00:00Z',
        criteriaValues: {
            initiative_name: 'Digital Twin Manufacturing',
            initiative_id: 'INI-2025-003',
            strategic_priority: 'p2_high',
            investment_required: 15000000,
            implementation_timeline: {
                start_date: '2025-03-01',
                end_date: '2026-02-28',
                confidence: 'medium'
            }
        },
        approvalChain: {
            legal: {
                status: 'approved',
                score: 28,
                reviewer: 'user-2',
                reviewedAt: '2025-01-03T10:00:00Z',
                scores: { 1: 5, 2: 5, 3: 4, 4: 5, 5: 5, 6: 4 },
                comments: 'Excellent legal compliance. All requirements met.',
                mandatoryFields: {
                    saudi_regulatory_compliance: 'Fully Compliant',
                    contract_review_status: 'Approved',
                    legal_risk_rating: 'Low'
                }
            },
            finance: {
                status: 'approved',
                score: 27,
                reviewer: 'user-3',
                reviewedAt: '2025-01-04T11:00:00Z',
                scores: { 1: 5, 2: 5, 3: 4, 4: 5, 5: 4, 6: 4 },
                comments: 'Strong financial case with solid ROI projections.',
                mandatoryFields: {
                    budget_accuracy: 'High',
                    roi_calculation: 'Complete',
                    cfo_approval: 'Approved'
                }
            },
            it: {
                status: 'approved',
                score: 25,
                reviewer: 'user-4',
                reviewedAt: '2025-01-05T14:00:00Z',
                scores: { 1: 4, 2: 4, 3: 4, 4: 5, 5: 4, 6: 4 },
                comments: 'Technical requirements well defined. Infrastructure ready.',
                mandatoryFields: {
                    security_compliance: 'NCA Compliant',
                    infrastructure_assessment: 'Ready',
                    technical_risk: 'Medium'
                }
            },
            agb: {
                status: 'approved',
                approved: true,
                reviewer: 'user-5',
                reviewedAt: '2025-01-07T10:00:00Z',
                comments: 'Overall compliance: 89%. Project approved for execution.',
                complianceScore: 89
            }
        },
        auditTrail: [
            {
                timestamp: '2025-01-02T10:00:00Z',
                userId: 'user-6',
                action: 'Project submitted for approval',
                details: 'Initiated approval chain workflow'
            },
            {
                timestamp: '2025-01-03T10:00:00Z',
                userId: 'user-2',
                action: 'Legal review completed',
                details: 'Score: 28/30 - Approved'
            },
            {
                timestamp: '2025-01-04T11:00:00Z',
                userId: 'user-3',
                action: 'Finance review completed',
                details: 'Score: 27/30 - Approved'
            },
            {
                timestamp: '2025-01-05T14:00:00Z',
                userId: 'user-4',
                action: 'IT review completed',
                details: 'Score: 25/30 - Approved'
            },
            {
                timestamp: '2025-01-07T10:00:00Z',
                userId: 'user-5',
                action: 'AGB final approval',
                details: 'Overall compliance: 89% - Project approved'
            }
        ],
        tasks: [],
        milestones: [],
        scores: {
            compositeScore: 79.8,
            rank: 3
        },
        createdAt: '2025-01-02T10:00:00Z'
    }
];

// Initialize projects
state.projects = [...SAMPLE_PROJECTS];

// ============================================================================
// RENDER ENGINE
// ============================================================================

function render() {
    const root = document.getElementById('app-root');
    root.innerHTML = `
        <style>${STYLES}</style>
        ${state.currentPage === 'landing' ? renderLanding() : ''}
        ${state.currentPage !== 'landing' ? renderHeader() : ''}
        ${state.currentPage !== 'landing' ? renderPage() : ''}
        ${state.currentPage !== 'landing' ? renderFooter() : ''}
        ${renderModals()}
    `;
}

function renderLanding() {
    return `
        <div style="background: linear-gradient(135deg, var(--petro-green-900), var(--petro-green-800)); min-height: 100vh; padding: 80px 24px; color: white;">
            <div class="container">
                <div class="text-center" style="margin-bottom: 64px;">
                    <div style="display: inline-flex; align-items: center; justify-content: center; width: 80px; height: 80px; background: rgba(255,255,255,0.15); border-radius: 20px; margin-bottom: 24px;">
                        <div style="font-size: 40px; font-weight: 800;">P</div>
                    </div>
                    <h1 style="font-size: 56px; margin-bottom: 16px; font-weight: 900;">PETROLUBE</h1>
                    <p style="font-size: 24px; color: var(--petro-gold-500); font-weight: 700; margin-bottom: 12px;">Enterprise Initiative Management</p>
                    <p style="color: rgba(255,255,255,0.8); font-size: 16px;">AI-Powered ‚Ä¢ PMO Dashboard ‚Ä¢ Task Management</p>
                </div>

                <div style="background: white; border-radius: 20px; padding: 48px; max-width: 700px; margin: 0 auto; box-shadow: 0 20px 60px rgba(0,0,0,0.4);">
                    <h2 style="color: var(--petro-green-800); margin-bottom: 32px; font-size: 26px; font-weight: 800;">Login</h2>

                    <div style="margin-bottom: 24px;">
                        <label style="font-weight: 700; margin-bottom: 12px; display: block; color: var(--neutral-700);">Select User</label>
                        <div style="max-height: 500px; overflow-y: auto;">
                            ${USERS.map(user => {
                                const roleIcons = {
                                    pmo: 'üìä',
                                    legal: '‚öñÔ∏è',
                                    finance: 'üí∞',
                                    it: 'üíª',
                                    agb_member: 'üëî',
                                    project_owner: 'üìÅ',
                                    admin: '‚öôÔ∏è'
                                };
                                const isSelected = state.currentUser?.id === user.id;
                                return `
                                <div onclick="loginAsUser('${user.id}')"
                                     style="padding: 16px 20px; border: 2px solid ${isSelected ? 'var(--petro-green-700)' : 'var(--neutral-200)'};
                                            border-radius: 10px; margin-bottom: 10px; cursor: pointer;
                                            background: ${isSelected ? 'var(--petro-green-50)' : 'white'}; transition: all 0.2s;">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <div style="display: flex; align-items: center; gap: 12px;">
                                            <div style="font-size: 24px;">${roleIcons[user.role] || 'üë§'}</div>
                                            <div>
                                                <strong style="font-weight: 700; color: var(--neutral-900);">${user.name}</strong>
                                                <p style="font-size: 13px; color: var(--neutral-600); margin-top: 2px;">${user.department} ‚Ä¢ ${user.role.replace('_', ' ').toUpperCase()}</p>
                                            </div>
                                        </div>
                                        ${isSelected ? '<div style="width: 20px; height: 20px; background: var(--petro-green-700); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 12px;">‚úì</div>' : ''}
                                    </div>
                                </div>
                            `}).join('')}
                        </div>
                    </div>

                    <button class="btn btn-gold btn-block btn-lg" onclick="continueToDashboard()" ${!state.currentUser ? 'disabled' : ''}>
                        Continue to Dashboard ‚Üí
                    </button>
                </div>
            </div>
        </div>
    `;
}

function renderHeader() {
    // Determine navigation based on user role
    let navLinks = '';

    if (state.currentRole === USER_ROLES.LEGAL) {
        navLinks = `<a href="#" class="nav-link ${state.currentPage === 'legal-review' ? 'active' : ''}" onclick="event.preventDefault(); navigateTo('legal-review');">‚öñÔ∏è Legal Review</a>`;
    } else if (state.currentRole === USER_ROLES.FINANCE) {
        navLinks = `<a href="#" class="nav-link ${state.currentPage === 'finance-review' ? 'active' : ''}" onclick="event.preventDefault(); navigateTo('finance-review');">üí∞ Finance Review</a>`;
    } else if (state.currentRole === USER_ROLES.IT) {
        navLinks = `<a href="#" class="nav-link ${state.currentPage === 'it-review' ? 'active' : ''}" onclick="event.preventDefault(); navigateTo('it-review');">üíª IT Review</a>`;
    } else if (state.currentRole === USER_ROLES.AGB_MEMBER) {
        navLinks = `<a href="#" class="nav-link ${state.currentPage === 'agb-review' ? 'active' : ''}" onclick="event.preventDefault(); navigateTo('agb-review');">üëî AGB Approval</a>`;
    } else {
        // PMO, Project Owner, Admin get full navigation
        navLinks = `
            <a href="#" class="nav-link ${state.currentPage === 'dashboard' ? 'active' : ''}" onclick="event.preventDefault(); navigateTo('dashboard');">Dashboard</a>
            <a href="#" class="nav-link ${state.currentPage === 'projects' ? 'active' : ''}" onclick="event.preventDefault(); navigateTo('projects');">Projects</a>
            <a href="#" class="nav-link ${state.currentPage === 'pmo' ? 'active' : ''}" onclick="event.preventDefault(); navigateTo('pmo');">PMO Manager</a>
        `;
    }

    return `
        <header>
            <div class="header-content container">
                <div class="logo-section" onclick="navigateTo('dashboard')">
                    <div class="logo">P</div>
                    <div class="logo-text">
                        <h1>PETROLUBE</h1>
                        <p>Enterprise Initiative Management</p>
                    </div>
                </div>
                <nav>
                    ${navLinks}
                </nav>
                <div class="user-info">
                    <div class="user-badge">
                        <span style="font-weight: 700;">${state.currentUserName}</span>
                        <div style="font-size: 11px; opacity: 0.7; margin-top: 2px;">${state.currentUser?.department || ''}</div>
                    </div>
                    <button class="btn btn-secondary btn-sm" onclick="logout()">Logout</button>
                </div>
            </div>
        </header>
    `;
}

function renderFooter() {
    return `
        <footer>
            <div class="container" style="display: flex; justify-content: space-between; align-items: center;">
                <div style="font-size: 14px;">
                    <span style="color: var(--petro-gold-500); font-weight: 700;">PETROLUBE</span>
                    <span style="opacity: 0.7; margin: 0 8px;">‚Ä¢</span>
                    Enterprise System
                </div>
                <div style="font-size: 13px; opacity: 0.7;">¬© 2025 PETROLUBE</div>
            </div>
        </footer>
    `;
}

function renderPage() {
    if (state.currentPage === 'dashboard') return renderDashboard();
    if (state.currentPage === 'projects') return renderProjects();
    if (state.currentPage === 'pmo') return renderPMOManager();
    if (state.currentPage === 'legal-review') return renderLegalReview();
    if (state.currentPage === 'finance-review') return renderFinanceReview();
    if (state.currentPage === 'it-review') return renderITReview();
    if (state.currentPage === 'agb-review') return renderAGBReview();
    return '<div class="container">Page not found</div>';
}

function renderDashboard() {
    const totalProjects = state.projects.length;
    const activeProjects = state.projects.filter(p => p.status === 'Ready').length;
    const totalTasks = state.projects.reduce((sum, p) => sum + (p.tasks?.length || 0), 0);
    const completedTasks = state.projects.reduce((sum, p) => sum + (p.tasks?.filter(t => t.status === 'completed').length || 0), 0);

    return `
        <div class="container" style="padding: 40px 32px;">
            <div style="margin-bottom: 32px;">
                <h2 style="font-size: 32px; font-weight: 900; color: var(--neutral-900); margin-bottom: 8px;">Dashboard</h2>
                <p style="color: var(--neutral-600); font-size: 16px;">Portfolio Overview</p>
            </div>

            <div class="grid grid-4 mb-6">
                ${[
                    { icon: 'üìÅ', label: 'Total Projects', value: totalProjects, color: 'var(--blue-600)' },
                    { icon: 'üöÄ', label: 'Active Projects', value: activeProjects, color: 'var(--green-600)' },
                    { icon: '‚úì', label: 'Total Tasks', value: totalTasks, color: 'var(--purple-600)' },
                    { icon: 'üìà', label: 'Completed Tasks', value: completedTasks, color: 'var(--orange-600)' }
                ].map(stat => `
                    <div class="card" style="padding: 24px; text-align: center;">
                        <div style="font-size: 40px; margin-bottom: 12px;">${stat.icon}</div>
                        <div style="font-size: 28px; font-weight: 800; color: ${stat.color}; margin-bottom: 4px;">${stat.value}</div>
                        <div style="font-size: 13px; color: var(--neutral-600); font-weight: 600; text-transform: uppercase;">${stat.label}</div>
                    </div>
                `).join('')}
            </div>

            <div class="card" style="padding: 32px;">
                <h3 style="font-size: 20px; font-weight: 800; margin-bottom: 24px;">Recent Projects</h3>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Project Name</th>
                            <th>Status</th>
                            <th>Tasks</th>
                            <th>Timeline</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${state.projects.map(p => `
                            <tr>
                                <td><strong>${p.criteriaValues?.initiative_name || p.name}</strong></td>
                                <td><span class="badge badge-green">${p.status}</span></td>
                                <td>${p.tasks?.length || 0} tasks</td>
                                <td>${p.criteriaValues?.implementation_timeline?.start_date || 'TBD'} ‚Üí ${p.criteriaValues?.implementation_timeline?.end_date || 'TBD'}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        </div>
    `;
}

function renderProjects() {
    return `
        <div class="container" style="padding: 40px 32px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 32px;">
                <div>
                    <h2 style="font-size: 32px; font-weight: 900; color: var(--neutral-900); margin-bottom: 8px;">Projects</h2>
                    <p style="color: var(--neutral-600); font-size: 16px;">${state.projects.length} initiatives</p>
                </div>
                <button class="btn btn-gold btn-lg" onclick="openProjectWizard()">+ Create New Initiative</button>
            </div>

            <div class="card" style="padding: 32px;">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Initiative Name</th>
                            <th>ID</th>
                            <th>Score</th>
                            <th>Priority</th>
                            <th>Investment</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${state.projects.map(p => `
                            <tr>
                                <td><strong>${p.criteriaValues?.initiative_name || p.name}</strong></td>
                                <td><span class="badge badge-gray">${p.criteriaValues?.initiative_id || p.id}</span></td>
                                <td><div style="font-size: 20px; font-weight: 800; color: var(--petro-green-600);">${p.scores?.compositeScore?.toFixed(1) || '--'}</div></td>
                                <td><span class="badge badge-orange">${p.criteriaValues?.strategic_priority || 'N/A'}</span></td>
                                <td><strong>${p.criteriaValues?.investment_required ? (p.criteriaValues.investment_required / 1000000).toFixed(1) + 'M SAR' : '‚Äî'}</strong></td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        </div>
    `;
}

function renderPMOManager() {
    const selectedProject = state.selectedPMOProject ? state.projects.find(p => p.id === state.selectedPMOProject) : null;
    const totalTasks = state.projects.reduce((sum, p) => sum + (p.tasks?.length || 0), 0);
    const completedTasks = state.projects.reduce((sum, p) => sum + (p.tasks?.filter(t => t.status === 'completed').length || 0), 0);
    const totalMilestones = state.projects.reduce((sum, p) => sum + (p.milestones?.length || 0), 0);
    const pmoView = state.pmoView || 'tasks'; // tasks, gantt, raci

    return `
        <div class="container" style="padding: 40px 32px;">
            <div style="margin-bottom: 32px;">
                <h2 style="font-size: 32px; font-weight: 900; color: var(--neutral-900); margin-bottom: 8px;">üìä PMO Manager Dashboard</h2>
                <p style="color: var(--neutral-600); font-size: 16px;">Project timelines, task management, and portfolio tracking</p>
            </div>

            <!-- View Tabs -->
            <div style="margin-bottom: 24px; display: flex; gap: 8px; border-bottom: 2px solid var(--neutral-200); padding-bottom: 0;">
                <button class="btn ${pmoView === 'tasks' ? 'btn-primary' : 'btn-secondary'}" style="border-radius: 8px 8px 0 0;"
                        onclick="setPMOView('tasks')">üìã Task Management</button>
                <button class="btn ${pmoView === 'gantt' ? 'btn-primary' : 'btn-secondary'}" style="border-radius: 8px 8px 0 0;"
                        onclick="setPMOView('gantt')">üìä Portfolio Gantt Chart</button>
                <button class="btn ${pmoView === 'raci' ? 'btn-primary' : 'btn-secondary'}" style="border-radius: 8px 8px 0 0;"
                        onclick="setPMOView('raci')">üë• RACI Matrix</button>
                <button class="btn ${pmoView === 'lifecycle' ? 'btn-primary' : 'btn-secondary'}" style="border-radius: 8px 8px 0 0;"
                        onclick="setPMOView('lifecycle')">üéØ Lifecycle & Performance</button>
            </div>

            ${pmoView === 'gantt' ? renderPortfolioGantt() : ''}
            ${pmoView === 'raci' ? renderRACIMatrix() : ''}
            ${pmoView === 'lifecycle' ? renderLifecycleDashboard() : ''}
            ${pmoView === 'tasks' ? `
            <div class="grid grid-4 mb-6">
                ${[
                    { icon: 'üìÅ', label: 'Total Projects', value: state.projects.length, color: 'var(--blue-600)' },
                    { icon: '‚úì', label: 'Total Tasks', value: totalTasks, color: 'var(--purple-600)' },
                    { icon: 'üìà', label: 'Completed', value: completedTasks, color: 'var(--green-600)' },
                    { icon: 'üìç', label: 'Milestones', value: totalMilestones, color: 'var(--orange-600)' }
                ].map(stat => `
                    <div class="card" style="padding: 24px; text-align: center;">
                        <div style="font-size: 40px; margin-bottom: 12px;">${stat.icon}</div>
                        <div style="font-size: 28px; font-weight: 800; color: ${stat.color}; margin-bottom: 4px;">${stat.value}</div>
                        <div style="font-size: 13px; color: var(--neutral-600); font-weight: 600; text-transform: uppercase;">${stat.label}</div>
                    </div>
                `).join('')}
            </div>

            <div class="grid grid-2 mb-6">
                <div class="card" style="padding: 24px;">
                    <h3 style="font-size: 18px; font-weight: 800; color: var(--neutral-900); margin-bottom: 16px;">üìÇ Select Project</h3>
                    <div style="max-height: 500px; overflow-y: auto;">
                        ${state.projects.map(project => `
                            <div onclick="selectPMOProject('${project.id}')"
                                 style="padding: 16px; border: 2px solid ${selectedProject?.id === project.id ? 'var(--petro-green-700)' : 'var(--neutral-200)'};
                                        border-radius: 8px; margin-bottom: 12px; cursor: pointer;
                                        background: ${selectedProject?.id === project.id ? 'var(--petro-green-50)' : 'white'};
                                        transition: all 0.2s;">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                                    <strong style="font-weight: 700; color: var(--neutral-900); flex: 1;">${project.criteriaValues?.initiative_name || project.name}</strong>
                                    ${selectedProject?.id === project.id ? '<div style="width: 20px; height: 20px; background: var(--petro-green-700); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 12px;">‚úì</div>' : ''}
                                </div>
                                <div style="display: flex; gap: 8px;">
                                    <span class="badge badge-blue">${project.tasks?.length || 0} tasks</span>
                                    <span class="badge badge-purple">${project.milestones?.length || 0} milestones</span>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>

                <div class="card" style="padding: 24px;">
                    ${selectedProject ? renderTaskManagement(selectedProject) : `
                        <div style="text-align: center; padding: 60px 20px; color: var(--neutral-400);">
                            <div style="font-size: 64px; margin-bottom: 16px;">üìã</div>
                            <p style="font-size: 16px; font-weight: 600;">Select a project to manage tasks</p>
                        </div>
                    `}
                </div>
            </div>
            ` : ''}
        </div>
    `;
}

// ============================================================================
// PORTFOLIO GANTT CHART
// ============================================================================

function renderPortfolioGantt() {
    // Calculate timeline bounds
    const today = new Date();
    const allTasks = [];
    state.projects.forEach(project => {
        if (project.tasks) {
            project.tasks.forEach(task => {
                allTasks.push({
                    ...task,
                    projectId: project.id,
                    projectName: project.criteriaValues?.initiative_name || project.name
                });
            });
        }
    });

    if (allTasks.length === 0) {
        return `
            <div class="card" style="padding: 60px; text-align: center;">
                <div style="font-size: 64px; margin-bottom: 16px;">üìä</div>
                <h3 style="font-size: 20px; font-weight: 700; margin-bottom: 8px;">No Tasks to Display</h3>
                <p style="color: var(--neutral-600);">Add tasks to projects to see them in the Gantt chart</p>
            </div>
        `;
    }

    // Find min and max dates
    const dates = allTasks.flatMap(t => [new Date(t.startDate), new Date(t.dueDate)]);
    const minDate = new Date(Math.min(...dates));
    const maxDate = new Date(Math.max(...dates));

    // Generate month columns
    const months = [];
    let current = new Date(minDate);
    current.setDate(1); // Start of month

    while (current <= maxDate) {
        months.push(new Date(current));
        current.setMonth(current.getMonth() + 1);
    }

    // Calculate position helpers
    const totalDays = Math.ceil((maxDate - minDate) / (1000 * 60 * 60 * 24));
    const getPosition = (date) => {
        const daysDiff = Math.ceil((new Date(date) - minDate) / (1000 * 60 * 60 * 24));
        return (daysDiff / totalDays) * 100;
    };
    const getWidth = (startDate, endDate) => {
        const duration = Math.ceil((new Date(endDate) - new Date(startDate)) / (1000 * 60 * 60 * 24));
        return (duration / totalDays) * 100;
    };

    return `
        <div class="card" style="padding: 24px;">
            <div style="margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
                <h3 style="font-size: 20px; font-weight: 800;">üìä Portfolio Gantt Chart</h3>
                <div style="font-size: 13px; color: var(--neutral-600);">
                    <strong>${allTasks.length} tasks</strong> across <strong>${state.projects.length} projects</strong>
                    | Timeline: ${minDate.toLocaleDateString()} - ${maxDate.toLocaleDateString()}
                </div>
            </div>

            <div style="overflow-x: auto; overflow-y: auto; max-height: 600px; border: 1px solid var(--neutral-200); border-radius: 8px;">
                <table style="width: 100%; min-width: 1200px; border-collapse: collapse;">
                    <thead style="position: sticky; top: 0; background: var(--neutral-50); z-index: 10;">
                        <tr>
                            <th style="width: 250px; text-align: left; padding: 12px; border-bottom: 2px solid var(--neutral-300); border-right: 2px solid var(--neutral-300); font-weight: 700;">Task / Project</th>
                            <th style="width: 100px; text-align: center; padding: 12px; border-bottom: 2px solid var(--neutral-300); border-right: 2px solid var(--neutral-300); font-weight: 700;">Assigned</th>
                            <th style="width: 80px; text-align: center; padding: 12px; border-bottom: 2px solid var(--neutral-300); border-right: 2px solid var(--neutral-300); font-weight: 700;">Status</th>
                            <th style="position: relative; padding: 12px; border-bottom: 2px solid var(--neutral-300);">
                                <div style="display: flex; position: relative; height: 40px;">
                                    ${months.map((month, idx) => {
                                        const monthStart = month;
                                        const monthEnd = new Date(month);
                                        monthEnd.setMonth(monthEnd.getMonth() + 1);
                                        monthEnd.setDate(0); // Last day of month

                                        const left = getPosition(monthStart);
                                        const width = getWidth(monthStart, monthEnd);

                                        return `
                                            <div style="position: absolute; left: ${left}%; width: ${width}%; border-right: 1px solid var(--neutral-300); padding: 4px; text-align: center;">
                                                <div style="font-size: 11px; font-weight: 700;">${month.toLocaleDateString('en-US', {month: 'short', year: 'numeric'})}</div>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        ${allTasks.map((task, idx) => {
                            const statusColors = {
                                'completed': 'var(--green-600)',
                                'in_progress': 'var(--blue-600)',
                                'blocked': 'var(--red-600)',
                                'not_started': 'var(--neutral-400)'
                            };
                            const statusBadge = {
                                'completed': 'badge-green',
                                'in_progress': 'badge-blue',
                                'blocked': 'badge-red',
                                'not_started': 'badge-gray'
                            };

                            const left = getPosition(task.startDate);
                            const width = getWidth(task.startDate, task.dueDate);
                            const isOverdue = new Date(task.dueDate) < today && task.status !== 'completed';

                            return `
                                <tr style="border-bottom: 1px solid var(--neutral-200);">
                                    <td style="padding: 12px; border-right: 2px solid var(--neutral-300);">
                                        <div style="font-weight: 700; font-size: 13px; margin-bottom: 4px;">${task.name}</div>
                                        <div style="font-size: 11px; color: var(--neutral-600);">${task.projectName}</div>
                                    </td>
                                    <td style="padding: 12px; text-align: center; border-right: 2px solid var(--neutral-300); font-size: 12px;">${task.assignedTo || 'Unassigned'}</td>
                                    <td style="padding: 12px; text-align: center; border-right: 2px solid var(--neutral-300);">
                                        <span class="badge ${statusBadge[task.status]}" style="font-size: 10px;">${task.status.replace('_', ' ')}</span>
                                    </td>
                                    <td style="padding: 8px; position: relative;">
                                        <div style="position: relative; height: 32px;">
                                            <!-- Gantt bar -->
                                            <div style="position: absolute; left: ${left}%; width: ${width}%; top: 50%; transform: translateY(-50%);
                                                        background: ${statusColors[task.status]}; height: 24px; border-radius: 4px;
                                                        ${isOverdue ? 'border: 2px solid var(--red-600);' : ''}
                                                        display: flex; align-items: center; justify-content: center; color: white; font-size: 10px; font-weight: 700;
                                                        box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                                ${task.progress || 0}%
                                                ${isOverdue ? ' üö®' : ''}
                                            </div>
                                            <!-- Today marker -->
                                            ${new Date(task.startDate) <= today && new Date(task.dueDate) >= today ? `
                                                <div style="position: absolute; left: ${getPosition(today)}%; width: 2px; height: 40px; background: var(--red-600); top: -4px; z-index: 5;">
                                                    <div style="position: absolute; top: -6px; left: 50%; transform: translateX(-50%); width: 0; height: 0; border-left: 4px solid transparent; border-right: 4px solid transparent; border-top: 6px solid var(--red-600);"></div>
                                                </div>
                                            ` : ''}
                                        </div>
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            </div>

            <div style="margin-top: 16px; display: flex; gap: 24px; font-size: 12px; color: var(--neutral-700);">
                <div><span style="display: inline-block; width: 16px; height: 16px; background: var(--green-600); border-radius: 3px; margin-right: 6px;"></span> Completed</div>
                <div><span style="display: inline-block; width: 16px; height: 16px; background: var(--blue-600); border-radius: 3px; margin-right: 6px;"></span> In Progress</div>
                <div><span style="display: inline-block; width: 16px; height: 16px; background: var(--neutral-400); border-radius: 3px; margin-right: 6px;"></span> Not Started</div>
                <div><span style="display: inline-block; width: 16px; height: 16px; background: var(--red-600); border-radius: 3px; margin-right: 6px;"></span> Blocked</div>
                <div><span style="display: inline-block; width: 2px; height: 16px; background: var(--red-600); margin-right: 6px;"></span> Today</div>
                <div>üö® Overdue</div>
            </div>
        </div>
    `;
}

// ============================================================================
// RACI MATRIX
// ============================================================================

function renderRACIMatrix() {
    if (!state.selectedPMOProject) {
        return `
            <div class="card" style="padding: 60px; text-align: center;">
                <div style="font-size: 64px; margin-bottom: 16px;">üë•</div>
                <h3 style="font-size: 20px; font-weight: 700; margin-bottom: 8px;">Select a Project</h3>
                <p style="color: var(--neutral-600);">Choose a project from the list to view its RACI matrix</p>
                <div style="margin-top: 24px; max-width: 600px; margin-left: auto; margin-right: auto;">
                    <div style="display: flex; flex-direction: column; gap: 12px;">
                        ${state.projects.map(project => `
                            <button class="btn btn-secondary" onclick="selectPMOProject('${project.id}'); setPMOView('raci');">
                                ${project.criteriaValues?.initiative_name || project.name}
                            </button>
                        `).join('')}
                    </div>
                </div>
            </div>
        `;
    }

    const project = state.projects.find(p => p.id === state.selectedPMOProject);
    const tasks = project?.tasks || [];

    if (tasks.length === 0) {
        return `
            <div class="card" style="padding: 60px; text-align: center;">
                <div style="font-size: 64px; margin-bottom: 16px;">üë•</div>
                <h3 style="font-size: 20px; font-weight: 700; margin-bottom: 8px;">No Tasks Yet</h3>
                <p style="color: var(--neutral-600);">Add tasks to ${project.name} to build a RACI matrix</p>
            </div>
        `;
    }

    // Extract all unique people from RACI assignments
    const allPeople = new Set();
    tasks.forEach(task => {
        if (task.raci) {
            [...(task.raci.responsible || []), ...(task.raci.accountable || []),
             ...(task.raci.consulted || []), ...(task.raci.informed || [])].forEach(person => allPeople.add(person));
        }
    });
    const people = Array.from(allPeople);

    return `
        <div class="card" style="padding: 24px;">
            <div style="margin-bottom: 24px; display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h3 style="font-size: 20px; font-weight: 800; margin-bottom: 4px;">üë• RACI Matrix</h3>
                    <p style="font-size: 14px; color: var(--neutral-600);">${project.criteriaValues?.initiative_name || project.name}</p>
                </div>
                <button class="btn btn-secondary" onclick="setPMOView('tasks')">‚Üê Back to Tasks</button>
            </div>

            <div style="background: var(--blue-50); padding: 16px; border-radius: 8px; margin-bottom: 24px; border-left: 4px solid var(--blue-600);">
                <div style="font-weight: 700; margin-bottom: 8px;">RACI Legend:</div>
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; font-size: 13px;">
                    <div><strong style="color: var(--blue-700);">R</strong> = Responsible (Does the work)</div>
                    <div><strong style="color: var(--green-700);">A</strong> = Accountable (Final authority)</div>
                    <div><strong style="color: var(--purple-700);">C</strong> = Consulted (Provides input)</div>
                    <div><strong style="color: var(--neutral-700);">I</strong> = Informed (Kept updated)</div>
                </div>
            </div>

            <div style="overflow-x: auto; border: 1px solid var(--neutral-200); border-radius: 8px;">
                <table class="data-table" style="min-width: 800px;">
                    <thead>
                        <tr style="background: var(--neutral-100);">
                            <th style="min-width: 200px; position: sticky; left: 0; background: var(--neutral-100); z-index: 2;">Task</th>
                            ${people.map(person => `
                                <th style="min-width: 120px; text-align: center;">${person}</th>
                            `).join('')}
                        </tr>
                    </thead>
                    <tbody>
                        ${tasks.map(task => {
                            const getRaciForPerson = (person) => {
                                const roles = [];
                                if (task.raci?.responsible?.includes(person)) roles.push('R');
                                if (task.raci?.accountable?.includes(person)) roles.push('A');
                                if (task.raci?.consulted?.includes(person)) roles.push('C');
                                if (task.raci?.informed?.includes(person)) roles.push('I');
                                return roles;
                            };

                            return `
                                <tr>
                                    <td style="position: sticky; left: 0; background: white; font-weight: 600; z-index: 1;">
                                        ${task.name}
                                        <div style="font-size: 11px; color: var(--neutral-600); font-weight: 400; margin-top: 4px;">
                                            ${task.startDate} ‚Üí ${task.dueDate}
                                        </div>
                                    </td>
                                    ${people.map(person => {
                                        const roles = getRaciForPerson(person);
                                        return `
                                            <td style="text-align: center; padding: 8px;">
                                                ${roles.length > 0 ? `
                                                    <div style="display: flex; gap: 4px; justify-content: center; flex-wrap: wrap;">
                                                        ${roles.map(role => {
                                                            const colors = {
                                                                'R': 'var(--blue-600)',
                                                                'A': 'var(--green-600)',
                                                                'C': 'var(--purple-600)',
                                                                'I': 'var(--neutral-600)'
                                                            };
                                                            return `<span style="display: inline-flex; align-items: center; justify-content: center; width: 24px; height: 24px; background: ${colors[role]}; color: white; border-radius: 4px; font-weight: 700; font-size: 12px;">${role}</span>`;
                                                        }).join('')}
                                                    </div>
                                                ` : `<span style="color: var(--neutral-300);">‚Äî</span>`}
                                            </td>
                                        `;
                                    }).join('')}
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            </div>

            <div style="margin-top: 24px; font-size: 13px; color: var(--neutral-600);">
                <strong>Total Tasks:</strong> ${tasks.length} |
                <strong>Team Members:</strong> ${people.length} |
                <strong>RACI Assignments:</strong> ${tasks.reduce((sum, t) => sum + (t.raci ?
                    [...(t.raci.responsible || []), ...(t.raci.accountable || []), ...(t.raci.consulted || []), ...(t.raci.informed || [])].length : 0), 0)}
            </div>
        </div>
    `;
}

// ============================================================================
// LIFECYCLE & PERFORMANCE DASHBOARD
// ============================================================================

function renderLifecycleDashboard() {
    const approvedProjects = state.projects.filter(p => p.lifecycle?.activated);

    if (approvedProjects.length === 0) {
        return `
            <div class="card" style="padding: 60px; text-align: center;">
                <div style="font-size: 64px; margin-bottom: 16px;">üéØ</div>
                <h3 style="font-size: 20px; font-weight: 700; margin-bottom: 8px;">No Approved Projects Yet</h3>
                <p style="color: var(--neutral-600);">Projects will appear here after AGB approval activates the lifecycle</p>
            </div>
        `;
    }

    // Calculate portfolio statistics
    const statusCounts = {
        GREEN: approvedProjects.filter(p => p.lifecycle.projectStatus === 'GREEN').length,
        YELLOW: approvedProjects.filter(p => p.lifecycle.projectStatus === 'YELLOW').length,
        RED: approvedProjects.filter(p => p.lifecycle.projectStatus === 'RED').length,
        BLUE: approvedProjects.filter(p => p.lifecycle.projectStatus === 'BLUE').length,
        BLACK: approvedProjects.filter(p => p.lifecycle.projectStatus === 'BLACK').length
    };

    const avgSPI = approvedProjects.reduce((sum, p) => sum + (p.performance?.schedulePerformanceIndex || 0), 0) / approvedProjects.length;
    const avgCPI = approvedProjects.reduce((sum, p) => sum + (p.performance?.costPerformanceIndex || 0), 0) / approvedProjects.length;

    return `
        <div>
            <!-- Portfolio Health Overview -->
            <div class="grid grid-5 mb-6">
                ${[
                    { status: 'GREEN', icon: 'üü¢', label: 'On Track', count: statusCounts.GREEN },
                    { status: 'YELLOW', icon: 'üü°', label: 'At Risk', count: statusCounts.YELLOW },
                    { status: 'RED', icon: 'üî¥', label: 'Critical', count: statusCounts.RED },
                    { status: 'BLUE', icon: 'üîµ', label: 'On Hold', count: statusCounts.BLUE },
                    { status: 'BLACK', icon: '‚¨õ', label: 'Recovery', count: statusCounts.BLACK }
                ].map(stat => `
                    <div class="card" style="padding: 20px; text-align: center; border-left: 4px solid ${
                        stat.status === 'GREEN' ? 'var(--green-600)' :
                        stat.status === 'YELLOW' ? 'var(--orange-600)' :
                        stat.status === 'RED' ? 'var(--red-600)' :
                        stat.status === 'BLUE' ? 'var(--blue-600)' : 'var(--neutral-600)'
                    };">
                        <div style="font-size: 32px; margin-bottom: 8px;">${stat.icon}</div>
                        <div style="font-size: 24px; font-weight: 800; margin-bottom: 4px;">${stat.count}</div>
                        <div style="font-size: 11px; color: var(--neutral-600); font-weight: 600; text-transform: uppercase;">${stat.label}</div>
                    </div>
                `).join('')}
            </div>

            <!-- Portfolio Performance Metrics -->
            <div class="grid grid-2 mb-6">
                <div class="card" style="padding: 24px;">
                    <h4 style="font-size: 14px; color: var(--neutral-600); margin-bottom: 12px;">üìà Avg Schedule Performance</h4>
                    <div style="font-size: 36px; font-weight: 900; color: ${avgSPI >= 0.95 ? 'var(--green-600)' : avgSPI >= 0.80 ? 'var(--orange-600)' : 'var(--red-600)'};">
                        ${avgSPI.toFixed(2)}
                    </div>
                    <div style="font-size: 12px; color: var(--neutral-600); margin-top: 4px;">SPI ${avgSPI >= 1 ? '(Ahead)' : avgSPI >= 0.95 ? '(On Track)' : avgSPI >= 0.80 ? '(At Risk)' : '(Delayed)'}</div>
                </div>
                <div class="card" style="padding: 24px;">
                    <h4 style="font-size: 14px; color: var(--neutral-600); margin-bottom: 12px;">üí∞ Avg Cost Performance</h4>
                    <div style="font-size: 36px; font-weight: 900; color: ${avgCPI >= 0.95 ? 'var(--green-600)' : avgCPI >= 0.80 ? 'var(--orange-600)' : 'var(--red-600)'};">
                        ${avgCPI.toFixed(2)}
                    </div>
                    <div style="font-size: 12px; color: var(--neutral-600); margin-top: 4px;">CPI ${avgCPI >= 1 ? '(Under Budget)' : avgCPI >= 0.95 ? '(On Budget)' : avgCPI >= 0.80 ? '(At Risk)' : '(Over Budget)'}</div>
                </div>
            </div>

            <!-- Project List with Lifecycle Status -->
            <div class="card" style="padding: 24px;">
                <h3 style="font-size: 18px; font-weight: 800; margin-bottom: 20px;">üéØ Active Projects - Stage-Gate Lifecycle</h3>

                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Project</th>
                            <th>Status</th>
                            <th>Current Gate</th>
                            <th>Phase</th>
                            <th>SPI</th>
                            <th>CPI</th>
                            <th>Start Date</th>
                            <th>End Date</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${approvedProjects.map(project => {
                            const lifecycle = project.lifecycle;
                            const performance = project.performance || {};

                            return `
                                <tr onclick="selectPMOProject('${project.id}'); setPMOView('tasks');" style="cursor: pointer;">
                                    <td>
                                        <strong>${project.criteriaValues?.initiative_name || project.name}</strong>
                                        <div style="font-size: 11px; color: var(--neutral-600);">${project.criteriaValues?.initiative_id || project.id}</div>
                                    </td>
                                    <td>
                                        <span class="badge ${getStatusBadgeClass(lifecycle.projectStatus)}" style="display: inline-flex; align-items: center; gap: 4px;">
                                            ${getStatusIcon(lifecycle.projectStatus)} ${lifecycle.projectStatus}
                                        </span>
                                    </td>
                                    <td style="font-size: 12px;">${getGateName(lifecycle.currentGate).replace('Gate ', 'G')}</td>
                                    <td>
                                        <span class="badge badge-blue">${lifecycle.phases[lifecycle.currentPhase]?.name || lifecycle.currentPhase}</span>
                                    </td>
                                    <td>
                                        <div style="font-weight: 700; color: ${performance.schedulePerformanceIndex >= 0.95 ? 'var(--green-600)' : performance.schedulePerformanceIndex >= 0.80 ? 'var(--orange-600)' : 'var(--red-600)'};">
                                            ${(performance.schedulePerformanceIndex || 1.0).toFixed(2)}
                                        </div>
                                    </td>
                                    <td>
                                        <div style="font-weight: 700; color: ${performance.costPerformanceIndex >= 0.95 ? 'var(--green-600)' : performance.costPerformanceIndex >= 0.80 ? 'var(--orange-600)' : 'var(--red-600)'};">
                                            ${(performance.costPerformanceIndex || 1.0).toFixed(2)}
                                        </div>
                                    </td>
                                    <td style="font-size: 12px;">${lifecycle.projectStartDate || 'TBD'}</td>
                                    <td style="font-size: 12px;">${lifecycle.projectEndDate || 'TBD'}</td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            </div>

            <!-- Legend -->
            <div style="margin-top: 16px; padding: 16px; background: var(--blue-50); border-radius: 8px;">
                <div style="font-size: 13px; font-weight: 600; margin-bottom: 8px;">Performance Indices:</div>
                <div style="font-size: 12px; color: var(--neutral-700); display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px;">
                    <div><strong>SPI (Schedule Performance Index):</strong> EV / PV - Measures schedule efficiency</div>
                    <div><strong>CPI (Cost Performance Index):</strong> EV / AC - Measures cost efficiency</div>
                    <div><span style="color: var(--green-600);">‚óè</span> ‚â•0.95 = GREEN (On Track)</div>
                    <div><span style="color: var(--orange-600);">‚óè</span> 0.80-0.94 = YELLOW (At Risk)</div>
                    <div><span style="color: var(--red-600);">‚óè</span> <0.80 = RED (Critical)</div>
                    <div><span style="color: var(--blue-600);">‚óè</span> BLUE = On Hold (Dependency Block)</div>
                </div>
            </div>
        </div>
    `;
}

function renderTaskManagement(project) {
    const tasks = project.tasks || [];

    return `
        <div>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="font-size: 18px; font-weight: 800; color: var(--neutral-900);">üìã Tasks for ${project.criteriaValues?.initiative_name || project.name}</h3>
                <button class="btn btn-primary btn-sm" onclick="openAddTaskModal('${project.id}')">+ Add Task</button>
            </div>

            ${tasks.length === 0 ? `
                <div style="text-align: center; padding: 40px 20px; background: var(--neutral-50); border-radius: 8px;">
                    <div style="font-size: 48px; margin-bottom: 12px;">üìù</div>
                    <p style="color: var(--neutral-600); margin-bottom: 16px;">No tasks yet</p>
                    <button class="btn btn-secondary btn-sm" onclick="openAddTaskModal('${project.id}')">Create First Task</button>
                </div>
            ` : `
                <div style="max-height: 500px; overflow-y: auto;">
                    ${tasks.map((task, idx) => `
                        <div class="card" style="padding: 16px; margin-bottom: 12px; border-left: 4px solid ${
                            task.status === 'completed' ? 'var(--green-600)' :
                            task.status === 'in_progress' ? 'var(--blue-600)' :
                            task.status === 'blocked' ? 'var(--red-600)' : 'var(--neutral-400)'
                        };">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                                <div style="flex: 1;">
                                    <strong style="font-weight: 700; color: var(--neutral-900); display: block; margin-bottom: 8px;">${task.name}</strong>
                                    ${task.description ? `<p style="font-size: 13px; color: var(--neutral-600); margin-bottom: 8px;">${task.description}</p>` : ''}
                                </div>
                                <div style="display: flex; gap: 8px;">
                                    <button class="btn btn-secondary btn-sm" onclick="editTask('${project.id}', ${idx})">Edit</button>
                                    <button class="btn btn-danger btn-sm" onclick="deleteTask('${project.id}', ${idx})">Delete</button>
                                </div>
                            </div>

                            <div style="display: flex; gap: 16px; flex-wrap: wrap;">
                                <div>
                                    <label style="font-size: 11px; text-transform: uppercase; color: var(--neutral-600); font-weight: 700; display: block; margin-bottom: 4px;">Status</label>
                                    <select class="form-control" style="font-size: 13px; padding: 4px 8px;" onchange="updateTaskStatus('${project.id}', ${idx}, this.value)">
                                        <option value="not_started" ${task.status === 'not_started' ? 'selected' : ''}>Not Started</option>
                                        <option value="in_progress" ${task.status === 'in_progress' ? 'selected' : ''}>In Progress</option>
                                        <option value="blocked" ${task.status === 'blocked' ? 'selected' : ''}>Blocked</option>
                                        <option value="completed" ${task.status === 'completed' ? 'selected' : ''}>Completed</option>
                                    </select>
                                </div>
                                <div>
                                    <label style="font-size: 11px; text-transform: uppercase; color: var(--neutral-600); font-weight: 700; display: block; margin-bottom: 4px;">Priority</label>
                                    <span class="badge ${
                                        task.priority === 'high' ? 'badge-red' :
                                        task.priority === 'medium' ? 'badge-orange' : 'badge-gray'
                                    }">${task.priority || 'low'}</span>
                                </div>
                                ${task.assignedTo ? `
                                    <div>
                                        <label style="font-size: 11px; text-transform: uppercase; color: var(--neutral-600); font-weight: 700; display: block; margin-bottom: 4px;">Assigned To</label>
                                        <span style="font-size: 13px; color: var(--neutral-900);">${task.assignedTo}</span>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    `).join('')}
                </div>
            `}
        </div>
    `;
}

function renderModals() {
    return `
        <div id="projectWizardModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Create New Initiative</h2>
                    <button class="modal-close" onclick="closeProjectWizard()">√ó</button>
                </div>
                <div class="modal-body" id="wizardContent"></div>
            </div>
        </div>
    `;
}

function renderWizard() {
    const stepNames = ['AI Auto-Fill', 'Header & Strategic', 'Financial & Business Case', 'Scoring Dimensions', 'Implementation & Dependencies', 'Risk & Success Metrics'];

    let html = `
        <div class="wizard-steps" style="justify-content: flex-start; gap: 12px; overflow-x: auto;">
            ${[1, 2, 3, 4, 5, 6].map(s => `
                <div class="wizard-step ${state.wizardStep === s ? 'active' : state.wizardStep > s ? 'completed' : ''}" style="flex: 0 0 auto; min-width: 120px;">
                    <div class="wizard-step-circle">${state.wizardStep > s ? '‚úì' : s}</div>
                    <div class="wizard-step-label" style="font-size: 10px;">${stepNames[s - 1]}</div>
                </div>
            `).join('')}
        </div>
    `;

    if (state.wizardStep === 1) html += renderWizardStep1();
    else if (state.wizardStep === 2) html += renderWizardStep2_HeaderStrategic();
    else if (state.wizardStep === 3) html += renderWizardStep3_Financial();
    else if (state.wizardStep === 4) html += renderWizardStep4_Scoring();
    else if (state.wizardStep === 5) html += renderWizardStep5_Implementation();
    else if (state.wizardStep === 6) html += renderWizardStep6_RiskSuccess();

    const wizardContent = document.getElementById('wizardContent');
    if (wizardContent) {
        wizardContent.innerHTML = html;
    }
}

function renderWizardStep1() {
    if (state.aiProcessing) {
        return `
            <div style="text-align: center; padding: 60px 24px;">
                <div style="font-size: 64px; margin-bottom: 24px; animation: pulse 2s infinite;">‚ö°</div>
                <h4 style="font-size: 18px; font-weight: 800; color: var(--blue-600); margin-bottom: 12px;">AI is Processing...</h4>
                <p style="font-size: 14px; color: var(--neutral-700); margin-bottom: 24px;">Analyzing your initiative and populating fields...</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" disabled>Processing...</button>
            </div>
        `;
    }

    return `
        <div style="margin-bottom: 32px;">
            <h3 style="font-size: 20px; font-weight: 800; color: var(--neutral-900); margin-bottom: 8px;">ü§ñ Step 1: AI Auto-Fill (Optional)</h3>
            <p style="color: var(--neutral-600); font-size: 14px;">Let AI populate fields, or skip and enter manually</p>
        </div>

        ${state.showDescriptionBox ? `
            <div class="agent-panel">
                <div class="form-group">
                    <label class="form-label">Project Description (Optional)</label>
                    <textarea class="form-control" id="wizard-description" rows="6"
                              placeholder="Describe your initiative...">${state.wizardData.description || ''}</textarea>
                </div>
                <button class="btn btn-gold btn-lg btn-block" onclick="runAIAutoFill()">
                    ‚ú® Auto-Fill All Fields
                </button>
            </div>
        ` : `
            <div class="alert alert-success mb-4">
                <div style="font-size: 24px;">‚úÖ</div>
                <div>
                    <strong style="font-weight: 700;">AI Processing Complete!</strong><br>
                    <span style="font-size: 14px;">Fields have been populated. Review in next steps.</span>
                </div>
            </div>
            <button class="btn btn-secondary" onclick="resetAIAutoFill()">‚Ü∫ Re-run AI</button>
        `}

        <div style="background: var(--blue-50); border-left: 4px solid var(--blue-600); padding: 12px 16px; border-radius: 6px; margin: 24px 0;">
            <div style="font-weight: 700; color: var(--blue-900); margin-bottom: 4px;">üí° Tip</div>
            <div style="font-size: 13px; color: var(--blue-700);">AI is optional. Click "Next" to enter data manually.</div>
        </div>

        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeProjectWizard()">Cancel</button>
            <button class="btn btn-primary" onclick="wizardNext()">
                ${state.showDescriptionBox ? 'Skip AI & Enter Manually ‚Üí' : 'Next: Basic Info ‚Üí'}
            </button>
        </div>
    `;
}

function renderWizardStep2() {
    const name = state.wizardData.criteriaValues.initiative_name || '';
    const id = state.wizardData.criteriaValues.initiative_id || '';
    const priority = state.wizardData.criteriaValues.strategic_priority || '';
    const investment = state.wizardData.criteriaValues.investment_required || '';

    return `
        <div style="margin-bottom: 32px;">
            <h3 style="font-size: 20px; font-weight: 800; color: var(--neutral-900); margin-bottom: 8px;">üìã Step 2: Basic Information</h3>
            <p style="color: var(--neutral-600); font-size: 14px;">Define core initiative details</p>
        </div>

        <div class="card" style="padding: 24px; background: var(--neutral-50); margin-bottom: 24px;">
            <div class="grid grid-2">
                <div class="form-group">
                    <label class="form-label required">Initiative Name</label>
                    <input type="text" class="form-control" id="field-name" value="${name}"
                           onchange="updateFieldValue('initiative_name', this.value)">
                </div>
                <div class="form-group">
                    <label class="form-label">Initiative ID</label>
                    <input type="text" class="form-control" id="field-id" value="${id}"
                           onchange="updateFieldValue('initiative_id', this.value)">
                </div>
                <div class="form-group">
                    <label class="form-label">Strategic Priority</label>
                    <select class="form-control" onchange="updateFieldValue('strategic_priority', this.value)">
                        <option value="">Select...</option>
                        <option value="p1_critical" ${priority === 'p1_critical' ? 'selected' : ''}>P1 - Critical</option>
                        <option value="p2_high" ${priority === 'p2_high' ? 'selected' : ''}>P2 - High</option>
                        <option value="p3_medium" ${priority === 'p3_medium' ? 'selected' : ''}>P3 - Medium</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Investment Required (SAR)</label>
                    <input type="number" class="form-control" value="${investment}"
                           onchange="updateFieldValue('investment_required', parseFloat(this.value))">
                </div>
            </div>
        </div>

        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="wizardPrev()">‚Üê Back</button>
            <button class="btn btn-primary" onclick="wizardNext()">Next: Review ‚Üí</button>
        </div>
    `;
}

// ===========================================================================
// NEW 35-CRITERIA WIZARD STEPS
// ===========================================================================

function renderWizardStep2_HeaderStrategic() {
    const data = state.wizardData.criteriaValues || {};

    return `
        <div style="margin-bottom: 24px;">
            <h3 style="font-size: 20px; font-weight: 800; margin-bottom: 8px;">üìã Header & Strategic Positioning (Criteria 1-10)</h3>
            <p style="color: var(--neutral-600); font-size: 14px;">Core identification and strategic alignment</p>
        </div>

        <div style="max-height: 500px; overflow-y: auto; padding-right: 8px;">
            <!-- Section 1: Header & Identification (Criteria 1-5) -->
            <div class="card" style="padding: 20px; margin-bottom: 16px;">
                <h4 style="font-weight: 700; margin-bottom: 16px; color: var(--petro-green-800);">Section 1: Header & Identification</h4>

                <div class="grid grid-2">
                    <!-- Criterion 1: Initiative ID (Auto-generated) -->
                    <div class="form-group">
                        <label class="form-label">1. Initiative ID <span style="color: var(--neutral-500); font-size: 12px;">(Auto-generated)</span></label>
                        <input type="text" class="form-control" value="${data.initiative_id || 'NEW-' + String(Date.now()).slice(-3)}" disabled>
                    </div>

                    <!-- Criterion 2: Initiative Name -->
                    <div class="form-group">
                        <label class="form-label required">2. Initiative Name <span style="color: var(--neutral-500); font-size: 12px;">(30-80 chars)</span></label>
                        <input type="text" class="form-control" id="initiative-name" value="${data.initiative_name || ''}"
                               onchange="updateFieldValue('initiative_name', this.value)" maxlength="80" placeholder="Deploy ERP Redwood UX Migration">
                    </div>

                    <!-- Criterion 3: Strategic Domain -->
                    <div class="form-group">
                        <label class="form-label required">3. Strategic Domain</label>
                        <select class="form-control" onchange="updateFieldValue('strategic_domain', this.value)">
                            <option value="">Select domain...</option>
                            <option value="digital_transformation" ${data.strategic_domain === 'digital_transformation' ? 'selected' : ''}>Digital Transformation</option>
                            <option value="international_expansion" ${data.strategic_domain === 'international_expansion' ? 'selected' : ''}>International Expansion</option>
                            <option value="sustainability_esg" ${data.strategic_domain === 'sustainability_esg' ? 'selected' : ''}>Sustainability/ESG</option>
                            <option value="core_business_excellence" ${data.strategic_domain === 'core_business_excellence' ? 'selected' : ''}>Core Business Excellence</option>
                            <option value="ev_bio_lubricants" ${data.strategic_domain === 'ev_bio_lubricants' ? 'selected' : ''}>EV/Bio-lubricants</option>
                            <option value="innovation_new_products" ${data.strategic_domain === 'innovation_new_products' ? 'selected' : ''}>Innovation & New Products</option>
                        </select>
                    </div>

                    <!-- Criterion 4: Portfolio Category -->
                    <div class="form-group">
                        <label class="form-label required">4. Portfolio Category (BCG Matrix)</label>
                        <select class="form-control" onchange="updateFieldValue('portfolio_category', this.value)">
                            <option value="">Select category...</option>
                            <option value="core_incremental" ${data.portfolio_category === 'core_incremental' ? 'selected' : ''}>Core Incremental (CI) - Target 60%</option>
                            <option value="core_disruptive" ${data.portfolio_category === 'core_disruptive' ? 'selected' : ''}>Core Disruptive (CD) - Target 15%</option>
                            <option value="non_core_incremental" ${data.portfolio_category === 'non_core_incremental' ? 'selected' : ''}>Non-Core Incremental (NCI) - Target 15%</option>
                            <option value="non_core_disruptive" ${data.portfolio_category === 'non_core_disruptive' ? 'selected' : ''}>Non-Core Disruptive (NCD) - Target 10%</option>
                        </select>
                    </div>

                    <!-- Criterion 5: Three Engines Alignment -->
                    <div class="form-group">
                        <label class="form-label required">5. Three Engines Alignment</label>
                        <select class="form-control" onchange="updateFieldValue('three_engines_alignment', this.value)">
                            <option value="">Select primary engine...</option>
                            <option value="e1_sustain_grow_core" ${data.three_engines_alignment === 'e1_sustain_grow_core' ? 'selected' : ''}>E1: Sustain & Grow Core (60%)</option>
                            <option value="e2_expand_inorganically" ${data.three_engines_alignment === 'e2_expand_inorganically' ? 'selected' : ''}>E2: Expand Inorganically (25%)</option>
                            <option value="e3_base_oil_integration" ${data.three_engines_alignment === 'e3_base_oil_integration' ? 'selected' : ''}>E3: Base Oil Vertical Integration (15%)</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Section 2: Strategic Positioning (Criteria 6-10) -->
            <div class="card" style="padding: 20px; margin-bottom: 16px;">
                <h4 style="font-weight: 700; margin-bottom: 16px; color: var(--petro-green-800);">Section 2: Strategic Positioning</h4>

                <div class="grid grid-2">
                    <!-- Criterion 6: Quadrant Assignment -->
                    <div class="form-group">
                        <label class="form-label required">6. Quadrant Assignment</label>
                        <select class="form-control" onchange="updateFieldValue('quadrant_assignment', this.value)">
                            <option value="">Select quadrant...</option>
                            <option value="quick_win" ${data.quadrant_assignment === 'quick_win' ? 'selected' : ''}>Quick-Win (0-12 months)</option>
                            <option value="push_harder" ${data.quadrant_assignment === 'push_harder' ? 'selected' : ''}>Push-Harder (6-18 months)</option>
                            <option value="transformational" ${data.quadrant_assignment === 'transformational' ? 'selected' : ''}>Transformational (18-36 months)</option>
                            <option value="moonshot" ${data.quadrant_assignment === 'moonshot' ? 'selected' : ''}>Moonshot (36+ months)</option>
                        </select>
                    </div>

                    <!-- Criterion 7: Strategic Priority -->
                    <div class="form-group">
                        <label class="form-label required">7. Strategic Priority</label>
                        <select class="form-control" onchange="updateFieldValue('strategic_priority', this.value)">
                            <option value="">Select priority...</option>
                            <option value="p1_critical" ${data.strategic_priority === 'p1_critical' ? 'selected' : ''}>P1 Critical (CEO/Board)</option>
                            <option value="p2_high" ${data.strategic_priority === 'p2_high' ? 'selected' : ''}>P2 High (Trio)</option>
                            <option value="p3_medium" ${data.strategic_priority === 'p3_medium' ? 'selected' : ''}>P3 Medium (CITO)</option>
                            <option value="p4_low" ${data.strategic_priority === 'p4_low' ? 'selected' : ''}>P4 Low (Owner)</option>
                        </select>
                    </div>

                    <!-- Criterion 8: Year 1 Tier Assignment -->
                    <div class="form-group">
                        <label class="form-label required">8. Year 1 Tier Assignment</label>
                        <select class="form-control" onchange="updateFieldValue('year1_tier', this.value)">
                            <option value="">Select tier...</option>
                            <option value="tier_1a" ${data.year1_tier === 'tier_1a' ? 'selected' : ''}>Tier 1A - Catastrophic Dependency</option>
                            <option value="tier_1b" ${data.year1_tier === 'tier_1b' ? 'selected' : ''}>Tier 1B - Oracle AI Quick Win</option>
                            <option value="tier_1c" ${data.year1_tier === 'tier_1c' ? 'selected' : ''}>Tier 1C - Digital Quick Win</option>
                            <option value="tier_1d" ${data.year1_tier === 'tier_1d' ? 'selected' : ''}>Tier 1D - Sustainability Quick Win</option>
                            <option value="tier_2" ${data.year1_tier === 'tier_2' ? 'selected' : ''}>Tier 2 - Foundational Capability</option>
                            <option value="contingent" ${data.year1_tier === 'contingent' ? 'selected' : ''}>Contingent - Q3-Q4 Activation</option>
                            <option value="deferred" ${data.year1_tier === 'deferred' ? 'selected' : ''}>Deferred - Year 2-5</option>
                        </select>
                    </div>

                    <!-- Criterion 9: Aramco Competitive Response -->
                    <div class="form-group">
                        <label class="form-label required">9. Aramco Competitive Response</label>
                        <select class="form-control" onchange="updateFieldValue('aramco_response', this.value)">
                            <option value="">Select response type...</option>
                            <option value="offensive" ${data.aramco_response === 'offensive' ? 'selected' : ''}>Offensive - Preemptive Capture</option>
                            <option value="defensive" ${data.aramco_response === 'defensive' ? 'selected' : ''}>Defensive - Market Share Protection</option>
                            <option value="neutral" ${data.aramco_response === 'neutral' ? 'selected' : ''}>Neutral - Independent Value</option>
                        </select>
                    </div>

                    <!-- Criterion 10: BCG i2i Dimension Impact -->
                    <div class="form-group">
                        <label class="form-label required">10. BCG i2i Points Contribution</label>
                        <input type="number" class="form-control" value="${data.bcg_i2i_points || 0}" min="0" max="20" step="1"
                               onchange="updateFieldValue('bcg_i2i_points', parseInt(this.value))"
                               placeholder="Expected points toward 59‚Üí80 journey">
                        <small style="font-size: 11px; color: var(--neutral-600);">Current baseline: 59/100, Target: 80+</small>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Aramco Competitive Impact Description</label>
                    <textarea class="form-control" rows="3" onchange="updateFieldValue('aramco_impact_description', this.value)"
                              placeholder="Describe specific competitive impact vs. Aramco-Valvoline integration...">${data.aramco_impact_description || ''}</textarea>
                </div>
            </div>
        </div>

        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="wizardPrev()">‚Üê Back</button>
            <button class="btn btn-primary" onclick="wizardNext()">Next: Financial & Business Case ‚Üí</button>
        </div>
    `;
}

function renderWizardStep3_Financial() {
    const data = state.wizardData.criteriaValues || {};

    return `
        <div style="margin-bottom: 24px;">
            <h3 style="font-size: 20px; font-weight: 800; margin-bottom: 8px;">üí∞ Financial & Business Case (Criteria 17-23)</h3>
            <p style="color: var(--neutral-600); font-size: 14px;">Investment, ROI, and financial validations</p>
        </div>

        <div style="max-height: 500px; overflow-y: auto; padding-right: 8px;">
            <div class="card" style="padding: 20px; margin-bottom: 16px;">
                <h4 style="font-weight: 700; margin-bottom: 16px; color: var(--petro-green-800);">Investment & Timeline</h4>

                <div class="grid grid-3">
                    <!-- Criterion 17: Investment Required -->
                    <div class="form-group">
                        <label class="form-label required">17. Total Investment (SAR M)</label>
                        <input type="number" class="form-control" value="${data.investment_total || ''}" step="0.1"
                               onchange="updateFieldValue('investment_total', parseFloat(this.value))"
                               placeholder="12.5">
                    </div>
                    <div class="form-group">
                        <label class="form-label required">Year 1 Allocation (SAR M)</label>
                        <input type="number" class="form-control" value="${data.investment_year1 || ''}" step="0.1"
                               onchange="updateFieldValue('investment_year1', parseFloat(this.value))">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Year 2+ Allocation (SAR M)</label>
                        <input type="number" class="form-control" value="${data.investment_year2plus || ''}" step="0.1"
                               onchange="updateFieldValue('investment_year2plus', parseFloat(this.value))">
                    </div>
                    <div class="form-group">
                        <label class="form-label required">CAPEX (SAR M)</label>
                        <input type="number" class="form-control" value="${data.investment_capex || ''}" step="0.1"
                               onchange="updateFieldValue('investment_capex', parseFloat(this.value))">
                    </div>
                    <div class="form-group">
                        <label class="form-label required">OPEX (SAR M)</label>
                        <input type="number" class="form-control" value="${data.investment_opex || ''}" step="0.1"
                               onchange="updateFieldValue('investment_opex', parseFloat(this.value))">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Contingency (SAR M)</label>
                        <input type="number" class="form-control" value="${data.investment_contingency || ''}" step="0.1"
                               onchange="updateFieldValue('investment_contingency', parseFloat(this.value))"
                               placeholder="10-15% of total">
                    </div>

                    <!-- Criterion 18: Timeline -->
                    <div class="form-group">
                        <label class="form-label required">18. Total Duration (Months)</label>
                        <input type="number" class="form-control" value="${data.timeline_months || ''}"
                               onchange="updateFieldValue('timeline_months', parseInt(this.value))">
                    </div>
                    <div class="form-group">
                        <label class="form-label">First Value Realization Date</label>
                        <input type="date" class="form-control" value="${data.first_value_date || ''}"
                               onchange="updateFieldValue('first_value_date', this.value)">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Full ROI Realization Date</label>
                        <input type="date" class="form-control" value="${data.full_roi_date || ''}"
                               onchange="updateFieldValue('full_roi_date', this.value)">
                    </div>
                </div>
            </div>

            <div class="card" style="padding: 20px; margin-bottom: 16px;">
                <h4 style="font-weight: 700; margin-bottom: 16px; color: var(--petro-green-800);">Financial Gates (Must Pass)</h4>

                <div class="grid grid-2">
                    <!-- Criterion 21: IRR -->
                    <div class="form-group">
                        <label class="form-label required">21. IRR - Base Case (%)</label>
                        <input type="number" class="form-control" value="${data.irr_base || ''}" step="0.1"
                               onchange="updateFieldValue('irr_base', parseFloat(this.value))"
                               placeholder="Must exceed 15% hurdle">
                        ${(data.irr_base && data.irr_base < 15) ? '<small style="color: var(--red-600);">‚ö† Below 15% hurdle - CFO exception required</small>' : ''}
                        ${(data.irr_base && data.irr_base >= 15) ? '<small style="color: var(--green-600);">‚úì Exceeds 15% hurdle rate</small>' : ''}
                    </div>
                    <div class="form-group">
                        <label class="form-label">IRR - Conservative (%)</label>
                        <input type="number" class="form-control" value="${data.irr_conservative || ''}" step="0.1"
                               onchange="updateFieldValue('irr_conservative', parseFloat(this.value))">
                    </div>

                    <!-- Criterion 22: Payback Period -->
                    <div class="form-group">
                        <label class="form-label required">22. Simple Payback (Years)</label>
                        <input type="number" class="form-control" value="${data.payback_simple || ''}" step="0.1"
                               onchange="updateFieldValue('payback_simple', parseFloat(this.value))">
                        ${(data.quadrant_assignment === 'quick_win' && data.payback_simple > 1.5) ? '<small style="color: var(--red-600);">‚ö† Quick-Wins must have <18mo payback</small>' : ''}
                    </div>
                    <div class="form-group">
                        <label class="form-label required">Discounted Payback @ 12% (Years)</label>
                        <input type="number" class="form-control" value="${data.payback_discounted || ''}" step="0.1"
                               onchange="updateFieldValue('payback_discounted', parseFloat(this.value))">
                    </div>

                    <!-- Criterion 23: NPV -->
                    <div class="form-group">
                        <label class="form-label required">23. NPV @ 12% WACC (SAR M)</label>
                        <input type="number" class="form-control" value="${data.npv_5year || ''}" step="0.1"
                               onchange="updateFieldValue('npv_5year', parseFloat(this.value))"
                               placeholder="5-year projection">
                        ${(data.npv_5year && data.npv_5year <= 0) ? '<small style="color: var(--red-600);">‚ö† Negative NPV - CFO exception required</small>' : ''}
                        ${(data.npv_5year && data.npv_5year > 0) ? '<small style="color: var(--green-600);">‚úì Positive NPV</small>' : ''}
                    </div>
                    <div class="form-group">
                        <label class="form-label">NPV Sensitivity - Investment +20% (SAR M)</label>
                        <input type="number" class="form-control" value="${data.npv_sensitivity_investment || ''}" step="0.1"
                               onchange="updateFieldValue('npv_sensitivity_investment', parseFloat(this.value))">
                    </div>

                    <!-- Criterion 20: Expected ROI -->
                    <div class="form-group">
                        <label class="form-label required">20. Year 1 ROI (SAR M)</label>
                        <input type="number" class="form-control" value="${data.roi_year1 || ''}" step="0.1"
                               onchange="updateFieldValue('roi_year1', parseFloat(this.value))">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Year 3 Cumulative ROI (SAR M)</label>
                        <input type="number" class="form-control" value="${data.roi_year3 || ''}" step="0.1"
                               onchange="updateFieldValue('roi_year3', parseFloat(this.value))">
                    </div>

                    <!-- Criterion 19: Resource Requirements -->
                    <div class="form-group">
                        <label class="form-label required">19. Total FTE Required</label>
                        <input type="number" class="form-control" value="${data.total_fte || ''}"
                               onchange="updateFieldValue('total_fte', parseInt(this.value))">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Peak FTE</label>
                        <input type="number" class="form-control" value="${data.peak_fte || ''}"
                               onchange="updateFieldValue('peak_fte', parseInt(this.value))">
                    </div>
                </div>
            </div>
        </div>

        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="wizardPrev()">‚Üê Back</button>
            <button class="btn btn-primary" onclick="wizardNext()">Next: Scoring Dimensions ‚Üí</button>
        </div>
    `;
}

function renderWizardStep4_Scoring() {
    const data = state.wizardData.criteriaValues || {};

    // Calculate D1-D6 totals
    const d1Total = (parseInt(data.d1_market_position) || 0) + (parseInt(data.d1_revenue_growth) || 0) +
                    (parseInt(data.d1_competitive_diff) || 0) + (parseInt(data.d1_strategic_alignment) || 0) +
                    (parseInt(data.d1_aramco_defense) || 0);
    const d2Total = (parseInt(data.d2_npv_score) || 0) + (parseInt(data.d2_irr_score) || 0) +
                    (parseInt(data.d2_payback_score) || 0) + (parseInt(data.d2_revenue_score) || 0) +
                    (parseInt(data.d2_cost_savings_score) || 0);
    const d3Total = (parseInt(data.d3_technical_readiness) || 0) + (parseInt(data.d3_resource_availability) || 0) +
                    (parseInt(data.d3_timeline_realism) || 0) + (parseInt(data.d3_dependency_mgmt) || 0);
    const d4Total = (parseInt(data.d4_technical_risk) || 0) + (parseInt(data.d4_market_risk) || 0) +
                    (parseInt(data.d4_execution_risk) || 0);
    const d5Total = (parseInt(data.d5_tech_novelty) || 0) + (parseInt(data.d5_business_model) || 0) +
                    (parseInt(data.d5_i2i_advancement) || 0);

    // D6 Composite (Scenario B weights)
    const d6Composite = (d1Total * 0.35) + (d2Total * 0.25) + (d3Total * 0.20) + (d4Total * 0.15) + (d5Total * 0.15);

    return `
        <div style="margin-bottom: 24px;">
            <h3 style="font-size: 20px; font-weight: 800; margin-bottom: 8px;">üìä Scoring Dimensions (Criteria 11-16)</h3>
            <p style="color: var(--neutral-600); font-size: 14px;">Framework V4.0 dimensional scoring (0-5 scale per criterion)</p>
        </div>

        <div style="max-height: 500px; overflow-y: auto; padding-right: 8px;">
            <!-- D1: Strategic Impact (Criterion 11) -->
            <div class="card" style="padding: 20px; margin-bottom: 16px; border-left: 4px solid var(--blue-600);">
                <h4 style="font-weight: 700; margin-bottom: 12px;">11. D1: Strategic Impact (0-25 pts, Weight: 35%)</h4>
                <div class="grid grid-2" style="gap: 12px;">
                    ${[
                        {id: 'd1_market_position', label: 'Market Position', hint: '0=No impact, 5=Transformational'},
                        {id: 'd1_revenue_growth', label: 'Revenue Growth', hint: '0=<1M, 5=>75M SAR'},
                        {id: 'd1_competitive_diff', label: 'Competitive Differentiation', hint: '0=None, 5=Unique moat'},
                        {id: 'd1_strategic_alignment', label: 'Strategic Alignment', hint: '0=Misaligned, 5=Foundational'},
                        {id: 'd1_aramco_defense', label: 'Aramco Defense Value', hint: '0=None, 5=Offensive counter'}
                    ].map(item => `
                        <div>
                            <label style="font-size: 13px; font-weight: 600; margin-bottom: 4px; display: block;">${item.label}</label>
                            <select class="form-control" onchange="updateFieldValue('${item.id}', parseInt(this.value))">
                                ${[0,1,2,3,4,5].map(v => `<option value="${v}" ${(data[item.id] == v) ? 'selected' : ''}>${v}</option>`).join('')}
                            </select>
                            <small style="font-size: 11px; color: var(--neutral-600);">${item.hint}</small>
                        </div>
                    `).join('')}
                </div>
                <div style="margin-top: 12px; padding: 12px; background: var(--blue-50); border-radius: 6px;">
                    <strong>D1 Total: ${d1Total}/25 points</strong>
                </div>
            </div>

            <!-- D2: Financial Impact (Criterion 12) -->
            <div class="card" style="padding: 20px; margin-bottom: 16px; border-left: 4px solid var(--green-600);">
                <h4 style="font-weight: 700; margin-bottom: 12px;">12. D2: Financial Impact (0-25 pts, Weight: 25%)</h4>
                <div class="grid grid-2" style="gap: 12px;">
                    ${[
                        {id: 'd2_npv_score', label: 'NPV @ 12% WACC', hint: '0=Negative, 5=>75M SAR'},
                        {id: 'd2_irr_score', label: 'IRR', hint: '0=<15%, 5=>50%'},
                        {id: 'd2_payback_score', label: 'Payback Period', hint: '0=>5yr, 5=<1yr'},
                        {id: 'd2_revenue_score', label: 'Revenue Potential', hint: 'Same as NPV bands'},
                        {id: 'd2_cost_savings_score', label: 'Cost Savings', hint: '0=None, 5=>25M SAR'}
                    ].map(item => `
                        <div>
                            <label style="font-size: 13px; font-weight: 600; margin-bottom: 4px; display: block;">${item.label}</label>
                            <select class="form-control" onchange="updateFieldValue('${item.id}', parseInt(this.value))">
                                ${[0,1,2,3,4,5].map(v => `<option value="${v}" ${(data[item.id] == v) ? 'selected' : ''}>${v}</option>`).join('')}
                            </select>
                            <small style="font-size: 11px; color: var(--neutral-600);">${item.hint}</small>
                        </div>
                    `).join('')}
                </div>
                <div style="margin-top: 12px; padding: 12px; background: var(--green-50); border-radius: 6px;">
                    <strong>D2 Total: ${d2Total}/25 points</strong>
                </div>
            </div>

            <!-- D3: Execution Feasibility (Criterion 13) -->
            <div class="card" style="padding: 20px; margin-bottom: 16px; border-left: 4px solid var(--purple-600);">
                <h4 style="font-weight: 700; margin-bottom: 12px;">13. D3: Execution Feasibility (0-20 pts, Weight: 20%)</h4>
                <div class="grid grid-2" style="gap: 12px;">
                    ${[
                        {id: 'd3_technical_readiness', label: 'Technical Readiness (TRL)', hint: 'TRL 1-3=1pt, TRL 9=5pt'},
                        {id: 'd3_resource_availability', label: 'Resource Availability', hint: '0=Major gaps, 5=Fully available'},
                        {id: 'd3_timeline_realism', label: 'Timeline Realism', hint: '0=Unrealistic, 5=Proven'},
                        {id: 'd3_dependency_mgmt', label: 'Dependency Management', hint: '0=Critical blockers, 5=No blockers'}
                    ].map(item => `
                        <div>
                            <label style="font-size: 13px; font-weight: 600; margin-bottom: 4px; display: block;">${item.label}</label>
                            <select class="form-control" onchange="updateFieldValue('${item.id}', parseInt(this.value))">
                                ${[0,1,2,3,4,5].map(v => `<option value="${v}" ${(data[item.id] == v) ? 'selected' : ''}>${v}</option>`).join('')}
                            </select>
                            <small style="font-size: 11px; color: var(--neutral-600);">${item.hint}</small>
                        </div>
                    `).join('')}
                </div>
                <div style="margin-top: 12px; padding: 12px; background: var(--purple-50); border-radius: 6px;">
                    <strong>D3 Total: ${d3Total}/20 points</strong>
                </div>
            </div>

            <!-- D4: Risk Management (Criterion 14) -->
            <div class="card" style="padding: 20px; margin-bottom: 16px; border-left: 4px solid var(--orange-600);">
                <h4 style="font-weight: 700; margin-bottom: 12px;">14. D4: Risk Management (0-15 pts, Weight: 15%)</h4>
                <p style="font-size: 12px; color: var(--neutral-600); margin-bottom: 12px;">Lower risk = Higher score</p>
                <div class="grid grid-3" style="gap: 12px;">
                    ${[
                        {id: 'd4_technical_risk', label: 'Technical Risk', hint: '5=Negligible, 0=Catastrophic'},
                        {id: 'd4_market_risk', label: 'Market Risk', hint: '5=Negligible, 0=Catastrophic'},
                        {id: 'd4_execution_risk', label: 'Execution Risk', hint: '5=Negligible, 0=Catastrophic'}
                    ].map(item => `
                        <div>
                            <label style="font-size: 13px; font-weight: 600; margin-bottom: 4px; display: block;">${item.label}</label>
                            <select class="form-control" onchange="updateFieldValue('${item.id}', parseInt(this.value))">
                                ${[0,1,2,3,4,5].map(v => `<option value="${v}" ${(data[item.id] == v) ? 'selected' : ''}>${v}</option>`).join('')}
                            </select>
                            <small style="font-size: 11px; color: var(--neutral-600);">${item.hint}</small>
                        </div>
                    `).join('')}
                </div>
                <div style="margin-top: 12px; padding: 12px; background: var(--orange-50); border-radius: 6px;">
                    <strong>D4 Total: ${d4Total}/15 points</strong>
                </div>
            </div>

            <!-- D5: Innovation Index (Criterion 15) -->
            <div class="card" style="padding: 20px; margin-bottom: 16px; border-left: 4px solid var(--petro-gold-600);">
                <h4 style="font-weight: 700; margin-bottom: 12px;">15. D5: Innovation Index (0-15 pts, Weight: 15%)</h4>
                <div class="grid grid-3" style="gap: 12px;">
                    ${[
                        {id: 'd5_tech_novelty', label: 'Technology Novelty', hint: '0=Commodity, 5=Industry first'},
                        {id: 'd5_business_model', label: 'Business Model Innovation', hint: '0=Existing, 5=New model'},
                        {id: 'd5_i2i_advancement', label: 'i2i Advancement Potential', hint: '0=No impact, 5=>6pts'}
                    ].map(item => `
                        <div>
                            <label style="font-size: 13px; font-weight: 600; margin-bottom: 4px; display: block;">${item.label}</label>
                            <select class="form-control" onchange="updateFieldValue('${item.id}', parseInt(this.value))">
                                ${[0,1,2,3,4,5].map(v => `<option value="${v}" ${(data[item.id] == v) ? 'selected' : ''}>${v}</option>`).join('')}
                            </select>
                            <small style="font-size: 11px; color: var(--neutral-600);">${item.hint}</small>
                        </div>
                    `).join('')}
                </div>
                <div style="margin-top: 12px; padding: 12px; background: var(--petro-gold-50); border-radius: 6px;">
                    <strong>D5 Total: ${d5Total}/15 points</strong>
                </div>
            </div>

            <!-- D6: Total Composite (Criterion 16) -->
            <div class="card" style="padding: 20px; background: var(--petro-green-50); border: 2px solid var(--petro-green-700);">
                <h4 style="font-weight: 800; margin-bottom: 12px; font-size: 18px;">16. D6: Total Composite Score (0-100 pts)</h4>
                <div style="font-size: 32px; font-weight: 900; color: var(--petro-green-800); margin: 16px 0;">
                    ${d6Composite.toFixed(1)} / 100
                </div>
                <div style="font-size: 13px; color: var(--neutral-700);">
                    Scenario B (Balanced Portfolio) Weights:<br>
                    D1 (35%) = ${(d1Total * 0.35).toFixed(1)} |
                    D2 (25%) = ${(d2Total * 0.25).toFixed(1)} |
                    D3 (20%) = ${(d3Total * 0.20).toFixed(1)} |
                    D4 (15%) = ${(d4Total * 0.15).toFixed(1)} |
                    D5 (15%) = ${(d5Total * 0.15).toFixed(1)}
                </div>
            </div>
        </div>

        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="wizardPrev()">‚Üê Back</button>
            <button class="btn btn-primary" onclick="wizardNext()">Next: Implementation & Dependencies ‚Üí</button>
        </div>
    `;
}

function renderWizardStep5_Implementation() {
    const data = state.wizardData.criteriaValues || {};

    return `
        <div style="margin-bottom: 24px;">
            <h3 style="font-size: 20px; font-weight: 800; margin-bottom: 8px;">üöÄ Implementation & Dependencies (Criteria 24-30)</h3>
            <p style="color: var(--neutral-600); font-size: 14px;">Execution plan, milestones, and critical dependencies</p>
        </div>

        <div style="max-height: 500px; overflow-y: auto; padding-right: 8px;">
            <!-- Implementation Plan (Criteria 24-27) -->
            <div class="card" style="padding: 20px; margin-bottom: 16px;">
                <h4 style="font-weight: 700; margin-bottom: 16px; color: var(--petro-green-800);">Implementation Plan</h4>

                <div class="form-group">
                    <label class="form-label required">24. Phase 1 Plan (Objectives & Key Activities)</label>
                    <textarea class="form-control" rows="4" onchange="updateFieldValue('phase1_plan', this.value)"
                              placeholder="List primary objectives and key activities for Phase 1...">${data.phase1_plan || ''}</textarea>
                </div>

                <div class="grid grid-2">
                    <div class="form-group">
                        <label class="form-label">25. Phase 2 Plan (if >6 months)</label>
                        <textarea class="form-control" rows="3" onchange="updateFieldValue('phase2_plan', this.value)"
                                  placeholder="Phase 2 objectives...">${data.phase2_plan || ''}</textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">26. Phase 3 Plan (if >12 months)</label>
                        <textarea class="form-control" rows="3" onchange="updateFieldValue('phase3_plan', this.value)"
                                  placeholder="Phase 3 objectives...">${data.phase3_plan || ''}</textarea>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label required">27. Key Milestones & Gate Checkpoints</label>
                    <textarea class="form-control" rows="4" onchange="updateFieldValue('key_milestones', this.value)"
                              placeholder="Gate 0: Concept approval (Month 0)\nGate 1: Planning complete (Month 2)\nGate 2: Development ready (Month 6)\nGate 3: Pilot review (Month 10)\nGate 4: Deployment (Month 12)">${data.key_milestones || ''}</textarea>
                </div>
            </div>

            <!-- Dependencies (Criteria 28-30) -->
            <div class="card" style="padding: 20px; margin-bottom: 16px; border: 2px solid var(--red-500);">
                <h4 style="font-weight: 700; margin-bottom: 16px; color: var(--red-700);">Critical Dependencies & Blockers</h4>

                <div class="form-group">
                    <label class="form-label required">28. Critical Prerequisites (Strategic, Financial, Governance)</label>
                    <textarea class="form-control" rows="3" onchange="updateFieldValue('critical_prerequisites', this.value)"
                              placeholder="List must-have conditions before initiative start...">${data.critical_prerequisites || ''}</textarea>
                </div>

                <div class="form-group">
                    <label class="form-label required">29. Technical Dependencies</label>
                    <textarea class="form-control" rows="4" onchange="updateFieldValue('technical_dependencies', this.value)"
                              placeholder="Platform/System dependencies:\n- NEW-001: Oracle Redwood UX (Dec 31, 2025)\n- NEW-003: MiRA Data Quality ‚â•90% (Mar 31, 2026)\nData dependencies:\nIntegration dependencies:">${data.technical_dependencies || ''}</textarea>
                    <small style="color: var(--red-600); font-weight: 600;">‚ö† Check for catastrophic dependencies: NEW-001, NEW-002, NEW-003</small>
                </div>

                <div class="form-group">
                    <label class="form-label required">30. Organizational Dependencies</label>
                    <textarea class="form-control" rows="4" onchange="updateFieldValue('organizational_dependencies', this.value)"
                              placeholder="Talent dependencies:\n- NEW-002: Data Scientist Recruitment (4 roles, Jan 31, 2026)\nGovernance dependencies:\nStakeholder dependencies:">${data.organizational_dependencies || ''}</textarea>
                </div>

                <div style="background: var(--red-50); padding: 12px; border-radius: 6px; border-left: 4px solid var(--red-600);">
                    <strong style="color: var(--red-700);">Catastrophic Dependency Check:</strong>
                    <ul style="margin: 8px 0; padding-left: 20px; font-size: 13px;">
                        <li>NEW-001: Oracle Redwood UX Migration (Dec 31, 2025 deadline)</li>
                        <li>NEW-002: Data Scientist Recruitment (4 roles, Jan 31, 2026 deadline)</li>
                        <li>NEW-003: MiRA Data Quality ‚â•90% (Mar 31, 2026 deadline)</li>
                    </ul>
                    <small>If this initiative depends on any above, it escalates to CEO daily management</small>
                </div>
            </div>
        </div>

        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="wizardPrev()">‚Üê Back</button>
            <button class="btn btn-primary" onclick="wizardNext()">Next: Risk & Success Metrics ‚Üí</button>
        </div>
    `;
}

function renderWizardStep6_RiskSuccess() {
    const data = state.wizardData.criteriaValues || {};

    return `
        <div style="margin-bottom: 24px;">
            <h3 style="font-size: 20px; font-weight: 800; margin-bottom: 8px;">‚ö†Ô∏è Risk Assessment & Success Metrics (Criteria 31-35)</h3>
            <p style="color: var(--neutral-600); font-size: 14px;">Risk management, success criteria, and final recommendation</p>
        </div>

        <div style="max-height: 500px; overflow-y: auto; padding-right: 8px;">
            <!-- Risk Assessment (Criteria 31-33) -->
            <div class="card" style="padding: 20px; margin-bottom: 16px;">
                <h4 style="font-weight: 700; margin-bottom: 16px; color: var(--orange-700);">Risk Assessment</h4>

                <div class="form-group">
                    <label class="form-label required">31. Top 3 Risks (Probability √ó Impact)</label>
                    <textarea class="form-control" rows="5" onchange="updateFieldValue('top3_risks', this.value)"
                              placeholder="Risk 1: [Description] | Probability: [LOW/MEDIUM/HIGH] | Impact: [SAR X or Y months delay] | Mitigation: [...]\n\nRisk 2: [...]\n\nRisk 3: [...]">${data.top3_risks || ''}</textarea>
                    <small>Format per risk: Description | Probability | Impact | Mitigation strategy</small>
                </div>

                <div class="form-group">
                    <label class="form-label">32. Opportunity Scenarios (Upside potential)</label>
                    <textarea class="form-control" rows="3" onchange="updateFieldValue('opportunity_scenarios', this.value)"
                              placeholder="Opportunity 1: Market expansion if successful - +SAR 15M potential\nOpportunity 2: [...]">${data.opportunity_scenarios || ''}</textarea>
                    <small style="color: var(--green-600);">‚úì Informational only - adds +5% score uplift if complete</small>
                </div>

                <div class="form-group">
                    <label class="form-label required">33. Contingency Plans & Kill Criteria</label>
                    <textarea class="form-control" rows="4" onchange="updateFieldValue('contingency_plans', this.value)"
                              placeholder="IF: [Scenario] THEN: [Action plan]\nKill Criteria:\n- Cost overrun >50% of budget\n- Strategic fit lost due to market changes\nExit Strategy: [...]">${data.contingency_plans || ''}</textarea>
                </div>
            </div>

            <!-- Success Metrics (Criterion 34) -->
            <div class="card" style="padding: 20px; margin-bottom: 16px; border-left: 4px solid var(--green-600);">
                <h4 style="font-weight: 700; margin-bottom: 16px; color: var(--green-700);">34. Success Criteria (KPIs)</h4>

                <div class="form-group">
                    <label class="form-label required">Business Outcome Metrics</label>
                    <textarea class="form-control" rows="3" onchange="updateFieldValue('business_kpis', this.value)"
                              placeholder="ROI: ‚â•SAR 25M by Year 3\nMarket Share: +5% in target segment\nOperational Efficiency: 30% time reduction">${data.business_kpis || ''}</textarea>
                </div>

                <div class="form-group">
                    <label class="form-label required">BCG i2i Advancement Metrics</label>
                    <textarea class="form-control" rows="2" onchange="updateFieldValue('bcg_i2i_kpis', this.value)"
                              placeholder="Domain 4 (Portfolio Management): +3 points\nDomain 9 (Technology & Data): +2 points">${data.bcg_i2i_kpis || ''}</textarea>
                </div>

                <div class="form-group">
                    <label class="form-label required">Minimum Viable Success (MVS) for Gate 3</label>
                    <textarea class="form-control" rows="3" onchange="updateFieldValue('mvs_criteria', this.value)"
                              placeholder="Metric 1: Customer adoption ‚â•60%\nMetric 2: Technical performance ‚â•90% uptime\nMetric 3: Cost within ¬±10% of budget\nIf below: PIVOT or TERMINATE">${data.mvs_criteria || ''}</textarea>
                    <small style="color: var(--orange-600);">‚ö† GATE REQUIREMENT - Must define clear go/no-go thresholds</small>
                </div>
            </div>

            <!-- Recommendation (Criterion 35) -->
            <div class="card" style="padding: 20px; background: var(--petro-gold-50); border: 2px solid var(--petro-gold-600);">
                <h4 style="font-weight: 800; margin-bottom: 16px; font-size: 18px; color: var(--petro-green-900);">35. Recommendation & Board Priority</h4>

                <div class="grid grid-2">
                    <div class="form-group">
                        <label class="form-label required">Recommendation Decision</label>
                        <select class="form-control" onchange="updateFieldValue('recommendation_decision', this.value)">
                            <option value="">Select...</option>
                            <option value="accelerate" ${data.recommendation_decision === 'accelerate' ? 'selected' : ''}>ACCELERATE - Increase resources</option>
                            <option value="keep" ${data.recommendation_decision === 'keep' ? 'selected' : ''}>KEEP - Proceed as planned</option>
                            <option value="keep_conditional" ${data.recommendation_decision === 'keep_conditional' ? 'selected' : ''}>KEEP WITH CONDITIONS</option>
                            <option value="defer" ${data.recommendation_decision === 'defer' ? 'selected' : ''}>DEFER - Move to Year 2+</option>
                            <option value="remove" ${data.recommendation_decision === 'remove' ? 'selected' : ''}>REMOVE - Eliminate from portfolio</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label required">Board Priority</label>
                        <select class="form-control" onchange="updateFieldValue('board_priority', this.value)">
                            <option value="">Select...</option>
                            <option value="p1_critical" ${data.board_priority === 'p1_critical' ? 'selected' : ''}>P1 Critical (Board attention)</option>
                            <option value="p2_high" ${data.board_priority === 'p2_high' ? 'selected' : ''}>P2 High (Trio oversight)</option>
                            <option value="p3_medium" ${data.board_priority === 'p3_medium' ? 'selected' : ''}>P3 Medium (CITO oversight)</option>
                            <option value="p4_low" ${data.board_priority === 'p4_low' ? 'selected' : ''}>P4 Low (Owner oversight)</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label required">Recommendation Rationale (Why critical now?)</label>
                    <textarea class="form-control" rows="4" onchange="updateFieldValue('recommendation_rationale', this.value)"
                              placeholder="Strategic imperative: [...]\nCompetitive urgency: Aramco-Valvoline timeline\nFinancial attractiveness: IRR X%, Payback Y years\nExecution confidence: [...]\nRisk profile: [...]">${data.recommendation_rationale || ''}</textarea>
                </div>

                <div class="form-group">
                    <label class="form-label required">CEO Talking Points (3 key messages)</label>
                    <textarea class="form-control" rows="3" onchange="updateFieldValue('ceo_talking_points', this.value)"
                              placeholder="1. Why this matters to Petrolube's future\n2. How this defends against Aramco-Valvoline\n3. Financial value proposition">${data.ceo_talking_points || ''}</textarea>
                </div>

                <div class="form-group">
                    <label class="form-label">Executive Sponsor</label>
                    <input type="text" class="form-control" value="${data.executive_sponsor || ''}"
                           onchange="updateFieldValue('executive_sponsor', this.value)" placeholder="Name, Title">
                </div>
            </div>
        </div>

        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="wizardPrev()">‚Üê Back</button>
            <button class="btn btn-gold btn-lg" onclick="submitWizard()">‚úì Submit Initiative for Scoring</button>
        </div>
    `;
}

function renderWizardStep3() {
    const name = state.wizardData.criteriaValues.initiative_name || 'Unnamed Initiative';
    const id = state.wizardData.criteriaValues.initiative_id || 'N/A';
    const priority = state.wizardData.criteriaValues.strategic_priority || 'N/A';
    const investment = state.wizardData.criteriaValues.investment_required || 0;

    return `
        <div style="margin-bottom: 32px;">
            <h3 style="font-size: 20px; font-weight: 800; color: var(--neutral-900); margin-bottom: 8px;">‚úÖ Step 3: Review & Submit</h3>
            <p style="color: var(--neutral-600); font-size: 14px;">Verify your initiative details</p>
        </div>

        <div class="card" style="padding: 24px; background: var(--neutral-50);">
            <table style="width: 100%;">
                <tr style="border-bottom: 1px solid var(--neutral-200);">
                    <td style="padding: 12px 0; font-weight: 600;">Initiative Name:</td>
                    <td style="padding: 12px 0;">${name}</td>
                </tr>
                <tr style="border-bottom: 1px solid var(--neutral-200);">
                    <td style="padding: 12px 0; font-weight: 600;">Initiative ID:</td>
                    <td style="padding: 12px 0;">${id}</td>
                </tr>
                <tr style="border-bottom: 1px solid var(--neutral-200);">
                    <td style="padding: 12px 0; font-weight: 600;">Priority:</td>
                    <td style="padding: 12px 0;">${priority}</td>
                </tr>
                <tr>
                    <td style="padding: 12px 0; font-weight: 600;">Investment:</td>
                    <td style="padding: 12px 0;">${investment ? (investment / 1000000).toFixed(1) + 'M SAR' : 'N/A'}</td>
                </tr>
            </table>
        </div>

        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="wizardPrev()">‚Üê Back</button>
            <button class="btn btn-gold btn-lg" onclick="submitWizard()">‚úì Create Initiative</button>
        </div>
    `;
}

// ============================================================================
// LEGAL REVIEW DASHBOARD
// ============================================================================

function renderLegalReview() {
    const pendingProjects = state.projects.filter(p =>
        p.status === 'awaiting_legal_review' ||
        (p.approvalChain?.legal?.status === 'pending')
    );

    return `
        <div class="container" style="padding: 40px 32px;">
            <div style="margin-bottom: 32px;">
                <h2 style="font-size: 32px; font-weight: 900; color: var(--neutral-900); margin-bottom: 8px;">‚öñÔ∏è Legal Review Dashboard</h2>
                <p style="color: var(--neutral-600); font-size: 16px;">Review projects for legal compliance and regulatory requirements</p>
            </div>

            <div class="grid grid-3 mb-6">
                ${[
                    { icon: 'üìã', label: 'Pending Reviews', value: pendingProjects.length, color: 'var(--orange-600)' },
                    { icon: '‚úì', label: 'Approved Today', value: 0, color: 'var(--green-600)' },
                    { icon: '‚ö°', label: 'High Priority', value: pendingProjects.filter(p => p.criteriaValues?.strategic_priority === 'p1_critical').length, color: 'var(--red-600)' }
                ].map(stat => `
                    <div class="card" style="padding: 24px; text-align: center;">
                        <div style="font-size: 40px; margin-bottom: 12px;">${stat.icon}</div>
                        <div style="font-size: 28px; font-weight: 800; color: ${stat.color}; margin-bottom: 4px;">${stat.value}</div>
                        <div style="font-size: 13px; color: var(--neutral-600); font-weight: 600; text-transform: uppercase;">${stat.label}</div>
                    </div>
                `).join('')}
            </div>

            <div class="card" style="padding: 32px; margin-bottom: 24px;">
                <h3 style="font-size: 20px; font-weight: 800; margin-bottom: 24px;">Projects Awaiting Legal Review</h3>

                ${pendingProjects.length === 0 ? `
                    <div style="text-align: center; padding: 40px; color: var(--neutral-500);">
                        <div style="font-size: 48px; margin-bottom: 16px;">‚úÖ</div>
                        <p style="font-size: 16px; font-weight: 600;">No projects pending review</p>
                    </div>
                ` : `
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Project Name</th>
                                <th>ID</th>
                                <th>Priority</th>
                                <th>Investment</th>
                                <th>Submitted</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${pendingProjects.map(p => {
                                const priorityBadge = {
                                    'p1_critical': '<span class="badge badge-red">P1 Critical</span>',
                                    'p2_high': '<span class="badge badge-orange">P2 High</span>',
                                    'p3_medium': '<span class="badge badge-blue">P3 Medium</span>'
                                };
                                return `
                                <tr>
                                    <td><strong>${p.name}</strong></td>
                                    <td>${p.criteriaValues?.initiative_id || 'N/A'}</td>
                                    <td>${priorityBadge[p.criteriaValues?.strategic_priority] || 'N/A'}</td>
                                    <td>${p.criteriaValues?.investment_required ? (p.criteriaValues.investment_required / 1000000).toFixed(1) + 'M SAR' : 'N/A'}</td>
                                    <td>${new Date(p.submittedAt).toLocaleDateString()}</td>
                                    <td>
                                        <button class="btn btn-primary btn-sm" onclick="startLegalReview('${p.id}')">
                                            Review
                                        </button>
                                    </td>
                                </tr>
                            `}).join('')}
                        </tbody>
                    </table>
                `}
            </div>

            ${state.selectedReviewProject ? renderLegalReviewForm() : ''}
        </div>
    `;
}

function renderLegalReviewForm() {
    const project = state.projects.find(p => p.id === state.selectedReviewProject);
    if (!project) return '';

    const legalReview = project.approvalChain?.legal || {};
    const scores = legalReview.scores || {};

    return `
        <div class="card" style="padding: 32px; border: 3px solid var(--blue-500);">
            <h3 style="font-size: 24px; font-weight: 800; margin-bottom: 24px; color: var(--blue-700);">
                üìã Legal Review: ${project.name}
            </h3>

            <div style="background: var(--neutral-50); padding: 20px; border-radius: 8px; margin-bottom: 32px;">
                <div class="grid grid-2">
                    <div>
                        <label style="font-size: 12px; font-weight: 600; color: var(--neutral-600); text-transform: uppercase;">Initiative ID</label>
                        <p style="font-weight: 700; margin-top: 4px;">${project.criteriaValues?.initiative_id || 'N/A'}</p>
                    </div>
                    <div>
                        <label style="font-size: 12px; font-weight: 600; color: var(--neutral-600); text-transform: uppercase;">Investment</label>
                        <p style="font-weight: 700; margin-top: 4px;">${project.criteriaValues?.investment_required ? (project.criteriaValues.investment_required / 1000000).toFixed(1) + 'M SAR' : 'N/A'}</p>
                    </div>
                </div>
            </div>

            <h4 style="font-weight: 800; margin-bottom: 16px;">Legal Scorecard (1-5 scale, /30 total)</h4>

            ${LEGAL_CRITERIA.map(criterion => `
                <div style="background: white; padding: 20px; border: 1px solid var(--neutral-200); border-radius: 8px; margin-bottom: 16px;">
                    <div style="margin-bottom: 12px;">
                        <strong style="font-size: 15px;">${criterion.id}. ${criterion.title}</strong>
                        <p style="font-size: 13px; color: var(--neutral-600); margin-top: 4px;">${criterion.desc}</p>
                    </div>
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <label style="font-size: 13px; font-weight: 600; margin-right: 8px;">Score:</label>
                        ${[1, 2, 3, 4, 5].map(score => `
                            <label style="cursor: pointer; padding: 8px 16px; border: 2px solid ${scores[criterion.id] === score ? 'var(--blue-600)' : 'var(--neutral-300)'};
                                          border-radius: 6px; background: ${scores[criterion.id] === score ? 'var(--blue-50)' : 'white'};
                                          font-weight: ${scores[criterion.id] === score ? '700' : '500'}; transition: all 0.2s;">
                                <input type="radio" name="legal-score-${criterion.id}" value="${score}"
                                       ${scores[criterion.id] === score ? 'checked' : ''}
                                       onchange="updateLegalScore(${criterion.id}, ${score})"
                                       style="display: none;">
                                ${score}
                            </label>
                        `).join('')}
                    </div>
                </div>
            `).join('')}

            <div style="background: var(--blue-50); padding: 20px; border-radius: 8px; margin: 24px 0;">
                <div style="font-weight: 800; font-size: 20px; color: var(--blue-700);">
                    Total Score: ${Object.values(scores).reduce((sum, val) => sum + (val || 0), 0)} / 30
                </div>
                ${Object.values(scores).reduce((sum, val) => sum + (val || 0), 0) >= 24 ?
                    '<div style="margin-top: 8px; color: var(--green-600); font-weight: 600;">‚úì Meets approval threshold (‚â•24/30)</div>' :
                    '<div style="margin-top: 8px; color: var(--orange-600); font-weight: 600;">‚ö† Below approval threshold (need ‚â•24/30)</div>'
                }
            </div>

            <div class="form-group">
                <label class="form-label">Legal Review Comments</label>
                <textarea class="form-control" id="legal-comments" rows="4"
                          placeholder="Enter your legal review comments...">${legalReview.comments || ''}</textarea>
            </div>

            <div style="display: flex; gap: 12px; margin-top: 24px;">
                <button class="btn btn-secondary" onclick="cancelReview()">Cancel</button>
                <button class="btn btn-primary btn-lg" onclick="submitLegalReview()">
                    Submit Legal Review
                </button>
            </div>
        </div>
    `;
}

// ============================================================================
// FINANCE REVIEW DASHBOARD
// ============================================================================

function renderFinanceReview() {
    const pendingProjects = state.projects.filter(p =>
        p.status === 'awaiting_finance_review' ||
        (p.approvalChain?.finance?.status === 'pending')
    );

    return `
        <div class="container" style="padding: 40px 32px;">
            <div style="margin-bottom: 32px;">
                <h2 style="font-size: 32px; font-weight: 900; color: var(--neutral-900); margin-bottom: 8px;">üí∞ Finance Review Dashboard</h2>
                <p style="color: var(--neutral-600); font-size: 16px;">Review projects for financial viability and ROI analysis</p>
            </div>

            <div class="grid grid-3 mb-6">
                ${[
                    { icon: 'üìã', label: 'Pending Reviews', value: pendingProjects.length, color: 'var(--orange-600)' },
                    { icon: '‚úì', label: 'Approved Today', value: 0, color: 'var(--green-600)' },
                    { icon: 'üíé', label: 'High Value', value: pendingProjects.filter(p => (p.criteriaValues?.investment_required || 0) > 10000000).length, color: 'var(--purple-600)' }
                ].map(stat => `
                    <div class="card" style="padding: 24px; text-align: center;">
                        <div style="font-size: 40px; margin-bottom: 12px;">${stat.icon}</div>
                        <div style="font-size: 28px; font-weight: 800; color: ${stat.color}; margin-bottom: 4px;">${stat.value}</div>
                        <div style="font-size: 13px; color: var(--neutral-600); font-weight: 600; text-transform: uppercase;">${stat.label}</div>
                    </div>
                `).join('')}
            </div>

            <div class="card" style="padding: 32px;">
                <h3 style="font-size: 20px; font-weight: 800; margin-bottom: 24px;">Projects Awaiting Finance Review</h3>

                ${pendingProjects.length === 0 ? `
                    <div style="text-align: center; padding: 40px; color: var(--neutral-500);">
                        <div style="font-size: 48px; margin-bottom: 16px;">‚úÖ</div>
                        <p style="font-size: 16px; font-weight: 600;">No projects pending review</p>
                    </div>
                ` : `
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Project Name</th>
                                <th>Investment</th>
                                <th>Legal Score</th>
                                <th>Submitted</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${pendingProjects.map(p => `
                                <tr>
                                    <td><strong>${p.name}</strong></td>
                                    <td>${p.criteriaValues?.investment_required ? (p.criteriaValues.investment_required / 1000000).toFixed(1) + 'M SAR' : 'N/A'}</td>
                                    <td><span class="badge badge-green">${p.approvalChain?.legal?.score || 'N/A'}/30</span></td>
                                    <td>${new Date(p.submittedAt).toLocaleDateString()}</td>
                                    <td>
                                        <button class="btn btn-primary btn-sm" onclick="startFinanceReview('${p.id}')">
                                            Review
                                        </button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `}
            </div>

            ${state.selectedReviewProject ? renderFinanceReviewForm() : ''}
        </div>
    `;
}

function renderFinanceReviewForm() {
    const project = state.projects.find(p => p.id === state.selectedReviewProject);
    if (!project) return '';

    const financeReview = project.approvalChain?.finance || {};
    const scores = financeReview.scores || {};

    return `
        <div class="card" style="padding: 32px; border: 3px solid var(--green-500); margin-top: 24px;">
            <h3 style="font-size: 24px; font-weight: 800; margin-bottom: 24px; color: var(--green-700);">
                üí∞ Finance Review: ${project.name}
            </h3>

            <h4 style="font-weight: 800; margin-bottom: 16px;">Finance Scorecard (1-5 scale, /30 total)</h4>

            ${FINANCE_CRITERIA.map(criterion => `
                <div style="background: white; padding: 20px; border: 1px solid var(--neutral-200); border-radius: 8px; margin-bottom: 16px;">
                    <div style="margin-bottom: 12px;">
                        <strong style="font-size: 15px;">${criterion.id}. ${criterion.title}</strong>
                        <p style="font-size: 13px; color: var(--neutral-600); margin-top: 4px;">${criterion.desc}</p>
                    </div>
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <label style="font-size: 13px; font-weight: 600; margin-right: 8px;">Score:</label>
                        ${[1, 2, 3, 4, 5].map(score => `
                            <label style="cursor: pointer; padding: 8px 16px; border: 2px solid ${scores[criterion.id] === score ? 'var(--green-600)' : 'var(--neutral-300)'};
                                          border-radius: 6px; background: ${scores[criterion.id] === score ? 'var(--green-50)' : 'white'};
                                          font-weight: ${scores[criterion.id] === score ? '700' : '500'}; transition: all 0.2s;">
                                <input type="radio" name="finance-score-${criterion.id}" value="${score}"
                                       ${scores[criterion.id] === score ? 'checked' : ''}
                                       onchange="updateFinanceScore(${criterion.id}, ${score})"
                                       style="display: none;">
                                ${score}
                            </label>
                        `).join('')}
                    </div>
                </div>
            `).join('')}

            <div style="background: var(--green-50); padding: 20px; border-radius: 8px; margin: 24px 0;">
                <div style="font-weight: 800; font-size: 20px; color: var(--green-700);">
                    Total Score: ${Object.values(scores).reduce((sum, val) => sum + (val || 0), 0)} / 30
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">Finance Review Comments</label>
                <textarea class="form-control" id="finance-comments" rows="4"
                          placeholder="Enter your finance review comments...">${financeReview.comments || ''}</textarea>
            </div>

            <div style="display: flex; gap: 12px; margin-top: 24px;">
                <button class="btn btn-secondary" onclick="cancelReview()">Cancel</button>
                <button class="btn btn-primary btn-lg" onclick="submitFinanceReview()">
                    Submit Finance Review
                </button>
            </div>
        </div>
    `;
}

// ============================================================================
// IT REVIEW DASHBOARD
// ============================================================================

function renderITReview() {
    const pendingProjects = state.projects.filter(p =>
        p.status === 'awaiting_it_review' ||
        (p.approvalChain?.it?.status === 'pending')
    );

    return `
        <div class="container" style="padding: 40px 32px;">
            <div style="margin-bottom: 32px;">
                <h2 style="font-size: 32px; font-weight: 900; color: var(--neutral-900); margin-bottom: 8px;">üíª IT Review Dashboard</h2>
                <p style="color: var(--neutral-600); font-size: 16px;">Review projects for technical feasibility and security compliance</p>
            </div>

            <div class="grid grid-3 mb-6">
                ${[
                    { icon: 'üìã', label: 'Pending Reviews', value: pendingProjects.length, color: 'var(--orange-600)' },
                    { icon: '‚úì', label: 'Approved Today', value: 0, color: 'var(--green-600)' },
                    { icon: 'üîí', label: 'Security Critical', value: pendingProjects.length, color: 'var(--red-600)' }
                ].map(stat => `
                    <div class="card" style="padding: 24px; text-align: center;">
                        <div style="font-size: 40px; margin-bottom: 12px;">${stat.icon}</div>
                        <div style="font-size: 28px; font-weight: 800; color: ${stat.color}; margin-bottom: 4px;">${stat.value}</div>
                        <div style="font-size: 13px; color: var(--neutral-600); font-weight: 600; text-transform: uppercase;">${stat.label}</div>
                    </div>
                `).join('')}
            </div>

            <div class="card" style="padding: 32px;">
                <h3 style="font-size: 20px; font-weight: 800; margin-bottom: 24px;">Projects Awaiting IT Review</h3>

                ${pendingProjects.length === 0 ? `
                    <div style="text-align: center; padding: 40px; color: var(--neutral-500);">
                        <div style="font-size: 48px; margin-bottom: 16px;">‚úÖ</div>
                        <p style="font-size: 16px; font-weight: 600;">No projects pending review</p>
                    </div>
                ` : `
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Project Name</th>
                                <th>Legal Score</th>
                                <th>Finance Score</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${pendingProjects.map(p => `
                                <tr>
                                    <td><strong>${p.name}</strong></td>
                                    <td><span class="badge badge-green">${p.approvalChain?.legal?.score || 'N/A'}/30</span></td>
                                    <td><span class="badge badge-green">${p.approvalChain?.finance?.score || 'N/A'}/30</span></td>
                                    <td>
                                        <button class="btn btn-primary btn-sm" onclick="startITReview('${p.id}')">
                                            Review
                                        </button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `}
            </div>

            ${state.selectedReviewProject ? renderITReviewForm() : ''}
        </div>
    `;
}

function renderITReviewForm() {
    const project = state.projects.find(p => p.id === state.selectedReviewProject);
    if (!project) return '';

    const itReview = project.approvalChain?.it || {};
    const scores = itReview.scores || {};

    return `
        <div class="card" style="padding: 32px; border: 3px solid var(--purple-500); margin-top: 24px;">
            <h3 style="font-size: 24px; font-weight: 800; margin-bottom: 24px; color: var(--purple-700);">
                üíª IT Review: ${project.name}
            </h3>

            <h4 style="font-weight: 800; margin-bottom: 16px;">IT Scorecard (1-5 scale, /30 total)</h4>

            ${IT_CRITERIA.map(criterion => `
                <div style="background: white; padding: 20px; border: 1px solid var(--neutral-200); border-radius: 8px; margin-bottom: 16px;">
                    <div style="margin-bottom: 12px;">
                        <strong style="font-size: 15px;">${criterion.id}. ${criterion.title}</strong>
                        <p style="font-size: 13px; color: var(--neutral-600); margin-top: 4px;">${criterion.desc}</p>
                    </div>
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <label style="font-size: 13px; font-weight: 600; margin-right: 8px;">Score:</label>
                        ${[1, 2, 3, 4, 5].map(score => `
                            <label style="cursor: pointer; padding: 8px 16px; border: 2px solid ${scores[criterion.id] === score ? 'var(--purple-600)' : 'var(--neutral-300)'};
                                          border-radius: 6px; background: ${scores[criterion.id] === score ? 'var(--purple-50)' : 'white'};
                                          font-weight: ${scores[criterion.id] === score ? '700' : '500'}; transition: all 0.2s;">
                                <input type="radio" name="it-score-${criterion.id}" value="${score}"
                                       ${scores[criterion.id] === score ? 'checked' : ''}
                                       onchange="updateITScore(${criterion.id}, ${score})"
                                       style="display: none;">
                                ${score}
                            </label>
                        `).join('')}
                    </div>
                </div>
            `).join('')}

            <div style="background: var(--purple-50); padding: 20px; border-radius: 8px; margin: 24px 0;">
                <div style="font-weight: 800; font-size: 20px; color: var(--purple-700);">
                    Total Score: ${Object.values(scores).reduce((sum, val) => sum + (val || 0), 0)} / 30
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">IT Review Comments</label>
                <textarea class="form-control" id="it-comments" rows="4"
                          placeholder="Enter your IT review comments...">${itReview.comments || ''}</textarea>
            </div>

            <div style="display: flex; gap: 12px; margin-top: 24px;">
                <button class="btn btn-secondary" onclick="cancelReview()">Cancel</button>
                <button class="btn btn-primary btn-lg" onclick="submitITReview()">
                    Submit IT Review
                </button>
            </div>
        </div>
    `;
}

// ============================================================================
// AGB REVIEW DASHBOARD
// ============================================================================

function renderAGBReview() {
    const pendingProjects = state.projects.filter(p =>
        p.status === 'awaiting_agb_approval' ||
        (p.approvalChain?.it?.status === 'approved' && p.approvalChain?.agb?.status === 'not_started')
    );

    return `
        <div class="container" style="padding: 40px 32px;">
            <div style="margin-bottom: 32px;">
                <h2 style="font-size: 32px; font-weight: 900; color: var(--neutral-900); margin-bottom: 8px;">üëî AGB Final Approval Dashboard</h2>
                <p style="color: var(--neutral-600); font-size: 16px;">Architecture Governance Board - Final project approval</p>
            </div>

            <div class="grid grid-3 mb-6">
                ${[
                    { icon: 'üìã', label: 'Pending Approval', value: pendingProjects.length, color: 'var(--orange-600)' },
                    { icon: '‚úì', label: 'Approved Today', value: 0, color: 'var(--green-600)' },
                    { icon: 'üìä', label: 'Portfolio Compliance', value: '87%', color: 'var(--blue-600)' }
                ].map(stat => `
                    <div class="card" style="padding: 24px; text-align: center;">
                        <div style="font-size: 40px; margin-bottom: 12px;">${stat.icon}</div>
                        <div style="font-size: 28px; font-weight: 800; color: ${stat.color}; margin-bottom: 4px;">${stat.value}</div>
                        <div style="font-size: 13px; color: var(--neutral-600); font-weight: 600; text-transform: uppercase;">${stat.label}</div>
                    </div>
                `).join('')}
            </div>

            <div class="card" style="padding: 32px;">
                <h3 style="font-size: 20px; font-weight: 800; margin-bottom: 24px;">Projects Awaiting AGB Approval</h3>

                ${pendingProjects.length === 0 ? `
                    <div style="text-align: center; padding: 40px; color: var(--neutral-500);">
                        <div style="font-size: 48px; margin-bottom: 16px;">‚úÖ</div>
                        <p style="font-size: 16px; font-weight: 600;">No projects pending approval</p>
                    </div>
                ` : `
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Project Name</th>
                                <th>Legal</th>
                                <th>Finance</th>
                                <th>IT</th>
                                <th>Overall</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${pendingProjects.map(p => {
                                const legalScore = p.approvalChain?.legal?.score || 0;
                                const financeScore = p.approvalChain?.finance?.score || 0;
                                const itScore = p.approvalChain?.it?.score || 0;
                                const totalScore = legalScore + financeScore + itScore;
                                const maxScore = 90;
                                const compliance = Math.round((totalScore / maxScore) * 100);
                                const meetsThreshold = compliance >= 80;

                                return `
                                <tr>
                                    <td><strong>${p.name}</strong></td>
                                    <td><span class="badge badge-green">${legalScore}/30</span></td>
                                    <td><span class="badge badge-green">${financeScore}/30</span></td>
                                    <td><span class="badge badge-green">${itScore}/30</span></td>
                                    <td><span class="badge ${meetsThreshold ? 'badge-green' : 'badge-red'}">${compliance}%</span></td>
                                    <td>
                                        <button class="btn btn-primary btn-sm" onclick="startAGBReview('${p.id}')">
                                            Review
                                        </button>
                                    </td>
                                </tr>
                            `}).join('')}
                        </tbody>
                    </table>
                `}
            </div>

            ${state.selectedReviewProject ? renderAGBReviewForm() : ''}
        </div>
    `;
}

function renderAGBReviewForm() {
    const project = state.projects.find(p => p.id === state.selectedReviewProject);
    if (!project) return '';

    const legalScore = project.approvalChain?.legal?.score || 0;
    const financeScore = project.approvalChain?.finance?.score || 0;
    const itScore = project.approvalChain?.it?.score || 0;
    const totalScore = legalScore + financeScore + itScore;
    const maxScore = 90;
    const compliance = Math.round((totalScore / maxScore) * 100);
    const meetsThreshold = compliance >= 80;

    return `
        <div class="card" style="padding: 32px; border: 3px solid var(--petro-gold-600); margin-top: 24px;">
            <h3 style="font-size: 24px; font-weight: 800; margin-bottom: 24px; color: var(--petro-green-800);">
                üëî AGB Final Approval: ${project.name}
            </h3>

            <div style="background: var(--neutral-50); padding: 24px; border-radius: 12px; margin-bottom: 24px;">
                <h4 style="font-weight: 800; margin-bottom: 20px;">Department Review Scores</h4>
                <div class="grid grid-3">
                    <div style="text-align: center; padding: 16px; background: white; border-radius: 8px;">
                        <div style="font-size: 14px; font-weight: 600; color: var(--neutral-600); margin-bottom: 8px;">‚öñÔ∏è Legal</div>
                        <div style="font-size: 24px; font-weight: 800; color: var(--blue-600);">${legalScore}/30</div>
                    </div>
                    <div style="text-align: center; padding: 16px; background: white; border-radius: 8px;">
                        <div style="font-size: 14px; font-weight: 600; color: var(--neutral-600); margin-bottom: 8px;">üí∞ Finance</div>
                        <div style="font-size: 24px; font-weight: 800; color: var(--green-600);">${financeScore}/30</div>
                    </div>
                    <div style="text-align: center; padding: 16px; background: white; border-radius: 8px;">
                        <div style="font-size: 14px; font-weight: 600; color: var(--neutral-600); margin-bottom: 8px;">üíª IT</div>
                        <div style="font-size: 24px; font-weight: 800; color: var(--purple-600);">${itScore}/30</div>
                    </div>
                </div>
            </div>

            <div style="background: ${meetsThreshold ? 'var(--green-50)' : 'var(--red-50)'}; padding: 24px; border-radius: 12px; margin-bottom: 24px; border: 2px solid ${meetsThreshold ? 'var(--green-600)' : 'var(--red-600)'};">
                <div style="font-weight: 800; font-size: 28px; color: ${meetsThreshold ? 'var(--green-700)' : 'var(--red-700)'}; margin-bottom: 8px;">
                    Overall Compliance: ${compliance}%
                </div>
                <div style="font-size: 16px; font-weight: 600; color: ${meetsThreshold ? 'var(--green-600)' : 'var(--red-600)'};">
                    ${meetsThreshold ? '‚úì Meets 80% threshold for approval' : '‚úó Below 80% threshold - requires justification'}
                </div>
                <div style="margin-top: 12px; font-size: 14px; color: var(--neutral-700);">
                    Total Score: ${totalScore} / ${maxScore}
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">AGB Decision Comments</label>
                <textarea class="form-control" id="agb-comments" rows="4"
                          placeholder="Enter final approval decision comments..."></textarea>
            </div>

            <div style="display: flex; gap: 12px; margin-top: 24px;">
                <button class="btn btn-secondary" onclick="cancelReview()">Cancel</button>
                <button class="btn btn-danger" onclick="submitAGBReview(false)">
                    ‚úó Reject Project
                </button>
                <button class="btn btn-primary btn-lg" onclick="submitAGBReview(true)" ${!meetsThreshold ? 'style="opacity: 0.5;"' : ''}>
                    ‚úì Approve Project
                </button>
            </div>
        </div>
    `;
}

// ============================================================================
// EVENT HANDLERS
// ============================================================================

function loginAsUser(userId) {
    const user = USERS.find(u => u.id === userId);
    if (!user) return;

    state.currentUser = user;
    state.currentRole = user.role;
    state.currentUserName = user.name;
    render();
}

function selectRole(roleId, userName) {
    state.currentRole = roleId;
    state.currentUserName = userName;
    render();
}

function continueToDashboard() {
    if (!state.currentUser) return;

    // Route to appropriate dashboard based on role
    switch (state.currentRole) {
        case USER_ROLES.LEGAL:
            state.currentPage = 'legal-review';
            break;
        case USER_ROLES.FINANCE:
            state.currentPage = 'finance-review';
            break;
        case USER_ROLES.IT:
            state.currentPage = 'it-review';
            break;
        case USER_ROLES.AGB_MEMBER:
            state.currentPage = 'agb-review';
            break;
        case USER_ROLES.PROJECT_OWNER:
        case USER_ROLES.PMO:
        case USER_ROLES.ADMIN:
        default:
            state.currentPage = 'dashboard';
            break;
    }

    render();
}

function navigateTo(page) {
    state.currentPage = page;
    render();
    window.scrollTo(0, 0);
}

function logout() {
    state.currentPage = 'landing';
    render();
}

function openProjectWizard() {
    state.wizardStep = 1;
    state.wizardData = { criteriaValues: {} };
    state.showDescriptionBox = true;
    state.aiProcessing = false;

    const modal = document.getElementById('projectWizardModal');
    if (modal) {
        modal.classList.add('active');
        setTimeout(() => renderWizard(), 0);
    }
}

function closeProjectWizard() {
    document.getElementById('projectWizardModal').classList.remove('active');
    state.wizardData = { criteriaValues: {} };
}

function runAIAutoFill() {
    const description = document.getElementById('wizard-description').value;
    if (!description.trim()) {
        alert('Please enter a project description first');
        return;
    }

    state.aiProcessing = true;
    state.wizardData.description = description;
    renderWizard();

    setTimeout(() => {
        // AI generates sample data
        state.wizardData.criteriaValues = {
            initiative_name: 'AI-Generated Initiative',
            initiative_id: 'INI-' + Date.now(),
            strategic_priority: 'p2_high',
            investment_required: 10000000
        };
        state.showDescriptionBox = false;
        state.aiProcessing = false;
        renderWizard();
    }, 1500);
}

function resetAIAutoFill() {
    state.showDescriptionBox = true;
    state.aiProcessing = false;
    state.wizardData.criteriaValues = {};
    renderWizard();
}

function updateFieldValue(key, value) {
    if (!state.wizardData.criteriaValues) state.wizardData.criteriaValues = {};
    state.wizardData.criteriaValues[key] = value;
}

function wizardNext() {
    state.wizardStep++;
    renderWizard();
}

function wizardPrev() {
    state.wizardStep--;
    renderWizard();
}

function submitWizard() {
    const newProject = {
        id: 'proj-' + Date.now(),
        name: state.wizardData.criteriaValues.initiative_name || 'Unnamed Initiative',
        criteriaValues: state.wizardData.criteriaValues,
        status: 'Ready',
        tasks: [],
        milestones: [],
        scores: {
            compositeScore: 75.0,
            rank: state.projects.length + 1
        },
        createdAt: new Date().toISOString()
    };

    state.projects.push(newProject);
    closeProjectWizard();

    alert(`‚úÖ Initiative "${newProject.name}" created successfully!`);
    navigateTo('projects');
}

// PMO Manager Functions

function selectPMOProject(projectId) {
    state.selectedPMOProject = projectId;
    render();
}

function setPMOView(view) {
    state.pmoView = view;
    render();
}

function openAddTaskModal(projectId) {
    const taskName = prompt('Task Name:');
    if (!taskName) return;

    const description = prompt('Task Description (optional):');
    const assignedTo = prompt('Assigned To (optional):');
    const priority = prompt('Priority (low/medium/high):') || 'medium';
    const startDate = prompt('Start Date (YYYY-MM-DD, optional):');
    const dueDate = prompt('Due Date (YYYY-MM-DD, optional):');
    const progress = prompt('Progress (0-100, optional):') || '0';

    // RACI Assignments
    const responsible = prompt('Responsible (comma-separated names, optional):');
    const accountable = prompt('Accountable (comma-separated names, optional):');
    const consulted = prompt('Consulted (comma-separated names, optional):');
    const informed = prompt('Informed (comma-separated names, optional):');

    addTask(projectId, {
        name: taskName,
        description: description || '',
        assignedTo: assignedTo || '',
        priority: priority,
        startDate: startDate || '',
        dueDate: dueDate || '',
        progress: parseInt(progress) || 0,
        status: 'not_started',
        raci: {
            responsible: responsible ? responsible.split(',').map(s => s.trim()) : [],
            accountable: accountable ? accountable.split(',').map(s => s.trim()) : [],
            consulted: consulted ? consulted.split(',').map(s => s.trim()) : [],
            informed: informed ? informed.split(',').map(s => s.trim()) : []
        },
        createdAt: new Date().toISOString()
    });
}

function addTask(projectId, task) {
    const project = state.projects.find(p => p.id === projectId);
    if (!project) return;

    if (!project.tasks) project.tasks = [];
    project.tasks.push(task);
    render();
}

function updateTaskStatus(projectId, taskIndex, newStatus) {
    const project = state.projects.find(p => p.id === projectId);
    if (!project || !project.tasks || !project.tasks[taskIndex]) return;

    project.tasks[taskIndex].status = newStatus;

    // Auto-update progress based on status
    if (newStatus === 'completed') {
        project.tasks[taskIndex].progress = 100;
    } else if (newStatus === 'in_progress' && project.tasks[taskIndex].progress === 0) {
        project.tasks[taskIndex].progress = 50;
    }

    // Recalculate project performance if lifecycle is activated
    if (project.lifecycle?.activated) {
        updateProjectPerformance(project);
    }

    render();
}

function editTask(projectId, taskIndex) {
    const project = state.projects.find(p => p.id === projectId);
    if (!project || !project.tasks || !project.tasks[taskIndex]) return;

    const task = project.tasks[taskIndex];
    const newName = prompt('Task Name:', task.name);
    if (!newName) return;

    const newDescription = prompt('Description:', task.description);
    const newAssignedTo = prompt('Assigned To:', task.assignedTo);
    const newStartDate = prompt('Start Date (YYYY-MM-DD):', task.startDate || '');
    const newDueDate = prompt('Due Date (YYYY-MM-DD):', task.dueDate || '');
    const newProgress = prompt('Progress (0-100):', task.progress || '0');

    // RACI Assignments
    const currentRaci = task.raci || { responsible: [], accountable: [], consulted: [], informed: [] };
    const newResponsible = prompt('Responsible (comma-separated names):', currentRaci.responsible.join(', '));
    const newAccountable = prompt('Accountable (comma-separated names):', currentRaci.accountable.join(', '));
    const newConsulted = prompt('Consulted (comma-separated names):', currentRaci.consulted.join(', '));
    const newInformed = prompt('Informed (comma-separated names):', currentRaci.informed.join(', '));

    task.name = newName;
    task.description = newDescription || '';
    task.assignedTo = newAssignedTo || '';
    task.startDate = newStartDate || '';
    task.dueDate = newDueDate || task.dueDate;
    task.progress = parseInt(newProgress) || 0;
    task.raci = {
        responsible: newResponsible ? newResponsible.split(',').map(s => s.trim()) : [],
        accountable: newAccountable ? newAccountable.split(',').map(s => s.trim()) : [],
        consulted: newConsulted ? newConsulted.split(',').map(s => s.trim()) : [],
        informed: newInformed ? newInformed.split(',').map(s => s.trim()) : []
    };

    render();
}

function deleteTask(projectId, taskIndex) {
    if (!confirm('Are you sure you want to delete this task?')) return;

    const project = state.projects.find(p => p.id === projectId);
    if (!project || !project.tasks || !project.tasks[taskIndex]) return;

    project.tasks.splice(taskIndex, 1);
    render();
}

// ============================================================================
// REVIEW WORKFLOW HANDLERS
// ============================================================================

function startLegalReview(projectId) {
    state.selectedReviewProject = projectId;
    render();
}

function updateLegalScore(criterionId, score) {
    if (!state.selectedReviewProject) return;

    const project = state.projects.find(p => p.id === state.selectedReviewProject);
    if (!project) return;

    if (!project.approvalChain) project.approvalChain = {};
    if (!project.approvalChain.legal) project.approvalChain.legal = { status: 'pending', scores: {}, comments: '', mandatoryFields: {} };
    if (!project.approvalChain.legal.scores) project.approvalChain.legal.scores = {};

    project.approvalChain.legal.scores[criterionId] = score;
    render();
}

function submitLegalReview() {
    if (!state.selectedReviewProject) return;

    const project = state.projects.find(p => p.id === state.selectedReviewProject);
    if (!project) return;

    const comments = document.getElementById('legal-comments')?.value || '';
    const scores = project.approvalChain?.legal?.scores || {};
    const totalScore = Object.values(scores).reduce((sum, val) => sum + (val || 0), 0);

    // Update legal review
    project.approvalChain.legal.status = 'approved';
    project.approvalChain.legal.score = totalScore;
    project.approvalChain.legal.reviewer = state.currentUser.id;
    project.approvalChain.legal.reviewedAt = new Date().toISOString();
    project.approvalChain.legal.comments = comments;

    // Add audit trail
    if (!project.auditTrail) project.auditTrail = [];
    project.auditTrail.push({
        timestamp: new Date().toISOString(),
        userId: state.currentUser.id,
        action: 'Legal review completed',
        details: `Score: ${totalScore}/30 - ${totalScore >= 24 ? 'Approved' : 'Conditional'}`
    });

    // Update project status to next stage
    project.status = 'awaiting_finance_review';
    project.approvalChain.finance.status = 'pending';

    state.selectedReviewProject = null;
    render();

    alert(`Legal review submitted successfully!\nScore: ${totalScore}/30`);
}

function startFinanceReview(projectId) {
    state.selectedReviewProject = projectId;
    render();
}

function updateFinanceScore(criterionId, score) {
    if (!state.selectedReviewProject) return;

    const project = state.projects.find(p => p.id === state.selectedReviewProject);
    if (!project) return;

    if (!project.approvalChain.finance.scores) project.approvalChain.finance.scores = {};
    project.approvalChain.finance.scores[criterionId] = score;
    render();
}

function submitFinanceReview() {
    if (!state.selectedReviewProject) return;

    const project = state.projects.find(p => p.id === state.selectedReviewProject);
    if (!project) return;

    const comments = document.getElementById('finance-comments')?.value || '';
    const scores = project.approvalChain?.finance?.scores || {};
    const totalScore = Object.values(scores).reduce((sum, val) => sum + (val || 0), 0);

    // Update finance review
    project.approvalChain.finance.status = 'approved';
    project.approvalChain.finance.score = totalScore;
    project.approvalChain.finance.reviewer = state.currentUser.id;
    project.approvalChain.finance.reviewedAt = new Date().toISOString();
    project.approvalChain.finance.comments = comments;

    // Add audit trail
    project.auditTrail.push({
        timestamp: new Date().toISOString(),
        userId: state.currentUser.id,
        action: 'Finance review completed',
        details: `Score: ${totalScore}/30 - ${totalScore >= 24 ? 'Approved' : 'Conditional'}`
    });

    // Update project status to next stage
    project.status = 'awaiting_it_review';
    project.approvalChain.it.status = 'pending';

    state.selectedReviewProject = null;
    render();

    alert(`Finance review submitted successfully!\nScore: ${totalScore}/30`);
}

function startITReview(projectId) {
    state.selectedReviewProject = projectId;
    render();
}

function updateITScore(criterionId, score) {
    if (!state.selectedReviewProject) return;

    const project = state.projects.find(p => p.id === state.selectedReviewProject);
    if (!project) return;

    if (!project.approvalChain.it.scores) project.approvalChain.it.scores = {};
    project.approvalChain.it.scores[criterionId] = score;
    render();
}

function submitITReview() {
    if (!state.selectedReviewProject) return;

    const project = state.projects.find(p => p.id === state.selectedReviewProject);
    if (!project) return;

    const comments = document.getElementById('it-comments')?.value || '';
    const scores = project.approvalChain?.it?.scores || {};
    const totalScore = Object.values(scores).reduce((sum, val) => sum + (val || 0), 0);

    // Update IT review
    project.approvalChain.it.status = 'approved';
    project.approvalChain.it.score = totalScore;
    project.approvalChain.it.reviewer = state.currentUser.id;
    project.approvalChain.it.reviewedAt = new Date().toISOString();
    project.approvalChain.it.comments = comments;

    // Add audit trail
    project.auditTrail.push({
        timestamp: new Date().toISOString(),
        userId: state.currentUser.id,
        action: 'IT review completed',
        details: `Score: ${totalScore}/30 - ${totalScore >= 24 ? 'Approved' : 'Conditional'}`
    });

    // Update project status to next stage
    project.status = 'awaiting_agb_approval';

    state.selectedReviewProject = null;
    render();

    alert(`IT review submitted successfully!\nScore: ${totalScore}/30`);
}

function startAGBReview(projectId) {
    state.selectedReviewProject = projectId;
    render();
}

function submitAGBReview(approved) {
    if (!state.selectedReviewProject) return;

    const project = state.projects.find(p => p.id === state.selectedReviewProject);
    if (!project) return;

    const comments = document.getElementById('agb-comments')?.value || '';

    const legalScore = project.approvalChain?.legal?.score || 0;
    const financeScore = project.approvalChain?.finance?.score || 0;
    const itScore = project.approvalChain?.it?.score || 0;
    const totalScore = legalScore + financeScore + itScore;
    const maxScore = 90;
    const compliance = Math.round((totalScore / maxScore) * 100);

    // Update AGB review
    project.approvalChain.agb.status = approved ? 'approved' : 'rejected';
    project.approvalChain.agb.approved = approved;
    project.approvalChain.agb.reviewer = state.currentUser.id;
    project.approvalChain.agb.reviewedAt = new Date().toISOString();
    project.approvalChain.agb.comments = comments;
    project.approvalChain.agb.complianceScore = compliance;

    // Add audit trail
    project.auditTrail.push({
        timestamp: new Date().toISOString(),
        userId: state.currentUser.id,
        action: `AGB ${approved ? 'approved' : 'rejected'} project`,
        details: `Overall compliance: ${compliance}% - ${approved ? 'Project approved for execution' : 'Project rejected'}`
    });

    // Update project status
    project.status = approved ? 'approved' : 'rejected';

    // ===== ACTIVATE POST-APPROVAL LIFECYCLE =====
    if (approved) {
        activateProjectLifecycle(project);
    }

    state.selectedReviewProject = null;
    render();

    alert(`Project ${approved ? 'approved' : 'rejected'} successfully!\nCompliance Score: ${compliance}%${approved ? '\n\n‚úÖ Post-Approval Lifecycle Activated\nProject transitioned to Stage-Gate execution model' : ''}`);
}

// ============================================================================
// POST-APPROVAL LIFECYCLE ACTIVATION
// ============================================================================

function activateProjectLifecycle(project) {
    const today = new Date();
    const handoverDate = new Date(today);
    handoverDate.setDate(handoverDate.getDate() + 5); // 5 business days handover period

    // Calculate project end date from implementation timeline
    const startDate = project.criteriaValues?.implementation_timeline?.start_date;
    const endDate = project.criteriaValues?.implementation_timeline?.end_date;
    const projectEndDate = endDate ? new Date(endDate) : new Date(handoverDate.getTime() + 365 * 24 * 60 * 60 * 1000);
    projectEndDate.setDate(projectEndDate.getDate() + 30); // Add 30 days for post-implementation review

    // Initialize lifecycle if not exists
    if (!project.lifecycle) {
        project.lifecycle = {
            activated: false,
            currentGate: 'gate_0',
            currentPhase: 'approval',
            projectStatus: 'PENDING_APPROVAL',
            projectStartDate: null,
            projectEndDate: null,
            handoverDate: null,
            gateHistory: [],
            phases: {
                phase_0: { name: 'Initiation', status: 'not_started', startDate: null, endDate: null, milestones: [] },
                phase_1: { name: 'Development/Pilot', status: 'not_started', startDate: null, endDate: null, milestones: [] },
                phase_2: { name: 'Scale/Deployment', status: 'not_started', startDate: null, endDate: null, milestones: [] },
                phase_3: { name: 'Optimization', status: 'not_started', startDate: null, endDate: null, milestones: [] },
                phase_4: { name: 'Closure', status: 'not_started', startDate: null, endDate: null, milestones: [] }
            },
            tier: 'tier_1c',
            owner: { primary: null, backup: null, escalationPath: 'CITO' }
        };
    }

    // Activate lifecycle
    project.lifecycle.activated = true;
    project.lifecycle.currentGate = 'gate_1'; // Move to Gate 1 (Concept Validation)
    project.lifecycle.currentPhase = 'phase_0'; // Initiation phase
    project.lifecycle.projectStatus = 'GREEN'; // Start as GREEN
    project.lifecycle.projectStartDate = handoverDate.toISOString().split('T')[0];
    project.lifecycle.projectEndDate = projectEndDate.toISOString().split('T')[0];
    project.lifecycle.handoverDate = handoverDate.toISOString();

    // Record Gate 0 passage (approval)
    project.lifecycle.gateHistory.push({
        gate: 'gate_0',
        decision: 'GO',
        date: today.toISOString(),
        reviewer: 'AGB Board',
        rationale: 'Al Dabbagh approval chain completed successfully',
        conditions: []
    });

    // Set Phase 0 (Initiation) to in_progress
    project.lifecycle.phases.phase_0.status = 'in_progress';
    project.lifecycle.phases.phase_0.startDate = handoverDate.toISOString().split('T')[0];

    // Calculate phase end dates (assuming 3-month initiation)
    const phase0End = new Date(handoverDate);
    phase0End.setMonth(phase0End.getMonth() + 3);
    project.lifecycle.phases.phase_0.endDate = phase0End.toISOString().split('T')[0];

    // Initialize performance metrics
    if (!project.performance) {
        project.performance = {
            budgetBaseline: project.criteriaValues?.investment_required || 0,
            plannedValue: 0,
            earnedValue: 0,
            actualCost: 0,
            schedulePerformanceIndex: 1.0,
            costPerformanceIndex: 1.0,
            scheduleVariance: 0,
            costVariance: 0,
            estimateAtCompletion: 0,
            lastUpdated: today.toISOString()
        };
    }
    project.performance.budgetBaseline = project.criteriaValues?.investment_required || 0;

    // Initialize RAID register if not exists
    if (!project.riskRegister) {
        project.riskRegister = {
            risks: [],
            assumptions: [],
            issues: [],
            dependencies: []
        };
    }

    // Initialize benefits tracking
    if (!project.benefitsTracking) {
        project.benefitsTracking = {
            baselineSet: true,
            financialBenefits: {
                projectedRevenue: 0,
                actualRevenue: 0,
                projectedCostSavings: project.criteriaValues?.roi_expected || 0,
                actualCostSavings: 0
            },
            operationalBenefits: [],
            strategicBenefits: [],
            kpis: []
        };
    }

    // Initialize closure data
    if (!project.closureData) {
        project.closureData = {
            status: 'active',
            closureType: null,
            closureApprovedBy: null,
            closureDate: null,
            lessonsLearned: [],
            postImplementationReview: { scheduled: false, completed: false, findings: [] }
        };
    }

    // Add audit trail entry
    project.auditTrail.push({
        timestamp: today.toISOString(),
        userId: 'system',
        action: 'Post-Approval Lifecycle Activated',
        details: `Project transitioned to Stage-Gate execution model. Gate 1 (Concept Validation) initiated. Handover date: ${handoverDate.toISOString().split('T')[0]}`
    });

    console.log('‚úÖ Post-Approval Lifecycle Activated for:', project.criteriaValues?.initiative_name || project.name);
}

// ============================================================================
// PERFORMANCE METRICS & STATUS CALCULATION
// ============================================================================

function updateProjectPerformance(project) {
    if (!project.lifecycle || !project.lifecycle.activated) return;
    if (!project.performance) return;

    const tasks = project.tasks || [];
    if (tasks.length === 0) return;

    // Calculate Planned Value (PV) and Earned Value (EV)
    const budget = project.performance.budgetBaseline;
    let totalPlannedProgress = 0;
    let totalActualProgress = 0;

    tasks.forEach(task => {
        const taskWeight = 1 / tasks.length; // Equal weight per task
        const plannedProgress = calculatePlannedProgress(task);
        const actualProgress = task.progress || 0;

        totalPlannedProgress += plannedProgress * taskWeight;
        totalActualProgress += actualProgress * taskWeight;
    });

    project.performance.plannedValue = budget * (totalPlannedProgress / 100);
    project.performance.earnedValue = budget * (totalActualProgress / 100);

    // Calculate indices
    if (project.performance.plannedValue > 0) {
        project.performance.schedulePerformanceIndex = project.performance.earnedValue / project.performance.plannedValue;
    }
    if (project.performance.actualCost > 0) {
        project.performance.costPerformanceIndex = project.performance.earnedValue / project.performance.actualCost;
    }

    // Calculate variances
    project.performance.scheduleVariance = project.performance.earnedValue - project.performance.plannedValue;
    project.performance.costVariance = project.performance.earnedValue - project.performance.actualCost;

    project.performance.lastUpdated = new Date().toISOString();

    // Update project status based on performance
    updateProjectStatus(project);
}

function calculatePlannedProgress(task) {
    if (!task.startDate || !task.dueDate) return 0;

    const start = new Date(task.startDate);
    const end = new Date(task.dueDate);
    const today = new Date();

    if (today < start) return 0;
    if (today > end) return 100;

    const totalDays = (end - start) / (1000 * 60 * 60 * 24);
    const elapsedDays = (today - start) / (1000 * 60 * 60 * 24);

    return Math.min(100, (elapsedDays / totalDays) * 100);
}

function updateProjectStatus(project) {
    if (!project.lifecycle || !project.lifecycle.activated) return;
    if (!project.performance) return;

    const spi = project.performance.schedulePerformanceIndex;
    const cpi = project.performance.costPerformanceIndex;

    // Check for HIGH+ risks
    const hasHighRisk = project.riskRegister?.risks?.some(r => r.score >= 10) || false;
    const hasCatastrophicRisk = project.riskRegister?.risks?.some(r => r.score >= 17) || false;

    // Status determination logic (per PETROLUBE Post-Approval Lifecycle Model)
    let newStatus = 'GREEN';

    if (hasCatastrophicRisk) {
        newStatus = 'BLACK'; // Recovery mode
    } else if (spi < 0.80 || cpi < 0.80) {
        newStatus = 'RED'; // Delayed/Critical
    } else if (hasHighRisk || (spi >= 0.80 && spi < 0.95) || (cpi >= 0.80 && cpi < 0.95)) {
        newStatus = 'YELLOW'; // At Risk
    } else if (spi >= 0.95 && cpi >= 0.95 && !hasHighRisk) {
        newStatus = 'GREEN'; // On Track
    }

    // Check if project is on hold due to dependencies
    const hasBlockedDependency = project.riskRegister?.dependencies?.some(d => d.status === 'blocked') || false;
    if (hasBlockedDependency && newStatus !== 'BLACK') {
        newStatus = 'BLUE'; // On Hold
    }

    // Update status if changed
    if (project.lifecycle.projectStatus !== newStatus) {
        const oldStatus = project.lifecycle.projectStatus;
        project.lifecycle.projectStatus = newStatus;

        // Add audit trail
        project.auditTrail.push({
            timestamp: new Date().toISOString(),
            userId: 'system',
            action: `Project status changed: ${oldStatus} ‚Üí ${newStatus}`,
            details: `SPI: ${spi.toFixed(2)}, CPI: ${cpi.toFixed(2)}, High Risks: ${hasHighRisk ? 'Yes' : 'No'}`
        });
    }
}

function getStatusBadgeClass(status) {
    const statusMap = {
        'GREEN': 'badge-green',
        'YELLOW': 'badge-orange',
        'RED': 'badge-red',
        'BLUE': 'badge-blue',
        'BLACK': 'badge-gray',
        'COMPLETED': 'badge-green',
        'TERMINATED': 'badge-red',
        'PENDING_APPROVAL': 'badge-gray'
    };
    return statusMap[status] || 'badge-gray';
}

function getStatusIcon(status) {
    const iconMap = {
        'GREEN': 'üü¢',
        'YELLOW': 'üü°',
        'RED': 'üî¥',
        'BLUE': 'üîµ',
        'BLACK': '‚¨õ',
        'COMPLETED': '‚úÖ',
        'TERMINATED': '‚ùå',
        'PENDING_APPROVAL': '‚è≥'
    };
    return iconMap[status] || '‚ö™';
}

function getGateName(gate) {
    const gateNames = {
        'gate_0': 'Gate 0: Idea Screening',
        'gate_1': 'Gate 1: Concept Validation',
        'gate_2': 'Gate 2: Pilot Validation (CFO Proof-Gate)',
        'gate_3': 'Gate 3: Scale Readiness',
        'gate_4': 'Gate 4: Deployment Approval',
        'gate_5': 'Gate 5: Post-Launch Review'
    };
    return gateNames[gate] || gate;
}

function cancelReview() {
    state.selectedReviewProject = null;
    render();
}

// ============================================================================
// EXPOSE FUNCTIONS TO WINDOW
// ============================================================================

window.selectRole = selectRole;
window.continueToDashboard = continueToDashboard;
window.navigateTo = navigateTo;
window.logout = logout;
window.loginAsUser = loginAsUser;
window.openProjectWizard = openProjectWizard;
window.closeProjectWizard = closeProjectWizard;
window.runAIAutoFill = runAIAutoFill;
window.resetAIAutoFill = resetAIAutoFill;
window.updateFieldValue = updateFieldValue;
window.wizardNext = wizardNext;
window.wizardPrev = wizardPrev;
window.submitWizard = submitWizard;
window.selectPMOProject = selectPMOProject;
window.setPMOView = setPMOView;
window.openAddTaskModal = openAddTaskModal;
window.addTask = addTask;
window.updateTaskStatus = updateTaskStatus;
window.editTask = editTask;
window.deleteTask = deleteTask;
window.startLegalReview = startLegalReview;
window.updateLegalScore = updateLegalScore;
window.submitLegalReview = submitLegalReview;
window.startFinanceReview = startFinanceReview;
window.updateFinanceScore = updateFinanceScore;
window.submitFinanceReview = submitFinanceReview;
window.startITReview = startITReview;
window.updateITScore = updateITScore;
window.submitITReview = submitITReview;
window.startAGBReview = startAGBReview;
window.submitAGBReview = submitAGBReview;
window.cancelReview = cancelReview;

// ============================================================================
// INITIALIZE
// ============================================================================

render();

</script>
</body>
</html>

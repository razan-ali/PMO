<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PETROLUBE - Enterprise Initiative Management</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
</head>
<body>
<div id="app-root"></div>

<script>
// ============================================================================
// PETROLUBE ENTERPRISE SYSTEM - CLEAN VERSION
// ============================================================================

const STYLES = `
* { margin: 0; padding: 0; box-sizing: border-box; }

:root {
    --petro-green-900: #0F3B29;
    --petro-green-800: #1B5E3F;
    --petro-green-700: #2E7D52;
    --petro-green-600: #45A569;
    --petro-green-100: #E8F5E9;
    --petro-green-50: #F1F8F4;
    --petro-gold-600: #C9A961;
    --petro-gold-500: #D4B97A;
    --neutral-900: #1A1A1A;
    --neutral-800: #2C2C2C;
    --neutral-700: #404040;
    --neutral-600: #525252;
    --neutral-500: #737373;
    --neutral-400: #A3A3A3;
    --neutral-300: #D4D4D4;
    --neutral-200: #E5E5E5;
    --neutral-100: #F5F5F5;
    --neutral-50: #FAFAFA;
    --blue-600: #2563EB;
    --blue-500: #3B82F6;
    --blue-50: #EFF6FF;
    --green-600: #16A34A;
    --green-500: #22C55E;
    --green-50: #F0FDF4;
    --red-600: #DC2626;
    --red-50: #FEF2F2;
    --orange-600: #EA580C;
    --orange-500: #F97316;
    --purple-600: #9333EA;
    --purple-500: #A855F7;
}

body {
    font-family: 'Inter', sans-serif;
    background: var(--neutral-50);
    color: var(--neutral-900);
    line-height: 1.6;
}

.container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 0 32px;
}

header {
    background: linear-gradient(135deg, var(--petro-green-900), var(--petro-green-800));
    color: white;
    padding: 20px 0;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}

.header-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.logo-section {
    display: flex;
    align-items: center;
    gap: 16px;
    cursor: pointer;
}

.logo {
    width: 48px;
    height: 48px;
    background: var(--petro-gold-600);
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    font-weight: 900;
    color: white;
}

.logo-text h1 {
    font-size: 20px;
    font-weight: 900;
    margin-bottom: 2px;
}

.logo-text p {
    font-size: 11px;
    opacity: 0.8;
}

nav {
    display: flex;
    gap: 8px;
}

.nav-link {
    padding: 8px 16px;
    color: white;
    text-decoration: none;
    border-radius: 6px;
    font-weight: 600;
    font-size: 14px;
    transition: all 0.2s;
}

.nav-link:hover {
    background: rgba(255,255,255,0.1);
}

.nav-link.active {
    background: var(--petro-gold-600);
}

.user-info {
    display: flex;
    align-items: center;
    gap: 16px;
}

.user-badge {
    font-size: 13px;
}

.btn {
    padding: 10px 20px;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    font-size: 14px;
}

.btn-primary {
    background: var(--petro-green-700);
    color: white;
}

.btn-primary:hover {
    background: var(--petro-green-600);
}

.btn-secondary {
    background: var(--neutral-200);
    color: var(--neutral-900);
}

.btn-secondary:hover {
    background: var(--neutral-300);
}

.btn-gold {
    background: var(--petro-gold-600);
    color: white;
}

.btn-gold:hover {
    background: var(--petro-gold-500);
}

.btn-sm {
    padding: 6px 12px;
    font-size: 13px;
}

.btn-lg {
    padding: 14px 28px;
    font-size: 16px;
}

.btn-block {
    width: 100%;
}

.btn-danger {
    background: var(--red-600);
    color: white;
}

.card {
    background: white;
    border-radius: 12px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.grid {
    display: grid;
    gap: 24px;
}

.grid-2 {
    grid-template-columns: repeat(2, 1fr);
}

.grid-3 {
    grid-template-columns: repeat(3, 1fr);
}

.grid-4 {
    grid-template-columns: repeat(4, 1fr);
}

.mb-4 {
    margin-bottom: 16px;
}

.mb-6 {
    margin-bottom: 24px;
}

.form-group {
    margin-bottom: 20px;
}

.form-label {
    display: block;
    font-weight: 600;
    margin-bottom: 8px;
    font-size: 14px;
    color: var(--neutral-900);
}

.form-label.required::after {
    content: ' *';
    color: var(--red-600);
}

.form-control {
    width: 100%;
    padding: 10px 14px;
    border: 1px solid var(--neutral-300);
    border-radius: 6px;
    font-size: 14px;
    font-family: inherit;
}

.form-control:focus {
    outline: none;
    border-color: var(--petro-green-600);
}

select.form-control {
    cursor: pointer;
}

textarea.form-control {
    resize: vertical;
    min-height: 80px;
}

.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 1000;
    align-items: center;
    justify-content: center;
}

.modal.active {
    display: flex;
}

.modal-content {
    background: white;
    border-radius: 16px;
    width: 90%;
    max-width: 900px;
    max-height: 90vh;
    overflow: hidden;
    display: flex;
    flex-direction: column;
}

.modal-header {
    padding: 24px 32px;
    border-bottom: 1px solid var(--neutral-200);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-header h2 {
    font-size: 24px;
    font-weight: 800;
}

.modal-close {
    background: none;
    border: none;
    font-size: 32px;
    cursor: pointer;
    color: var(--neutral-500);
    padding: 0;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.modal-body {
    padding: 32px;
    overflow-y: auto;
    flex: 1;
}

.modal-footer {
    padding: 16px 32px;
    border-top: 1px solid var(--neutral-200);
    display: flex;
    gap: 12px;
    justify-content: flex-end;
}

.wizard-steps {
    display: flex;
    justify-content: space-between;
    margin-bottom: 32px;
}

.wizard-step {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    position: relative;
}

.wizard-step-circle {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: var(--neutral-300);
    color: var(--neutral-600);
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    margin-bottom: 8px;
}

.wizard-step.active .wizard-step-circle {
    background: var(--petro-green-600);
    color: white;
}

.wizard-step.completed .wizard-step-circle {
    background: var(--petro-green-700);
    color: white;
}

.wizard-step-label {
    font-size: 12px;
    font-weight: 600;
    color: var(--neutral-600);
}

.wizard-step.active .wizard-step-label {
    color: var(--petro-green-700);
}

.agent-panel {
    background: linear-gradient(135deg, #EFF6FF 0%, #DBEAFE 100%);
    border: 2px solid var(--blue-500);
    border-radius: 12px;
    padding: 24px;
}

.alert {
    padding: 16px;
    border-radius: 8px;
    display: flex;
    gap: 12px;
    align-items: start;
}

.alert-success {
    background: var(--green-50);
    border: 1px solid var(--green-500);
    color: var(--green-600);
}

.badge {
    display: inline-block;
    padding: 4px 12px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 600;
}

.badge-green {
    background: var(--green-50);
    color: var(--green-600);
}

.badge-blue {
    background: var(--blue-50);
    color: var(--blue-600);
}

.badge-red {
    background: var(--red-50);
    color: var(--red-600);
}

.badge-orange {
    background: #FFF7ED;
    color: var(--orange-600);
}

.badge-purple {
    background: #FAF5FF;
    color: var(--purple-600);
}

.badge-gray {
    background: var(--neutral-100);
    color: var(--neutral-600);
}

.data-table {
    width: 100%;
    border-collapse: collapse;
}

.data-table th,
.data-table td {
    padding: 12px;
    text-align: left;
    border-bottom: 1px solid var(--neutral-200);
}

.data-table th {
    background: var(--neutral-50);
    font-weight: 700;
    font-size: 12px;
    text-transform: uppercase;
    color: var(--neutral-600);
}

.data-table tbody tr:hover {
    background: var(--neutral-50);
}

.text-center {
    text-align: center;
}

footer {
    background: var(--neutral-900);
    color: white;
    padding: 24px 0;
    margin-top: 60px;
}

@keyframes pulse {
    0%, 100% { opacity: 1; transform: scale(1); }
    50% { opacity: 0.6; transform: scale(1.1); }
}

.progress-bar {
    width: 100%;
    height: 6px;
    background: var(--neutral-200);
    border-radius: 3px;
    overflow: hidden;
}

.progress-fill {
    height: 100%;
    background: var(--petro-green-600);
    transition: width 0.3s ease;
}
`;

// ============================================================================
// APP STATE
// ============================================================================

const state = {
    currentPage: 'landing',
    currentTenant: 'petrolube',
    currentRole: 'pmo',
    currentUserName: 'Ghadah (CITO)',
    wizardStep: 1,
    wizardData: { criteriaValues: {} },
    showDescriptionBox: true,
    aiProcessing: false,
    aiComplete: false,
    selectedScenario: 'A',
    selectedPMOProject: null,
    projects: []
};

// ============================================================================
// SIMPLE SAMPLE DATA
// ============================================================================

const SAMPLE_PROJECTS = [
    {
        id: 'proj-1',
        name: 'Oracle ERP Redwood UX Migration',
        status: 'Ready',
        criteriaValues: {
            initiative_name: 'Oracle ERP Redwood UX Migration',
            initiative_id: 'INI-2025-001',
            strategic_priority: 'p1_critical',
            investment_required: 12500000,
            implementation_timeline: {
                start_date: '2025-01-15',
                end_date: '2025-12-31',
                confidence: 'high'
            }
        },
        tasks: [
            {
                name: 'Requirements Gathering',
                description: 'Collect requirements from stakeholders',
                assignedTo: 'Sara Al-Otaibi',
                priority: 'high',
                dueDate: '2025-02-01',
                status: 'in_progress',
                createdAt: '2025-01-10T10:00:00Z'
            },
            {
                name: 'Design UX Mockups',
                description: 'Create new Redwood interface designs',
                assignedTo: 'Khalid Al-Fahad',
                priority: 'high',
                dueDate: '2025-02-15',
                status: 'not_started',
                createdAt: '2025-01-10T10:05:00Z'
            }
        ],
        milestones: [
            {
                name: 'Phase 1 Complete',
                date: '2025-03-31',
                status: 'pending'
            },
            {
                name: 'Go-Live',
                date: '2025-12-31',
                status: 'pending'
            }
        ],
        scores: {
            compositeScore: 87.5,
            rank: 1
        },
        createdAt: '2025-01-05T10:00:00Z'
    },
    {
        id: 'proj-2',
        name: 'AI-Powered Predictive Maintenance',
        status: 'Ready',
        criteriaValues: {
            initiative_name: 'AI-Powered Predictive Maintenance',
            initiative_id: 'INI-2025-002',
            strategic_priority: 'p2_high',
            investment_required: 8000000,
            implementation_timeline: {
                start_date: '2025-02-01',
                end_date: '2025-09-30',
                confidence: 'medium'
            }
        },
        tasks: [
            {
                name: 'Data Collection Setup',
                description: 'Set up IoT sensors for data collection',
                assignedTo: 'Sara Al-Otaibi',
                priority: 'medium',
                dueDate: '2025-03-01',
                status: 'not_started',
                createdAt: '2025-01-10T11:00:00Z'
            }
        ],
        milestones: [
            {
                name: 'Pilot Launch',
                date: '2025-06-30',
                status: 'pending'
            }
        ],
        scores: {
            compositeScore: 82.3,
            rank: 2
        },
        createdAt: '2025-01-06T10:00:00Z'
    },
    {
        id: 'proj-3',
        name: 'Digital Twin Manufacturing',
        status: 'Ready',
        criteriaValues: {
            initiative_name: 'Digital Twin Manufacturing',
            initiative_id: 'INI-2025-003',
            strategic_priority: 'p2_high',
            investment_required: 15000000,
            implementation_timeline: {
                start_date: '2025-03-01',
                end_date: '2026-02-28',
                confidence: 'medium'
            }
        },
        tasks: [],
        milestones: [],
        scores: {
            compositeScore: 79.8,
            rank: 3
        },
        createdAt: '2025-01-07T10:00:00Z'
    }
];

// Initialize projects
state.projects = [...SAMPLE_PROJECTS];

// ============================================================================
// RENDER ENGINE
// ============================================================================

function render() {
    const root = document.getElementById('app-root');
    root.innerHTML = `
        <style>${STYLES}</style>
        ${state.currentPage === 'landing' ? renderLanding() : ''}
        ${state.currentPage !== 'landing' ? renderHeader() : ''}
        ${state.currentPage !== 'landing' ? renderPage() : ''}
        ${state.currentPage !== 'landing' ? renderFooter() : ''}
        ${renderModals()}
    `;
}

function renderLanding() {
    return `
        <div style="background: linear-gradient(135deg, var(--petro-green-900), var(--petro-green-800)); min-height: 100vh; padding: 80px 24px; color: white;">
            <div class="container">
                <div class="text-center" style="margin-bottom: 64px;">
                    <div style="display: inline-flex; align-items: center; justify-content: center; width: 80px; height: 80px; background: rgba(255,255,255,0.15); border-radius: 20px; margin-bottom: 24px;">
                        <div style="font-size: 40px; font-weight: 800;">P</div>
                    </div>
                    <h1 style="font-size: 56px; margin-bottom: 16px; font-weight: 900;">PETROLUBE</h1>
                    <p style="font-size: 24px; color: var(--petro-gold-500); font-weight: 700; margin-bottom: 12px;">Enterprise Initiative Management</p>
                    <p style="color: rgba(255,255,255,0.8); font-size: 16px;">AI-Powered ‚Ä¢ PMO Dashboard ‚Ä¢ Task Management</p>
                </div>

                <div style="background: white; border-radius: 20px; padding: 48px; max-width: 600px; margin: 0 auto; box-shadow: 0 20px 60px rgba(0,0,0,0.4);">
                    <h2 style="color: var(--petro-green-800); margin-bottom: 32px; font-size: 26px; font-weight: 800;">Get Started</h2>

                    <div style="margin-bottom: 24px;">
                        <label style="font-weight: 700; margin-bottom: 12px; display: block; color: var(--neutral-700);">Select Role</label>
                        ${[
                            { id: 'pmo', name: 'PMO Manager', desc: 'Full system access' },
                            { id: 'executive', name: 'Executive', desc: 'Strategic overview' }
                        ].map(role => `
                            <div onclick="selectRole('${role.id}', '${role.name}')"
                                 style="padding: 18px 20px; border: 2px solid ${state.currentRole === role.id ? 'var(--petro-green-700)' : 'var(--neutral-200)'};
                                        border-radius: 10px; margin-bottom: 12px; cursor: pointer;
                                        background: ${state.currentRole === role.id ? 'var(--petro-green-50)' : 'white'}; transition: all 0.2s;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <strong style="font-weight: 700; color: var(--neutral-900);">${role.name}</strong>
                                        <p style="font-size: 13px; color: var(--neutral-600); margin-top: 4px;">${role.desc}</p>
                                    </div>
                                    ${state.currentRole === role.id ? '<div style="width: 20px; height: 20px; background: var(--petro-green-700); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 12px;">‚úì</div>' : ''}
                                </div>
                            </div>
                        `).join('')}
                    </div>

                    <button class="btn btn-gold btn-block btn-lg" onclick="continueToDashboard()">
                        Continue to Dashboard ‚Üí
                    </button>
                </div>
            </div>
        </div>
    `;
}

function renderHeader() {
    return `
        <header>
            <div class="header-content container">
                <div class="logo-section" onclick="navigateTo('dashboard')">
                    <div class="logo">P</div>
                    <div class="logo-text">
                        <h1>PETROLUBE</h1>
                        <p>Enterprise Initiative Management</p>
                    </div>
                </div>
                <nav>
                    <a href="#" class="nav-link ${state.currentPage === 'dashboard' ? 'active' : ''}" onclick="event.preventDefault(); navigateTo('dashboard');">Dashboard</a>
                    <a href="#" class="nav-link ${state.currentPage === 'projects' ? 'active' : ''}" onclick="event.preventDefault(); navigateTo('projects');">Projects</a>
                    <a href="#" class="nav-link ${state.currentPage === 'pmo' ? 'active' : ''}" onclick="event.preventDefault(); navigateTo('pmo');">PMO Manager</a>
                </nav>
                <div class="user-info">
                    <div class="user-badge">
                        <span style="font-weight: 700;">${state.currentUserName}</span>
                    </div>
                    <button class="btn btn-secondary btn-sm" onclick="logout()">Logout</button>
                </div>
            </div>
        </header>
    `;
}

function renderFooter() {
    return `
        <footer>
            <div class="container" style="display: flex; justify-content: space-between; align-items: center;">
                <div style="font-size: 14px;">
                    <span style="color: var(--petro-gold-500); font-weight: 700;">PETROLUBE</span>
                    <span style="opacity: 0.7; margin: 0 8px;">‚Ä¢</span>
                    Enterprise System
                </div>
                <div style="font-size: 13px; opacity: 0.7;">¬© 2025 PETROLUBE</div>
            </div>
        </footer>
    `;
}

function renderPage() {
    if (state.currentPage === 'dashboard') return renderDashboard();
    if (state.currentPage === 'projects') return renderProjects();
    if (state.currentPage === 'pmo') return renderPMOManager();
    return '<div class="container">Page not found</div>';
}

function renderDashboard() {
    const totalProjects = state.projects.length;
    const activeProjects = state.projects.filter(p => p.status === 'Ready').length;
    const totalTasks = state.projects.reduce((sum, p) => sum + (p.tasks?.length || 0), 0);
    const completedTasks = state.projects.reduce((sum, p) => sum + (p.tasks?.filter(t => t.status === 'completed').length || 0), 0);

    return `
        <div class="container" style="padding: 40px 32px;">
            <div style="margin-bottom: 32px;">
                <h2 style="font-size: 32px; font-weight: 900; color: var(--neutral-900); margin-bottom: 8px;">Dashboard</h2>
                <p style="color: var(--neutral-600); font-size: 16px;">Portfolio Overview</p>
            </div>

            <div class="grid grid-4 mb-6">
                ${[
                    { icon: 'üìÅ', label: 'Total Projects', value: totalProjects, color: 'var(--blue-600)' },
                    { icon: 'üöÄ', label: 'Active Projects', value: activeProjects, color: 'var(--green-600)' },
                    { icon: '‚úì', label: 'Total Tasks', value: totalTasks, color: 'var(--purple-600)' },
                    { icon: 'üìà', label: 'Completed Tasks', value: completedTasks, color: 'var(--orange-600)' }
                ].map(stat => `
                    <div class="card" style="padding: 24px; text-align: center;">
                        <div style="font-size: 40px; margin-bottom: 12px;">${stat.icon}</div>
                        <div style="font-size: 28px; font-weight: 800; color: ${stat.color}; margin-bottom: 4px;">${stat.value}</div>
                        <div style="font-size: 13px; color: var(--neutral-600); font-weight: 600; text-transform: uppercase;">${stat.label}</div>
                    </div>
                `).join('')}
            </div>

            <div class="card" style="padding: 32px;">
                <h3 style="font-size: 20px; font-weight: 800; margin-bottom: 24px;">Recent Projects</h3>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Project Name</th>
                            <th>Status</th>
                            <th>Tasks</th>
                            <th>Timeline</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${state.projects.map(p => `
                            <tr>
                                <td><strong>${p.criteriaValues?.initiative_name || p.name}</strong></td>
                                <td><span class="badge badge-green">${p.status}</span></td>
                                <td>${p.tasks?.length || 0} tasks</td>
                                <td>${p.criteriaValues?.implementation_timeline?.start_date || 'TBD'} ‚Üí ${p.criteriaValues?.implementation_timeline?.end_date || 'TBD'}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        </div>
    `;
}

function renderProjects() {
    return `
        <div class="container" style="padding: 40px 32px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 32px;">
                <div>
                    <h2 style="font-size: 32px; font-weight: 900; color: var(--neutral-900); margin-bottom: 8px;">Projects</h2>
                    <p style="color: var(--neutral-600); font-size: 16px;">${state.projects.length} initiatives</p>
                </div>
                <button class="btn btn-gold btn-lg" onclick="openProjectWizard()">+ Create New Initiative</button>
            </div>

            <div class="card" style="padding: 32px;">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Initiative Name</th>
                            <th>ID</th>
                            <th>Score</th>
                            <th>Priority</th>
                            <th>Investment</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${state.projects.map(p => `
                            <tr>
                                <td><strong>${p.criteriaValues?.initiative_name || p.name}</strong></td>
                                <td><span class="badge badge-gray">${p.criteriaValues?.initiative_id || p.id}</span></td>
                                <td><div style="font-size: 20px; font-weight: 800; color: var(--petro-green-600);">${p.scores?.compositeScore?.toFixed(1) || '--'}</div></td>
                                <td><span class="badge badge-orange">${p.criteriaValues?.strategic_priority || 'N/A'}</span></td>
                                <td><strong>${p.criteriaValues?.investment_required ? (p.criteriaValues.investment_required / 1000000).toFixed(1) + 'M SAR' : '‚Äî'}</strong></td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        </div>
    `;
}

function renderPMOManager() {
    const selectedProject = state.selectedPMOProject ? state.projects.find(p => p.id === state.selectedPMOProject) : null;
    const totalTasks = state.projects.reduce((sum, p) => sum + (p.tasks?.length || 0), 0);
    const completedTasks = state.projects.reduce((sum, p) => sum + (p.tasks?.filter(t => t.status === 'completed').length || 0), 0);
    const totalMilestones = state.projects.reduce((sum, p) => sum + (p.milestones?.length || 0), 0);

    return `
        <div class="container" style="padding: 40px 32px;">
            <div style="margin-bottom: 32px;">
                <h2 style="font-size: 32px; font-weight: 900; color: var(--neutral-900); margin-bottom: 8px;">üìä PMO Manager Dashboard</h2>
                <p style="color: var(--neutral-600); font-size: 16px;">Project timelines, task management, and portfolio tracking</p>
            </div>

            <div class="grid grid-4 mb-6">
                ${[
                    { icon: 'üìÅ', label: 'Total Projects', value: state.projects.length, color: 'var(--blue-600)' },
                    { icon: '‚úì', label: 'Total Tasks', value: totalTasks, color: 'var(--purple-600)' },
                    { icon: 'üìà', label: 'Completed', value: completedTasks, color: 'var(--green-600)' },
                    { icon: 'üìç', label: 'Milestones', value: totalMilestones, color: 'var(--orange-600)' }
                ].map(stat => `
                    <div class="card" style="padding: 24px; text-align: center;">
                        <div style="font-size: 40px; margin-bottom: 12px;">${stat.icon}</div>
                        <div style="font-size: 28px; font-weight: 800; color: ${stat.color}; margin-bottom: 4px;">${stat.value}</div>
                        <div style="font-size: 13px; color: var(--neutral-600); font-weight: 600; text-transform: uppercase;">${stat.label}</div>
                    </div>
                `).join('')}
            </div>

            <div class="grid grid-2 mb-6">
                <div class="card" style="padding: 24px;">
                    <h3 style="font-size: 18px; font-weight: 800; color: var(--neutral-900); margin-bottom: 16px;">üìÇ Select Project</h3>
                    <div style="max-height: 500px; overflow-y: auto;">
                        ${state.projects.map(project => `
                            <div onclick="selectPMOProject('${project.id}')"
                                 style="padding: 16px; border: 2px solid ${selectedProject?.id === project.id ? 'var(--petro-green-700)' : 'var(--neutral-200)'};
                                        border-radius: 8px; margin-bottom: 12px; cursor: pointer;
                                        background: ${selectedProject?.id === project.id ? 'var(--petro-green-50)' : 'white'};
                                        transition: all 0.2s;">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                                    <strong style="font-weight: 700; color: var(--neutral-900); flex: 1;">${project.criteriaValues?.initiative_name || project.name}</strong>
                                    ${selectedProject?.id === project.id ? '<div style="width: 20px; height: 20px; background: var(--petro-green-700); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 12px;">‚úì</div>' : ''}
                                </div>
                                <div style="display: flex; gap: 8px;">
                                    <span class="badge badge-blue">${project.tasks?.length || 0} tasks</span>
                                    <span class="badge badge-purple">${project.milestones?.length || 0} milestones</span>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>

                <div class="card" style="padding: 24px;">
                    ${selectedProject ? renderTaskManagement(selectedProject) : `
                        <div style="text-align: center; padding: 60px 20px; color: var(--neutral-400);">
                            <div style="font-size: 64px; margin-bottom: 16px;">üìã</div>
                            <p style="font-size: 16px; font-weight: 600;">Select a project to manage tasks</p>
                        </div>
                    `}
                </div>
            </div>
        </div>
    `;
}

function renderTaskManagement(project) {
    const tasks = project.tasks || [];

    return `
        <div>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="font-size: 18px; font-weight: 800; color: var(--neutral-900);">üìã Tasks for ${project.criteriaValues?.initiative_name || project.name}</h3>
                <button class="btn btn-primary btn-sm" onclick="openAddTaskModal('${project.id}')">+ Add Task</button>
            </div>

            ${tasks.length === 0 ? `
                <div style="text-align: center; padding: 40px 20px; background: var(--neutral-50); border-radius: 8px;">
                    <div style="font-size: 48px; margin-bottom: 12px;">üìù</div>
                    <p style="color: var(--neutral-600); margin-bottom: 16px;">No tasks yet</p>
                    <button class="btn btn-secondary btn-sm" onclick="openAddTaskModal('${project.id}')">Create First Task</button>
                </div>
            ` : `
                <div style="max-height: 500px; overflow-y: auto;">
                    ${tasks.map((task, idx) => `
                        <div class="card" style="padding: 16px; margin-bottom: 12px; border-left: 4px solid ${
                            task.status === 'completed' ? 'var(--green-600)' :
                            task.status === 'in_progress' ? 'var(--blue-600)' :
                            task.status === 'blocked' ? 'var(--red-600)' : 'var(--neutral-400)'
                        };">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                                <div style="flex: 1;">
                                    <strong style="font-weight: 700; color: var(--neutral-900); display: block; margin-bottom: 8px;">${task.name}</strong>
                                    ${task.description ? `<p style="font-size: 13px; color: var(--neutral-600); margin-bottom: 8px;">${task.description}</p>` : ''}
                                </div>
                                <div style="display: flex; gap: 8px;">
                                    <button class="btn btn-secondary btn-sm" onclick="editTask('${project.id}', ${idx})">Edit</button>
                                    <button class="btn btn-danger btn-sm" onclick="deleteTask('${project.id}', ${idx})">Delete</button>
                                </div>
                            </div>

                            <div style="display: flex; gap: 16px; flex-wrap: wrap;">
                                <div>
                                    <label style="font-size: 11px; text-transform: uppercase; color: var(--neutral-600); font-weight: 700; display: block; margin-bottom: 4px;">Status</label>
                                    <select class="form-control" style="font-size: 13px; padding: 4px 8px;" onchange="updateTaskStatus('${project.id}', ${idx}, this.value)">
                                        <option value="not_started" ${task.status === 'not_started' ? 'selected' : ''}>Not Started</option>
                                        <option value="in_progress" ${task.status === 'in_progress' ? 'selected' : ''}>In Progress</option>
                                        <option value="blocked" ${task.status === 'blocked' ? 'selected' : ''}>Blocked</option>
                                        <option value="completed" ${task.status === 'completed' ? 'selected' : ''}>Completed</option>
                                    </select>
                                </div>
                                <div>
                                    <label style="font-size: 11px; text-transform: uppercase; color: var(--neutral-600); font-weight: 700; display: block; margin-bottom: 4px;">Priority</label>
                                    <span class="badge ${
                                        task.priority === 'high' ? 'badge-red' :
                                        task.priority === 'medium' ? 'badge-orange' : 'badge-gray'
                                    }">${task.priority || 'low'}</span>
                                </div>
                                ${task.assignedTo ? `
                                    <div>
                                        <label style="font-size: 11px; text-transform: uppercase; color: var(--neutral-600); font-weight: 700; display: block; margin-bottom: 4px;">Assigned To</label>
                                        <span style="font-size: 13px; color: var(--neutral-900);">${task.assignedTo}</span>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    `).join('')}
                </div>
            `}
        </div>
    `;
}

function renderModals() {
    return `
        <div id="projectWizardModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Create New Initiative</h2>
                    <button class="modal-close" onclick="closeProjectWizard()">√ó</button>
                </div>
                <div class="modal-body" id="wizardContent"></div>
            </div>
        </div>
    `;
}

function renderWizard() {
    const stepNames = ['AI Auto-Fill', 'Basic Info', 'Review'];

    let html = `
        <div class="wizard-steps">
            ${[1, 2, 3].map(s => `
                <div class="wizard-step ${state.wizardStep === s ? 'active' : state.wizardStep > s ? 'completed' : ''}">
                    <div class="wizard-step-circle">${state.wizardStep > s ? '‚úì' : s}</div>
                    <div class="wizard-step-label">${stepNames[s - 1]}</div>
                </div>
            `).join('')}
        </div>
    `;

    if (state.wizardStep === 1) html += renderWizardStep1();
    else if (state.wizardStep === 2) html += renderWizardStep2();
    else if (state.wizardStep === 3) html += renderWizardStep3();

    const wizardContent = document.getElementById('wizardContent');
    if (wizardContent) {
        wizardContent.innerHTML = html;
    }
}

function renderWizardStep1() {
    if (state.aiProcessing) {
        return `
            <div style="text-align: center; padding: 60px 24px;">
                <div style="font-size: 64px; margin-bottom: 24px; animation: pulse 2s infinite;">‚ö°</div>
                <h4 style="font-size: 18px; font-weight: 800; color: var(--blue-600); margin-bottom: 12px;">AI is Processing...</h4>
                <p style="font-size: 14px; color: var(--neutral-700); margin-bottom: 24px;">Analyzing your initiative and populating fields...</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" disabled>Processing...</button>
            </div>
        `;
    }

    return `
        <div style="margin-bottom: 32px;">
            <h3 style="font-size: 20px; font-weight: 800; color: var(--neutral-900); margin-bottom: 8px;">ü§ñ Step 1: AI Auto-Fill (Optional)</h3>
            <p style="color: var(--neutral-600); font-size: 14px;">Let AI populate fields, or skip and enter manually</p>
        </div>

        ${state.showDescriptionBox ? `
            <div class="agent-panel">
                <div class="form-group">
                    <label class="form-label">Project Description (Optional)</label>
                    <textarea class="form-control" id="wizard-description" rows="6"
                              placeholder="Describe your initiative...">${state.wizardData.description || ''}</textarea>
                </div>
                <button class="btn btn-gold btn-lg btn-block" onclick="runAIAutoFill()">
                    ‚ú® Auto-Fill All Fields
                </button>
            </div>
        ` : `
            <div class="alert alert-success mb-4">
                <div style="font-size: 24px;">‚úÖ</div>
                <div>
                    <strong style="font-weight: 700;">AI Processing Complete!</strong><br>
                    <span style="font-size: 14px;">Fields have been populated. Review in next steps.</span>
                </div>
            </div>
            <button class="btn btn-secondary" onclick="resetAIAutoFill()">‚Ü∫ Re-run AI</button>
        `}

        <div style="background: var(--blue-50); border-left: 4px solid var(--blue-600); padding: 12px 16px; border-radius: 6px; margin: 24px 0;">
            <div style="font-weight: 700; color: var(--blue-900); margin-bottom: 4px;">üí° Tip</div>
            <div style="font-size: 13px; color: var(--blue-700);">AI is optional. Click "Next" to enter data manually.</div>
        </div>

        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeProjectWizard()">Cancel</button>
            <button class="btn btn-primary" onclick="wizardNext()">
                ${state.showDescriptionBox ? 'Skip AI & Enter Manually ‚Üí' : 'Next: Basic Info ‚Üí'}
            </button>
        </div>
    `;
}

function renderWizardStep2() {
    const name = state.wizardData.criteriaValues.initiative_name || '';
    const id = state.wizardData.criteriaValues.initiative_id || '';
    const priority = state.wizardData.criteriaValues.strategic_priority || '';
    const investment = state.wizardData.criteriaValues.investment_required || '';

    return `
        <div style="margin-bottom: 32px;">
            <h3 style="font-size: 20px; font-weight: 800; color: var(--neutral-900); margin-bottom: 8px;">üìã Step 2: Basic Information</h3>
            <p style="color: var(--neutral-600); font-size: 14px;">Define core initiative details</p>
        </div>

        <div class="card" style="padding: 24px; background: var(--neutral-50); margin-bottom: 24px;">
            <div class="grid grid-2">
                <div class="form-group">
                    <label class="form-label required">Initiative Name</label>
                    <input type="text" class="form-control" id="field-name" value="${name}"
                           onchange="updateFieldValue('initiative_name', this.value)">
                </div>
                <div class="form-group">
                    <label class="form-label">Initiative ID</label>
                    <input type="text" class="form-control" id="field-id" value="${id}"
                           onchange="updateFieldValue('initiative_id', this.value)">
                </div>
                <div class="form-group">
                    <label class="form-label">Strategic Priority</label>
                    <select class="form-control" onchange="updateFieldValue('strategic_priority', this.value)">
                        <option value="">Select...</option>
                        <option value="p1_critical" ${priority === 'p1_critical' ? 'selected' : ''}>P1 - Critical</option>
                        <option value="p2_high" ${priority === 'p2_high' ? 'selected' : ''}>P2 - High</option>
                        <option value="p3_medium" ${priority === 'p3_medium' ? 'selected' : ''}>P3 - Medium</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Investment Required (SAR)</label>
                    <input type="number" class="form-control" value="${investment}"
                           onchange="updateFieldValue('investment_required', parseFloat(this.value))">
                </div>
            </div>
        </div>

        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="wizardPrev()">‚Üê Back</button>
            <button class="btn btn-primary" onclick="wizardNext()">Next: Review ‚Üí</button>
        </div>
    `;
}

function renderWizardStep3() {
    const name = state.wizardData.criteriaValues.initiative_name || 'Unnamed Initiative';
    const id = state.wizardData.criteriaValues.initiative_id || 'N/A';
    const priority = state.wizardData.criteriaValues.strategic_priority || 'N/A';
    const investment = state.wizardData.criteriaValues.investment_required || 0;

    return `
        <div style="margin-bottom: 32px;">
            <h3 style="font-size: 20px; font-weight: 800; color: var(--neutral-900); margin-bottom: 8px;">‚úÖ Step 3: Review & Submit</h3>
            <p style="color: var(--neutral-600); font-size: 14px;">Verify your initiative details</p>
        </div>

        <div class="card" style="padding: 24px; background: var(--neutral-50);">
            <table style="width: 100%;">
                <tr style="border-bottom: 1px solid var(--neutral-200);">
                    <td style="padding: 12px 0; font-weight: 600;">Initiative Name:</td>
                    <td style="padding: 12px 0;">${name}</td>
                </tr>
                <tr style="border-bottom: 1px solid var(--neutral-200);">
                    <td style="padding: 12px 0; font-weight: 600;">Initiative ID:</td>
                    <td style="padding: 12px 0;">${id}</td>
                </tr>
                <tr style="border-bottom: 1px solid var(--neutral-200);">
                    <td style="padding: 12px 0; font-weight: 600;">Priority:</td>
                    <td style="padding: 12px 0;">${priority}</td>
                </tr>
                <tr>
                    <td style="padding: 12px 0; font-weight: 600;">Investment:</td>
                    <td style="padding: 12px 0;">${investment ? (investment / 1000000).toFixed(1) + 'M SAR' : 'N/A'}</td>
                </tr>
            </table>
        </div>

        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="wizardPrev()">‚Üê Back</button>
            <button class="btn btn-gold btn-lg" onclick="submitWizard()">‚úì Create Initiative</button>
        </div>
    `;
}

// ============================================================================
// EVENT HANDLERS
// ============================================================================

function selectRole(roleId, userName) {
    state.currentRole = roleId;
    state.currentUserName = userName;
    render();
}

function continueToDashboard() {
    state.currentPage = 'dashboard';
    render();
}

function navigateTo(page) {
    state.currentPage = page;
    render();
    window.scrollTo(0, 0);
}

function logout() {
    state.currentPage = 'landing';
    render();
}

function openProjectWizard() {
    state.wizardStep = 1;
    state.wizardData = { criteriaValues: {} };
    state.showDescriptionBox = true;
    state.aiProcessing = false;

    const modal = document.getElementById('projectWizardModal');
    if (modal) {
        modal.classList.add('active');
        setTimeout(() => renderWizard(), 0);
    }
}

function closeProjectWizard() {
    document.getElementById('projectWizardModal').classList.remove('active');
    state.wizardData = { criteriaValues: {} };
}

function runAIAutoFill() {
    const description = document.getElementById('wizard-description').value;
    if (!description.trim()) {
        alert('Please enter a project description first');
        return;
    }

    state.aiProcessing = true;
    state.wizardData.description = description;
    renderWizard();

    setTimeout(() => {
        // AI generates sample data
        state.wizardData.criteriaValues = {
            initiative_name: 'AI-Generated Initiative',
            initiative_id: 'INI-' + Date.now(),
            strategic_priority: 'p2_high',
            investment_required: 10000000
        };
        state.showDescriptionBox = false;
        state.aiProcessing = false;
        renderWizard();
    }, 1500);
}

function resetAIAutoFill() {
    state.showDescriptionBox = true;
    state.aiProcessing = false;
    state.wizardData.criteriaValues = {};
    renderWizard();
}

function updateFieldValue(key, value) {
    if (!state.wizardData.criteriaValues) state.wizardData.criteriaValues = {};
    state.wizardData.criteriaValues[key] = value;
}

function wizardNext() {
    state.wizardStep++;
    renderWizard();
}

function wizardPrev() {
    state.wizardStep--;
    renderWizard();
}

function submitWizard() {
    const newProject = {
        id: 'proj-' + Date.now(),
        name: state.wizardData.criteriaValues.initiative_name || 'Unnamed Initiative',
        criteriaValues: state.wizardData.criteriaValues,
        status: 'Ready',
        tasks: [],
        milestones: [],
        scores: {
            compositeScore: 75.0,
            rank: state.projects.length + 1
        },
        createdAt: new Date().toISOString()
    };

    state.projects.push(newProject);
    closeProjectWizard();

    alert(`‚úÖ Initiative "${newProject.name}" created successfully!`);
    navigateTo('projects');
}

// PMO Manager Functions

function selectPMOProject(projectId) {
    state.selectedPMOProject = projectId;
    render();
}

function openAddTaskModal(projectId) {
    const taskName = prompt('Task Name:');
    if (!taskName) return;

    const description = prompt('Task Description (optional):');
    const assignedTo = prompt('Assigned To (optional):');
    const priority = prompt('Priority (low/medium/high):') || 'medium';
    const dueDate = prompt('Due Date (YYYY-MM-DD, optional):');

    addTask(projectId, {
        name: taskName,
        description: description || '',
        assignedTo: assignedTo || '',
        priority: priority,
        dueDate: dueDate || '',
        status: 'not_started',
        createdAt: new Date().toISOString()
    });
}

function addTask(projectId, task) {
    const project = state.projects.find(p => p.id === projectId);
    if (!project) return;

    if (!project.tasks) project.tasks = [];
    project.tasks.push(task);
    render();
}

function updateTaskStatus(projectId, taskIndex, newStatus) {
    const project = state.projects.find(p => p.id === projectId);
    if (!project || !project.tasks || !project.tasks[taskIndex]) return;

    project.tasks[taskIndex].status = newStatus;
    render();
}

function editTask(projectId, taskIndex) {
    const project = state.projects.find(p => p.id === projectId);
    if (!project || !project.tasks || !project.tasks[taskIndex]) return;

    const task = project.tasks[taskIndex];
    const newName = prompt('Task Name:', task.name);
    if (!newName) return;

    const newDescription = prompt('Description:', task.description);
    const newAssignedTo = prompt('Assigned To:', task.assignedTo);

    task.name = newName;
    task.description = newDescription || '';
    task.assignedTo = newAssignedTo || '';

    render();
}

function deleteTask(projectId, taskIndex) {
    if (!confirm('Are you sure you want to delete this task?')) return;

    const project = state.projects.find(p => p.id === projectId);
    if (!project || !project.tasks || !project.tasks[taskIndex]) return;

    project.tasks.splice(taskIndex, 1);
    render();
}

// ============================================================================
// EXPOSE FUNCTIONS TO WINDOW
// ============================================================================

window.selectRole = selectRole;
window.continueToDashboard = continueToDashboard;
window.navigateTo = navigateTo;
window.logout = logout;
window.openProjectWizard = openProjectWizard;
window.closeProjectWizard = closeProjectWizard;
window.runAIAutoFill = runAIAutoFill;
window.resetAIAutoFill = resetAIAutoFill;
window.updateFieldValue = updateFieldValue;
window.wizardNext = wizardNext;
window.wizardPrev = wizardPrev;
window.submitWizard = submitWizard;
window.selectPMOProject = selectPMOProject;
window.openAddTaskModal = openAddTaskModal;
window.addTask = addTask;
window.updateTaskStatus = updateTaskStatus;
window.editTask = editTask;
window.deleteTask = deleteTask;

// ============================================================================
// INITIALIZE
// ============================================================================

render();

</script>
</body>
</html>

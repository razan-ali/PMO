<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PETROLUBE - Enterprise Initiative Management</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
</head>
<body>
<div id="app-root"></div>

<script>
// ============================================================================
// PETROLUBE ENTERPRISE INITIATIVE MANAGEMENT SYSTEM
// Expert-Level UI/UX with Full Sample Data
// ============================================================================

const STYLES = `
* { margin: 0; padding: 0; box-sizing: border-box; }

:root {
    --petro-green-900: #0F3B29;
    --petro-green-800: #1B5E3F;
    --petro-green-700: #2E7D52;
    --petro-green-600: #45A569;
    --petro-green-100: #E8F5E9;
    --petro-green-50: #F1F8F4;
    
    --petro-orange-700: #E67000;
    --petro-orange-600: #F57C00;
    --petro-orange-500: #FF9800;
    --petro-orange-100: #FFE0B2;
    
    --petro-gold-600: #C9A961;
    --petro-gold-500: #D4B97A;
    
    --neutral-900: #1A1A1A;
    --neutral-800: #2C2C2C;
    --neutral-700: #404040;
    --neutral-600: #525252;
    --neutral-500: #737373;
    --neutral-400: #A3A3A3;
    --neutral-300: #D4D4D4;
    --neutral-200: #E5E5E5;
    --neutral-100: #F5F5F5;
    --neutral-50: #FAFAFA;
    
    --blue-600: #2563EB;
    --blue-100: #DBEAFE;
    
    --red-600: #DC2626;
    --red-100: #FEE2E2;
    
    --yellow-600: #CA8A04;
    --yellow-100: #FEF3C7;
    
    --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
    --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
}

body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    background: var(--neutral-50);
    color: var(--neutral-900);
    line-height: 1.6;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
}

h1, h2, h3, h4, h5, h6 {
    font-weight: 700;
    line-height: 1.2;
    letter-spacing: -0.02em;
}

.container { 
    max-width: 1400px; 
    margin: 0 auto; 
    padding: 0 32px; 
}

/* Header */
header {
    background: white;
    border-bottom: 1px solid var(--neutral-200);
    box-shadow: var(--shadow-sm);
    position: sticky;
    top: 0;
    z-index: 100;
    backdrop-filter: blur(8px);
    background: rgba(255, 255, 255, 0.95);
}

.header-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
    height: 72px;
    padding: 0 32px;
}

.logo-section {
    display: flex;
    align-items: center;
    gap: 16px;
    cursor: pointer;
}

.logo {
    width: 44px;
    height: 44px;
    background: linear-gradient(135deg, var(--petro-green-800), var(--petro-green-900));
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 800;
    font-size: 20px;
    box-shadow: var(--shadow-md);
}

.logo-text h1 { 
    font-size: 18px; 
    color: var(--petro-green-800); 
    font-weight: 800;
    letter-spacing: -0.03em;
}
.logo-text p { 
    font-size: 12px; 
    color: var(--neutral-500); 
    font-weight: 500;
    margin-top: 2px;
}

nav { display: flex; gap: 4px; }

.nav-link {
    padding: 8px 16px;
    border-radius: 8px;
    font-weight: 600;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.2s ease;
    color: var(--neutral-600);
}

.nav-link:hover { 
    background: var(--neutral-100); 
    color: var(--neutral-900);
}
.nav-link.active { 
    background: var(--petro-green-800); 
    color: white; 
}

.user-info { 
    display: flex; 
    align-items: center; 
    gap: 16px; 
}

.user-badge { 
    padding: 10px 16px; 
    background: var(--neutral-100); 
    border-radius: 10px; 
    font-size: 13px; 
    font-weight: 600;
    border: 1px solid var(--neutral-200);
}

/* Buttons */
.btn {
    padding: 10px 20px;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.2s ease;
    font-family: 'Inter', sans-serif;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    justify-content: center;
}

.btn-primary { 
    background: var(--petro-green-800); 
    color: white; 
    box-shadow: var(--shadow-sm);
}
.btn-primary:hover { 
    background: var(--petro-green-900); 
    box-shadow: var(--shadow-md);
    transform: translateY(-1px);
}

.btn-secondary { 
    background: white; 
    color: var(--neutral-700); 
    border: 1px solid var(--neutral-300);
    box-shadow: var(--shadow-sm);
}
.btn-secondary:hover { 
    background: var(--neutral-50); 
    border-color: var(--neutral-400);
}

.btn-gold {
    background: linear-gradient(135deg, var(--petro-gold-600), var(--petro-gold-500));
    color: white;
    box-shadow: 0 4px 12px rgba(201, 169, 97, 0.25);
}
.btn-gold:hover { 
    transform: translateY(-1px); 
    box-shadow: 0 6px 16px rgba(201, 169, 97, 0.35);
}

.btn-orange { 
    background: var(--petro-orange-600); 
    color: white;
    box-shadow: var(--shadow-sm);
}
.btn-orange:hover { 
    background: var(--petro-orange-700);
    transform: translateY(-1px);
}

.btn-sm { padding: 6px 14px; font-size: 13px; }
.btn-lg { padding: 14px 28px; font-size: 16px; }
.btn-block { width: 100%; }
.btn:disabled { 
    opacity: 0.5; 
    cursor: not-allowed; 
}

/* Cards */
.card {
    background: white;
    border-radius: 12px;
    padding: 24px;
    box-shadow: var(--shadow-sm);
    border: 1px solid var(--neutral-200);
    margin-bottom: 24px;
    transition: all 0.2s ease;
}

.card:hover {
    box-shadow: var(--shadow-md);
}

.stat-card {
    background: white;
    border-radius: 12px;
    padding: 24px;
    box-shadow: var(--shadow-sm);
    border: 1px solid var(--neutral-200);
    transition: all 0.2s ease;
}

.stat-card:hover {
    box-shadow: var(--shadow-lg);
    transform: translateY(-2px);
}

.stat-card-header {
    font-size: 12px;
    font-weight: 700;
    color: var(--neutral-600);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: 12px;
}

.stat-card-value {
    font-size: 40px;
    font-weight: 800;
    line-height: 1;
    margin-bottom: 8px;
    letter-spacing: -0.02em;
}

.stat-card-footer {
    font-size: 13px;
    color: var(--neutral-500);
    font-weight: 500;
}

/* Status Badges */
.badge {
    padding: 4px 10px;
    border-radius: 6px;
    font-size: 11px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.03em;
    display: inline-flex;
    align-items: center;
    gap: 6px;
}

.badge-green { background: var(--petro-green-100); color: var(--petro-green-800); }
.badge-orange { background: var(--petro-orange-100); color: var(--petro-orange-700); }
.badge-yellow { background: var(--yellow-100); color: var(--yellow-600); }
.badge-red { background: var(--red-100); color: var(--red-600); }
.badge-blue { background: var(--blue-100); color: var(--blue-600); }
.badge-gray { background: var(--neutral-100); color: var(--neutral-600); }

/* Rank Badge */
.rank-badge {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 36px;
    height: 36px;
    border-radius: 8px;
    font-weight: 800;
    font-size: 16px;
}

.rank-1 { 
    background: linear-gradient(135deg, #FFD700, #FFA500); 
    color: white; 
    box-shadow: 0 4px 12px rgba(255, 215, 0, 0.3); 
}
.rank-2 { 
    background: linear-gradient(135deg, #C0C0C0, #A8A8A8); 
    color: white; 
    box-shadow: 0 4px 12px rgba(192, 192, 192, 0.3); 
}
.rank-3 { 
    background: linear-gradient(135deg, #CD7F32, #B87333); 
    color: white; 
    box-shadow: 0 4px 12px rgba(205, 127, 50, 0.3); 
}
.rank-default { 
    background: var(--petro-green-800); 
    color: white; 
}

/* Progress Bar */
.progress-bar {
    width: 100%;
    height: 8px;
    background: var(--neutral-200);
    border-radius: 4px;
    overflow: hidden;
}

.progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--petro-green-700), var(--petro-green-600));
    transition: width 0.5s ease;
    border-radius: 4px;
}

/* Alert */
.alert {
    padding: 16px 20px;
    border-radius: 10px;
    margin-bottom: 24px;
    display: flex;
    align-items: start;
    gap: 12px;
    font-size: 14px;
    border: 1px solid;
}

.alert-success { 
    background: var(--petro-green-50); 
    border-color: var(--petro-green-600); 
    color: var(--petro-green-900); 
}
.alert-danger { 
    background: var(--red-100); 
    border-color: var(--red-600); 
    color: var(--neutral-900); 
}
.alert-info { 
    background: var(--blue-100); 
    border-color: var(--blue-600); 
    color: var(--neutral-900); 
}

/* Modal */
.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.6);
    z-index: 1000;
    align-items: center;
    justify-content: center;
    padding: 20px;
    overflow-y: auto;
    backdrop-filter: blur(4px);
}

.modal.active { display: flex; }

.modal-content {
    background: white;
    border-radius: 16px;
    max-width: 1100px;
    width: 100%;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: var(--shadow-xl);
}

.modal-header {
    padding: 24px 28px;
    border-bottom: 1px solid var(--neutral-200);
    display: flex;
    justify-content: space-between;
    align-items: center;
    position: sticky;
    top: 0;
    background: white;
    z-index: 10;
}

.modal-header h2 { 
    color: var(--petro-green-800); 
    font-size: 22px; 
    font-weight: 800;
}

.modal-close {
    width: 36px;
    height: 36px;
    border: none;
    background: var(--neutral-100);
    border-radius: 8px;
    cursor: pointer;
    font-size: 20px;
    font-weight: 600;
    color: var(--neutral-600);
    transition: all 0.2s;
}

.modal-close:hover {
    background: var(--neutral-200);
    color: var(--neutral-900);
}

.modal-body { padding: 28px; }
.modal-footer { 
    padding: 20px 28px; 
    border-top: 1px solid var(--neutral-200); 
    display: flex; 
    gap: 12px; 
    justify-content: flex-end;
    position: sticky;
    bottom: 0;
    background: white;
}

/* Form */
.form-group { margin-bottom: 20px; }
.form-label { 
    display: block; 
    font-weight: 600; 
    margin-bottom: 8px; 
    font-size: 14px;
    color: var(--neutral-800);
}
.form-label.required::after { 
    content: '*'; 
    color: var(--red-600); 
    margin-left: 4px; 
}

.form-control {
    width: 100%;
    padding: 11px 14px;
    border: 1px solid var(--neutral-300);
    border-radius: 8px;
    font-family: 'Inter', sans-serif;
    font-size: 14px;
    transition: all 0.2s;
    background: white;
}

.form-control:focus { 
    outline: none; 
    border-color: var(--petro-green-600);
    box-shadow: 0 0 0 3px var(--petro-green-100);
}

/* Tables */
.data-table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    background: white;
    border-radius: 12px;
    overflow: hidden;
    border: 1px solid var(--neutral-200);
}

.data-table thead { 
    background: var(--neutral-50); 
}
.data-table th { 
    padding: 14px 16px; 
    text-align: left; 
    font-weight: 700; 
    font-size: 12px; 
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--neutral-700);
    border-bottom: 1px solid var(--neutral-200);
}
.data-table td { 
    padding: 16px; 
    border-bottom: 1px solid var(--neutral-100);
    font-size: 14px;
}
.data-table tbody tr { 
    cursor: pointer; 
    transition: background 0.15s; 
}
.data-table tbody tr:hover { 
    background: var(--neutral-50); 
}
.data-table tbody tr:last-child td {
    border-bottom: none;
}

/* Agent Panel */
.agent-panel {
    background: linear-gradient(135deg, #EFF6FF, #DBEAFE);
    border-left: 3px solid var(--blue-600);
    padding: 20px;
    border-radius: 10px;
    margin: 16px 0;
    border: 1px solid #BFDBFE;
}

/* Wizard */
.wizard-steps {
    display: flex;
    justify-content: space-between;
    margin-bottom: 32px;
    position: relative;
    padding: 0 40px;
}

.wizard-step {
    display: flex;
    flex-direction: column;
    align-items: center;
    flex: 1;
    position: relative;
    z-index: 1;
}

.wizard-step-circle {
    width: 44px;
    height: 44px;
    border-radius: 10px;
    background: white;
    border: 2px solid var(--neutral-300);
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 800;
    margin-bottom: 10px;
    transition: all 0.2s;
}

.wizard-step.active .wizard-step-circle { 
    background: var(--petro-green-800); 
    border-color: var(--petro-green-800); 
    color: white;
    box-shadow: 0 0 0 4px var(--petro-green-100);
}
.wizard-step.completed .wizard-step-circle { 
    background: var(--petro-gold-600); 
    border-color: var(--petro-gold-600); 
    color: white; 
}

.wizard-step-label {
    font-size: 13px;
    font-weight: 600;
    text-align: center;
    color: var(--neutral-600);
}

.wizard-step.active .wizard-step-label {
    color: var(--petro-green-800);
}

/* Section Header */
.section-header {
    background: linear-gradient(135deg, var(--petro-green-800), var(--petro-green-700));
    color: white;
    padding: 14px 20px;
    margin: 28px 0 20px 0;
    font-weight: 700;
    font-size: 15px;
    border-left: 4px solid var(--petro-orange-600);
    border-radius: 8px;
    box-shadow: var(--shadow-sm);
}

/* Portfolio Matrix */
.matrix-container {
    position: relative;
    background: linear-gradient(to bottom right, var(--neutral-50), white);
    padding: 60px;
    border-radius: 12px;
    border: 1px solid var(--neutral-200);
    min-height: 450px;
}

.matrix-dot {
    position: absolute;
    width: 16px;
    height: 16px;
    background: var(--petro-green-700);
    border-radius: 50%;
    border: 3px solid white;
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    cursor: pointer;
    transition: all 0.2s;
}

.matrix-dot:hover {
    transform: scale(1.3);
    box-shadow: 0 4px 12px rgba(0,0,0,0.25);
}

/* Grid */
.grid { display: grid; gap: 24px; }
.grid-2 { grid-template-columns: repeat(2, 1fr); }
.grid-3 { grid-template-columns: repeat(3, 1fr); }
.grid-4 { grid-template-columns: repeat(4, 1fr); }

@media (max-width: 1024px) {
    .grid-4 { grid-template-columns: repeat(2, 1fr); }
    .grid-3 { grid-template-columns: repeat(2, 1fr); }
}

@media (max-width: 640px) {
    .grid-4, .grid-3, .grid-2 { grid-template-columns: 1fr; }
}

/* Utilities */
.hidden { display: none !important; }
.mb-2 { margin-bottom: 8px; }
.mb-4 { margin-bottom: 16px; }
.mb-6 { margin-bottom: 24px; }
.mt-4 { margin-top: 16px; }
.text-center { text-align: center; }

footer {
    background: var(--neutral-900);
    color: white;
    padding: 32px;
    margin-top: 80px;
}

footer a {
    color: var(--petro-green-600);
    text-decoration: none;
}
`;

// ============================================================================
// PETROLUBE 35-CRITERIA TEMPLATE
// ============================================================================

const PETROLUBE_35_TEMPLATE = {
    id: 'template-petrolube-35',
    name: 'Petrolube Initiative Dossier - 35 Criteria V14',
    is_published: true,
    created_at: '2025-11-17T00:00:00Z',
    fields: [
        // SECTION 1: HEADER & IDENTIFICATION
        { id: '1', key: 'initiative_id', label: '1. Initiative ID', type: 'text', required: true, is_scoring: false, weight: 0, threshold: null, config: {}, category: 'header' },
        { id: '2', key: 'initiative_name', label: '2. Initiative Name', type: 'text', required: true, is_scoring: false, weight: 0, threshold: null, config: {}, category: 'header' },
        { 
            id: '3', 
            key: 'strategic_domain', 
            label: '3. Strategic Domain', 
            type: 'dropdown', 
            required: true, 
            is_scoring: false, 
            weight: 0, 
            threshold: null,
            category: 'header',
            config: { 
                options: [
                    { value: 'digital_transformation', label: 'Digital Transformation', points: 0 },
                    { value: 'international_expansion', label: 'International Expansion', points: 0 },
                    { value: 'sustainability_esg', label: 'Sustainability/ESG', points: 0 },
                    { value: 'core_business_excellence', label: 'Core Business Excellence', points: 0 },
                    { value: 'ev_bio_lubricants', label: 'EV/Bio-lubricants', points: 0 },
                    { value: 'innovation_new_products', label: 'Innovation & New Products', points: 0 }
                ]
            }
        },
        { 
            id: '4', 
            key: 'portfolio_category', 
            label: '4. Portfolio Category', 
            type: 'dropdown', 
            required: true, 
            is_scoring: false, 
            weight: 0, 
            threshold: null,
            category: 'header',
            config: { 
                options: [
                    { value: 'core_incremental', label: 'Core Incremental', points: 0 },
                    { value: 'core_disruptive', label: 'Core Disruptive', points: 0 },
                    { value: 'non_core_incremental', label: 'Non-Core Incremental', points: 0 },
                    { value: 'non_core_disruptive', label: 'Non-Core Disruptive', points: 0 }
                ]
            }
        },
        { 
            id: '5', 
            key: 'three_engines_alignment', 
            label: '5. Three Engines Alignment', 
            type: 'dropdown', 
            required: true, 
            is_scoring: false, 
            weight: 0, 
            threshold: null,
            category: 'header',
            config: { 
                options: [
                    { value: 'e1_sustain_grow', label: 'E1: Sustain & Grow Core (60%)', points: 0 },
                    { value: 'e2_expand_inorganically', label: 'E2: Expand Inorganically (25%)', points: 0 },
                    { value: 'e3_base_oil_integration', label: 'E3: Base Oil Vertical Integration (15%)', points: 0 }
                ]
            }
        },
        
        // SECTION 2: STRATEGIC POSITIONING
        { 
            id: '6', 
            key: 'quadrant', 
            label: '6. Quadrant', 
            type: 'dropdown', 
            required: true, 
            is_scoring: false, 
            weight: 0, 
            threshold: null,
            category: 'strategic',
            config: { 
                options: [
                    { value: 'quick_win', label: 'Quick-Win (0-12m)', points: 0 },
                    { value: 'push_harder', label: 'Push-Harder (6-18m)', points: 0 },
                    { value: 'transformational', label: 'Transformational (18-36m)', points: 0 },
                    { value: 'moonshot', label: 'Moonshot (36m+)', points: 0 }
                ]
            }
        },
        { 
            id: '7', 
            key: 'strategic_priority', 
            label: '7. Strategic Priority', 
            type: 'dropdown', 
            required: true, 
            is_scoring: true, 
            weight: 15, 
            threshold: null,
            category: 'strategic',
            config: { 
                options: [
                    { value: 'p1_critical', label: 'P1 Critical', points: 100 },
                    { value: 'p2_high', label: 'P2 High', points: 75 },
                    { value: 'p3_medium', label: 'P3 Medium', points: 50 },
                    { value: 'p4_low', label: 'P4 Low', points: 25 }
                ]
            }
        },
        { 
            id: '8', 
            key: 'year1_tier', 
            label: '8. Year 1 Tier Assignment', 
            type: 'dropdown', 
            required: true, 
            is_scoring: true, 
            weight: 10, 
            threshold: null,
            category: 'strategic',
            config: { 
                options: [
                    { value: 'tier_1a', label: 'Tier 1A: Catastrophic Dependency', points: 100 },
                    { value: 'tier_1b', label: 'Tier 1B: Oracle AI Quick Win', points: 90 },
                    { value: 'tier_1c', label: 'Tier 1C: Digital Quick Win', points: 85 },
                    { value: 'tier_1d', label: 'Tier 1D: Sustainability Quick Win', points: 80 },
                    { value: 'tier_2', label: 'Tier 2: Foundational Capability', points: 60 },
                    { value: 'deferred', label: 'Deferred: Year 2-5', points: 0 }
                ]
            }
        },
        { 
            id: '9', 
            key: 'aramco_response', 
            label: '9. Aramco Competitive Response Type', 
            type: 'dropdown', 
            required: true, 
            is_scoring: false, 
            weight: 0, 
            threshold: null,
            category: 'strategic',
            config: { 
                options: [
                    { value: 'offensive', label: 'Offensive: Preemptive market capture', points: 0 },
                    { value: 'defensive', label: 'Defensive: Market share protection', points: 0 },
                    { value: 'neutral', label: 'Neutral: Independent value creation', points: 0 }
                ]
            }
        },
        { id: '10', key: 'bcg_i2i_target', label: '10. BCG i2i Target Contribution (+points)', type: 'number', required: true, is_scoring: false, weight: 0, threshold: null, config: { min: 0, max: 50 }, category: 'strategic' },
        
        // SECTION 3: FRAMEWORK V4.0 SCORING
        { id: '11', key: 'strategic_impact_score', label: '11. Strategic Impact Score (0-25)', type: 'number', required: true, is_scoring: true, weight: 25, threshold: null, config: { min: 0, max: 25 }, category: 'scoring' },
        { id: '12', key: 'financial_impact_score', label: '12. Financial Impact Score (0-25)', type: 'number', required: true, is_scoring: true, weight: 25, threshold: null, config: { min: 0, max: 25 }, category: 'scoring' },
        { id: '13', key: 'execution_feasibility_score', label: '13. Execution Feasibility Score (0-20)', type: 'number', required: true, is_scoring: true, weight: 20, threshold: null, config: { min: 0, max: 20 }, category: 'scoring' },
        { id: '14', key: 'risk_management_score', label: '14. Risk Management Score (0-15)', type: 'number', required: true, is_scoring: false, weight: 0, threshold: null, config: { min: 0, max: 15 }, category: 'scoring' },
        { id: '15', key: 'innovation_index_score', label: '15. Innovation Index Score (0-15)', type: 'number', required: true, is_scoring: false, weight: 0, threshold: null, config: { min: 0, max: 15 }, category: 'scoring' },
        
        // SECTION 4: BUSINESS CASE
        { id: '17', key: 'investment_required', label: '17. Total Investment Required (SAR)', type: 'currency', required: true, is_scoring: false, weight: 0, threshold: null, config: { min: 0, max: 100000000 }, category: 'financial' },
        { id: '17b', key: 'year1_investment', label: '17b. Year 1 Investment (SAR)', type: 'currency', required: true, is_scoring: false, weight: 0, threshold: null, config: { min: 0, max: 50000000 }, category: 'financial' },
        { id: '18', key: 'timeline_months', label: '18. Total Timeline (Months)', type: 'number', required: true, is_scoring: false, weight: 0, threshold: null, config: { min: 1, max: 60 }, category: 'financial' },
        { id: '19', key: 'resource_fte', label: '19. Total FTE Required', type: 'number', required: true, is_scoring: false, weight: 0, threshold: null, config: { min: 0, max: 100 }, category: 'financial' },
        { id: '20', key: 'expected_roi_year3', label: '20. Expected ROI Year 3 (SAR)', type: 'currency', required: true, is_scoring: false, weight: 0, threshold: null, config: { min: 0, max: 100000000 }, category: 'financial' },
        { 
            id: '21', 
            key: 'irr_percentage', 
            label: '21. IRR - Internal Rate of Return (%)', 
            type: 'number', 
            required: true, 
            is_scoring: true, 
            weight: 5, 
            threshold: 15,
            config: { min: 0, max: 100 },
            category: 'financial'
        },
        { id: '22', key: 'payback_period', label: '22. Payback Period (Years)', type: 'number', required: true, is_scoring: false, weight: 0, threshold: null, config: { min: 0, max: 10 }, category: 'financial' },
        { id: '23', key: 'npv_5year', label: '23. NPV @ 12% WACC - 5 Year (SAR)', type: 'currency', required: true, is_scoring: false, weight: 0, threshold: null, config: { min: -50000000, max: 100000000 }, category: 'financial' },
        
        // SECTION 5: IMPLEMENTATION
        { id: '24', key: 'phase1_duration', label: '24. Phase 1 Duration (Months)', type: 'number', required: true, is_scoring: false, weight: 0, threshold: null, config: { min: 1, max: 24 }, category: 'implementation' },
        { id: '25', key: 'phase2_duration', label: '25. Phase 2 Duration (Months)', type: 'number', required: false, is_scoring: false, weight: 0, threshold: null, config: { min: 0, max: 24 }, category: 'implementation' },
        { id: '26', key: 'phase3_duration', label: '26. Phase 3 Duration (Months)', type: 'number', required: false, is_scoring: false, weight: 0, threshold: null, config: { min: 0, max: 24 }, category: 'implementation' },
        { id: '27', key: 'gate0_approved', label: '27. Gate 0 - Concept Approval', type: 'yesno', required: true, is_scoring: false, weight: 0, threshold: null, config: {}, category: 'implementation' },
        
        // SECTION 6: DEPENDENCIES
        { id: '28', key: 'critical_prerequisites_count', label: '28. Number of Critical Prerequisites', type: 'number', required: true, is_scoring: false, weight: 0, threshold: null, config: { min: 0, max: 20 }, category: 'dependencies' },
        { id: '29', key: 'technical_dependencies_count', label: '29. Number of Technical Dependencies', type: 'number', required: true, is_scoring: false, weight: 0, threshold: null, config: { min: 0, max: 20 }, category: 'dependencies' },
        { id: '30', key: 'organizational_dependencies_count', label: '30. Number of Organizational Dependencies', type: 'number', required: true, is_scoring: false, weight: 0, threshold: null, config: { min: 0, max: 20 }, category: 'dependencies' },
        
        // SECTION 7: RISK ASSESSMENT
        { 
            id: '31a', 
            key: 'risk1_severity', 
            label: '31a. Risk #1 Severity', 
            type: 'dropdown', 
            required: true, 
            is_scoring: false, 
            weight: 0, 
            threshold: null,
            category: 'risk',
            config: { 
                options: [
                    { value: 'critical', label: 'Critical', points: 0 },
                    { value: 'high', label: 'High', points: 0 },
                    { value: 'medium', label: 'Medium', points: 0 },
                    { value: 'low', label: 'Low', points: 0 }
                ]
            },
            killSwitch: {
                operator: '==',
                threshold: 'critical',
                message: 'Critical risk requires Risk Committee approval'
            }
        },
        { id: '32', key: 'upside_potential_sar', label: '32. Upside Opportunity Potential (SAR)', type: 'currency', required: false, is_scoring: false, weight: 0, threshold: null, config: { min: 0, max: 50000000 }, category: 'risk' },
        { id: '33', key: 'contingency_budget', label: '33. Contingency Budget (SAR)', type: 'currency', required: true, is_scoring: false, weight: 0, threshold: null, config: { min: 0, max: 20000000 }, category: 'risk' },
        
        // SECTION 8: SUCCESS METRICS
        { id: '34', key: 'roi_target_year1', label: '34. ROI Achievement Target Year 1 (%)', type: 'number', required: true, is_scoring: false, weight: 0, threshold: null, config: { min: 0, max: 200 }, category: 'metrics' },
        { 
            id: '35', 
            key: 'board_recommendation', 
            label: '35. Recommendation', 
            type: 'dropdown', 
            required: true, 
            is_scoring: false, 
            weight: 0, 
            threshold: null,
            category: 'metrics',
            config: { 
                options: [
                    { value: 'accelerate', label: 'ACCELERATE', points: 0 },
                    { value: 'keep', label: 'KEEP', points: 0 },
                    { value: 'keep_conditions', label: 'KEEP WITH CONDITIONS', points: 0 },
                    { value: 'defer', label: 'DEFER', points: 0 },
                    { value: 'remove', label: 'REMOVE', points: 0 }
                ]
            }
        }
    ]
};

// ============================================================================
// SAMPLE DATA - 7 REALISTIC PROJECTS
// ============================================================================

const SAMPLE_PROJECTS = [
    {
        id: 'proj-001',
        name: 'Oracle Redwood UX Migration',
        criteriaValues: {
            initiative_id: 'PET-2025-001',
            initiative_name: 'Oracle Redwood UX Migration',
            strategic_domain: 'digital_transformation',
            portfolio_category: 'core_incremental',
            three_engines_alignment: 'e1_sustain_grow',
            quadrant: 'quick_win',
            strategic_priority: 'p1_critical',
            year1_tier: 'tier_1a',
            aramco_response: 'defensive',
            bcg_i2i_target: 8,
            strategic_impact_score: 24,
            financial_impact_score: 23,
            execution_feasibility_score: 18,
            risk_management_score: 12,
            innovation_index_score: 13,
            investment_required: 12500000,
            year1_investment: 8500000,
            timeline_months: 14,
            resource_fte: 18,
            expected_roi_year3: 17550000,
            irr_percentage: 42,
            payback_period: 2.1,
            npv_5year: 24300000,
            phase1_duration: 6,
            phase2_duration: 5,
            phase3_duration: 3,
            gate0_approved: 'yes',
            critical_prerequisites_count: 3,
            technical_dependencies_count: 5,
            organizational_dependencies_count: 4,
            risk1_severity: 'high',
            upside_potential_sar: 5000000,
            contingency_budget: 1250000,
            roi_target_year1: 35,
            board_recommendation: 'accelerate'
        },
        status: 'Prioritized',
        scores: {},
        createdAt: '2024-12-01T00:00:00Z'
    },
    {
        id: 'proj-002',
        name: 'AI-Powered Predictive Maintenance Platform',
        criteriaValues: {
            initiative_id: 'PET-2025-002',
            initiative_name: 'AI-Powered Predictive Maintenance Platform',
            strategic_domain: 'digital_transformation',
            portfolio_category: 'core_disruptive',
            three_engines_alignment: 'e1_sustain_grow',
            quadrant: 'push_harder',
            strategic_priority: 'p1_critical',
            year1_tier: 'tier_1b',
            aramco_response: 'offensive',
            bcg_i2i_target: 12,
            strategic_impact_score: 25,
            financial_impact_score: 24,
            execution_feasibility_score: 15,
            risk_management_score: 10,
            innovation_index_score: 14,
            investment_required: 18000000,
            year1_investment: 9000000,
            timeline_months: 18,
            resource_fte: 22,
            expected_roi_year3: 32400000,
            irr_percentage: 48,
            payback_period: 1.8,
            npv_5year: 41200000,
            phase1_duration: 7,
            phase2_duration: 7,
            phase3_duration: 4,
            gate0_approved: 'yes',
            critical_prerequisites_count: 4,
            technical_dependencies_count: 8,
            organizational_dependencies_count: 5,
            risk1_severity: 'medium',
            upside_potential_sar: 12000000,
            contingency_budget: 1800000,
            roi_target_year1: 28,
            board_recommendation: 'accelerate'
        },
        status: 'Prioritized',
        scores: {},
        createdAt: '2024-11-28T00:00:00Z'
    },
    {
        id: 'proj-003',
        name: 'Morocco Manufacturing Facility Expansion',
        criteriaValues: {
            initiative_id: 'PET-2025-003',
            initiative_name: 'Morocco Manufacturing Facility Expansion',
            strategic_domain: 'international_expansion',
            portfolio_category: 'core_disruptive',
            three_engines_alignment: 'e2_expand_inorganically',
            quadrant: 'transformational',
            strategic_priority: 'p2_high',
            year1_tier: 'tier_2',
            aramco_response: 'offensive',
            bcg_i2i_target: 15,
            strategic_impact_score: 23,
            financial_impact_score: 22,
            execution_feasibility_score: 14,
            risk_management_score: 9,
            innovation_index_score: 11,
            investment_required: 45000000,
            year1_investment: 18000000,
            timeline_months: 30,
            resource_fte: 35,
            expected_roi_year3: 67500000,
            irr_percentage: 35,
            payback_period: 3.2,
            npv_5year: 78000000,
            phase1_duration: 10,
            phase2_duration: 12,
            phase3_duration: 8,
            gate0_approved: 'yes',
            critical_prerequisites_count: 7,
            technical_dependencies_count: 6,
            organizational_dependencies_count: 9,
            risk1_severity: 'high',
            upside_potential_sar: 20000000,
            contingency_budget: 4500000,
            roi_target_year1: 18,
            board_recommendation: 'keep'
        },
        status: 'Prioritized',
        scores: {},
        createdAt: '2024-11-20T00:00:00Z'
    },
    {
        id: 'proj-004',
        name: 'Customer Portal & Self-Service Platform',
        criteriaValues: {
            initiative_id: 'PET-2025-004',
            initiative_name: 'Customer Portal & Self-Service Platform',
            strategic_domain: 'digital_transformation',
            portfolio_category: 'core_incremental',
            three_engines_alignment: 'e1_sustain_grow',
            quadrant: 'quick_win',
            strategic_priority: 'p2_high',
            year1_tier: 'tier_1c',
            aramco_response: 'neutral',
            bcg_i2i_target: 6,
            strategic_impact_score: 20,
            financial_impact_score: 21,
            execution_feasibility_score: 17,
            risk_management_score: 13,
            innovation_index_score: 12,
            investment_required: 7500000,
            year1_investment: 5000000,
            timeline_months: 10,
            resource_fte: 14,
            expected_roi_year3: 11250000,
            irr_percentage: 38,
            payback_period: 2.3,
            npv_5year: 14800000,
            phase1_duration: 4,
            phase2_duration: 4,
            phase3_duration: 2,
            gate0_approved: 'yes',
            critical_prerequisites_count: 2,
            technical_dependencies_count: 4,
            organizational_dependencies_count: 3,
            risk1_severity: 'low',
            upside_potential_sar: 3500000,
            contingency_budget: 750000,
            roi_target_year1: 32,
            board_recommendation: 'keep'
        },
        status: 'Prioritized',
        scores: {},
        createdAt: '2024-12-05T00:00:00Z'
    },
    {
        id: 'proj-005',
        name: 'Bio-Lubricants R&D Initiative',
        criteriaValues: {
            initiative_id: 'PET-2025-005',
            initiative_name: 'Bio-Lubricants R&D Initiative',
            strategic_domain: 'ev_bio_lubricants',
            portfolio_category: 'non_core_disruptive',
            three_engines_alignment: 'e1_sustain_grow',
            quadrant: 'transformational',
            strategic_priority: 'p2_high',
            year1_tier: 'tier_1d',
            aramco_response: 'offensive',
            bcg_i2i_target: 10,
            strategic_impact_score: 22,
            financial_impact_score: 19,
            execution_feasibility_score: 13,
            risk_management_score: 11,
            innovation_index_score: 15,
            investment_required: 24000000,
            year1_investment: 12000000,
            timeline_months: 24,
            resource_fte: 28,
            expected_roi_year3: 31200000,
            irr_percentage: 29,
            payback_period: 3.5,
            npv_5year: 38500000,
            phase1_duration: 9,
            phase2_duration: 9,
            phase3_duration: 6,
            gate0_approved: 'yes',
            critical_prerequisites_count: 5,
            technical_dependencies_count: 7,
            organizational_dependencies_count: 6,
            risk1_severity: 'medium',
            upside_potential_sar: 18000000,
            contingency_budget: 2400000,
            roi_target_year1: 22,
            board_recommendation: 'keep'
        },
        status: 'Prioritized',
        scores: {},
        createdAt: '2024-11-25T00:00:00Z'
    },
    {
        id: 'proj-006',
        name: 'Supply Chain Blockchain Traceability',
        criteriaValues: {
            initiative_id: 'PET-2025-006',
            initiative_name: 'Supply Chain Blockchain Traceability',
            strategic_domain: 'innovation_new_products',
            portfolio_category: 'non_core_disruptive',
            three_engines_alignment: 'e1_sustain_grow',
            quadrant: 'moonshot',
            strategic_priority: 'p3_medium',
            year1_tier: 'deferred',
            aramco_response: 'neutral',
            bcg_i2i_target: 4,
            strategic_impact_score: 18,
            financial_impact_score: 16,
            execution_feasibility_score: 10,
            risk_management_score: 8,
            innovation_index_score: 14,
            investment_required: 32000000,
            year1_investment: 8000000,
            timeline_months: 36,
            resource_fte: 24,
            expected_roi_year3: 19200000,
            irr_percentage: 12,
            payback_period: 5.2,
            npv_5year: 18500000,
            phase1_duration: 12,
            phase2_duration: 14,
            phase3_duration: 10,
            gate0_approved: 'yes',
            critical_prerequisites_count: 8,
            technical_dependencies_count: 12,
            organizational_dependencies_count: 7,
            risk1_severity: 'critical',
            upside_potential_sar: 25000000,
            contingency_budget: 3200000,
            roi_target_year1: 8,
            board_recommendation: 'keep_conditions'
        },
        status: 'Blocked',
        scores: {},
        killSwitch: {
            triggered: true,
            fieldId: '31a',
            message: 'Critical risk requires Risk Committee approval'
        },
        createdAt: '2024-12-10T00:00:00Z'
    },
    {
        id: 'proj-007',
        name: 'ESG Reporting & Sustainability Dashboard',
        criteriaValues: {
            initiative_id: 'PET-2025-007',
            initiative_name: 'ESG Reporting & Sustainability Dashboard',
            strategic_domain: 'sustainability_esg',
            portfolio_category: 'core_incremental',
            three_engines_alignment: 'e1_sustain_grow',
            quadrant: 'quick_win',
            strategic_priority: 'p2_high',
            year1_tier: 'tier_1d',
            aramco_response: 'neutral',
            bcg_i2i_target: 7,
            strategic_impact_score: 21,
            financial_impact_score: 18,
            execution_feasibility_score: 16,
            risk_management_score: 12,
            innovation_index_score: 11,
            investment_required: 5500000,
            year1_investment: 4000000,
            timeline_months: 9,
            resource_fte: 12,
            expected_roi_year3: 7700000,
            irr_percentage: 32,
            payback_period: 2.6,
            npv_5year: 9800000,
            phase1_duration: 3,
            phase2_duration: 4,
            phase3_duration: 2,
            gate0_approved: 'yes',
            critical_prerequisites_count: 2,
            technical_dependencies_count: 3,
            organizational_dependencies_count: 4,
            risk1_severity: 'low',
            upside_potential_sar: 2000000,
            contingency_budget: 550000,
            roi_target_year1: 28,
            board_recommendation: 'keep'
        },
        status: 'Prioritized',
        scores: {},
        createdAt: '2024-12-03T00:00:00Z'
    }
];

// ============================================================================
// DATA STORE WITH SAMPLE DATA
// ============================================================================

const INITIAL_DATA = {
    templates: [PETROLUBE_35_TEMPLATE],
    projects: SAMPLE_PROJECTS,
    scenarios: [
        {
            id: 'scenario-quick-wins',
            name: 'Quick Wins (2025)',
            description: 'Fast ROI and low-risk projects'
        },
        {
            id: 'scenario-balanced',
            name: 'Balanced Portfolio',
            description: 'Balance short-term and long-term'
        },
        {
            id: 'scenario-transformation',
            name: 'Strategic Transformation (2025-2030)',
            description: 'Long-term strategic bets'
        }
    ],
    adminSettings: {
        companyProfile: {
            companyName: 'Petrolube',
            companyFullName: 'Petrolube Company',
            industry: 'Lubricants & Petroleum Products',
            headquarters: 'Riyadh, Saudi Arabia',
            founded: '1985',
            employees: '500+',
            description: 'Leading lubricants manufacturer in the Middle East',
            vision: 'To be the most trusted lubricants brand in the region',
            mission: 'Delivering premium quality lubricants that exceed customer expectations'
        },
        coCompanies: [
            {
                id: 'co-1',
                name: 'Petrolube Distribution',
                relationship: 'Subsidiary',
                country: 'Saudi Arabia',
                description: 'Distribution and logistics arm'
            },
            {
                id: 'co-2',
                name: 'Petrolube International',
                relationship: 'Subsidiary',
                country: 'UAE',
                description: 'International operations division'
            }
        ],
        businessInfo: {
            taxId: 'SAT-300123456789',
            registrationNumber: 'CR-1234567890',
            fiscalYearStart: 'January',
            currency: 'SAR',
            timezone: 'Asia/Riyadh',
            website: 'www.petrolube.com',
            contactEmail: 'info@petrolube.com',
            contactPhone: '+966 11 234 5678'
        },
        documents: [
            {
                id: 'doc-1',
                name: '2025-2030 Strategic Plan.pdf',
                type: 'Strategy',
                uploadedBy: 'Ghadah (CITO)',
                uploadedAt: '2024-11-15T10:30:00Z',
                size: '2.4 MB',
                description: 'Five-year strategic roadmap'
            },
            {
                id: 'doc-2',
                name: 'BCG Innovation Framework.pdf',
                type: 'Framework',
                uploadedBy: 'Ghadah (CITO)',
                uploadedAt: '2024-11-10T14:20:00Z',
                size: '1.8 MB',
                description: 'BCG i2i methodology guidelines'
            }
        ]
    },
    auditEvents: []
};

class DataStore {
    constructor() {
        this.loadData();
    }

    loadData() {
        const stored = localStorage.getItem('petrolubeEnterpriseData');
        if (stored) {
            this.data = JSON.parse(stored);
        } else {
            this.data = JSON.parse(JSON.stringify(INITIAL_DATA));
            // Score all sample projects
            const template = this.data.templates[0];
            this.data.projects.forEach(project => {
                if (project.status !== 'Blocked') {
                    ScoringEngine.scoreProject(project, template);
                }
            });
            // Prioritize
            ScoringEngine.prioritizeProjects(this.data.projects, template);
            this.saveData();
        }
    }

    saveData() {
        localStorage.setItem('petrolubeEnterpriseData', JSON.stringify(this.data));
    }

    getData() {
        return this.data;
    }

    addAuditEvent(event) {
        this.data.auditEvents.unshift({
            id: 'evt-' + Date.now(),
            timestamp: new Date().toISOString(),
            ...event
        });
        if (this.data.auditEvents.length > 50) {
            this.data.auditEvents = this.data.auditEvents.slice(0, 50);
        }
        this.saveData();
    }

    saveTemplate(template) {
        const existingIndex = this.data.templates.findIndex(t => t.id === template.id);

        if (existingIndex >= 0) {
            // Update existing template
            this.data.templates[existingIndex] = template;
            this.addAuditEvent({
                type: 'template_updated',
                user: state.currentUserName,
                description: `Updated template: ${template.name}`
            });
        } else {
            // Add new template
            this.data.templates.push(template);
            this.addAuditEvent({
                type: 'template_created',
                user: state.currentUserName,
                description: `Created template: ${template.name}`
            });
        }

        this.saveData();
    }

    deleteTemplate(templateId) {
        this.data.templates = this.data.templates.filter(t => t.id !== templateId);
        this.addAuditEvent({
            type: 'template_deleted',
            user: state.currentUserName,
            description: `Deleted template ID: ${templateId}`
        });
        this.saveData();
    }
}

// ============================================================================
// SCORING ENGINE
// ============================================================================

class ScoringEngine {
    static calculateCriterionScore(value, field) {
        if (field.type === 'dropdown') {
            const option = field.config.options.find(opt => opt.value === value);
            return option ? option.points : 0;
        } else if (field.type === 'currency' || field.type === 'number') {
            if (field.threshold !== null && field.threshold !== undefined && field.threshold !== '') {
                return value >= field.threshold ? 100 : 0;
            } else {
                const min = field.config.min || 0;
                const max = field.config.max || 100;
                const points = ((value - min) / (max - min)) * 100;
                return Math.max(0, Math.min(100, points));
            }
        } else if (field.type === 'yesno') {
            return value === 'yes' ? 100 : 0;
        }
        return 0;
    }

    static checkKillSwitch(project, template) {
        for (const field of template.fields) {
            if (!field.killSwitch) continue;
            const value = project.criteriaValues[field.key];
            if (value === undefined) continue;

            const { operator, threshold, message } = field.killSwitch;
            let triggered = false;

            if (operator === '<' && parseFloat(value) < threshold) triggered = true;
            if (operator === '==' && value === threshold) triggered = true;

            if (triggered) {
                return {
                    triggered: true,
                    fieldId: field.id,
                    message: message
                };
            }
        }
        return null;
    }

    static scoreProject(project, template) {
        // Check kill switches first
        const killSwitch = this.checkKillSwitch(project, template);
        if (killSwitch) {
            project.killSwitch = killSwitch;
            project.status = 'Blocked';
            return null;
        }

        const scoringFields = template.fields.filter(f => f.is_scoring);
        let totalContribution = 0;
        const breakdown = [];

        scoringFields.forEach(field => {
            let points = 0;
            const value = project.criteriaValues[field.key];
            
            points = this.calculateCriterionScore(value, field);
            const contribution = (points * field.weight) / 100;
            totalContribution += contribution;

            breakdown.push({
                field_key: field.key,
                field_label: field.label,
                raw_value: value,
                points,
                weight: field.weight,
                contribution
            });
        });

        const compositeScore = Math.round(totalContribution * 10) / 10;

        project.scores = {
            compositeScore,
            breakdown,
            scoredAt: new Date().toISOString()
        };

        project.status = 'Scored';
        return project.scores;
    }

    static prioritizeProjects(projects, template) {
        // Score all eligible projects
        for (const project of projects) {
            if (project.status !== 'Blocked' && project.status !== 'Draft') {
                this.scoreProject(project, template);
            }
        }

        // Get eligible projects
        const eligible = projects.filter(p => 
            p.scores && p.status !== 'Blocked'
        );

        // Sort by score
        eligible.sort((a, b) => 
            b.scores.compositeScore - a.scores.compositeScore
        );

        // Assign ranks
        eligible.forEach((project, index) => {
            project.scores.rank = index + 1;
            project.status = 'Prioritized';
        });

        return {
            rankedProjects: eligible,
            blockedCount: projects.filter(p => p.status === 'Blocked').length
        };
    }
}

// ============================================================================
// AI AUTO-FILL AGENT
// ============================================================================

class AIAgent {
    static analyzeDescription(description) {
        const lowerDesc = description.toLowerCase();
        
        const signals = {
            isDigital: /digital|cloud|ai|automation|software|platform|oracle|sap|erp/i.test(description),
            isInternational: /international|expansion|morocco|africa|export|global/i.test(description),
            isSustainability: /sustainability|esg|environment|green|carbon|bio/i.test(description),
            isCritical: /critical|urgent|catastrophic|blocking|dependency/i.test(description),
            isHighValue: /million|strategic|transform|competitive|market share/i.test(description),
            isQuickWin: /quick|fast|rapid|immediate|short-term/i.test(description),
            isTransformational: /transform|revolutionize|game-changer|fundamental/i.test(description),
        };
        
        const generated = {};
        
        const idMatch = description.match(/PET-\d+/i);
        generated.initiative_id = idMatch ? idMatch[0].toUpperCase() : `PET-2025-${String(Math.floor(Math.random() * 900) + 100).padStart(3, '0')}`;
        
        const sentences = description.split(/[.!?]/);
        generated.initiative_name = sentences[0].trim().slice(0, 80);
        
        if (signals.isDigital) generated.strategic_domain = 'digital_transformation';
        else if (signals.isInternational) generated.strategic_domain = 'international_expansion';
        else if (signals.isSustainability) generated.strategic_domain = 'sustainability_esg';
        else generated.strategic_domain = 'core_business_excellence';
        
        generated.portfolio_category = signals.isTransformational ? 'core_disruptive' : 'core_incremental';
        generated.three_engines_alignment = signals.isInternational ? 'e2_expand_inorganically' : 'e1_sustain_grow';
        generated.quadrant = signals.isQuickWin ? 'quick_win' : signals.isTransformational ? 'transformational' : 'push_harder';
        generated.strategic_priority = signals.isCritical ? 'p1_critical' : signals.isHighValue ? 'p2_high' : 'p3_medium';
        
        if (signals.isCritical && signals.isDigital) generated.year1_tier = 'tier_1a';
        else if (signals.isQuickWin && signals.isDigital) generated.year1_tier = 'tier_1b';
        else if (signals.isQuickWin) generated.year1_tier = 'tier_1c';
        else generated.year1_tier = 'tier_2';
        
        generated.aramco_response = /aramco|compet/i.test(description) ? 'defensive' : 'neutral';
        generated.bcg_i2i_target = signals.isTransformational ? 12 : signals.isHighValue ? 8 : 5;
        generated.strategic_impact_score = signals.isCritical ? 23 : signals.isHighValue ? 20 : 18;
        generated.financial_impact_score = signals.isHighValue ? 22 : 19;
        generated.execution_feasibility_score = signals.isQuickWin ? 18 : signals.isTransformational ? 12 : 15;
        generated.risk_management_score = 11;
        generated.innovation_index_score = signals.isDigital ? 13 : 10;
        
        const investmentMatch = description.match(/(\d+(?:\.\d+)?)\s*(?:million|m)/i);
        if (investmentMatch) {
            generated.investment_required = parseFloat(investmentMatch[1]) * 1000000;
            generated.year1_investment = generated.investment_required * 0.6;
        } else {
            generated.investment_required = signals.isTransformational ? 15000000 : signals.isHighValue ? 10000000 : 5000000;
            generated.year1_investment = generated.investment_required * 0.6;
        }
        
        const timelineMatch = description.match(/(\d+)\s*month/i);
        generated.timeline_months = timelineMatch ? parseInt(timelineMatch[1]) : signals.isQuickWin ? 8 : signals.isTransformational ? 24 : 12;
        generated.resource_fte = Math.ceil(generated.timeline_months * 1.5);
        generated.expected_roi_year3 = generated.investment_required * (signals.isHighValue ? 1.8 : 1.4);
        generated.irr_percentage = signals.isHighValue ? 38 : 25;
        generated.payback_period = signals.isQuickWin ? 1.5 : signals.isHighValue ? 2.2 : 3.0;
        generated.npv_5year = generated.investment_required * (signals.isHighValue ? 2.2 : 1.6);
        generated.phase1_duration = Math.ceil(generated.timeline_months * 0.4);
        generated.phase2_duration = Math.ceil(generated.timeline_months * 0.35);
        generated.phase3_duration = Math.ceil(generated.timeline_months * 0.25);
        generated.gate0_approved = 'yes';
        generated.critical_prerequisites_count = signals.isCritical ? 5 : 3;
        generated.technical_dependencies_count = signals.isDigital ? 6 : 4;
        generated.organizational_dependencies_count = signals.isTransformational ? 7 : 4;
        generated.risk1_severity = signals.isCritical ? 'high' : 'medium';
        generated.upside_potential_sar = generated.investment_required * 0.3;
        generated.contingency_budget = generated.investment_required * 0.1;
        generated.roi_target_year1 = signals.isQuickWin ? 40 : 25;
        generated.board_recommendation = signals.isCritical ? 'accelerate' : signals.isHighValue ? 'keep' : 'keep_conditions';
        
        return generated;
    }
}

// ============================================================================
// APP STATE
// ============================================================================

const state = {
    currentPage: 'landing',
    currentTenant: 'petrolube',
    currentRole: 'pmo',
    currentUserName: 'Ghadah (CITO)',
    wizardStep: 1,
    wizardData: { criteriaValues: {} },
    showDescriptionBox: true,
    store: new DataStore(),
    // Template Builder State
    templateBuilderMode: null, // null, 'create', 'edit'
    editingTemplate: null,
    showFieldEditor: false,
    editingField: null,
    editingFieldIndex: null,
    // Admin State
    adminEditMode: null, // null, 'profile', 'business', 'company'
    editingCompany: null
};

// ============================================================================
// RENDER ENGINE
// ============================================================================

function render() {
    const root = document.getElementById('app-root');
    root.innerHTML = `
        <style>${STYLES}</style>
        ${state.currentPage === 'landing' ? renderLanding() : ''}
        ${state.currentPage !== 'landing' ? renderHeader() : ''}
        ${state.currentPage !== 'landing' ? renderPage() : ''}
        ${state.currentPage !== 'landing' ? renderFooter() : ''}
        ${renderModals()}
    `;
}

function renderLanding() {
    return `
        <div style="background: linear-gradient(135deg, var(--petro-green-900), var(--petro-green-800), var(--neutral-900)); min-height: 100vh; padding: 80px 24px; color: white;">
            <div class="container">
                <div class="text-center" style="margin-bottom: 64px;">
                    <div style="display: inline-flex; align-items: center; justify-content: center; width: 80px; height: 80px; background: rgba(255,255,255,0.15); border-radius: 20px; margin-bottom: 24px; backdrop-filter: blur(10px);">
                        <div style="font-size: 40px; font-weight: 800;">P</div>
                    </div>
                    <h1 style="font-size: 56px; margin-bottom: 16px; font-weight: 900; letter-spacing: -0.03em;">PETROLUBE</h1>
                    <p style="font-size: 24px; color: var(--petro-gold-500); font-weight: 700; margin-bottom: 12px;">Enterprise Initiative Management</p>
                    <p style="color: rgba(255,255,255,0.8); font-size: 16px; max-width: 600px; margin: 0 auto;">35-Criteria Framework  AI-Powered Analysis  Strategic Portfolio Optimization</p>
                </div>

                <div class="grid grid-4 mb-6">
                    ${[
                        { icon: '', title: 'AI Auto-Fill', desc: 'Intelligent data population' },
                        { icon: '', title: '35 Criteria', desc: 'Comprehensive evaluation' },
                        { icon: '', title: 'Smart Scoring', desc: 'Weighted prioritization' },
                        { icon: '', title: 'Live Data', desc: '7 sample projects ready' }
                    ].map(item => `
                        <div style="background: rgba(255,255,255,0.1); padding: 28px; border-radius: 16px; text-align: center; backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2);">
                            <div style="font-size: 48px; margin-bottom: 16px;">${item.icon}</div>
                            <h3 style="font-size: 18px; font-weight: 700; margin-bottom: 8px;">${item.title}</h3>
                            <p style="font-size: 14px; color: rgba(255,255,255,0.7);">${item.desc}</p>
                        </div>
                    `).join('')}
                </div>

                <div style="background: white; border-radius: 20px; padding: 48px; max-width: 900px; margin: 0 auto; box-shadow: 0 20px 60px rgba(0,0,0,0.4);">
                    <h2 style="color: var(--petro-green-800); margin-bottom: 32px; font-size: 26px; font-weight: 800;">Access System</h2>
                    
                    <div style="margin-bottom: 36px;">
                        <p style="font-weight: 700; margin-bottom: 16px; text-transform: uppercase; font-size: 13px; color: var(--neutral-600); letter-spacing: 0.05em;">Organization</p>
                        <div class="grid grid-2" style="gap: 16px;">
                            ${[
                                { id: 'petrolube', name: 'PETROLUBE', desc: 'Primary Instance' },
                                { id: 'acme', name: 'ACME Industries', desc: 'Multi-Tenant Demo' }
                            ].map(tenant => `
                                <div onclick="selectTenant('${tenant.id}')" style="padding: 24px; border: 2px solid ${state.currentTenant === tenant.id ? 'var(--petro-green-700)' : 'var(--neutral-200)'}; border-radius: 12px; cursor: pointer; text-align: center; background: ${state.currentTenant === tenant.id ? 'var(--petro-green-50)' : 'white'}; transition: all 0.2s;">
                                    <div style="font-size: 40px; font-weight: 800; margin-bottom: 12px; color: var(--petro-green-800);">${tenant.name[0]}</div>
                                    <h3 style="font-weight: 700; margin-bottom: 4px; color: var(--neutral-900);">${tenant.name}</h3>
                                    <p style="font-size: 13px; color: var(--neutral-600);">${tenant.desc}</p>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <div>
                        <p style="font-weight: 700; margin-bottom: 16px; text-transform: uppercase; font-size: 13px; color: var(--neutral-600); letter-spacing: 0.05em;">Select Role</p>
                        ${[
                            { id: 'pmo', name: 'PMO / Innovation Office', user: 'Ghadah (CITO)', desc: 'Full system access' },
                            { id: 'executive', name: 'Executive Leadership', user: 'Ahmed Al-Rashid (CEO)', desc: 'Strategic overview' },
                            { id: 'analyst', name: 'Portfolio Analyst', user: 'Sara Al-Otaibi', desc: 'Analysis & modeling' },
                            { id: 'dept', name: 'Department Lead', user: 'Khalid Al-Fahad', desc: 'Department initiatives' }
                        ].map(role => `
                            <div onclick="selectRole('${role.id}', '${role.user}')" style="padding: 18px 20px; border: 2px solid ${state.currentRole === role.id ? 'var(--petro-green-700)' : 'var(--neutral-200)'}; border-radius: 10px; margin-bottom: 12px; cursor: pointer; background: ${state.currentRole === role.id ? 'var(--petro-green-50)' : 'white'}; transition: all 0.2s;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <strong style="font-weight: 700; color: var(--neutral-900);">${role.name}</strong>
                                        <p style="font-size: 13px; color: var(--neutral-600); margin-top: 4px;">${role.desc}</p>
                                    </div>
                                    ${state.currentRole === role.id ? '<div style="width: 20px; height: 20px; background: var(--petro-green-700); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 12px;"></div>' : ''}
                                </div>
                            </div>
                        `).join('')}
                    </div>

                    <button class="btn btn-gold btn-block btn-lg" style="margin-top: 32px; font-size: 16px;" onclick="continueToDashboard()">
                        Continue to Dashboard 
                    </button>
                </div>
            </div>
        </div>
    `;
}

function renderHeader() {
    return `
        <header>
            <div class="header-content container">
                <div class="logo-section" onclick="navigateTo('dashboard')">
                    <div class="logo">P</div>
                    <div class="logo-text">
                        <h1>PETROLUBE</h1>
                        <p>Enterprise Initiative Management</p>
                    </div>
                </div>
                <nav>
                    ${['dashboard', 'projects', 'templates', 'scenarios', 'insights', 'admin'].map(page => `
                        <a class="nav-link ${state.currentPage === page ? 'active' : ''}" onclick="navigateTo('${page}')">
                            ${page.charAt(0).toUpperCase() + page.slice(1)}
                        </a>
                    `).join('')}
                </nav>
                <div class="user-info">
                    <div class="user-badge">
                        <span style="font-weight: 700;">${state.currentUserName}</span>
                        <span style="color: var(--petro-green-800); margin-left: 8px; font-weight: 700;">${state.currentRole.toUpperCase()}</span>
                    </div>
                    <button class="btn btn-secondary btn-sm" onclick="logout()">Logout</button>
                </div>
            </div>
        </header>
    `;
}

function renderFooter() {
    return `
        <footer>
            <div class="container" style="display: flex; justify-content: space-between; align-items: center;">
                <div style="font-size: 14px;">
                    <span style="color: var(--petro-gold-500); font-weight: 700;">CONFIDENTIAL</span> 
                    <span style="opacity: 0.7; margin: 0 8px;"></span>
                    Petrolube Internal Use Only
                </div>
                <div style="font-size: 13px; opacity: 0.7;"> 2024 PETROLUBE. Enterprise System v2.5</div>
            </div>
        </footer>
    `;
}

function renderPage() {
    const pages = {
        'dashboard': renderDashboard,
        'projects': renderProjects,
        'templates': renderTemplates,
        'scenarios': renderScenarios,
        'insights': renderInsights,
        'admin': renderAdmin
    };

    const renderFn = pages[state.currentPage];
    return renderFn ? renderFn() : '<div class="container">Page not found</div>';
}

function renderDashboard() {
    const data = state.store.getData();
    const template = data.templates[0];
    const scored = data.projects.filter(p => p.scores && p.scores.compositeScore);
    const avgScore = scored.length > 0 
        ? scored.reduce((sum, p) => sum + p.scores.compositeScore, 0) / scored.length
        : 0;
    const totalBudget = data.projects.reduce((sum, p) => sum + (p.criteriaValues?.investment_required || 0), 0);
    const blocked = data.projects.filter(p => p.status === 'Blocked').length;

    return `
        <div class="container" style="padding: 40px 32px;">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 40px;">
                <div>
                    <h1 style="font-size: 32px; margin-bottom: 8px; font-weight: 800;">Portfolio Dashboard</h1>
                    <p style="color: var(--neutral-600); font-size: 15px;">Real-time initiative analytics and portfolio health monitoring</p>
                </div>
                <button class="btn btn-gold" onclick="openProjectWizard()">
                    <span></span> New Initiative
                </button>
            </div>

            <div class="grid grid-4 mb-6">
                <div class="stat-card">
                    <div class="stat-card-header">Total Initiatives</div>
                    <div class="stat-card-value" style="color: var(--petro-green-800);">${data.projects.length}</div>
                    <div class="stat-card-footer">${scored.length} scored, ${blocked} blocked</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-header">Avg Score</div>
                    <div class="stat-card-value" style="color: var(--petro-gold-600);">${avgScore.toFixed(1)}</div>
                    <div class="stat-card-footer">out of 100 points</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-header">Total Investment</div>
                    <div class="stat-card-value" style="color: var(--blue-600);">${(totalBudget / 1000000).toFixed(0)}M</div>
                    <div class="stat-card-footer">SAR committed</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-header">High Priority</div>
                    <div class="stat-card-value" style="color: ${blocked > 0 ? 'var(--red-600)' : 'var(--petro-green-700)'};">${data.projects.filter(p => p.criteriaValues?.strategic_priority === 'p1_critical').length}</div>
                    <div class="stat-card-footer">P1 Critical initiatives</div>
                </div>
            </div>

            ${blocked > 0 ? `
                <div class="alert alert-danger mb-6">
                    <div style="font-size: 20px;"></div>
                    <div>
                        <strong style="font-weight: 700;">Attention Required</strong><br>
                        <span style="font-size: 14px;">${blocked} initiative(s) blocked by kill-switch rules. Review required before proceeding.</span>
                    </div>
                </div>
            ` : ''}

            <div class="grid grid-3 mb-6" style="gap: 24px; grid-template-columns: 2fr 1fr;">
                <div class="card">
                    <h2 style="font-size: 20px; font-weight: 800; margin-bottom: 24px; color: var(--neutral-900);">Portfolio Impact Matrix</h2>
                    ${renderPortfolioMatrix()}
                </div>
                <div class="card">
                    <h2 style="font-size: 20px; font-weight: 800; margin-bottom: 20px; color: var(--neutral-900);">Quick Actions</h2>
                    <div style="display: flex; flex-direction: column; gap: 12px;">
                        <button class="btn btn-primary btn-block" onclick="runPrioritization()">
                            <span></span> Run Prioritization
                        </button>
                        <button class="btn btn-secondary btn-block" onclick="navigateTo('projects')">
                            <span></span> View All Projects
                        </button>
                        <button class="btn btn-secondary btn-block" onclick="navigateTo('scenarios')">
                            <span></span> Manage Scenarios
                        </button>
                        <button class="btn btn-secondary btn-block" onclick="navigateTo('insights')">
                            <span></span> View Insights
                        </button>
                    </div>
                </div>
            </div>

            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                    <h2 style="font-size: 20px; font-weight: 800; color: var(--neutral-900);">Top Ranked Initiatives</h2>
                    <a onclick="navigateTo('projects')" style="color: var(--petro-green-700); font-weight: 600; cursor: pointer; font-size: 14px; text-decoration: none;">View All </a>
                </div>
                ${renderProjectsTable(true)}
            </div>
        </div>
    `;
}

function renderPortfolioMatrix() {
    const data = state.store.getData();
    const scored = data.projects.filter(p => p.scores && p.scores.compositeScore);
    
    let html = `
        <div class="matrix-container">
            <div style="position: absolute; top: 16px; left: 50%; transform: translateX(-50%); font-size: 12px; font-weight: 700; color: var(--neutral-600); text-transform: uppercase; letter-spacing: 0.05em;">High Impact</div>
            <div style="position: absolute; bottom: 16px; left: 50%; transform: translateX(-50%); font-size: 12px; font-weight: 700; color: var(--neutral-600); text-transform: uppercase; letter-spacing: 0.05em;">Low Impact</div>
            <div style="position: absolute; left: 16px; top: 50%; transform: translateY(-50%) rotate(-90deg); font-size: 12px; font-weight: 700; color: var(--neutral-600); text-transform: uppercase; letter-spacing: 0.05em;">Low Feasibility</div>
            <div style="position: absolute; right: 16px; top: 50%; transform: translateY(-50%) rotate(-90deg); font-size: 12px; font-weight: 700; color: var(--neutral-600); text-transform: uppercase; letter-spacing: 0.05em;">High Feasibility</div>
    `;
    
    scored.forEach(p => {
        const alignment = p.criteriaValues?.strategic_impact_score || 50;
        const feasibility = p.criteriaValues?.execution_feasibility_score || 50;
        const x = (feasibility / 20) * 85 + 5;
        const y = 95 - ((alignment / 25) * 85 + 5);
        
        html += `<div class="matrix-dot" style="left: ${x}%; top: ${y}%;" onclick="viewProject('${p.id}')" title="${p.criteriaValues?.initiative_name || p.name} (Score: ${p.scores.compositeScore})"></div>`;
    });
    
    return html + '</div>';
}

function renderProjectsTable(topOnly = false) {
    const data = state.store.getData();
    let projects = data.projects
        .filter(p => p.scores && p.scores.compositeScore)
        .sort((a, b) => (a.scores.rank || 999) - (b.scores.rank || 999));
    
    if (topOnly) projects = projects.slice(0, 5);
    
    if (projects.length === 0) {
        return `
            <div style="text-align: center; padding: 60px 20px; color: var(--neutral-500);">
                <div style="font-size: 48px; margin-bottom: 16px;"></div>
                <p style="font-size: 16px; font-weight: 600; margin-bottom: 8px;">No Scored Initiatives</p>
                <p style="font-size: 14px;">Create and score initiatives to see them here.</p>
            </div>
        `;
    }
    
    return `
        <table class="data-table">
            <thead>
                <tr>
                    <th style="width: 80px;">Rank</th>
                    <th>Initiative Name</th>
                    <th>Domain</th>
                    <th style="width: 100px;">Score</th>
                    <th style="width: 120px;">Priority</th>
                    <th style="width: 140px;">Investment</th>
                </tr>
            </thead>
            <tbody>
                ${projects.map(p => {
                    const rank = p.scores.rank;
                    const rankClass = rank === 1 ? 'rank-1' : rank === 2 ? 'rank-2' : rank === 3 ? 'rank-3' : 'rank-default';
                    
                    return `
                        <tr onclick="viewProject('${p.id}')">
                            <td><div class="rank-badge ${rankClass}">${rank}</div></td>
                            <td>
                                <div style="font-weight: 700; color: var(--neutral-900); margin-bottom: 4px;">${p.criteriaValues?.initiative_name || p.name}</div>
                                <div style="font-size: 12px; color: var(--neutral-500); font-family: 'JetBrains Mono', monospace;">${p.criteriaValues?.initiative_id}</div>
                            </td>
                            <td>
                                <span class="badge badge-gray">${(p.criteriaValues?.strategic_domain || '').replace(/_/g, ' ')}</span>
                            </td>
                            <td>
                                <div style="font-size: 20px; font-weight: 800; color: var(--petro-orange-600);">${p.scores.compositeScore.toFixed(1)}</div>
                            </td>
                            <td>
                                <span class="badge ${
                                    p.criteriaValues?.strategic_priority === 'p1_critical' ? 'badge-red' :
                                    p.criteriaValues?.strategic_priority === 'p2_high' ? 'badge-orange' :
                                    p.criteriaValues?.strategic_priority === 'p3_medium' ? 'badge-yellow' : 'badge-gray'
                                }">${(p.criteriaValues?.strategic_priority || '').replace(/_/g, ' ').toUpperCase()}</span>
                            </td>
                            <td>
                                <div style="font-weight: 700; color: var(--neutral-900);">${p.criteriaValues?.investment_required ? (p.criteriaValues.investment_required / 1000000).toFixed(1) + 'M SAR' : ''}</div>
                            </td>
                        </tr>
                    `;
                }).join('')}
            </tbody>
        </table>
    `;
}

function renderProjects() {
    const data = state.store.getData();
    const scored = data.projects.filter(p => p.scores && Object.keys(p.scores).length > 0).length;
    const blocked = data.projects.filter(p => p.status === 'Blocked').length;
    const drafts = data.projects.filter(p => p.status === 'Draft').length;

    return `
        <div class="container" style="padding: 40px 32px;">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 32px;">
                <div>
                    <h1 style="font-size: 32px; margin-bottom: 8px; font-weight: 800;">Initiative Portfolio</h1>
                    <p style="color: var(--neutral-600); font-size: 15px;">${data.projects.length} total initiatives across all stages</p>
                </div>
                <button class="btn btn-gold" onclick="openProjectWizard()">
                    <span></span> New Initiative
                </button>
            </div>

            <div class="grid grid-4 mb-6">
                <div class="stat-card">
                    <div class="stat-card-header">Total</div>
                    <div class="stat-card-value" style="color: var(--petro-green-800);">${data.projects.length}</div>
                    <div class="stat-card-footer">All initiatives</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-header">Scored</div>
                    <div class="stat-card-value" style="color: var(--blue-600);">${scored}</div>
                    <div class="stat-card-footer">Ready for review</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-header">Blocked</div>
                    <div class="stat-card-value" style="color: var(--red-600);">${blocked}</div>
                    <div class="stat-card-footer">Requires action</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-header">Drafts</div>
                    <div class="stat-card-value" style="color: var(--neutral-500);">${drafts}</div>
                    <div class="stat-card-footer">In progress</div>
                </div>
            </div>

            ${blocked > 0 ? `
                <div class="alert alert-danger mb-6">
                    <div style="font-size: 20px;"></div>
                    <div>
                        <strong style="font-weight: 700;">Kill-Switch Triggered</strong><br>
                        <span style="font-size: 14px;">${blocked} initiative(s) blocked. Critical risk assessment required before proceeding.</span>
                    </div>
                </div>
            ` : ''}

            <div class="card">
                ${renderProjectsTable(false)}
            </div>
        </div>
    `;
}

// ============================================================================
// ADMIN FUNCTIONS
// ============================================================================

function updateCompanyProfile(field, value) {
    const data = state.store.getData();
    data.adminSettings.companyProfile[field] = value;
    state.store.saveData();
    state.store.addAuditEvent({
        type: 'admin_profile_updated',
        user: state.currentUserName,
        description: `Updated company ${field}`
    });
}

function updateBusinessInfo(field, value) {
    const data = state.store.getData();
    data.adminSettings.businessInfo[field] = value;
    state.store.saveData();
    state.store.addAuditEvent({
        type: 'admin_business_updated',
        user: state.currentUserName,
        description: `Updated business ${field}`
    });
}

function startAddCoCompany() {
    state.editingCompany = {
        id: 'co-' + Date.now(),
        name: '',
        relationship: 'Subsidiary',
        country: '',
        description: ''
    };
    state.adminEditMode = 'company';
    render();
}

function startEditCoCompany(companyId) {
    const data = state.store.getData();
    const company = data.adminSettings.coCompanies.find(c => c.id === companyId);
    if (company) {
        state.editingCompany = JSON.parse(JSON.stringify(company));
        state.adminEditMode = 'company';
        render();
    }
}

function saveCoCompany() {
    const company = state.editingCompany;
    if (!company.name.trim()) {
        alert('Company name is required');
        return;
    }

    const data = state.store.getData();
    const existingIndex = data.adminSettings.coCompanies.findIndex(c => c.id === company.id);

    if (existingIndex >= 0) {
        data.adminSettings.coCompanies[existingIndex] = company;
    } else {
        data.adminSettings.coCompanies.push(company);
    }

    state.store.saveData();
    state.store.addAuditEvent({
        type: 'admin_cocompany_updated',
        user: state.currentUserName,
        description: `${existingIndex >= 0 ? 'Updated' : 'Added'} co-company: ${company.name}`
    });

    cancelEditCoCompany();
}

function deleteCoCompany(companyId) {
    if (!confirm('Are you sure you want to remove this co-company?')) return;

    const data = state.store.getData();
    const company = data.adminSettings.coCompanies.find(c => c.id === companyId);
    data.adminSettings.coCompanies = data.adminSettings.coCompanies.filter(c => c.id !== companyId);

    state.store.saveData();
    state.store.addAuditEvent({
        type: 'admin_cocompany_deleted',
        user: state.currentUserName,
        description: `Removed co-company: ${company?.name}`
    });

    render();
}

function cancelEditCoCompany() {
    state.editingCompany = null;
    state.adminEditMode = null;
    render();
}

function simulateDocumentUpload() {
    const docName = prompt('Enter document name (e.g., "Q4 2024 Strategic Review.pdf"):');
    if (!docName) return;

    const docType = prompt('Enter document type (Strategy/Framework/Report/Policy):') || 'Document';

    const data = state.store.getData();
    const newDoc = {
        id: 'doc-' + Date.now(),
        name: docName,
        type: docType,
        uploadedBy: state.currentUserName,
        uploadedAt: new Date().toISOString(),
        size: (Math.random() * 5 + 0.5).toFixed(1) + ' MB',
        description: ''
    };

    data.adminSettings.documents.unshift(newDoc);
    state.store.saveData();
    state.store.addAuditEvent({
        type: 'admin_document_uploaded',
        user: state.currentUserName,
        description: `Uploaded document: ${docName}`
    });

    render();
}

function deleteDocument(docId) {
    if (!confirm('Are you sure you want to delete this document?')) return;

    const data = state.store.getData();
    const doc = data.adminSettings.documents.find(d => d.id === docId);
    data.adminSettings.documents = data.adminSettings.documents.filter(d => d.id !== docId);

    state.store.saveData();
    state.store.addAuditEvent({
        type: 'admin_document_deleted',
        user: state.currentUserName,
        description: `Deleted document: ${doc?.name}`
    });

    render();
}

function renderAdmin() {
    const data = state.store.getData();
    const admin = data.adminSettings;

    if (state.adminEditMode === 'company') {
        return renderCoCompanyEditor();
    }

    return `
        <div class="container" style="padding: 40px 32px;">
            <div style="margin-bottom: 40px;">
                <h1 style="font-size: 32px; margin-bottom: 8px; font-weight: 800;">Admin Settings</h1>
                <p style="color: var(--neutral-600); font-size: 15px;">Manage company information, co-companies, and strategic documents</p>
            </div>

            <!-- Company Profile Section -->
            <div class="card" style="margin-bottom: 32px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; padding-bottom: 20px; border-bottom: 1px solid var(--neutral-200);">
                    <div>
                        <h2 style="font-size: 22px; font-weight: 800; color: var(--neutral-900); margin-bottom: 4px;"> Company Profile</h2>
                        <p style="font-size: 14px; color: var(--neutral-600);">Core business identity and information</p>
                    </div>
                </div>

                <div class="grid grid-2" style="gap: 24px;">
                    <div class="form-group">
                        <label class="form-label">Company Name</label>
                        <input type="text" class="form-control" value="${admin.companyProfile.companyName}"
                               oninput="updateCompanyProfile('companyName', this.value)">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Full Legal Name</label>
                        <input type="text" class="form-control" value="${admin.companyProfile.companyFullName}"
                               oninput="updateCompanyProfile('companyFullName', this.value)">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Industry</label>
                        <input type="text" class="form-control" value="${admin.companyProfile.industry}"
                               oninput="updateCompanyProfile('industry', this.value)">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Headquarters</label>
                        <input type="text" class="form-control" value="${admin.companyProfile.headquarters}"
                               oninput="updateCompanyProfile('headquarters', this.value)">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Founded</label>
                        <input type="text" class="form-control" value="${admin.companyProfile.founded}"
                               oninput="updateCompanyProfile('founded', this.value)">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Employees</label>
                        <input type="text" class="form-control" value="${admin.companyProfile.employees}"
                               oninput="updateCompanyProfile('employees', this.value)">
                    </div>
                    <div class="form-group" style="grid-column: span 2;">
                        <label class="form-label">Company Description</label>
                        <textarea class="form-control" rows="2"
                                  oninput="updateCompanyProfile('description', this.value)">${admin.companyProfile.description}</textarea>
                    </div>
                    <div class="form-group" style="grid-column: span 2;">
                        <label class="form-label">Vision Statement</label>
                        <textarea class="form-control" rows="2"
                                  oninput="updateCompanyProfile('vision', this.value)">${admin.companyProfile.vision}</textarea>
                    </div>
                    <div class="form-group" style="grid-column: span 2;">
                        <label class="form-label">Mission Statement</label>
                        <textarea class="form-control" rows="2"
                                  oninput="updateCompanyProfile('mission', this.value)">${admin.companyProfile.mission}</textarea>
                    </div>
                </div>
            </div>

            <!-- Co-Companies Section -->
            <div class="card" style="margin-bottom: 32px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; padding-bottom: 20px; border-bottom: 1px solid var(--neutral-200);">
                    <div>
                        <h2 style="font-size: 22px; font-weight: 800; color: var(--neutral-900); margin-bottom: 4px;"> Co-Companies & Subsidiaries</h2>
                        <p style="font-size: 14px; color: var(--neutral-600);">${admin.coCompanies.length} related entities</p>
                    </div>
                    <button class="btn btn-primary" onclick="startAddCoCompany()">+ Add Co-Company</button>
                </div>

                <div class="grid grid-2" style="gap: 16px;">
                    ${admin.coCompanies.map(company => `
                        <div class="card" style="border: 1px solid var(--neutral-200); margin: 0;">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                                <div style="flex: 1;">
                                    <h3 style="font-size: 16px; font-weight: 700; color: var(--neutral-900); margin-bottom: 4px;">${company.name}</h3>
                                    <span class="badge badge-blue" style="margin-bottom: 8px;">${company.relationship}</span>
                                </div>
                            </div>
                            <div style="font-size: 13px; color: var(--neutral-600); margin-bottom: 8px;">
                                <strong>Country:</strong> ${company.country}
                            </div>
                            <div style="font-size: 13px; color: var(--neutral-600); margin-bottom: 12px;">
                                ${company.description}
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button class="btn btn-secondary btn-sm" onclick="startEditCoCompany('${company.id}')" style="flex: 1;">Edit</button>
                                <button class="btn btn-secondary btn-sm" onclick="deleteCoCompany('${company.id}')" style="color: var(--red-600);">Remove</button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>

            <!-- Business Information Section -->
            <div class="card" style="margin-bottom: 32px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; padding-bottom: 20px; border-bottom: 1px solid var(--neutral-200);">
                    <div>
                        <h2 style="font-size: 22px; font-weight: 800; color: var(--neutral-900); margin-bottom: 4px;"> Business Information</h2>
                        <p style="font-size: 14px; color: var(--neutral-600);">Legal and operational details</p>
                    </div>
                </div>

                <div class="grid grid-2" style="gap: 24px;">
                    <div class="form-group">
                        <label class="form-label">Tax ID</label>
                        <input type="text" class="form-control" value="${admin.businessInfo.taxId}"
                               oninput="updateBusinessInfo('taxId', this.value)">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Registration Number</label>
                        <input type="text" class="form-control" value="${admin.businessInfo.registrationNumber}"
                               oninput="updateBusinessInfo('registrationNumber', this.value)">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Fiscal Year Start</label>
                        <select class="form-control" onchange="updateBusinessInfo('fiscalYearStart', this.value)">
                            ${['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'].map(month => `
                                <option value="${month}" ${admin.businessInfo.fiscalYearStart === month ? 'selected' : ''}>${month}</option>
                            `).join('')}
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Currency</label>
                        <select class="form-control" onchange="updateBusinessInfo('currency', this.value)">
                            ${['SAR', 'USD', 'EUR', 'AED', 'GBP'].map(curr => `
                                <option value="${curr}" ${admin.businessInfo.currency === curr ? 'selected' : ''}>${curr}</option>
                            `).join('')}
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Timezone</label>
                        <input type="text" class="form-control" value="${admin.businessInfo.timezone}"
                               oninput="updateBusinessInfo('timezone', this.value)">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Website</label>
                        <input type="text" class="form-control" value="${admin.businessInfo.website}"
                               oninput="updateBusinessInfo('website', this.value)">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Contact Email</label>
                        <input type="email" class="form-control" value="${admin.businessInfo.contactEmail}"
                               oninput="updateBusinessInfo('contactEmail', this.value)">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Contact Phone</label>
                        <input type="tel" class="form-control" value="${admin.businessInfo.contactPhone}"
                               oninput="updateBusinessInfo('contactPhone', this.value)">
                    </div>
                </div>
            </div>

            <!-- Documents Section -->
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; padding-bottom: 20px; border-bottom: 1px solid var(--neutral-200);">
                    <div>
                        <h2 style="font-size: 22px; font-weight: 800; color: var(--neutral-900); margin-bottom: 4px;"> Strategic Documents</h2>
                        <p style="font-size: 14px; color: var(--neutral-600);">${admin.documents.length} documents uploaded</p>
                    </div>
                    <button class="btn btn-primary" onclick="simulateDocumentUpload()"> Upload Document</button>
                </div>

                ${admin.documents.length === 0 ? `
                    <div style="text-align: center; padding: 60px 40px; background: var(--neutral-50); border-radius: 10px; border: 2px dashed var(--neutral-300);">
                        <div style="font-size: 48px; margin-bottom: 16px; opacity: 0.3;"></div>
                        <p style="color: var(--neutral-500); font-size: 15px; margin-bottom: 20px;">No documents uploaded yet</p>
                        <button class="btn btn-primary" onclick="simulateDocumentUpload()">Upload First Document</button>
                    </div>
                ` : `
                    <div style="display: flex; flex-direction: column; gap: 12px;">
                        ${admin.documents.map(doc => `
                            <div class="card" style="margin: 0; padding: 16px; border: 1px solid var(--neutral-200); display: flex; justify-content: space-between; align-items: center;">
                                <div style="display: flex; align-items: center; gap: 16px; flex: 1;">
                                    <div style="width: 48px; height: 48px; background: var(--petro-green-50); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 24px;">
                                        
                                    </div>
                                    <div style="flex: 1;">
                                        <div style="font-size: 15px; font-weight: 700; color: var(--neutral-900); margin-bottom: 4px;">${doc.name}</div>
                                        <div style="font-size: 13px; color: var(--neutral-600);">
                                            <span class="badge badge-orange" style="margin-right: 8px;">${doc.type}</span>
                                            <span>${doc.size}</span>
                                            <span style="margin: 0 8px;"></span>
                                            <span>Uploaded by ${doc.uploadedBy}</span>
                                            <span style="margin: 0 8px;"></span>
                                            <span>${new Date(doc.uploadedAt).toLocaleDateString()}</span>
                                        </div>
                                    </div>
                                </div>
                                <div style="display: flex; gap: 8px;">
                                    <button class="btn btn-secondary btn-sm">Download</button>
                                    <button class="btn btn-secondary btn-sm" onclick="deleteDocument('${doc.id}')" style="color: var(--red-600);">Delete</button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `}
            </div>
        </div>
    `;
}

function renderCoCompanyEditor() {
    const company = state.editingCompany;

    return `
        <div class="container" style="padding: 40px 32px; max-width: 800px;">
            <div style="margin-bottom: 32px;">
                <h1 style="font-size: 32px; margin-bottom: 8px; font-weight: 800;">
                    ${company.name ? 'Edit Co-Company' : 'Add Co-Company'}
                </h1>
                <p style="color: var(--neutral-600); font-size: 15px;">Configure related entity information</p>
            </div>

            <div class="card">
                <div class="form-group">
                    <label class="form-label required">Company Name</label>
                    <input type="text" class="form-control" value="${company.name}"
                           oninput="state.editingCompany.name = this.value; render();"
                           placeholder="e.g., Petrolube Distribution">
                </div>

                <div class="form-group">
                    <label class="form-label">Relationship</label>
                    <select class="form-control" onchange="state.editingCompany.relationship = this.value; render();">
                        ${['Subsidiary', 'Joint Venture', 'Partner', 'Affiliate', 'Division'].map(rel => `
                            <option value="${rel}" ${company.relationship === rel ? 'selected' : ''}>${rel}</option>
                        `).join('')}
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Country</label>
                    <input type="text" class="form-control" value="${company.country}"
                           oninput="state.editingCompany.country = this.value; render();"
                           placeholder="e.g., Saudi Arabia">
                </div>

                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea class="form-control" rows="3"
                              oninput="state.editingCompany.description = this.value; render();"
                              placeholder="Brief description of the company and its role">${company.description}</textarea>
                </div>
            </div>

            <div style="display: flex; gap: 12px; margin-top: 24px;">
                <button class="btn btn-secondary btn-lg" onclick="cancelEditCoCompany()">Cancel</button>
                <button class="btn btn-primary btn-lg btn-block" onclick="saveCoCompany()">
                    ${company.name ? 'Update' : 'Add'} Co-Company
                </button>
            </div>
        </div>
    `;
}

// ============================================================================
// TEMPLATE BUILDER FUNCTIONS
// ============================================================================

function startCreateTemplate() {
    state.templateBuilderMode = 'create';
    state.editingTemplate = {
        id: 'template-' + Date.now(),
        name: '',
        fields: [],
        is_published: true,
        created_at: new Date().toISOString()
    };
    render();
}

function startEditTemplate(templateId) {
    const data = state.store.getData();
    const template = data.templates.find(t => t.id === templateId);
    if (template) {
        state.templateBuilderMode = 'edit';
        state.editingTemplate = JSON.parse(JSON.stringify(template)); // Deep copy
        render();
    }
}

function duplicateTemplate(templateId) {
    const data = state.store.getData();
    const template = data.templates.find(t => t.id === templateId);
    if (template) {
        state.templateBuilderMode = 'create';
        state.editingTemplate = {
            ...JSON.parse(JSON.stringify(template)),
            id: 'template-' + Date.now(),
            name: template.name + ' (Copy)',
            created_at: new Date().toISOString()
        };
        render();
    }
}

function cancelTemplateBuilder() {
    state.templateBuilderMode = null;
    state.editingTemplate = null;
    state.showFieldEditor = false;
    state.editingField = null;
    state.editingFieldIndex = null;
    render();
}

function saveTemplateFromBuilder() {
    const template = state.editingTemplate;

    if (!template.name.trim()) {
        alert('Template name is required');
        return;
    }

    if (template.fields.length === 0) {
        alert('Add at least one field');
        return;
    }

    const scoringFields = template.fields.filter(f => f.is_scoring);
    const totalWeight = scoringFields.reduce((sum, f) => sum + f.weight, 0);

    if (totalWeight !== 100) {
        alert(`Scoring weight total must equal 100% (currently ${totalWeight}%)`);
        return;
    }

    state.store.saveTemplate(template);
    cancelTemplateBuilder();
}

function openFieldEditor(fieldIndex = null) {
    if (fieldIndex !== null) {
        state.editingField = JSON.parse(JSON.stringify(state.editingTemplate.fields[fieldIndex]));
        state.editingFieldIndex = fieldIndex;
    } else {
        state.editingField = {
            id: 'field-' + Date.now(),
            type: 'text',
            label: '',
            key: '',
            required: false,
            is_scoring: false,
            weight: 0,
            threshold: null,
            category: '',
            config: {}
        };
        state.editingFieldIndex = null;
    }
    state.showFieldEditor = true;
    render();
}

function closeFieldEditor() {
    state.showFieldEditor = false;
    state.editingField = null;
    state.editingFieldIndex = null;
    render();
}

function saveField() {
    const field = state.editingField;

    if (!field.label.trim() || !field.key.trim()) {
        alert('Label and Key are required');
        return;
    }

    // Validate dropdown options
    if (field.type === 'dropdown') {
        const validOptions = field.config.options.filter(o => o.value && o.label);
        if (validOptions.length === 0) {
            alert('Add at least one dropdown option');
            return;
        }
        field.config.options = validOptions;
    }

    // Set config for number/currency fields
    if (field.type === 'number' || field.type === 'currency') {
        field.config = {
            min: Number(field.config.min) || 0,
            max: Number(field.config.max) || 100
        };
    }

    // Ensure weight is 0 if not scoring
    if (!field.is_scoring) {
        field.weight = 0;
    }

    if (state.editingFieldIndex !== null) {
        // Update existing field
        state.editingTemplate.fields[state.editingFieldIndex] = field;
    } else {
        // Add new field
        state.editingTemplate.fields.push(field);
    }

    closeFieldEditor();
}

function removeField(fieldIndex) {
    if (confirm('Remove this field?')) {
        state.editingTemplate.fields.splice(fieldIndex, 1);
        render();
    }
}

function moveField(fieldIndex, direction) {
    const fields = state.editingTemplate.fields;
    const newIndex = direction === 'up' ? fieldIndex - 1 : fieldIndex + 1;

    if (newIndex >= 0 && newIndex < fields.length) {
        [fields[fieldIndex], fields[newIndex]] = [fields[newIndex], fields[fieldIndex]];
        render();
    }
}

function updateFieldEditorProperty(property, value) {
    if (property.includes('.')) {
        const [parent, child] = property.split('.');
        if (!state.editingField[parent]) {
            state.editingField[parent] = {};
        }
        state.editingField[parent][child] = value;
    } else {
        state.editingField[property] = value;
    }

    // Auto-generate key from label
    if (property === 'label') {
        state.editingField.key = value.toLowerCase()
            .replace(/^\d+\.\s*/, '') // Remove numbering
            .replace(/\s+/g, '_')
            .replace(/[^a-z0-9_]/g, '');
    }

    render();
}

function addDropdownOption() {
    if (!state.editingField.config.options) {
        state.editingField.config.options = [];
    }
    state.editingField.config.options.push({ value: '', label: '', points: 0 });
    render();
}

function removeDropdownOption(index) {
    state.editingField.config.options.splice(index, 1);
    render();
}

function updateDropdownOption(index, property, value) {
    state.editingField.config.options[index][property] = value;
    render();
}

function renderFieldEditorModal() {
    const field = state.editingField;
    if (!field) return '';

    const isEditing = state.editingFieldIndex !== null;

    return `
        <div class="modal" style="display: flex;">
            <div class="modal-content" style="max-width: 800px;">
                <div class="modal-header">
                    <h2>${isEditing ? 'Edit Field' : 'Add Field'}</h2>
                    <button class="modal-close" onclick="closeFieldEditor()"></button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label class="form-label">Field Type</label>
                        <select class="form-control" onchange="updateFieldEditorProperty('type', this.value)">
                            <option value="text" ${field.type === 'text' ? 'selected' : ''}>Text</option>
                            <option value="number" ${field.type === 'number' ? 'selected' : ''}>Number</option>
                            <option value="currency" ${field.type === 'currency' ? 'selected' : ''}>Currency (SAR)</option>
                            <option value="dropdown" ${field.type === 'dropdown' ? 'selected' : ''}>Dropdown</option>
                            <option value="date" ${field.type === 'date' ? 'selected' : ''}>Date</option>
                            <option value="yesno" ${field.type === 'yesno' ? 'selected' : ''}>Yes/No</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Label (Display Name)</label>
                        <input type="text" class="form-control" value="${field.label}"
                               oninput="updateFieldEditorProperty('label', this.value)"
                               placeholder="e.g., 7. Strategic Priority">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Key (Internal Identifier - no spaces)</label>
                        <input type="text" class="form-control" value="${field.key}"
                               oninput="updateFieldEditorProperty('key', this.value.toLowerCase().replace(/\\s+/g, '_'))"
                               placeholder="e.g., strategic_priority">
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px;">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 12px; background: var(--neutral-50); border-radius: 8px; border: 1px solid var(--neutral-200);">
                            <input type="checkbox" ${field.required ? 'checked' : ''}
                                   onchange="updateFieldEditorProperty('required', this.checked)">
                            <span style="font-weight: 600; color: var(--neutral-800); font-size: 14px;">Required field</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 12px; background: var(--neutral-50); border-radius: 8px; border: 1px solid var(--neutral-200);">
                            <input type="checkbox" ${field.is_scoring ? 'checked' : ''}
                                   onchange="updateFieldEditorProperty('is_scoring', this.checked)">
                            <span style="font-weight: 600; color: var(--neutral-800); font-size: 14px;">Use for scoring</span>
                        </label>
                    </div>

                    ${field.is_scoring ? `
                        <div style="background: var(--petro-green-50); border: 2px solid var(--petro-green-200); border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                            <h3 style="font-weight: 700; color: var(--petro-green-800); margin-bottom: 16px; font-size: 16px;">Scoring Configuration</h3>
                            <div class="form-group">
                                <label class="form-label">Weight (%)</label>
                                <input type="number" class="form-control" value="${field.weight}"
                                       oninput="updateFieldEditorProperty('weight', Number(this.value))"
                                       placeholder="e.g., 25" min="0" max="100">
                            </div>

                            ${(field.type === 'number' || field.type === 'currency') ? `
                                <div class="form-group">
                                    <label class="form-label">Threshold (Optional - for pass/fail scoring)</label>
                                    <input type="number" class="form-control" value="${field.threshold || ''}"
                                           oninput="updateFieldEditorProperty('threshold', this.value ? Number(this.value) : null)"
                                           placeholder="e.g., 15 (for IRR >= 15%)">
                                </div>
                                <div class="alert alert-info" style="margin-bottom: 0;">
                                    ${field.threshold !== null && field.threshold !== undefined && field.threshold !== '' ? `
                                        <strong>Threshold Mode:</strong> Value  ${field.threshold} = 100 points, below = 0 points
                                    ` : `
                                        <strong>Normalization Mode:</strong> Value normalized to 0-100 scale based on min/max
                                    `}
                                </div>
                            ` : ''}
                        </div>
                    ` : ''}

                    ${(field.type === 'number' || field.type === 'currency') ? `
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px;">
                            <div class="form-group">
                                <label class="form-label">Min Value</label>
                                <input type="number" class="form-control" value="${field.config.min || 0}"
                                       oninput="updateFieldEditorProperty('config.min', Number(this.value))">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Max Value</label>
                                <input type="number" class="form-control" value="${field.config.max || 100}"
                                       oninput="updateFieldEditorProperty('config.max', Number(this.value))">
                            </div>
                        </div>
                    ` : ''}

                    ${field.type === 'dropdown' ? `
                        <div class="form-group">
                            <label class="form-label">
                                Dropdown Options ${field.is_scoring ? '(with point values)' : ''}
                            </label>
                            <div style="max-height: 300px; overflow-y: auto; margin-bottom: 12px; padding: 12px; background: var(--neutral-50); border-radius: 8px; border: 1px solid var(--neutral-200);">
                                ${(field.config.options || []).map((opt, idx) => `
                                    <div style="display: grid; grid-template-columns: ${field.is_scoring ? '2fr 3fr 1fr 40px' : '2fr 3fr 40px'}; gap: 8px; margin-bottom: 8px;">
                                        <input type="text" class="form-control" placeholder="value" value="${opt.value}"
                                               oninput="updateDropdownOption(${idx}, 'value', this.value)" style="font-size: 13px; padding: 8px 10px;">
                                        <input type="text" class="form-control" placeholder="Label" value="${opt.label}"
                                               oninput="updateDropdownOption(${idx}, 'label', this.value)" style="font-size: 13px; padding: 8px 10px;">
                                        ${field.is_scoring ? `
                                            <input type="number" class="form-control" placeholder="Points" value="${opt.points}"
                                                   oninput="updateDropdownOption(${idx}, 'points', Number(this.value))" style="font-size: 13px; padding: 8px 10px;">
                                        ` : ''}
                                        <button class="btn btn-secondary btn-sm" onclick="removeDropdownOption(${idx})" style="padding: 8px;"></button>
                                    </div>
                                `).join('')}
                            </div>
                            <button class="btn btn-secondary btn-sm" onclick="addDropdownOption()">+ Add Option</button>
                        </div>
                    ` : ''}
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="closeFieldEditor()">Cancel</button>
                    <button class="btn btn-primary" onclick="saveField()">
                        ${isEditing ? 'Update Field' : 'Add Field'}
                    </button>
                </div>
            </div>
        </div>
    `;
}

function renderTemplateBuilder() {
    const template = state.editingTemplate;
    const scoringFields = template.fields.filter(f => f.is_scoring);
    const totalWeight = scoringFields.reduce((sum, f) => sum + f.weight, 0);

    return `
        <div class="container" style="padding: 40px 32px;">
            <div style="margin-bottom: 32px;">
                <h1 style="font-size: 32px; margin-bottom: 8px; font-weight: 800;">
                    ${state.templateBuilderMode === 'edit' ? 'Edit Template' : 'Create Template'}
                </h1>
                <p style="color: var(--neutral-600); font-size: 15px;">Configure initiative criteria and scoring weights</p>
            </div>

            <div class="card">
                <div class="form-group">
                    <label class="form-label">Template Name</label>
                    <input type="text" class="form-control" value="${template.name}"
                           oninput="state.editingTemplate.name = this.value; render();"
                           placeholder="e.g., Petrolube Initiative Dossier - 35 Criteria V15">
                </div>
            </div>

            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 24px; padding-bottom: 20px; border-bottom: 1px solid var(--neutral-200);">
                    <div>
                        <h2 style="font-size: 20px; font-weight: 800; margin-bottom: 4px; color: var(--neutral-900);">Fields Configuration</h2>
                        <p style="font-size: 14px; color: var(--neutral-600);">
                            ${template.fields.length} total fields  ${scoringFields.length} scoring fields
                        </p>
                    </div>
                    <div class="stat-card" style="min-width: 140px; text-align: center; margin: 0;">
                        <div class="stat-card-header" style="margin-bottom: 8px;">Weight Total</div>
                        <div style="font-size: 36px; font-weight: 800; line-height: 1; color: ${totalWeight === 100 ? 'var(--petro-green-700)' : 'var(--red-600)'};">
                            ${totalWeight}%
                        </div>
                        ${totalWeight !== 100 ? '<div style="font-size: 11px; color: var(--red-600); margin-top: 8px; font-weight: 600;">Must equal 100%</div>' : '<div style="font-size: 11px; color: var(--petro-green-700); margin-top: 8px; font-weight: 600;"> Valid</div>'}
                    </div>
                </div>

                ${template.fields.length === 0 ? `
                    <div style="text-align: center; padding: 80px 40px; background: var(--neutral-50); border-radius: 10px; border: 2px dashed var(--neutral-300);">
                        <div style="font-size: 48px; margin-bottom: 16px; opacity: 0.3;"></div>
                        <p style="color: var(--neutral-500); font-size: 15px; margin-bottom: 20px;">No fields added yet. Click "Add Field" to get started.</p>
                        <button class="btn btn-primary" onclick="openFieldEditor()">+ Add First Field</button>
                    </div>
                ` : `
                    <div style="max-height: 500px; overflow-y: auto; margin-bottom: 20px; padding-right: 4px;">
                        ${template.fields.map((field, index) => `
                            <div class="card" style="margin-bottom: 12px; padding: 16px; border: 1px solid var(--neutral-200); box-shadow: var(--shadow-sm);">
                                <div style="display: flex; gap: 16px; align-items: start;">
                                    <div style="display: flex; flex-direction: column; gap: 6px;">
                                        <button class="btn btn-secondary btn-sm" onclick="moveField(${index}, 'up')"
                                                ${index === 0 ? 'disabled' : ''}
                                                style="padding: 6px 10px; font-size: 11px; min-width: 32px;"></button>
                                        <button class="btn btn-secondary btn-sm" onclick="moveField(${index}, 'down')"
                                                ${index === template.fields.length - 1 ? 'disabled' : ''}
                                                style="padding: 6px 10px; font-size: 11px; min-width: 32px;"></button>
                                    </div>

                                    <div style="flex: 1;">
                                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px; flex-wrap: wrap;">
                                            <span style="font-size: 11px; font-family: monospace; color: var(--neutral-400); background: var(--neutral-100); padding: 2px 6px; border-radius: 4px;">#${index + 1}</span>
                                            <span style="font-size: 15px; font-weight: 700; color: var(--neutral-900);">${field.label}</span>
                                            ${field.required ? '<span class="badge badge-red">Required</span>' : ''}
                                            ${field.is_scoring ? `<span class="badge badge-orange">Scoring: ${field.weight}%</span>` : ''}
                                        </div>
                                        <div style="font-size: 13px; color: var(--neutral-600); line-height: 1.6;">
                                            <span style="font-weight: 600;">Type:</span> <code style="background: var(--neutral-100); padding: 2px 6px; border-radius: 4px; font-size: 12px;">${field.type}</code>
                                            <span style="margin-left: 12px; font-weight: 600;">Key:</span> <code style="background: var(--neutral-100); padding: 2px 6px; border-radius: 4px; font-size: 12px;">${field.key}</code>
                                            ${field.threshold !== null && field.threshold !== undefined && field.threshold !== '' ?
                                                `<span style="margin-left: 12px; font-weight: 600;">Threshold: <strong>${field.threshold}</strong></span>` : ''}
                                        </div>
                                        ${field.type === 'dropdown' && field.config.options ? `
                                            <div style="margin-top: 10px; padding: 8px 12px; background: var(--neutral-50); border-radius: 6px; border: 1px solid var(--neutral-200);">
                                                <div style="font-size: 11px; color: var(--neutral-600); font-weight: 600; margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.03em;">Options</div>
                                                <div style="font-size: 12px; color: var(--neutral-700);">${field.config.options.map(o => o.label).slice(0, 5).join(', ')}${field.config.options.length > 5 ? ` +${field.config.options.length - 5} more` : ''}</div>
                                            </div>
                                        ` : ''}
                                    </div>

                                    <div style="display: flex; gap: 8px;">
                                        <button class="btn btn-primary btn-sm" onclick="openFieldEditor(${index})">Edit</button>
                                        <button class="btn btn-secondary btn-sm" onclick="removeField(${index})" style="color: var(--red-600);">Remove</button>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    <button class="btn btn-secondary btn-block" onclick="openFieldEditor()">+ Add Field</button>
                `}
            </div>

            <div style="display: flex; gap: 12px; position: sticky; bottom: 20px; background: var(--neutral-50); padding: 16px 0; margin-top: 24px;">
                <button class="btn btn-secondary btn-lg" onclick="cancelTemplateBuilder()">Cancel</button>
                <button class="btn btn-primary btn-lg btn-block" onclick="saveTemplateFromBuilder()"
                        ${totalWeight !== 100 ? 'disabled' : ''}>
                    ${totalWeight === 100 ? ' Publish Template' : ` Fix Weight Total (${totalWeight}%  100%)`}
                </button>
            </div>
        </div>
    `;
}

function renderTemplates() {
    // If in builder mode, show builder
    if (state.templateBuilderMode) {
        return renderTemplateBuilder();
    }

    const data = state.store.getData();
    
    return `
        <div class="container" style="padding: 40px 32px;">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 32px;">
                <div>
                    <h1 style="font-size: 32px; margin-bottom: 8px; font-weight: 800;">Assessment Templates</h1>
                    <p style="color: var(--neutral-600); font-size: 15px;">Manage evaluation frameworks and scoring criteria</p>
                </div>
                <button class="btn btn-primary" onclick="startCreateTemplate()">+ Create New Template</button>
            </div>

            ${data.templates.length === 0 ? `
                <div class="card" style="padding: 80px 40px; text-align: center;">
                    <div style="font-size: 64px; margin-bottom: 20px; opacity: 0.3;"></div>
                    <p style="color: var(--neutral-600); margin-bottom: 24px; font-size: 16px;">No templates yet</p>
                    <button class="btn btn-primary" onclick="startCreateTemplate()">Create Your First Template</button>
                </div>
            ` : `
                <div class="grid grid-2">
                    ${data.templates.map(template => {
                        const scoringFields = template.fields.filter(f => f.is_scoring);
                        const totalWeight = scoringFields.reduce((sum, f) => sum + f.weight, 0);

                        return `
                            <div class="card">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 20px;">
                                    <div style="flex: 1;">
                                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                                            <h3 style="font-size: 18px; font-weight: 800; color: var(--neutral-900);">${template.name}</h3>
                                            ${template.is_published ? '<span class="badge badge-green">Published</span>' : ''}
                                        </div>
                                        <div style="font-size: 13px; color: var(--neutral-600);">
                                            ${template.fields.length} total fields  ${scoringFields.length} scoring fields  Weight total:
                                            <span style="font-weight: 700; color: ${totalWeight === 100 ? 'var(--petro-green-700)' : 'var(--red-600)'};">
                                                ${totalWeight}%
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 20px;">
                                    <div>
                                        <div style="font-size: 11px; color: var(--neutral-600); margin-bottom: 4px; text-transform: uppercase; font-weight: 700; letter-spacing: 0.05em;">Total Fields</div>
                                        <div style="font-size: 28px; font-weight: 800; color: var(--neutral-900);">${template.fields.length}</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 11px; color: var(--neutral-600); margin-bottom: 4px; text-transform: uppercase; font-weight: 700; letter-spacing: 0.05em;">Scoring</div>
                                        <div style="font-size: 28px; font-weight: 800; color: var(--petro-green-700);">${scoringFields.length}</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 11px; color: var(--neutral-600); margin-bottom: 4px; text-transform: uppercase; font-weight: 700; letter-spacing: 0.05em;">Weight Total</div>
                                        <div style="font-size: 28px; font-weight: 800; color: ${totalWeight === 100 ? 'var(--petro-green-700)' : 'var(--red-600)'};">${totalWeight}%</div>
                                    </div>
                                </div>
                                <div style="padding: 16px; background: var(--neutral-50); border-radius: 10px; margin-bottom: 20px;">
                                    <div style="font-size: 12px; font-weight: 700; color: var(--neutral-700); margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.05em;">Scoring Criteria Preview</div>
                                    <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                                        ${scoringFields.slice(0, 5).map(f => `
                                            <span class="badge badge-orange">${f.label.split('.')[1]?.trim() || f.label}: ${f.weight}%</span>
                                        `).join('')}
                                        ${scoringFields.length > 5 ? `<span style="font-size: 12px; color: var(--neutral-500);">+${scoringFields.length - 5} more</span>` : ''}
                                    </div>
                                </div>
                                <div style="display: flex; gap: 8px;">
                                    <button class="btn btn-primary btn-sm" onclick="startEditTemplate('${template.id}')" style="flex: 1;">Edit</button>
                                    <button class="btn btn-secondary btn-sm" onclick="duplicateTemplate('${template.id}')">Duplicate</button>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `}
        </div>
    `;
}

function renderScenarios() {
    const data = state.store.getData();
    
    return `
        <div class="container" style="padding: 40px 32px;">
            <div style="margin-bottom: 32px;">
                <h1 style="font-size: 32px; margin-bottom: 8px; font-weight: 800;">Scenario Management</h1>
                <p style="color: var(--neutral-600); font-size: 15px;">Compare strategic approaches and portfolio optimization strategies</p>
            </div>
            
            <div class="grid grid-3 mb-6">
                ${data.scenarios.map(s => `
                    <div class="card" style="cursor: pointer; ${s.id === state.selectedScenario ? 'border: 2px solid var(--petro-green-700); background: var(--petro-green-50);' : ''}" onclick="selectScenario('${s.id}')">
                        <h3 style="font-size: 18px; font-weight: 800; margin-bottom: 12px; color: var(--neutral-900);">${s.name}</h3>
                        <p style="font-size: 14px; color: var(--neutral-600); margin-bottom: 16px;">${s.description}</p>
                        ${s.id === state.selectedScenario ? '<span class="badge badge-green">Active Scenario</span>' : '<span class="badge badge-gray">Available</span>'}
                    </div>
                `).join('')}
            </div>

            <div class="card">
                <h2 style="font-size: 20px; font-weight: 800; margin-bottom: 24px; color: var(--neutral-900);">Cross-Scenario Comparison</h2>
                <p style="color: var(--neutral-600); margin-bottom: 20px; font-size: 14px;">Compare how initiatives rank across different strategic scenarios</p>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Initiative</th>
                            ${data.scenarios.map(s => `<th>${s.name.split(' ')[0]}</th>`).join('')}
                        </tr>
                    </thead>
                    <tbody>
                        ${data.projects.filter(p => p.scores).slice(0, 10).map(p => `
                            <tr>
                                <td>
                                    <div style="font-weight: 700; color: var(--neutral-900);">${p.criteriaValues?.initiative_name || p.name}</div>
                                    <div style="font-size: 12px; color: var(--neutral-500); margin-top: 2px;">${p.criteriaValues?.initiative_id}</div>
                                </td>
                                ${data.scenarios.map(s => {
                                    const rank = p.scores?.rank;
                                    return `<td><div class="rank-badge rank-default" style="width: 32px; height: 32px; font-size: 14px;">${rank || ''}</div></td>`;
                                }).join('')}
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        </div>
    `;
}

function renderInsights() {
    const data = state.store.getData();
    const scored = data.projects.filter(p => p.scores && p.scores.compositeScore);
    const avgScore = scored.length > 0 ? scored.reduce((sum, p) => sum + p.scores.compositeScore, 0) / scored.length : 0;
    const maxScore = Math.max(...scored.map(p => p.scores.compositeScore), 0);
    const minScore = scored.length > 0 ? Math.min(...scored.map(p => p.scores.compositeScore)) : 0;
    const template = data.templates[0];
    const scoringFields = template.fields.filter(f => f.is_scoring);

    return `
        <div class="container" style="padding: 40px 32px;">
            <div style="margin-bottom: 32px;">
                <h1 style="font-size: 32px; margin-bottom: 8px; font-weight: 800;">Portfolio Insights</h1>
                <p style="color: var(--neutral-600); font-size: 15px;">Deep analytics and scoring methodology transparency</p>
            </div>
            
            <div class="grid grid-3 mb-6">
                <div class="stat-card" style="background: linear-gradient(135deg, var(--blue-100), white); border-left: 3px solid var(--blue-600);">
                    <div class="stat-card-header" style="color: var(--blue-600);">Top Driver</div>
                    <div style="font-size: 24px; font-weight: 800; color: var(--blue-600); margin-bottom: 4px;">Financial Impact</div>
                    <div class="stat-card-footer">25% weight contribution</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, var(--petro-green-100), white); border-left: 3px solid var(--petro-green-700);">
                    <div class="stat-card-header" style="color: var(--petro-green-700);">Score Range</div>
                    <div style="font-size: 24px; font-weight: 800; color: var(--petro-green-700); margin-bottom: 4px;">${minScore.toFixed(0)} - ${maxScore.toFixed(0)}</div>
                    <div class="stat-card-footer">Portfolio distribution</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, var(--petro-orange-100), white); border-left: 3px solid var(--petro-orange-600);">
                    <div class="stat-card-header" style="color: var(--petro-orange-600);">Average Score</div>
                    <div style="font-size: 24px; font-weight: 800; color: var(--petro-orange-600); margin-bottom: 4px;">${avgScore.toFixed(1)}</div>
                    <div class="stat-card-footer">Across ${scored.length} projects</div>
                </div>
            </div>

            <div class="card mb-6">
                <h2 style="font-size: 20px; font-weight: 800; margin-bottom: 24px; color: var(--neutral-900);">Scoring Methodology</h2>
                
                <div style="padding: 20px; background: var(--petro-green-50); border-radius: 10px; border-left: 3px solid var(--petro-green-700); margin-bottom: 24px;">
                    <h3 style="font-size: 16px; font-weight: 800; margin-bottom: 12px; color: var(--petro-green-900);">35-Criteria Framework V14</h3>
                    <div class="grid grid-2" style="gap: 16px;">
                        <div>
                            <p style="font-size: 14px; color: var(--neutral-700); margin-bottom: 8px;"><strong>Total Criteria:</strong> 35 evaluation points</p>
                            <p style="font-size: 14px; color: var(--neutral-700); margin-bottom: 8px;"><strong>Scoring Criteria:</strong> ${scoringFields.length} weighted fields</p>
                            <p style="font-size: 14px; color: var(--neutral-700);"><strong>Total Weight:</strong> 100% distributed across criteria</p>
                        </div>
                        <div>
                            <p style="font-size: 14px; color: var(--neutral-700); margin-bottom: 8px;"><strong>Methodology:</strong> Weighted composite scoring</p>
                            <p style="font-size: 14px; color: var(--neutral-700); margin-bottom: 8px;"><strong>Kill-Switch:</strong> Automated risk gates</p>
                            <p style="font-size: 14px; color: var(--neutral-700);"><strong>Normalization:</strong> 0-100 scale</p>
                        </div>
                    </div>
                </div>

                <div style="margin-bottom: 20px;">
                    <h4 style="font-size: 14px; font-weight: 800; margin-bottom: 16px; color: var(--neutral-800); text-transform: uppercase; letter-spacing: 0.05em;">Weight Distribution</h4>
                    ${scoringFields.map(field => {
                        const percentage = field.weight;
                        return `
                            <div style="margin-bottom: 16px;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                                    <span style="font-size: 14px; font-weight: 600; color: var(--neutral-900);">${field.label}</span>
                                    <span style="font-size: 14px; font-weight: 800; color: var(--petro-green-700);">${percentage}%</span>
                                </div>
                                <div class="progress-bar" style="height: 10px;">
                                    <div class="progress-fill" style="width: ${percentage}%;"></div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            </div>

            <div class="card">
                <h2 style="font-size: 20px; font-weight: 800; margin-bottom: 24px; color: var(--neutral-900);">Top Performers Analysis</h2>
                ${scored.slice(0, 3).map((p, idx) => `
                    <div style="padding: 20px; background: ${idx === 0 ? 'var(--petro-green-50)' : 'var(--neutral-50)'}; border-radius: 10px; margin-bottom: 16px; border-left: 3px solid ${idx === 0 ? 'var(--petro-gold-600)' : 'var(--petro-green-700)'};">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                            <div style="flex: 1;">
                                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                                    <div class="rank-badge ${p.scores.rank === 1 ? 'rank-1' : p.scores.rank === 2 ? 'rank-2' : 'rank-3'}" style="width: 32px; height: 32px; font-size: 14px;">${p.scores.rank}</div>
                                    <h3 style="font-size: 18px; font-weight: 800; color: var(--neutral-900);">${p.criteriaValues?.initiative_name || p.name}</h3>
                                </div>
                                <p style="font-size: 12px; color: var(--neutral-600); font-family: 'JetBrains Mono', monospace;">${p.criteriaValues?.initiative_id}</p>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 36px; font-weight: 800; color: var(--petro-orange-600);">${p.scores.compositeScore.toFixed(1)}</div>
                                <div style="font-size: 12px; color: var(--neutral-600);">Composite Score</div>
                            </div>
                        </div>
                        <div style="padding-top: 16px; border-top: 1px solid var(--neutral-200);">
                            <h4 style="font-size: 12px; font-weight: 800; margin-bottom: 12px; color: var(--neutral-700); text-transform: uppercase; letter-spacing: 0.05em;">Top Contributors</h4>
                            ${p.scores.breakdown.sort((a, b) => b.contribution - a.contribution).slice(0, 3).map((item, i) => `
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; ${i < 2 ? 'border-bottom: 1px solid var(--neutral-200);' : ''}">
                                    <span style="font-size: 13px; color: var(--neutral-700);">${item.field_label.split('.')[1]?.trim() || item.field_label}</span>
                                    <div style="display: flex; align-items: center; gap: 12px;">
                                        <span style="font-size: 12px; color: var(--neutral-600); font-family: 'JetBrains Mono', monospace;">${item.raw_value}</span>
                                        <span style="font-size: 14px; font-weight: 800; color: var(--petro-green-700); min-width: 50px; text-align: right;">${item.contribution.toFixed(1)} pts</span>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `).join('')}
            </div>
        </div>
    `;
}

function renderModals() {
    return `
        <div id="projectWizardModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Create New Initiative</h2>
                    <button class="modal-close" onclick="closeProjectWizard()"></button>
                </div>
                <div class="modal-body" id="wizardContent"></div>
            </div>
        </div>

        ${state.showFieldEditor ? renderFieldEditorModal() : ''}
    `;
}

// ============================================================================
// WIZARD RENDERS
// ============================================================================

function renderWizard() {
    const data = state.store.getData();
    const template = data.templates[0];
    const mandatoryFields = template.fields.filter(f => f.required);
    
    let completed = 0;
    if (state.wizardData.description) completed++;
    mandatoryFields.forEach(f => {
        if (state.wizardData.criteriaValues?.[f.key]) completed++;
    });
    const completeness = Math.round((completed / (mandatoryFields.length + 1)) * 100);

    let html = `
        <div class="wizard-steps">
            ${[1, 2, 3, 4, 5].map(s => `
                <div class="wizard-step ${state.wizardStep === s ? 'active' : state.wizardStep > s ? 'completed' : ''}">
                    <div class="wizard-step-circle">${s}</div>
                    <div class="wizard-step-label">
                        ${['AI Describe', 'Header', 'Strategic', 'Scoring', 'Review'][s - 1]}
                    </div>
                </div>
            `).join('')}
        </div>

        <div class="card mb-6">
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
                <h3 style="font-size: 15px; color: var(--petro-green-800); font-weight: 700;">Completion Progress</h3>
                <div style="font-size: 24px; font-weight: 800; color: var(--petro-green-700);">${completeness}%</div>
            </div>
            <div class="progress-bar" style="height: 12px;">
                <div class="progress-fill" style="width: ${completeness}%"></div>
            </div>
            <div style="margin-top: 8px; font-size: 13px; color: var(--neutral-600);">
                ${completed} of ${mandatoryFields.length + 1} required fields completed
            </div>
        </div>
    `;

    if (state.wizardStep === 1) html += renderWizardStep1();
    else if (state.wizardStep === 2) html += renderWizardStep2(template);
    else if (state.wizardStep === 3) html += renderWizardStep3(template);
    else if (state.wizardStep === 4) html += renderWizardStep4(template);
    else if (state.wizardStep === 5) html += renderWizardStep5(template);

    document.getElementById('wizardContent').innerHTML = html;
}

function renderWizardStep1() {
    return `
        <h3 style="font-size: 18px; font-weight: 800; margin-bottom: 20px;">Step 1: AI-Powered Description</h3>
        
        ${state.showDescriptionBox ? `
            <div class="agent-panel">
                <div style="display: flex; align-items: start; gap: 16px; margin-bottom: 16px;">
                    <div style="font-size: 40px;"></div>
                    <div>
                        <h4 style="font-size: 16px; font-weight: 800; color: var(--blue-600); margin-bottom: 8px;">AI Auto-Fill Assistant</h4>
                        <p style="font-size: 14px; color: var(--neutral-700);">
                            Describe your initiative and our AI will intelligently populate all 35 criteria based on pattern recognition and historical data analysis.
                        </p>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label required">Project Description</label>
                    <textarea class="form-control" id="wizard-description" rows="6" 
                              placeholder="Example: Oracle ERP Redwood UX migration. Critical dependency blocking 91 AI agents. Budget: 12.5M SAR, Timeline: 14 months, Expected IRR: 42%. High strategic priority for Q1 2025 delivery...">${state.wizardData.description || ''}</textarea>
                </div>
                
                <button class="btn btn-gold btn-block btn-lg" onclick="runAIAutoFill()">
                    <span></span> Auto-Fill All 35 Criteria
                </button>
            </div>
        ` : `
            <div class="alert alert-success mb-4">
                <div style="font-size: 24px;"></div>
                <div>
                    <strong style="font-weight: 700;">AI Processing Complete!</strong><br>
                    <span style="font-size: 14px;">All 35 criteria have been intelligently populated. Review and adjust in the following steps.</span>
                </div>
            </div>
            <button class="btn btn-secondary" onclick="resetAIAutoFill()">
                <span></span> Re-run AI Analysis
            </button>
        `}

        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeProjectWizard()">Cancel</button>
            <button class="btn btn-primary" onclick="wizardNext(1)" ${!state.wizardData.description ? 'disabled' : ''}>
                Next: Header Info 
            </button>
        </div>
    `;
}

function renderWizardStep2(template) {
    const fields = template.fields.filter(f => f.category === 'header');
    
    return `
        <div class="section-header">Section 1: Header & Identification</div>
        <div class="grid grid-2">
            ${fields.map(field => renderFieldInput(field)).join('')}
        </div>

        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="wizardPrev()"> Back</button>
            <button class="btn btn-primary" onclick="wizardNext(2)">Next: Strategic </button>
        </div>
    `;
}

function renderWizardStep3(template) {
    const fields = template.fields.filter(f => f.category === 'strategic');
    
    return `
        <div class="section-header">Section 2: Strategic Positioning</div>
        <div class="grid grid-2">
            ${fields.map(field => renderFieldInput(field)).join('')}
        </div>

        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="wizardPrev()"> Back</button>
            <button class="btn btn-primary" onclick="wizardNext(3)">Next: Scoring </button>
        </div>
    `;
}

function renderWizardStep4(template) {
    const scoringFields = template.fields.filter(f => f.category === 'scoring');
    const financialFields = template.fields.filter(f => f.category === 'financial');
    
    return `
        <div class="section-header">Section 3: Framework V4.0 Scoring</div>
        <div class="grid grid-2">
            ${scoringFields.map(field => renderFieldInput(field)).join('')}
        </div>
        
        <div class="section-header">Section 4: Business Case & Financial</div>
        <div class="grid grid-2">
            ${financialFields.map(field => renderFieldInput(field)).join('')}
        </div>

        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="wizardPrev()"> Back</button>
            <button class="btn btn-primary" onclick="wizardNext(4)">Next: Review </button>
        </div>
    `;
}

function renderWizardStep5(template) {
    const allComplete = template.fields.filter(f => f.required).every(f => state.wizardData.criteriaValues?.[f.key]);
    
    return `
        <h3 style="font-size: 18px; font-weight: 800; margin-bottom: 24px;">Step 5: Review & Submit</h3>
        
        ${allComplete ? `
            <div class="alert alert-success mb-6">
                <div style="font-size: 24px;"></div>
                <div>
                    <strong style="font-weight: 700;">Ready to Create</strong><br>
                    <span style="font-size: 14px;">All required fields are complete. Review the summary below and submit.</span>
                </div>
            </div>
        ` : `
            <div class="alert alert-danger mb-6">
                <div style="font-size: 24px;"></div>
                <div>
                    <strong style="font-weight: 700;">Missing Required Fields</strong><br>
                    <span style="font-size: 14px;">Please go back and complete all mandatory criteria before submitting.</span>
                </div>
            </div>
        `}

        <div class="card mb-6">
            <h4 style="font-size: 16px; font-weight: 800; margin-bottom: 20px; color: var(--neutral-900);">Initiative Summary</h4>
            <div style="padding: 20px; background: var(--neutral-50); border-radius: 10px; margin-bottom: 16px;">
                <div style="font-size: 24px; font-weight: 800; color: var(--petro-green-800); margin-bottom: 8px;">${state.wizardData.criteriaValues?.initiative_name || 'Unnamed Initiative'}</div>
                <div style="font-size: 13px; color: var(--neutral-600); font-family: 'JetBrains Mono', monospace;">${state.wizardData.criteriaValues?.initiative_id || ''}</div>
            </div>
            <div class="grid grid-4" style="gap: 16px;">
                <div>
                    <div style="font-size: 11px; color: var(--neutral-600); margin-bottom: 4px; text-transform: uppercase; font-weight: 700; letter-spacing: 0.05em;">Domain</div>
                    <div style="font-weight: 700; font-size: 14px; color: var(--neutral-900);">${(state.wizardData.criteriaValues?.strategic_domain || '').replace(/_/g, ' ')}</div>
                </div>
                <div>
                    <div style="font-size: 11px; color: var(--neutral-600); margin-bottom: 4px; text-transform: uppercase; font-weight: 700; letter-spacing: 0.05em;">Priority</div>
                    <div style="font-weight: 700; font-size: 14px; color: var(--neutral-900);">${(state.wizardData.criteriaValues?.strategic_priority || '').replace(/_/g, ' ').toUpperCase()}</div>
                </div>
                <div>
                    <div style="font-size: 11px; color: var(--neutral-600); margin-bottom: 4px; text-transform: uppercase; font-weight: 700; letter-spacing: 0.05em;">Investment</div>
                    <div style="font-weight: 700; font-size: 14px; color: var(--neutral-900);">${state.wizardData.criteriaValues?.investment_required ? (state.wizardData.criteriaValues.investment_required / 1000000).toFixed(1) + 'M SAR' : ''}</div>
                </div>
                <div>
                    <div style="font-size: 11px; color: var(--neutral-600); margin-bottom: 4px; text-transform: uppercase; font-weight: 700; letter-spacing: 0.05em;">IRR</div>
                    <div style="font-weight: 700; font-size: 14px; color: var(--petro-green-700);">${state.wizardData.criteriaValues?.irr_percentage || ''}%</div>
                </div>
            </div>
        </div>

        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="wizardPrev()"> Back</button>
            <button class="btn btn-gold" ${!allComplete ? 'disabled' : ''} onclick="submitWizard()">
                <span></span> Create & Score Initiative
            </button>
        </div>
    `;
}

function renderFieldInput(field) {
    const value = state.wizardData.criteriaValues?.[field.key] || '';
    
    if (field.type === 'text') {
        return `
            <div class="form-group">
                <label class="form-label ${field.required ? 'required' : ''}">${field.label}</label>
                <input type="text" class="form-control" id="field-${field.key}" 
                       value="${value}" onchange="updateFieldValue('${field.key}', this.value)">
            </div>
        `;
    } else if (field.type === 'number') {
        return `
            <div class="form-group">
                <label class="form-label ${field.required ? 'required' : ''}">${field.label}</label>
                <input type="number" class="form-control" id="field-${field.key}" 
                       value="${value}" min="${field.config.min || 0}" max="${field.config.max || 100}"
                       onchange="updateFieldValue('${field.key}', parseFloat(this.value))">
            </div>
        `;
    } else if (field.type === 'currency') {
        return `
            <div class="form-group">
                <label class="form-label ${field.required ? 'required' : ''}">${field.label}</label>
                <div style="position: relative;">
                    <span style="position: absolute; left: 14px; top: 13px; color: var(--neutral-500); font-size: 14px; font-weight: 600;">SAR</span>
                    <input type="number" class="form-control" id="field-${field.key}" 
                           style="padding-left: 54px;"
                           value="${value}" min="0" step="1000"
                           onchange="updateFieldValue('${field.key}', parseFloat(this.value))">
                </div>
            </div>
        `;
    } else if (field.type === 'dropdown') {
        return `
            <div class="form-group">
                <label class="form-label ${field.required ? 'required' : ''}">${field.label}</label>
                <select class="form-control" id="field-${field.key}" onchange="updateFieldValue('${field.key}', this.value)">
                    <option value="">Select...</option>
                    ${field.config.options.map(opt => `
                        <option value="${opt.value}" ${value === opt.value ? 'selected' : ''}>${opt.label}</option>
                    `).join('')}
                </select>
            </div>
        `;
    } else if (field.type === 'yesno') {
        return `
            <div class="form-group">
                <label class="form-label ${field.required ? 'required' : ''}">${field.label}</label>
                <div style="display: flex; gap: 16px; padding-top: 8px;">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="radio" name="${field.key}" value="yes" ${value === 'yes' ? 'checked' : ''} onchange="updateFieldValue('${field.key}', 'yes')">
                        <span>Yes</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="radio" name="${field.key}" value="no" ${value === 'no' ? 'checked' : ''} onchange="updateFieldValue('${field.key}', 'no')">
                        <span>No</span>
                    </label>
                </div>
            </div>
        `;
    }
    return '';
}

// ============================================================================
// EVENT HANDLERS
// ============================================================================

function selectTenant(tenant) {
    state.currentTenant = tenant;
    render();
}

function selectRole(role, userName) {
    state.currentRole = role;
    state.currentUserName = userName;
    render();
}

function continueToDashboard() {
    navigateTo('dashboard');
}

function navigateTo(page) {
    state.currentPage = page;
    render();
    window.scrollTo(0, 0);
}

function logout() {
    navigateTo('landing');
}

function selectScenario(scenarioId) {
    state.selectedScenario = scenarioId;
    render();
}

function openProjectWizard() {
    state.wizardStep = 1;
    state.wizardData = { criteriaValues: {} };
    state.showDescriptionBox = true;
    document.getElementById('projectWizardModal').classList.add('active');
    renderWizard();
}

function closeProjectWizard() {
    document.getElementById('projectWizardModal').classList.remove('active');
    state.wizardData = { criteriaValues: {} };
}

function runAIAutoFill() {
    const description = document.getElementById('wizard-description').value;
    if (!description.trim()) {
        alert('Please enter a project description first');
        return;
    }
    
    state.wizardData.description = description;
    const generated = AIAgent.analyzeDescription(description);
    state.wizardData.criteriaValues = generated;
    state.showDescriptionBox = false;
    
    renderWizard();
}

function resetAIAutoFill() {
    state.showDescriptionBox = true;
    state.wizardData.criteriaValues = {};
    renderWizard();
}

function updateFieldValue(key, value) {
    if (!state.wizardData.criteriaValues) state.wizardData.criteriaValues = {};
    state.wizardData.criteriaValues[key] = value;
}

function wizardNext(currentStep) {
    state.wizardStep++;
    renderWizard();
}

function wizardPrev() {
    state.wizardStep--;
    renderWizard();
}

function submitWizard() {
    const data = state.store.getData();
    const template = data.templates[0];
    
    const newProject = {
        id: 'proj-' + Date.now(),
        name: state.wizardData.criteriaValues.initiative_name || 'Unnamed Initiative',
        criteriaValues: state.wizardData.criteriaValues,
        status: 'Ready',
        scores: {},
        createdAt: new Date().toISOString()
    };

    data.projects.push(newProject);
    
    // Auto-score
    ScoringEngine.scoreProject(newProject, template);
    
    // Re-prioritize all
    ScoringEngine.prioritizeProjects(data.projects, template);
    
    state.store.saveData();
    
    state.store.addAuditEvent({
        type: 'ProjectCreated',
        entityType: 'Project',
        entityId: newProject.id,
        actor: state.currentUserName
    });

    closeProjectWizard();
    
    // Show success message
    alert(` Initiative "${newProject.name}" created and scored successfully!\n\nScore: ${newProject.scores.compositeScore.toFixed(1)}/100\nRank: #${newProject.scores.rank}`);
    
    navigateTo('projects');
}

function runPrioritization() {
    const data = state.store.getData();
    const template = data.templates[0];
    const result = ScoringEngine.prioritizeProjects(data.projects, template);
    
    state.store.addAuditEvent({
        type: 'PrioritizationRun',
        entityType: 'Portfolio',
        entityId: 'all',
        actor: state.currentUserName
    });
    
    state.store.saveData();
    
    alert(` Prioritization complete!\n\n${result.rankedProjects.length} initiatives ranked\n${result.blockedCount} blocked by kill-switch rules`);
    render();
}

function viewProject(projectId) {
    const data = state.store.getData();
    const project = data.projects.find(p => p.id === projectId);
    if (project) {
        const details = `
Initiative: ${project.criteriaValues?.initiative_name || project.name}
ID: ${project.criteriaValues?.initiative_id || project.id}
Score: ${project.scores?.compositeScore?.toFixed(1) || 'Not scored'}/100
Rank: #${project.scores?.rank || 'N/A'}
Status: ${project.status}

Investment: ${project.criteriaValues?.investment_required ? (project.criteriaValues.investment_required / 1000000).toFixed(1) + 'M SAR' : 'N/A'}
Timeline: ${project.criteriaValues?.timeline_months || 'N/A'} months
IRR: ${project.criteriaValues?.irr_percentage || 'N/A'}%
        `.trim();
        
        alert(details);
    }
}

// ============================================================================
// INITIALIZE
// ============================================================================

render();

// Make functions global
window.selectTenant = selectTenant;
window.selectRole = selectRole;
window.continueToDashboard = continueToDashboard;
window.navigateTo = navigateTo;
window.logout = logout;
window.selectScenario = selectScenario;
window.openProjectWizard = openProjectWizard;
window.closeProjectWizard = closeProjectWizard;
window.runAIAutoFill = runAIAutoFill;
window.resetAIAutoFill = resetAIAutoFill;
window.updateFieldValue = updateFieldValue;
window.wizardNext = wizardNext;
window.wizardPrev = wizardPrev;
window.submitWizard = submitWizard;
window.runPrioritization = runPrioritization;
window.viewProject = viewProject;

</script>
</body>
</html>
